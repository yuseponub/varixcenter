---
phase: 14-returns-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/033_medias_returns.sql
autonomous: true

must_haves:
  truths:
    - "medias_returns table exists with required columns"
    - "devolucion_estado and reembolso_metodo ENUMs exist"
    - "DEV- numbering counter initialized"
    - "RLS enabled with role-based policies"
    - "Immutability trigger prevents state changes after approval/rejection"
  artifacts:
    - path: "supabase/migrations/033_medias_returns.sql"
      provides: "Returns schema, ENUMs, counter, triggers, RLS"
      min_lines: 300
  key_links:
    - from: "medias_returns"
      to: "medias_sales"
      via: "sale_id FK"
      pattern: "REFERENCES public.medias_sales"
    - from: "medias_returns"
      to: "medias_sale_items"
      via: "sale_item_id FK"
      pattern: "REFERENCES public.medias_sale_items"
---

<objective>
Create the database foundation for the returns workflow with medias_returns table, ENUMs, gapless numbering, and RLS policies.

Purpose: Establishes the immutable data model for two-phase return approval with proper audit trail and fraud prevention at the database level.
Output: Migration file 033_medias_returns.sql with complete schema ready for RPC functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-returns-workflow/14-CONTEXT.md
@.planning/phases/14-returns-workflow/14-RESEARCH.md
@supabase/migrations/021_medias_sales.sql
@supabase/migrations/022_medias_sales_immutability.sql
@supabase/migrations/024_medias_cierres.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medias_returns migration with ENUMs, table, counter, and triggers</name>
  <files>supabase/migrations/033_medias_returns.sql</files>
  <action>
Create comprehensive migration file following existing medias patterns:

1. **ENUMs:**
   - `devolucion_estado`: 'pendiente', 'aprobada', 'rechazada'
   - `reembolso_metodo`: 'efectivo', 'cambio_producto'

2. **Counter table (gapless DEV- numbering):**
   - `medias_return_counter` with single-row enforcement
   - `get_next_medias_return_number()` function with FOR UPDATE lock
   - Protection trigger (no DELETE, no extra INSERTs)
   - Initialize with (1, 0, 'DEV')

3. **medias_returns table:**
   - id UUID PRIMARY KEY
   - numero_devolucion VARCHAR(20) UNIQUE (DEV-000001)
   - sale_id UUID NOT NULL REFERENCES medias_sales
   - sale_item_id UUID NOT NULL REFERENCES medias_sale_items
   - cantidad INTEGER NOT NULL (partial returns allowed)
   - product_codigo, product_tipo, product_talla (snapshot from sale_item)
   - monto_devolucion DECIMAL(12,2) (unit_price * cantidad)
   - motivo TEXT NOT NULL (free text, 10+ chars)
   - foto_path TEXT (OPTIONAL per CONTEXT.md)
   - metodo_reembolso reembolso_metodo NOT NULL
   - estado devolucion_estado DEFAULT 'pendiente'
   - solicitante_id UUID NOT NULL REFERENCES auth.users
   - aprobador_id UUID (NULL until approved/rejected)
   - aprobado_at TIMESTAMPTZ (NULL until approved/rejected)
   - notas_aprobador TEXT (OPTIONAL per CONTEXT.md)
   - created_at, updated_at TIMESTAMPTZ

4. **Constraints:**
   - cantidad_positive CHECK (cantidad > 0)
   - monto_positive CHECK (monto_devolucion > 0)
   - motivo_length CHECK (LENGTH(TRIM(motivo)) >= 10)

5. **Immutability trigger:** (enforce_medias_return_immutability)
   - Block DELETE
   - Block changes to: numero_devolucion, sale_id, sale_item_id, cantidad, product_*, monto_devolucion, motivo, metodo_reembolso, solicitante_id, created_at
   - Allow estado transition ONLY: pendiente -> aprobada OR pendiente -> rechazada
   - Block any transition from aprobada or rechazada (terminal states)
   - Auto-set aprobado_at on estado change

6. **Indexes:**
   - idx_medias_returns_sale (sale_id)
   - idx_medias_returns_estado (estado)
   - idx_medias_returns_created (created_at DESC)
   - idx_medias_returns_aprobado (aprobado_at) WHERE estado = 'aprobada' (partial)

7. **RLS Policies:**
   - SELECT: All staff (admin, medico, enfermera, secretaria)
   - INSERT: All staff (anyone can request a return)
   - UPDATE: Only admin and medico (for approval/rejection)
   - DELETE: None (immutable)

8. **Grants:**
   - SELECT, INSERT on medias_returns TO authenticated
   - UPDATE (estado, aprobador_id, aprobado_at, notas_aprobador, updated_at) on medias_returns TO authenticated
   - SELECT, UPDATE on medias_return_counter TO authenticated

9. **Verification block:**
   - Check table exists
   - Check RLS enabled
   - Check ENUMs exist
   - Check counter initialized with DEV prefix
   - Check immutability trigger exists

Follow exact patterns from 024_medias_cierres.sql for counter and 022_medias_sales_immutability.sql for immutability trigger.
  </action>
  <verify>
Run SQL validation:
```bash
cd /mnt/c/Users/Usuario/Proyectos/varix-clinic
npx supabase db lint supabase/migrations/033_medias_returns.sql
```
Or manually check migration syntax is valid SQL with:
- All FK references to existing tables
- Trigger function bodies are syntactically correct
- RLS policies reference valid roles
  </verify>
  <done>
Migration file exists with:
- devolucion_estado and reembolso_metodo ENUMs created
- medias_returns table with all required columns
- medias_return_counter with single-row and DEV prefix
- get_next_medias_return_number() function
- Immutability trigger blocking invalid state transitions
- RLS policies for all staff SELECT, all staff INSERT, admin/medico UPDATE
- Verification block confirms all objects created
  </done>
</task>

</tasks>

<verification>
1. Migration file follows existing medias patterns (compare with 024_medias_cierres.sql)
2. All FKs reference existing tables: medias_sales, medias_sale_items, auth.users
3. State machine only allows: pendiente -> aprobada, pendiente -> rechazada
4. RLS allows any employee to create return request
5. RLS restricts approval to admin/medico only
6. Counter uses DEV- prefix (not VTA- or CIM-)
</verification>

<success_criteria>
- [ ] File supabase/migrations/033_medias_returns.sql exists
- [ ] ENUMs devolucion_estado and reembolso_metodo defined
- [ ] Table medias_returns with all columns from spec
- [ ] Counter initialized with DEV prefix
- [ ] Immutability trigger enforces state machine
- [ ] RLS policies match role requirements (anyone can request, admin/medico approve)
- [ ] SQL syntax is valid (no lint errors)
</success_criteria>

<output>
After completion, create `.planning/phases/14-returns-workflow/14-01-SUMMARY.md`
</output>
