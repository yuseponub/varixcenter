---
phase: 09-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/notifications.ts
  - src/lib/validations/notification.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match database schema"
    - "Zod schema validates notification data"
    - "Types are exported from barrel file"
  artifacts:
    - path: "src/types/notifications.ts"
      provides: "Notification, NotificationStatus, ReminderType types"
      exports: ["Notification", "NotificationStatus", "ReminderType"]
    - path: "src/lib/validations/notification.ts"
      provides: "Zod schemas for notifications"
      exports: ["notificationSchema"]
  key_links:
    - from: "src/types/notifications.ts"
      to: "src/types/index.ts"
      via: "re-export"
      pattern: "export \\* from './notifications'"
---

<objective>
Create TypeScript types and Zod validation schemas for the notifications system.

Purpose: Type safety for notification data flowing between database, API routes, and UI components.
Output: Type definitions and Zod schemas matching the database schema from Plan 01.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-notifications/09-RESEARCH.md
@src/types/alerts.ts
@src/lib/validations/service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification TypeScript types</name>
  <files>src/types/notifications.ts</files>
  <action>
Create TypeScript types matching the database schema:

```typescript
/**
 * Notification Types for SMS Reminders
 *
 * Matches database schema from 030_notifications.sql
 */

/**
 * Notification status enum matching database
 * - pendiente: Scheduled, not yet sent
 * - enviado: Successfully sent to Twilio
 * - fallido: Failed after all retry attempts
 * - reintentando: Will retry in 30 minutes
 */
export type NotificationStatus = 'pendiente' | 'enviado' | 'fallido' | 'reintentando'

/**
 * Reminder type enum
 * - 24h: Sent 24 hours before appointment
 * - 2h: Sent 2 hours before appointment
 */
export type ReminderType = '24h' | '2h'

/**
 * Notification record from database
 */
export interface Notification {
  id: string
  appointment_id: string
  patient_id: string
  tipo_recordatorio: ReminderType
  telefono_destino: string
  mensaje: string
  estado: NotificationStatus
  twilio_message_sid: string | null
  error_code: number | null
  error_message: string | null
  intentos: number
  enviado_at: string | null
  siguiente_reintento_at: string | null
  created_at: string
}

/**
 * Notification with joined patient and appointment data
 * Used in notification list page
 */
export interface NotificationWithDetails extends Notification {
  patients: {
    id: string
    nombre: string
    apellido: string
    celular: string
  }
  appointments: {
    id: string
    fecha_hora_inicio: string
    estado: string
  }
}

/**
 * Data needed to create a notification
 */
export interface CreateNotificationData {
  appointment_id: string
  patient_id: string
  tipo_recordatorio: ReminderType
  telefono_destino: string
  mensaje: string
}

/**
 * Result from sending an SMS via Twilio
 */
export interface SendSMSResult {
  success: boolean
  messageSid?: string
  errorCode?: number
  errorMessage?: string
}

/**
 * Configuration for notification status display
 */
export const NOTIFICATION_STATUS_CONFIG: Record<
  NotificationStatus,
  { label: string; variant: 'default' | 'secondary' | 'destructive' | 'outline'; icon: string }
> = {
  pendiente: { label: 'Pendiente', variant: 'secondary', icon: 'Clock' },
  enviado: { label: 'Enviado', variant: 'default', icon: 'CheckCircle' },
  fallido: { label: 'Fallido', variant: 'destructive', icon: 'XCircle' },
  reintentando: { label: 'Reintentando', variant: 'outline', icon: 'RefreshCw' },
}

/**
 * Configuration for reminder type display
 */
export const REMINDER_TYPE_CONFIG: Record<ReminderType, { label: string }> = {
  '24h': { label: '24 horas antes' },
  '2h': { label: '2 horas antes' },
}
```
  </action>
  <verify>
File exists with exports:
- NotificationStatus type
- ReminderType type
- Notification interface
- NotificationWithDetails interface
- CreateNotificationData interface
- SendSMSResult interface
- NOTIFICATION_STATUS_CONFIG constant
- REMINDER_TYPE_CONFIG constant
  </verify>
  <done>
TypeScript types created matching database schema with helper configs for UI display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas</name>
  <files>src/lib/validations/notification.ts</files>
  <action>
Create Zod schemas for validation:

```typescript
import { z } from 'zod'

/**
 * Phone number validation (E.164 format for Colombia)
 * Format: +57XXXXXXXXXX (10 digits after country code)
 */
export const phoneE164Schema = z
  .string()
  .regex(/^\+57[0-9]{10}$/, {
    message: 'Telefono debe estar en formato E.164 (+57XXXXXXXXXX)',
  })

/**
 * Notification status enum schema
 */
export const notificationStatusSchema = z.enum([
  'pendiente',
  'enviado',
  'fallido',
  'reintentando',
])

/**
 * Reminder type enum schema
 */
export const reminderTypeSchema = z.enum(['24h', '2h'])

/**
 * Schema for creating a new notification
 */
export const createNotificationSchema = z.object({
  appointment_id: z.string().uuid({ message: 'ID de cita invalido' }),
  patient_id: z.string().uuid({ message: 'ID de paciente invalido' }),
  tipo_recordatorio: reminderTypeSchema,
  telefono_destino: phoneE164Schema,
  mensaje: z
    .string()
    .min(1, { message: 'Mensaje es requerido' })
    .max(160, { message: 'Mensaje no puede exceder 160 caracteres' }),
})

/**
 * Schema for updating notification status after send attempt
 */
export const updateNotificationStatusSchema = z.object({
  estado: notificationStatusSchema,
  twilio_message_sid: z.string().nullable().optional(),
  error_code: z.number().nullable().optional(),
  error_message: z.string().nullable().optional(),
  enviado_at: z.string().datetime().nullable().optional(),
  siguiente_reintento_at: z.string().datetime().nullable().optional(),
  intentos: z.number().int().min(0).optional(),
})

/**
 * Schema for notification filters in list page
 */
export const notificationFiltersSchema = z.object({
  estado: notificationStatusSchema.optional(),
  tipo_recordatorio: reminderTypeSchema.optional(),
  patient_id: z.string().uuid().optional(),
  fecha_desde: z.string().date().optional(),
  fecha_hasta: z.string().date().optional(),
  limit: z.number().int().min(1).max(100).default(50),
})

export type CreateNotificationInput = z.infer<typeof createNotificationSchema>
export type UpdateNotificationStatusInput = z.infer<typeof updateNotificationStatusSchema>
export type NotificationFilters = z.infer<typeof notificationFiltersSchema>
```
  </action>
  <verify>
File exists with exports:
- phoneE164Schema
- notificationStatusSchema
- reminderTypeSchema
- createNotificationSchema
- updateNotificationStatusSchema
- notificationFiltersSchema
- Type exports for zod inferred types
  </verify>
  <done>
Zod schemas created for notification creation, status updates, and filtering with E.164 phone validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export notifications types from barrel</name>
  <files>src/types/index.ts</files>
  <action>
Add export for notifications types to the barrel file:

```typescript
// Re-export notification types
export * from './notifications'
```

Add this line after the existing exports (after medical-records export).
  </action>
  <verify>
src/types/index.ts contains:
- `export * from './notifications'`
  </verify>
  <done>
Notification types are accessible via `@/types` import.
  </done>
</task>

</tasks>

<verification>
- [ ] src/types/notifications.ts exists with all type definitions
- [ ] src/lib/validations/notification.ts exists with Zod schemas
- [ ] src/types/index.ts re-exports notifications module
- [ ] Types match database column names exactly
- [ ] E.164 phone validation regex is correct for Colombia (+57)
</verification>

<success_criteria>
Types and validation schemas are complete and can be imported via `@/types` and `@/lib/validations/notification`. Schemas validate phone numbers in E.164 format and notification status values.
</success_criteria>

<output>
After completion, create `.planning/phases/09-notifications/09-02-SUMMARY.md`
</output>
