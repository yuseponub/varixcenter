---
phase: 15-dashboard-inventory
plan: 05
type: execute
wave: 3
depends_on: ["15-02", "15-03"]
files_modified:
  - src/app/(protected)/medias/movimientos/actions.ts
  - src/components/medias/movements/adjustment-form.tsx
  - src/components/medias/movements/adjustment-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "createAdjustment action calls RPC and revalidates paths"
    - "AdjustmentForm validates with adjustmentSchema"
    - "Form allows choosing entrada/salida and normal/devoluciones"
  artifacts:
    - path: "src/app/(protected)/medias/movimientos/actions.ts"
      provides: "Server action for inventory adjustment"
      exports: ["createAdjustment"]
    - path: "src/components/medias/movements/adjustment-form.tsx"
      provides: "Adjustment form with validation"
      exports: ["AdjustmentForm"]
    - path: "src/components/medias/movements/adjustment-dialog.tsx"
      provides: "Dialog wrapper for adjustment form"
      exports: ["AdjustmentDialog"]
  key_links:
    - from: "createAdjustment"
      to: "create_inventory_adjustment RPC"
      via: "supabase.rpc call"
      pattern: "rpc.*create_inventory_adjustment"
---

<objective>
Create server action and form components for inventory adjustments.

Purpose: Enable admin/medico users to make manual stock adjustments with justification.
Output: Server action and two components (form and dialog wrapper).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-dashboard-inventory/15-CONTEXT.md
@.planning/phases/15-dashboard-inventory/15-RESEARCH.md
@src/app/(protected)/medias/productos/actions.ts
@src/lib/validations/medias/adjustment.ts
@src/types/medias/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create adjustment server action</name>
  <files>src/app/(protected)/medias/movimientos/actions.ts</files>
  <action>
Create src/app/(protected)/medias/movimientos/actions.ts with:

1. 'use server' directive
2. Import createClient, revalidatePath, adjustmentSchema

3. AdjustmentActionState type:
   - error?: string
   - errors?: Record<string, string[]>
   - success?: boolean

4. createAdjustment function:
   - Signature: (prevState: AdjustmentActionState | null, formData: FormData) => Promise<AdjustmentActionState>
   - Extract and parse form fields
   - Validate with adjustmentSchema.safeParse
   - If invalid: return { errors: field errors }
   - Create supabase client
   - Call RPC: supabase.rpc('create_inventory_adjustment', {
       p_product_id: data.product_id,
       p_cantidad: data.cantidad,
       p_tipo: data.tipo,
       p_stock_type: data.stock_type,
       p_razon: data.razon
     })
   - Handle RPC errors (role validation fails, stock negative)
   - On success: revalidatePath('/medias'), revalidatePath('/medias/movimientos'), revalidatePath('/medias/productos')
   - Return { success: true }

Use eslint-disable for untyped RPC call.
  </action>
  <verify>Run `cat src/app/(protected)/medias/movimientos/actions.ts` to confirm action structure</verify>
  <done>Server action validates input, calls adjustment RPC, and revalidates affected paths</done>
</task>

<task type="auto">
  <name>Task 2: Create adjustment form and dialog</name>
  <files>
    src/components/medias/movements/adjustment-form.tsx
    src/components/medias/movements/adjustment-dialog.tsx
  </files>
  <action>
Create src/components/medias/movements/adjustment-form.tsx:
- 'use client'
- Props: products: { id: string; codigo: string; tipo: string; talla: string; stock_normal: number; stock_devoluciones: number }[], onSuccess?: () => void
- Use useActionState with createAdjustment
- Form fields:
  - Product select dropdown (show codigo - tipo talla, current stock)
  - cantidad: number input (min 1)
  - tipo: radio group (Entrada adds stock, Salida removes stock)
  - stock_type: radio group (Normal, Devoluciones)
  - razon: textarea (min 10 chars, placeholder "Motivo del ajuste...")
- Show validation errors per field
- Show general error if RPC fails
- Submit button: "Registrar Ajuste"
- On success: call onSuccess callback

Create src/components/medias/movements/adjustment-dialog.tsx:
- Props: products array (same as form), trigger?: React.ReactNode
- Uses shadcn Dialog
- Default trigger: Button with Plus icon "Nuevo Ajuste"
- Dialog title: "Ajuste de Inventario"
- Contains AdjustmentForm
- Closes dialog on success

Use shadcn RadioGroup for tipo and stock_type selections.
  </action>
  <verify>Run `cat src/components/medias/movements/adjustment-form.tsx src/components/medias/movements/adjustment-dialog.tsx` to confirm form structure</verify>
  <done>Adjustment form collects all required fields and dialog provides modal wrapper</done>
</task>

</tasks>

<verification>
- [ ] src/app/(protected)/medias/movimientos/actions.ts exists
- [ ] createAdjustment validates with adjustmentSchema
- [ ] createAdjustment calls create_inventory_adjustment RPC
- [ ] Action revalidates /medias, /medias/movimientos, /medias/productos
- [ ] src/components/medias/movements/adjustment-form.tsx exists
- [ ] Form has product select, cantidad, tipo, stock_type, razon fields
- [ ] src/components/medias/movements/adjustment-dialog.tsx exists
- [ ] Dialog closes on successful submission
</verification>

<success_criteria>
Adjustment action and form components ready for movements page integration.
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-inventory/15-05-SUMMARY.md`
</output>
