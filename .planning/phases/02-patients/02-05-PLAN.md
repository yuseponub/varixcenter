---
phase: 02-patients
plan: 05
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/components/patients/patient-search.tsx
  - src/components/patients/patient-table.tsx
  - src/app/(protected)/pacientes/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of patients in a table"
    - "User can search patients by typing in search input"
    - "Search matches cedula, nombre, apellido, or celular"
    - "Table shows cedula, nombre, apellido, celular columns"
    - "Clicking a row navigates to patient detail"
  artifacts:
    - path: "src/components/patients/patient-search.tsx"
      provides: "Search input with debounce"
      exports: ["PatientSearch"]
    - path: "src/components/patients/patient-table.tsx"
      provides: "Patient data table"
      exports: ["PatientTable"]
    - path: "src/app/(protected)/pacientes/page.tsx"
      provides: "Patient list page"
  key_links:
    - from: "src/app/(protected)/pacientes/page.tsx"
      to: "src/lib/queries/patients.ts"
      via: "searchPatients import"
      pattern: "searchPatients"
    - from: "src/components/patients/patient-table.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable hook"
      pattern: "useReactTable"
---

<objective>
Create patient list page with search functionality and data table

Purpose: Enables staff to find patients quickly by cedula, name, or phone. The search is debounced for performance and the table uses TanStack for sorting capability.
Output: Patient list page accessible at /pacientes with working search
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-patients/02-RESEARCH.md

# Query functions from 02-03
@src/lib/queries/patients.ts

# shadcn/ui components from 02-01
@src/components/ui/table.tsx
@src/components/ui/input.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patient search component</name>
  <files>src/components/patients/patient-search.tsx</files>
  <action>
Create `src/components/patients/patient-search.tsx`:

```typescript
'use client'

import { useRouter, useSearchParams } from 'next/navigation'
import { useEffect, useState, useTransition } from 'react'
import { Input } from '@/components/ui/input'

/**
 * Search input with debounce for patient search
 * Updates URL search params for server-side filtering
 */
export function PatientSearch() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const [isPending, startTransition] = useTransition()

  // Local state for immediate UI feedback
  const [query, setQuery] = useState(searchParams.get('q') ?? '')

  // Debounce search - update URL after 300ms of no typing
  useEffect(() => {
    const timer = setTimeout(() => {
      const params = new URLSearchParams(searchParams.toString())

      if (query) {
        params.set('q', query)
      } else {
        params.delete('q')
      }

      // Reset to page 1 when search changes
      params.delete('page')

      startTransition(() => {
        router.push(`/pacientes?${params.toString()}`)
      })
    }, 300)

    return () => clearTimeout(timer)
  }, [query, router, searchParams])

  return (
    <div className="relative">
      <Input
        type="search"
        placeholder="Buscar por cedula, nombre, apellido o celular..."
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        className="w-full max-w-md"
      />
      {isPending && (
        <div className="absolute right-3 top-1/2 -translate-y-1/2">
          <div className="h-4 w-4 animate-spin rounded-full border-2 border-gray-300 border-t-gray-600" />
        </div>
      )}
    </div>
  )
}
```

Key points:
1. Debounced search (300ms delay) to avoid excessive server requests
2. Updates URL params for server-side filtering (enables sharing search URLs)
3. Shows loading spinner during transition
4. Spanish placeholder text
5. Resets pagination when search changes
  </action>
  <verify>
Run `cat src/components/patients/patient-search.tsx | grep -E "(setTimeout|startTransition|Buscar)"` - should show debounce, transition, and Spanish text.
  </verify>
  <done>
Patient search component created with debounce and URL param updates
  </done>
</task>

<task type="auto">
  <name>Task 2: Create patient table component</name>
  <files>src/components/patients/patient-table.tsx</files>
  <action>
Create `src/components/patients/patient-table.tsx`:

```typescript
'use client'

import { useRouter } from 'next/navigation'
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  flexRender,
  type ColumnDef,
  type SortingState,
} from '@tanstack/react-table'
import { useState } from 'react'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'

type Patient = {
  id: string
  cedula: string
  nombre: string
  apellido: string
  celular: string
  created_at: string
}

interface PatientTableProps {
  data: Patient[]
}

const columns: ColumnDef<Patient>[] = [
  {
    accessorKey: 'cedula',
    header: 'Cedula',
    cell: ({ row }) => (
      <span className="font-mono">{row.getValue('cedula')}</span>
    ),
  },
  {
    accessorKey: 'nombre',
    header: 'Nombre',
  },
  {
    accessorKey: 'apellido',
    header: 'Apellido',
  },
  {
    accessorKey: 'celular',
    header: 'Celular',
    cell: ({ row }) => (
      <span className="font-mono">{row.getValue('celular')}</span>
    ),
  },
  {
    accessorKey: 'created_at',
    header: 'Registrado',
    cell: ({ row }) => {
      const date = new Date(row.getValue('created_at'))
      return new Intl.DateTimeFormat('es-CO', {
        dateStyle: 'medium',
      }).format(date)
    },
  },
]

/**
 * Patient data table with sorting and row click navigation
 */
export function PatientTable({ data }: PatientTableProps) {
  const router = useRouter()
  const [sorting, setSorting] = useState<SortingState>([])

  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    onSortingChange: setSorting,
    state: {
      sorting,
    },
  })

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          {table.getHeaderGroups().map((headerGroup) => (
            <TableRow key={headerGroup.id}>
              {headerGroup.headers.map((header) => (
                <TableHead
                  key={header.id}
                  className={header.column.getCanSort() ? 'cursor-pointer select-none' : ''}
                  onClick={header.column.getToggleSortingHandler()}
                >
                  {header.isPlaceholder ? null : (
                    <div className="flex items-center gap-2">
                      {flexRender(
                        header.column.columnDef.header,
                        header.getContext()
                      )}
                      {{
                        asc: ' ^',
                        desc: ' v',
                      }[header.column.getIsSorted() as string] ?? null}
                    </div>
                  )}
                </TableHead>
              ))}
            </TableRow>
          ))}
        </TableHeader>
        <TableBody>
          {table.getRowModel().rows.length ? (
            table.getRowModel().rows.map((row) => (
              <TableRow
                key={row.id}
                className="cursor-pointer hover:bg-gray-50"
                onClick={() => router.push(`/pacientes/${row.original.id}`)}
              >
                {row.getVisibleCells().map((cell) => (
                  <TableCell key={cell.id}>
                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                  </TableCell>
                ))}
              </TableRow>
            ))
          ) : (
            <TableRow>
              <TableCell colSpan={columns.length} className="h-24 text-center">
                No se encontraron pacientes
              </TableCell>
            </TableRow>
          )}
        </TableBody>
      </Table>
    </div>
  )
}
```

Key points:
1. Uses TanStack Table for sorting functionality
2. Row click navigates to patient detail page
3. Date formatted with Spanish locale (es-CO)
4. Cedula and celular use monospace font for readability
5. Empty state shows Spanish message
6. Hover state indicates clickable rows
  </action>
  <verify>
Run `cat src/components/patients/patient-table.tsx | grep -E "(useReactTable|router.push|es-CO)"` - should show TanStack, navigation, and Spanish locale.
  </verify>
  <done>
Patient table component created with sorting, row navigation, and Spanish locale
  </done>
</task>

<task type="auto">
  <name>Task 3: Create patient list page</name>
  <files>src/app/(protected)/pacientes/page.tsx</files>
  <action>
Create the directory if needed: `mkdir -p src/app/\(protected\)/pacientes`

Create `src/app/(protected)/pacientes/page.tsx`:

```typescript
import Link from 'next/link'
import { Suspense } from 'react'
import { searchPatients } from '@/lib/queries/patients'
import { PatientSearch } from '@/components/patients/patient-search'
import { PatientTable } from '@/components/patients/patient-table'
import { Button } from '@/components/ui/button'

interface PageProps {
  searchParams: Promise<{ q?: string }>
}

async function PatientList({ query }: { query: string }) {
  const patients = await searchPatients(query)

  return <PatientTable data={patients} />
}

export default async function PacientesPage({ searchParams }: PageProps) {
  const { q = '' } = await searchParams

  return (
    <div className="container mx-auto py-6">
      {/* Header */}
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold">Pacientes</h1>
        <Link href="/pacientes/nuevo">
          <Button>Nuevo Paciente</Button>
        </Link>
      </div>

      {/* Search */}
      <div className="mb-6">
        <PatientSearch />
      </div>

      {/* Results */}
      <Suspense
        fallback={
          <div className="flex h-64 items-center justify-center">
            <div className="h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600" />
          </div>
        }
      >
        <PatientList query={q} />
      </Suspense>
    </div>
  )
}
```

Key points:
1. Server component with async data fetching
2. Search query from URL params (enables sharing URLs)
3. Suspense boundary for loading state during search
4. "Nuevo Paciente" button links to create page
5. Container layout with proper spacing
6. Spanish UI text throughout
  </action>
  <verify>
Run `cat src/app/\(protected\)/pacientes/page.tsx | grep -E "(searchPatients|PatientSearch|PatientTable|Nuevo Paciente)"` - should show all component integrations.
  </verify>
  <done>
Patient list page created with search, table, and new patient button
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` should pass
2. Navigate to /pacientes should show patient list page
3. Search should filter results with debounce
4. Clicking a row should navigate to /pacientes/[id]
</verification>

<success_criteria>
- /pacientes page renders with search input and table
- Search updates URL and filters results with 300ms debounce
- Table shows cedula, nombre, apellido, celular, registrado columns
- Rows are clickable and navigate to patient detail
- "Nuevo Paciente" button navigates to /pacientes/nuevo
- Empty state shows "No se encontraron pacientes"
</success_criteria>

<output>
After completion, create `.planning/phases/02-patients/02-05-SUMMARY.md`
</output>
