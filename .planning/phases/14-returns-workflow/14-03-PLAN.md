---
phase: 14-returns-workflow
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/types/medias/returns.ts
  - src/lib/validations/medias/return.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match medias_returns table schema"
    - "Zod schemas validate return creation and approval inputs"
    - "DevolucionEstado and ReembolsoMetodo types exported"
  artifacts:
    - path: "src/types/medias/returns.ts"
      provides: "Return type definitions"
      min_lines: 60
      exports: ["DevolucionEstado", "ReembolsoMetodo", "MediasReturn", "MediasReturnWithDetails"]
    - path: "src/lib/validations/medias/return.ts"
      provides: "Zod validation schemas"
      min_lines: 40
      exports: ["createReturnSchema", "approveReturnSchema", "rejectReturnSchema"]
  key_links:
    - from: "src/lib/validations/medias/return.ts"
      to: "src/types/medias/returns.ts"
      via: "type import"
      pattern: "from '@/types/medias/returns'"
---

<objective>
Create TypeScript types and Zod validation schemas for the returns domain following existing medias patterns.

Purpose: Provides type-safe interfaces for return data and validates inputs before RPC calls.
Output: Types and validation files matching existing medias/sales.ts and medias/sale.ts patterns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-returns-workflow/14-CONTEXT.md
@src/types/medias/sales.ts
@src/lib/validations/medias/sale.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types for returns</name>
  <files>src/types/medias/returns.ts</files>
  <action>
Create types file following existing medias/sales.ts pattern:

```typescript
/**
 * Medias Returns Type Definitions
 *
 * Types matching medias_returns table
 * Used by: Return creation, approval workflow, returns list
 */

/**
 * Return status (matches devolucion_estado ENUM)
 */
export const DEVOLUCION_ESTADOS = ['pendiente', 'aprobada', 'rechazada'] as const
export type DevolucionEstado = (typeof DEVOLUCION_ESTADOS)[number]

export const DEVOLUCION_ESTADO_LABELS: Record<DevolucionEstado, string> = {
  pendiente: 'Pendiente',
  aprobada: 'Aprobada',
  rechazada: 'Rechazada',
}

export const DEVOLUCION_ESTADO_COLORS: Record<DevolucionEstado, string> = {
  pendiente: 'bg-yellow-100 text-yellow-800',
  aprobada: 'bg-green-100 text-green-800',
  rechazada: 'bg-red-100 text-red-800',
}

/**
 * Refund method (matches reembolso_metodo ENUM)
 */
export const REEMBOLSO_METODOS = ['efectivo', 'cambio_producto'] as const
export type ReembolsoMetodo = (typeof REEMBOLSO_METODOS)[number]

export const REEMBOLSO_METODO_LABELS: Record<ReembolsoMetodo, string> = {
  efectivo: 'Efectivo',
  cambio_producto: 'Cambio de producto',
}

/**
 * Return record (medias_returns table)
 */
export interface MediasReturn {
  id: string
  numero_devolucion: string
  sale_id: string
  sale_item_id: string
  cantidad: number
  product_codigo: string
  product_tipo: string
  product_talla: string
  monto_devolucion: number
  motivo: string
  foto_path: string | null
  metodo_reembolso: ReembolsoMetodo
  estado: DevolucionEstado
  solicitante_id: string
  aprobador_id: string | null
  aprobado_at: string | null
  notas_aprobador: string | null
  created_at: string
  updated_at: string
}

/**
 * Return with related data for detail/list views
 */
export interface MediasReturnWithDetails extends MediasReturn {
  sale?: {
    id: string
    numero_venta: string
    patient?: {
      id: string
      nombre: string
      apellido: string
    } | null
  }
  solicitante?: {
    id: string
    email: string
  }
  aprobador?: {
    id: string
    email: string
  } | null
}

/**
 * Return creation input (for RPC call)
 */
export interface CreateReturnInput {
  sale_id: string
  sale_item_id: string
  cantidad: number
  motivo: string
  metodo_reembolso: ReembolsoMetodo
  foto_path?: string | null
}

/**
 * Approval/rejection input
 */
export interface ApproveReturnInput {
  return_id: string
  notas?: string | null
}
```
  </action>
  <verify>Check types match 033_medias_returns.sql column definitions</verify>
  <done>TypeScript types exported matching database schema</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas for returns</name>
  <files>src/lib/validations/medias/return.ts</files>
  <action>
Create validation file following existing medias/sale.ts pattern:

```typescript
import { z } from 'zod'
import { REEMBOLSO_METODOS } from '@/types/medias/returns'

/**
 * Create return request schema
 * Used by: Return form, createMediasReturn server action
 */
export const createReturnSchema = z.object({
  sale_id: z.string().uuid('ID de venta invalido'),
  sale_item_id: z.string().uuid('ID de item invalido'),
  cantidad: z
    .number({ invalid_type_error: 'Cantidad debe ser un numero' })
    .int('Cantidad debe ser un numero entero')
    .min(1, 'La cantidad debe ser al menos 1'),
  motivo: z
    .string()
    .min(10, 'El motivo debe tener al menos 10 caracteres')
    .max(500, 'El motivo es muy largo'),
  metodo_reembolso: z.enum(REEMBOLSO_METODOS, {
    error: 'Metodo de reembolso invalido',
  }),
  foto_path: z.string().nullable().optional(),
})

/**
 * Approve return schema (admin/medico only)
 */
export const approveReturnSchema = z.object({
  return_id: z.string().uuid('ID de devolucion invalido'),
  notas: z
    .string()
    .max(500, 'Las notas son muy largas')
    .nullable()
    .optional(),
})

/**
 * Reject return schema (admin/medico only)
 */
export const rejectReturnSchema = z.object({
  return_id: z.string().uuid('ID de devolucion invalido'),
  notas: z
    .string()
    .max(500, 'Las notas son muy largas')
    .nullable()
    .optional(),
})

/**
 * TypeScript types inferred from schemas
 */
export type CreateReturnFormData = z.infer<typeof createReturnSchema>
export type ApproveReturnFormData = z.infer<typeof approveReturnSchema>
export type RejectReturnFormData = z.infer<typeof rejectReturnSchema>
```

Note: Using Zod v4 API with { error: } instead of { required_error: } per codebase convention (10-02 decision).
  </action>
  <verify>Check validation rules match RPC constraints (motivo 10+ chars, valid enums)</verify>
  <done>Zod schemas validate all return inputs with Spanish error messages</done>
</task>

</tasks>

<verification>
1. Types match 033_medias_returns.sql columns exactly
2. All ENUM values match database ENUM definitions
3. Zod uses { error: } syntax (Zod v4 API)
4. motivo validation matches CHECK constraint (10+ chars)
5. Both files follow existing medias patterns (sales.ts, sale.ts)
</verification>

<success_criteria>
- [ ] src/types/medias/returns.ts created with all types
- [ ] DEVOLUCION_ESTADOS and REEMBOLSO_METODOS const arrays exported
- [ ] MediasReturn interface matches table columns
- [ ] MediasReturnWithDetails includes nested sale/user info
- [ ] src/lib/validations/medias/return.ts created
- [ ] createReturnSchema validates all required fields
- [ ] approveReturnSchema and rejectReturnSchema defined
- [ ] Spanish error messages for all validations
</success_criteria>

<output>
After completion, create `.planning/phases/14-returns-workflow/14-03-SUMMARY.md`
</output>
