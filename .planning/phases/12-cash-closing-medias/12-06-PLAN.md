---
phase: 12-cash-closing-medias
plan: 06
type: execute
wave: 4
depends_on: ["12-04", "12-05"]
files_modified:
  - src/app/(protected)/medias/cierres/page.tsx
  - src/app/(protected)/medias/cierres/nuevo/page.tsx
  - src/app/(protected)/medias/cierres/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can view list of medias cash closings"
    - "User can create new cierre with date selection and summary preview"
    - "User can view cierre detail with photo and sales breakdown"
    - "Admin can reopen closed cierre from list or detail page"
  artifacts:
    - path: "src/app/(protected)/medias/cierres/page.tsx"
      provides: "Cierres list page"
      min_lines: 40
    - path: "src/app/(protected)/medias/cierres/nuevo/page.tsx"
      provides: "New cierre page with date picker"
      min_lines: 60
    - path: "src/app/(protected)/medias/cierres/[id]/page.tsx"
      provides: "Cierre detail page"
      min_lines: 80
  key_links:
    - from: "src/app/(protected)/medias/cierres/page.tsx"
      to: "getMediasCierres query"
      via: "server component fetch"
      pattern: "await getMediasCierres"
    - from: "src/app/(protected)/medias/cierres/nuevo/page.tsx"
      to: "MediasCierreForm component"
      via: "component render"
      pattern: "<MediasCierreForm"
---

<objective>
Create the pages for medias cash closing: list page, new cierre page with date picker, and detail page.

Purpose: Provides the user-facing pages to manage medias cash closings with proper navigation and data fetching.

Output: 3 pages in src/app/(protected)/medias/cierres/
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-cash-closing-medias/12-RESEARCH.md
@src/app/(protected)/cierres/page.tsx (pattern to adapt if exists)
@src/app/(protected)/cierres/nuevo/page.tsx (pattern to adapt if exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medias cierres list page</name>
  <files>src/app/(protected)/medias/cierres/page.tsx</files>
  <action>
Create src/app/(protected)/medias/cierres/page.tsx:

```tsx
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Plus } from 'lucide-react'
import { getMediasCierres } from '@/lib/queries/medias/cierres'
import { MediasCierresTable } from '@/components/medias/cierres/cierres-table'
import { createClient } from '@/lib/supabase/server'

export const metadata = {
  title: 'Cierres de Caja - Medias | VarixClinic',
  description: 'Listado de cierres de caja de medias',
}

export default async function MediasCierresPage() {
  // Fetch closings
  const { closings, total } = await getMediasCierres({ limit: 50 })

  // Check if user is admin (for reopen button)
  const supabase = await createClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()

  let isAdmin = false
  if (user) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const { data: roleData } = await (supabase as any)
      .from('user_roles')
      .select('role')
      .eq('user_id', user.id)
      .single()
    isAdmin = roleData?.role === 'admin'
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold tracking-tight">
            Cierres de Caja - Medias
          </h1>
          <p className="text-muted-foreground">
            Gestion de cierres de caja diarios para ventas de medias
          </p>
        </div>
        <Button asChild>
          <Link href="/medias/cierres/nuevo">
            <Plus className="h-4 w-4 mr-2" />
            Nuevo Cierre
          </Link>
        </Button>
      </div>

      {/* Info card about zero tolerance */}
      <Card className="border-amber-200 bg-amber-50">
        <CardContent className="pt-4">
          <p className="text-sm text-amber-800">
            <strong>Tolerancia Cero:</strong> Cualquier diferencia entre el
            conteo fisico y el total calculado requiere justificacion detallada.
            Esta politica es mas estricta que la clinica.
          </p>
        </CardContent>
      </Card>

      {/* Closings table */}
      <Card>
        <CardHeader>
          <CardTitle>
            Cierres Registrados{' '}
            <span className="text-muted-foreground font-normal">({total})</span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <MediasCierresTable closings={closings} isAdmin={isAdmin} />
        </CardContent>
      </Card>
    </div>
  )
}
```

Key points:
- Links to /medias/cierres/nuevo for new cierre
- Shows zero-tolerance info card
- Passes isAdmin to table for reopen button visibility
  </action>
  <verify>Page renders with table and new cierre button, links use /medias/ paths</verify>
  <done>MediasCierresPage lists closings with admin reopen capability</done>
</task>

<task type="auto">
  <name>Task 2: Create new medias cierre page with date picker</name>
  <files>src/app/(protected)/medias/cierres/nuevo/page.tsx</files>
  <action>
Create src/app/(protected)/medias/cierres/nuevo/page.tsx:

```tsx
import { redirect } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { ArrowLeft, AlertTriangle } from 'lucide-react'
import { getMediasCierreSummaryForDate } from '@/lib/queries/medias/cierres'
import { MediasCierreForm } from '@/components/medias/cierres/cierre-form'
import { DatePickerForm } from '@/components/medias/cierres/date-picker-form'

export const metadata = {
  title: 'Nuevo Cierre - Medias | VarixClinic',
  description: 'Crear cierre de caja de medias',
}

interface Props {
  searchParams: Promise<{ fecha?: string }>
}

export default async function NuevoMediasCierrePage({ searchParams }: Props) {
  const params = await searchParams
  const fecha = params.fecha

  // If no date selected, show date picker
  if (!fecha) {
    return (
      <div className="space-y-6">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="sm" asChild>
            <Link href="/medias/cierres">
              <ArrowLeft className="h-4 w-4 mr-2" />
              Volver
            </Link>
          </Button>
          <div>
            <h1 className="text-2xl font-bold tracking-tight">
              Nuevo Cierre de Medias
            </h1>
            <p className="text-muted-foreground">
              Seleccione la fecha para cerrar
            </p>
          </div>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Seleccionar Fecha</CardTitle>
          </CardHeader>
          <CardContent>
            <DatePickerForm basePath="/medias/cierres/nuevo" />
          </CardContent>
        </Card>

        {/* Zero tolerance reminder */}
        <Alert className="border-amber-200 bg-amber-50">
          <AlertTriangle className="h-4 w-4 text-amber-600" />
          <AlertDescription className="text-amber-800">
            <strong>Recuerde:</strong> Cualquier diferencia entre el conteo
            fisico y el total calculado requerira justificacion escrita (minimo
            10 caracteres). La foto del cierre es obligatoria.
          </AlertDescription>
        </Alert>
      </div>
    )
  }

  // Validate date format
  if (!/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
    redirect('/medias/cierres/nuevo')
  }

  // Fetch summary for selected date
  const summary = await getMediasCierreSummaryForDate(fecha)

  if (!summary) {
    return (
      <div className="space-y-6">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="sm" asChild>
            <Link href="/medias/cierres/nuevo">
              <ArrowLeft className="h-4 w-4 mr-2" />
              Cambiar fecha
            </Link>
          </Button>
          <h1 className="text-2xl font-bold tracking-tight">Error</h1>
        </div>
        <Alert variant="destructive">
          <AlertDescription>
            No se pudo cargar el resumen para la fecha seleccionada.
          </AlertDescription>
        </Alert>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="sm" asChild>
          <Link href="/medias/cierres/nuevo">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Cambiar fecha
          </Link>
        </Button>
        <div>
          <h1 className="text-2xl font-bold tracking-tight">
            Cierre de Medias - {fecha}
          </h1>
          <p className="text-muted-foreground">
            Complete el cierre de caja para esta fecha
          </p>
        </div>
      </div>

      <MediasCierreForm fecha={fecha} summary={summary} />
    </div>
  )
}
```

Create src/components/medias/cierres/date-picker-form.tsx:

```tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Calendar } from '@/components/ui/calendar'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'

interface DatePickerFormProps {
  basePath: string
}

export function DatePickerForm({ basePath }: DatePickerFormProps) {
  const router = useRouter()
  const [date, setDate] = useState<Date | undefined>(undefined)

  const handleContinue = () => {
    if (date) {
      const fechaStr = format(date, 'yyyy-MM-dd')
      router.push(`${basePath}?fecha=${fechaStr}`)
    }
  }

  // Disable future dates
  const disabledDays = { after: new Date() }

  return (
    <div className="space-y-4">
      <Calendar
        mode="single"
        selected={date}
        onSelect={setDate}
        disabled={disabledDays}
        locale={es}
        className="rounded-md border"
      />

      {date && (
        <div className="flex items-center justify-between">
          <p className="text-sm">
            Fecha seleccionada:{' '}
            <strong>{format(date, 'dd MMMM yyyy', { locale: es })}</strong>
          </p>
          <Button onClick={handleContinue}>Continuar</Button>
        </div>
      )}
    </div>
  )
}
```

Key points:
- Two-step flow: select date, then show form
- Disables future dates in calendar
- Shows zero-tolerance reminder before starting
  </action>
  <verify>Page shows date picker first, then form with summary after date selection</verify>
  <done>NuevoMediasCierrePage provides date selection and form workflow</done>
</task>

<task type="auto">
  <name>Task 3: Create medias cierre detail page</name>
  <files>src/app/(protected)/medias/cierres/[id]/page.tsx</files>
  <action>
Create src/app/(protected)/medias/cierres/[id]/page.tsx:

```tsx
import { notFound } from 'next/navigation'
import Link from 'next/link'
import Image from 'next/image'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import {
  ArrowLeft,
  Banknote,
  CreditCard,
  Building2,
  Smartphone,
  AlertTriangle,
} from 'lucide-react'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import {
  getMediasCierreById,
  getMediasSalesForDate,
} from '@/lib/queries/medias/cierres'
import { createClient } from '@/lib/supabase/server'
import { CIERRE_ESTADO_LABELS, CIERRE_ESTADO_VARIANTS } from '@/types'
import { MediasReopenDialog } from '@/components/medias/cierres/reopen-dialog'

export const metadata = {
  title: 'Detalle de Cierre - Medias | VarixClinic',
  description: 'Detalle del cierre de caja de medias',
}

interface Props {
  params: Promise<{ id: string }>
}

const formatCurrency = (amount: number) =>
  new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
  }).format(amount)

export default async function MediasCierreDetailPage({ params }: Props) {
  const { id } = await params
  const cierre = await getMediasCierreById(id)

  if (!cierre) {
    notFound()
  }

  // Fetch sales for this date
  const sales = await getMediasSalesForDate(cierre.fecha_cierre)

  // Check if user is admin
  const supabase = await createClient()
  const {
    data: { user },
  } = await supabase.auth.getUser()

  let isAdmin = false
  if (user) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const { data: roleData } = await (supabase as any)
      .from('user_roles')
      .select('role')
      .eq('user_id', user.id)
      .single()
    isAdmin = roleData?.role === 'admin'
  }

  // Get signed URL for photo
  let photoUrl: string | null = null
  if (cierre.cierre_photo_path) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const { data: signedUrlData } = await (supabase as any).storage
      .from('cierres')
      .createSignedUrl(cierre.cierre_photo_path, 3600)
    photoUrl = signedUrlData?.signedUrl || null
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="sm" asChild>
            <Link href="/medias/cierres">
              <ArrowLeft className="h-4 w-4 mr-2" />
              Volver
            </Link>
          </Button>
          <div>
            <h1 className="text-2xl font-bold tracking-tight">
              Cierre {cierre.cierre_numero}
            </h1>
            <p className="text-muted-foreground">
              {format(new Date(cierre.fecha_cierre), 'EEEE, dd MMMM yyyy', {
                locale: es,
              })}
            </p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <Badge variant={CIERRE_ESTADO_VARIANTS[cierre.estado]}>
            {CIERRE_ESTADO_LABELS[cierre.estado]}
          </Badge>
          {isAdmin && cierre.estado === 'cerrado' && (
            <MediasReopenDialog
              cierreId={cierre.id}
              cierreNumero={cierre.cierre_numero}
            />
          )}
        </div>
      </div>

      {/* Totals */}
      <Card>
        <CardHeader>
          <CardTitle>Resumen de Ventas</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="flex items-center gap-2">
              <Banknote className="h-4 w-4 text-green-600" />
              <div>
                <p className="text-xs text-muted-foreground">Efectivo</p>
                <p className="font-medium">
                  {formatCurrency(cierre.total_efectivo)}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <CreditCard className="h-4 w-4 text-blue-600" />
              <div>
                <p className="text-xs text-muted-foreground">Tarjeta</p>
                <p className="font-medium">
                  {formatCurrency(cierre.total_tarjeta)}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Building2 className="h-4 w-4 text-purple-600" />
              <div>
                <p className="text-xs text-muted-foreground">Transferencia</p>
                <p className="font-medium">
                  {formatCurrency(cierre.total_transferencia)}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Smartphone className="h-4 w-4 text-teal-600" />
              <div>
                <p className="text-xs text-muted-foreground">Nequi</p>
                <p className="font-medium">
                  {formatCurrency(cierre.total_nequi)}
                </p>
              </div>
            </div>
          </div>

          <Separator />

          <div className="flex justify-between items-center">
            <span className="font-medium">Total del Dia</span>
            <span className="text-xl font-bold">
              {formatCurrency(cierre.grand_total)}
            </span>
          </div>
        </CardContent>
      </Card>

      {/* Cash reconciliation */}
      <Card>
        <CardHeader>
          <CardTitle>Reconciliacion de Efectivo</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-3 gap-4">
            <div>
              <p className="text-xs text-muted-foreground">Efectivo Esperado</p>
              <p className="font-medium">
                {formatCurrency(cierre.total_efectivo)}
              </p>
            </div>
            <div>
              <p className="text-xs text-muted-foreground">Conteo Fisico</p>
              <p className="font-medium">
                {formatCurrency(cierre.conteo_fisico_efectivo)}
              </p>
            </div>
            <div>
              <p className="text-xs text-muted-foreground">Diferencia</p>
              <p
                className={`font-medium ${
                  cierre.diferencia !== 0 ? 'text-red-600' : 'text-green-600'
                }`}
              >
                {formatCurrency(cierre.diferencia)}
              </p>
            </div>
          </div>

          {cierre.diferencia !== 0 && cierre.diferencia_justificacion && (
            <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
              <div className="flex items-start gap-2">
                <AlertTriangle className="h-4 w-4 text-red-600 mt-0.5" />
                <div>
                  <p className="text-sm font-medium text-red-700">
                    Justificacion de Diferencia
                  </p>
                  <p className="text-sm text-red-600 mt-1">
                    {cierre.diferencia_justificacion}
                  </p>
                </div>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Photo */}
      {photoUrl && (
        <Card>
          <CardHeader>
            <CardTitle>Foto del Cierre</CardTitle>
          </CardHeader>
          <CardContent>
            <Image
              src={photoUrl}
              alt="Foto del cierre"
              width={400}
              height={300}
              className="rounded-lg border"
            />
          </CardContent>
        </Card>
      )}

      {/* Reopen info */}
      {cierre.estado === 'reabierto' && (
        <Card className="border-amber-200 bg-amber-50">
          <CardHeader>
            <CardTitle className="text-amber-800">Cierre Reabierto</CardTitle>
          </CardHeader>
          <CardContent className="space-y-2">
            <p className="text-sm text-amber-700">
              <strong>Reabierto:</strong>{' '}
              {cierre.reopened_at
                ? format(new Date(cierre.reopened_at), 'dd/MM/yyyy HH:mm', {
                    locale: es,
                  })
                : 'N/A'}
            </p>
            <p className="text-sm text-amber-700">
              <strong>Justificacion:</strong> {cierre.reopen_justificacion}
            </p>
          </CardContent>
        </Card>
      )}

      {/* Notes */}
      {cierre.notas && (
        <Card>
          <CardHeader>
            <CardTitle>Notas</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground">{cierre.notas}</p>
          </CardContent>
        </Card>
      )}

      {/* Sales list */}
      <Card>
        <CardHeader>
          <CardTitle>Ventas del Dia ({sales.length})</CardTitle>
        </CardHeader>
        <CardContent>
          {sales.length === 0 ? (
            <p className="text-center text-muted-foreground py-4">
              No hay ventas registradas para esta fecha
            </p>
          ) : (
            <div className="space-y-2">
              {sales.map((sale: {
                id: string
                numero_venta: string
                total: number
                estado: string
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                patients?: any
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                medias_sale_methods?: any[]
              }) => (
                <div
                  key={sale.id}
                  className="flex justify-between items-center p-2 border rounded"
                >
                  <div>
                    <span className="font-mono text-sm">
                      {sale.numero_venta}
                    </span>
                    {sale.patients && (
                      <span className="text-sm text-muted-foreground ml-2">
                        - {sale.patients.nombre} {sale.patients.apellido}
                      </span>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <span
                      className={`font-medium ${
                        sale.estado === 'anulado'
                          ? 'text-red-500 line-through'
                          : ''
                      }`}
                    >
                      {formatCurrency(sale.total)}
                    </span>
                    {sale.estado === 'anulado' && (
                      <Badge variant="destructive" className="text-xs">
                        Anulada
                      </Badge>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

Key points:
- Shows complete cierre details with photo
- Displays sales list for the date
- Admin can reopen from detail page
- Shows reopen justification if estado='reabierto'
  </action>
  <verify>Page shows cierre details, photo, sales list, and reopen option for admin</verify>
  <done>MediasCierreDetailPage displays full cierre information with admin reopen</done>
</task>

</tasks>

<verification>
1. List page exists at src/app/(protected)/medias/cierres/page.tsx
2. New cierre page exists at src/app/(protected)/medias/cierres/nuevo/page.tsx
3. Detail page exists at src/app/(protected)/medias/cierres/[id]/page.tsx
4. Date picker form created at src/components/medias/cierres/date-picker-form.tsx
5. All pages use /medias/cierres routes (not /cierres)
6. Admin can reopen from both list and detail pages
7. Zero-tolerance messaging appears in appropriate places
</verification>

<success_criteria>
- User can navigate to /medias/cierres and see list of closings
- User can click "Nuevo Cierre" and select a date
- Form loads with summary after date selection
- User can view cierre detail at /medias/cierres/[id]
- Detail page shows photo, totals, sales breakdown
- Admin sees reopen button on closed cierres
- All navigation stays within /medias/ path structure
</success_criteria>

<output>
After completion, create `.planning/phases/12-cash-closing-medias/12-06-SUMMARY.md`
</output>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete medias cash closing feature with zero-tolerance policy</what-built>
  <how-to-verify>
    1. Navigate to /medias/cierres - should see list page with "Nuevo Cierre" button
    2. Click "Nuevo Cierre" - should see date picker
    3. Select today's date - should load form with summary
    4. Enter physical count different from expected - should see "TOLERANCIA CERO" warning
    5. Try to submit without justification - should be blocked
    6. Try to submit without photo - should be blocked
    7. Complete valid cierre - should redirect to list with new CIM-000001 entry
    8. View cierre detail - should show photo, totals, sales breakdown
    9. As admin, click reopen - should require 10+ char justification
    10. After reopen, try creating sale for that date - should succeed (lockdown lifted)
    11. Create another sale, close again - verify sales blocked for closed date
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</checkpoint>
