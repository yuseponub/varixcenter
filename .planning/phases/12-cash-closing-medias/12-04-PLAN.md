---
phase: 12-cash-closing-medias
plan: 04
type: execute
wave: 3
depends_on: ["12-02", "12-03"]
files_modified:
  - src/lib/queries/medias/cierres.ts
  - src/app/(protected)/medias/cierres/actions.ts
autonomous: true

must_haves:
  truths:
    - "Query functions call medias-specific RPCs and tables"
    - "Server actions wrap RPC calls with error handling"
    - "Actions use Zod validation before calling RPC"
  artifacts:
    - path: "src/lib/queries/medias/cierres.ts"
      provides: "Query functions for medias cierres"
      exports: ["getMediasCierreSummary", "getMediasCierres", "getMediasCierreById"]
    - path: "src/app/(protected)/medias/cierres/actions.ts"
      provides: "Server actions for cierre operations"
      exports: ["createMediasCierre", "reopenMediasCierre"]
  key_links:
    - from: "src/lib/queries/medias/cierres.ts"
      to: "get_medias_cierre_summary RPC"
      via: "supabase.rpc call"
      pattern: "rpc\\('get_medias_cierre_summary'"
    - from: "src/app/(protected)/medias/cierres/actions.ts"
      to: "create_medias_cierre RPC"
      via: "supabase.rpc call"
      pattern: "rpc\\('create_medias_cierre'"
---

<objective>
Create query functions and server actions for medias cash closing operations.

Purpose: Provides data fetching and mutation layer between UI and database RPCs, with proper error handling and type safety.

Output: src/lib/queries/medias/cierres.ts and src/app/(protected)/medias/cierres/actions.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-cash-closing-medias/12-RESEARCH.md
@src/lib/queries/cash-closings.ts (pattern to adapt)
@src/app/(protected)/cierres/actions.ts (pattern to adapt if exists)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medias cierre query functions</name>
  <files>src/lib/queries/medias/cierres.ts</files>
  <action>
Create src/lib/queries/medias/cierres.ts (adapt from src/lib/queries/cash-closings.ts):

```typescript
import { createClient } from '@/lib/supabase/server'
import type { MediasCierre, MediasCierreSummary } from '@/types'

// Note: medias_cierres table and RPC types not yet in generated types
// Using type assertions until migrations are applied and types regenerated

/**
 * Get closing summary for a date (preview before closing)
 * Calls the get_medias_cierre_summary RPC
 */
export async function getMediasCierreSummaryForDate(
  fecha: string
): Promise<MediasCierreSummary | null> {
  const supabase = await createClient()

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const { data, error } = await (supabase as any).rpc('get_medias_cierre_summary', {
    p_fecha: fecha,
  })

  if (error) {
    console.error('Error fetching medias cierre summary:', error)
    return null
  }

  return data as MediasCierreSummary
}

/**
 * Get paginated list of medias cash closings
 * Most recent first
 */
export async function getMediasCierres(
  options: {
    page?: number
    limit?: number
    estado?: 'cerrado' | 'reabierto'
  } = {}
): Promise<{ closings: MediasCierre[]; total: number }> {
  const { page = 1, limit = 20, estado } = options
  const offset = (page - 1) * limit

  const supabase = await createClient()

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  let query = (supabase as any)
    .from('medias_cierres')
    .select('*', { count: 'exact' })
    .order('fecha_cierre', { ascending: false })
    .range(offset, offset + limit - 1)

  if (estado) {
    query = query.eq('estado', estado)
  }

  const { data, error, count } = await query

  if (error) {
    console.error('Error fetching medias cierres:', error)
    return { closings: [], total: 0 }
  }

  return {
    closings: (data as MediasCierre[]) || [],
    total: count || 0,
  }
}

/**
 * Get single medias cash closing by ID
 */
export async function getMediasCierreById(
  id: string
): Promise<MediasCierre | null> {
  const supabase = await createClient()

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const { data, error } = await (supabase as any)
    .from('medias_cierres')
    .select('*')
    .eq('id', id)
    .single()

  if (error) {
    console.error('Error fetching medias cierre:', error)
    return null
  }

  return data as MediasCierre
}

/**
 * Get medias cash closing by date
 */
export async function getMediasCierreByDate(
  fecha: string
): Promise<MediasCierre | null> {
  const supabase = await createClient()

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const { data, error } = await (supabase as any)
    .from('medias_cierres')
    .select('*')
    .eq('fecha_cierre', fecha)
    .single()

  if (error) {
    if (error.code !== 'PGRST116') {
      // Not found is OK
      console.error('Error fetching medias cierre by date:', error)
    }
    return null
  }

  return data as MediasCierre
}

/**
 * Check if a specific date is closed for medias
 */
export async function isMediasDateClosed(fecha: string): Promise<boolean> {
  const supabase = await createClient()

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const { data, error } = await (supabase as any)
    .from('medias_cierres')
    .select('id, estado')
    .eq('fecha_cierre', fecha)
    .eq('estado', 'cerrado')
    .single()

  if (error) {
    return false
  }

  return data !== null
}

/**
 * Get sales for a specific date (for closing detail view)
 */
export async function getMediasSalesForDate(fecha: string) {
  const supabase = await createClient()

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const { data, error } = await (supabase as any)
    .from('medias_sales')
    .select(`
      id,
      numero_venta,
      total,
      estado,
      created_at,
      patients(id, nombre, apellido, cedula),
      medias_sale_methods(metodo, monto)
    `)
    .gte('created_at', `${fecha}T00:00:00`)
    .lt('created_at', `${fecha}T23:59:59.999`)
    .order('created_at', { ascending: true })

  if (error) {
    console.error('Error fetching medias sales for date:', error)
    return []
  }

  return data || []
}
```

CRITICAL:
- All queries use medias_cierres table (not cash_closings)
- RPC calls use medias-specific function names (get_medias_cierre_summary)
- Type assertions until migrations applied
  </action>
  <verify>File created, exports all query functions, uses medias-specific tables/RPCs</verify>
  <done>Query functions for medias cierres connect to medias_cierres table and RPCs</done>
</task>

<task type="auto">
  <name>Task 2: Create medias cierre server actions</name>
  <files>src/app/(protected)/medias/cierres/actions.ts</files>
  <action>
Create src/app/(protected)/medias/cierres/actions.ts:

```typescript
'use server'

import { revalidatePath } from 'next/cache'
import { createClient } from '@/lib/supabase/server'
import {
  mediasCierreSchema,
  reopenMediasCierreSchema,
} from '@/lib/validations/medias/cierre'
import type { CreateMediasCierreResult, ReopenMediasCierreResult } from '@/types'

/**
 * Action state type for form handling
 */
export interface MediasCierreActionState {
  success: boolean
  error?: string
  errors?: Record<string, string[]>
  data?: CreateMediasCierreResult | ReopenMediasCierreResult
}

/**
 * Create a medias cash closing
 * Calls create_medias_cierre RPC
 *
 * CIE-04: Zero tolerance enforced by RPC
 * CIE-06: Sequential numbering (CIM-) handled by RPC
 */
export async function createMediasCierre(
  _prevState: MediasCierreActionState | null,
  formData: FormData
): Promise<MediasCierreActionState> {
  // Parse form data
  const rawData = {
    fecha: formData.get('fecha') as string,
    conteo_fisico: parseFloat(formData.get('conteo_fisico') as string) || 0,
    diferencia_justificacion: formData.get('diferencia_justificacion') as string || null,
    cierre_photo_path: formData.get('cierre_photo_path') as string,
    notas: formData.get('notas') as string || null,
  }

  // Validate with Zod
  const validated = mediasCierreSchema.safeParse(rawData)
  if (!validated.success) {
    return {
      success: false,
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
    }
  }

  const supabase = await createClient()

  // Call create RPC
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const { data, error } = await (supabase as any).rpc('create_medias_cierre', {
    p_fecha: validated.data.fecha,
    p_conteo_fisico: validated.data.conteo_fisico,
    p_diferencia_justificacion: validated.data.diferencia_justificacion || '',
    p_cierre_photo_path: validated.data.cierre_photo_path,
    p_notas: validated.data.notas || null,
  })

  if (error) {
    console.error('Error creating medias cierre:', error)
    return {
      success: false,
      error: error.message || 'Error al crear el cierre de medias',
    }
  }

  // Revalidate cache
  revalidatePath('/medias/cierres')
  revalidatePath('/medias/ventas') // Sales page may show closed status

  return {
    success: true,
    data: data as CreateMediasCierreResult,
  }
}

/**
 * Reopen a medias cash closing
 * Calls reopen_medias_cierre RPC
 *
 * CIE-07: Admin only, requires justification (enforced by RPC)
 */
export async function reopenMediasCierre(
  _prevState: MediasCierreActionState | null,
  formData: FormData
): Promise<MediasCierreActionState> {
  // Parse form data
  const rawData = {
    cierre_id: formData.get('cierre_id') as string,
    justificacion: formData.get('justificacion') as string,
  }

  // Validate with Zod
  const validated = reopenMediasCierreSchema.safeParse(rawData)
  if (!validated.success) {
    return {
      success: false,
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
    }
  }

  const supabase = await createClient()

  // Call reopen RPC
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const { data, error } = await (supabase as any).rpc('reopen_medias_cierre', {
    p_cierre_id: validated.data.cierre_id,
    p_justificacion: validated.data.justificacion,
  })

  if (error) {
    console.error('Error reopening medias cierre:', error)
    return {
      success: false,
      error: error.message || 'Error al reabrir el cierre de medias',
    }
  }

  // Revalidate cache
  revalidatePath('/medias/cierres')
  revalidatePath('/medias/ventas')

  return {
    success: true,
    data: data as ReopenMediasCierreResult,
  }
}
```

CRITICAL:
- Server actions use 'use server' directive
- Call medias-specific RPCs (create_medias_cierre, reopen_medias_cierre)
- Revalidate medias paths (not clinic paths)
- Zod validation before RPC call
  </action>
  <verify>File created with 'use server' directive, exports createMediasCierre and reopenMediasCierre</verify>
  <done>Server actions call medias-specific RPCs with Zod validation and path revalidation</done>
</task>

</tasks>

<verification>
1. Query file exists at src/lib/queries/medias/cierres.ts
2. Actions file exists at src/app/(protected)/medias/cierres/actions.ts
3. All functions use medias_cierres table and medias RPCs
4. Server actions have 'use server' directive
5. Actions revalidate /medias/* paths (not /cierres)
6. Type assertions used for untyped Supabase client
</verification>

<success_criteria>
- Query functions fetch from medias_cierres table
- Query functions call get_medias_cierre_summary RPC
- Server actions call create_medias_cierre and reopen_medias_cierre RPCs
- Zod validation happens before RPC calls
- Cache revalidation targets /medias/cierres and /medias/ventas
- All functions are medias-independent (no clinic table references)
</success_criteria>

<output>
After completion, create `.planning/phases/12-cash-closing-medias/12-04-SUMMARY.md`
</output>
