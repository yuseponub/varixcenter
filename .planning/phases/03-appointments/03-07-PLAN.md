---
phase: 03-appointments
plan: 07
type: execute
wave: 4
depends_on: ["03-02", "03-04"]
files_modified:
  - src/components/ui/textarea.tsx
  - src/components/appointments/appointment-form.tsx
  - src/app/(protected)/citas/nueva/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can create appointment linked to existing patient"
    - "Form validates patient selection, doctor, and time range"
    - "Form prefills times from URL params (calendar selection)"
  artifacts:
    - path: "src/components/ui/textarea.tsx"
      provides: "Textarea shadcn component"
      contains: "Textarea"
    - path: "src/components/appointments/appointment-form.tsx"
      provides: "Appointment creation form"
      contains: "react-hook-form"
    - path: "src/app/(protected)/citas/nueva/page.tsx"
      provides: "New appointment page"
      contains: "AppointmentForm"
  key_links:
    - from: "src/components/appointments/appointment-form.tsx"
      to: "createAppointment"
      via: "server action"
      pattern: "useActionState.*createAppointment"
    - from: "src/app/(protected)/citas/nueva/page.tsx"
      to: "searchPatients"
      via: "patient query"
      pattern: "searchPatients"
---

<objective>
Create the appointment form component and new appointment page.

Purpose: Complete the appointment creation flow (Success Criteria #4: "Usuario puede crear cita vinculada a paciente existente").
Output: Working form with patient search, doctor selection, datetime inputs, and validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-appointments/03-RESEARCH.md
@src/components/patients/patient-form.tsx
@src/lib/validations/appointment.ts
@src/app/(protected)/citas/actions.ts
@src/lib/queries/patients.ts
@src/lib/queries/appointments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Textarea component and create form</name>
  <files>src/components/ui/textarea.tsx, src/components/appointments/appointment-form.tsx</files>
  <action>
First, install the shadcn/ui Textarea component:

```bash
npx shadcn@latest add textarea
```

This creates `src/components/ui/textarea.tsx`.

Then create `src/components/appointments/appointment-form.tsx` following the pattern from patient-form.tsx:

```typescript
'use client'

import { useActionState, useEffect } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { useRouter } from 'next/navigation'
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { appointmentSchema, AppointmentFormData } from '@/lib/validations/appointment'
import { createAppointment } from '@/app/(protected)/citas/actions'
import { Doctor } from '@/types/appointments'
import { Loader2 } from 'lucide-react'

interface Patient {
  id: string
  cedula: string
  nombre: string
  apellido: string
}

interface AppointmentFormProps {
  doctors: Doctor[]
  patients: Patient[]
  defaultValues?: Partial<{
    patient_id: string
    doctor_id: string
    fecha_hora_inicio: string
    fecha_hora_fin: string
  }>
}

/**
 * Appointment creation form
 *
 * Features:
 * - Patient selection from dropdown (linked to existing patients)
 * - Doctor selection (APT-02 doctors)
 * - DateTime inputs for start/end
 * - Optional notes and consultation reason
 * - Zod validation with Spanish messages
 */
export function AppointmentForm({
  doctors,
  patients,
  defaultValues
}: AppointmentFormProps) {
  const router = useRouter()

  // Format datetime for input (datetime-local format: YYYY-MM-DDTHH:mm)
  const formatForInput = (isoString: string | undefined): string => {
    if (!isoString) return ''
    try {
      const date = new Date(isoString)
      // Format as YYYY-MM-DDTHH:mm for datetime-local input
      return date.toISOString().slice(0, 16)
    } catch {
      return ''
    }
  }

  const form = useForm<AppointmentFormData>({
    resolver: zodResolver(appointmentSchema),
    defaultValues: {
      patient_id: defaultValues?.patient_id || '',
      doctor_id: defaultValues?.doctor_id || '',
      fecha_hora_inicio: formatForInput(defaultValues?.fecha_hora_inicio),
      fecha_hora_fin: formatForInput(defaultValues?.fecha_hora_fin),
      notas: null,
      motivo_consulta: null
    }
  })

  const [state, formAction, isPending] = useActionState(createAppointment, {
    success: false,
    message: ''
  })

  // Redirect on success
  useEffect(() => {
    if (state.success) {
      router.push('/citas')
      router.refresh()
    }
  }, [state.success, router])

  // Set form errors from server response
  useEffect(() => {
    if (state.errors) {
      Object.entries(state.errors).forEach(([field, messages]) => {
        if (messages && messages[0]) {
          form.setError(field as keyof AppointmentFormData, {
            type: 'server',
            message: messages[0]
          })
        }
      })
    }
  }, [state.errors, form])

  return (
    <Form {...form}>
      <form action={formAction} className="space-y-6">
        {/* General error message */}
        {state.message && !state.success && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
            {state.message}
          </div>
        )}

        {/* Patient selection */}
        <FormField
          control={form.control}
          name="patient_id"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Paciente *</FormLabel>
              <Select
                onValueChange={field.onChange}
                defaultValue={field.value}
                name="patient_id"
              >
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="Seleccionar paciente" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  {patients.map((patient) => (
                    <SelectItem key={patient.id} value={patient.id}>
                      {patient.nombre} {patient.apellido} (CC: {patient.cedula})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <FormDescription>
                Seleccione el paciente para esta cita
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />

        {/* Doctor selection */}
        <FormField
          control={form.control}
          name="doctor_id"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Medico *</FormLabel>
              <Select
                onValueChange={field.onChange}
                defaultValue={field.value}
                name="doctor_id"
              >
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="Seleccionar medico" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  {doctors.map((doctor) => (
                    <SelectItem key={doctor.id} value={doctor.id}>
                      {doctor.nombre}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <FormDescription>
                Seleccione el medico que atendera la cita
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />

        {/* Date/Time inputs */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <FormField
            control={form.control}
            name="fecha_hora_inicio"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Fecha y hora de inicio *</FormLabel>
                <FormControl>
                  <Input
                    type="datetime-local"
                    {...field}
                    value={field.value || ''}
                  />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="fecha_hora_fin"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Fecha y hora de fin *</FormLabel>
                <FormControl>
                  <Input
                    type="datetime-local"
                    {...field}
                    value={field.value || ''}
                  />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        {/* Consultation reason */}
        <FormField
          control={form.control}
          name="motivo_consulta"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Motivo de consulta</FormLabel>
              <FormControl>
                <Input
                  placeholder="Ej: Control varices, evaluacion inicial..."
                  {...field}
                  value={field.value || ''}
                  name="motivo_consulta"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        {/* Notes */}
        <FormField
          control={form.control}
          name="notas"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Notas adicionales</FormLabel>
              <FormControl>
                <Textarea
                  placeholder="Informacion adicional para la cita..."
                  rows={3}
                  {...field}
                  value={field.value || ''}
                  name="notas"
                />
              </FormControl>
              <FormDescription>
                Maximo 500 caracteres
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />

        {/* Submit button */}
        <div className="flex justify-end gap-4">
          <Button
            type="button"
            variant="outline"
            onClick={() => router.back()}
            disabled={isPending}
          >
            Cancelar
          </Button>
          <Button type="submit" disabled={isPending}>
            {isPending ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Guardando...
              </>
            ) : (
              'Crear Cita'
            )}
          </Button>
        </div>
      </form>
    </Form>
  )
}
```
  </action>
  <verify>
- `src/components/ui/textarea.tsx` exists (from shadcn)
- File exists at `src/components/appointments/appointment-form.tsx`
- Form uses react-hook-form with zodResolver
- Imports Textarea from '@/components/ui/textarea'
- `npm run build` passes
  </verify>
  <done>
- Textarea component installed via shadcn
- AppointmentForm with patient dropdown, doctor dropdown, datetime inputs
- Zod validation with Spanish error messages
- Success redirects to /citas
- Loading state shows "Guardando..."
- Prefill support from URL params
  </done>
</task>

<task type="auto">
  <name>Task 2: Create new appointment page</name>
  <files>src/app/(protected)/citas/nueva/page.tsx</files>
  <action>
Create directory and file `src/app/(protected)/citas/nueva/page.tsx`:

**IMPORTANT:** The searchPatients function signature is `(query: string, limit = 50)` (see src/lib/queries/patients.ts).
Do NOT use object parameter `{ q, page, limit }` - that would be incorrect.

```typescript
import { AppointmentForm } from '@/components/appointments/appointment-form'
import { getDoctors } from '@/lib/queries/appointments'
import { searchPatients } from '@/lib/queries/patients'
import Link from 'next/link'
import { ChevronLeft } from 'lucide-react'

interface NuevaCitaPageProps {
  searchParams: Promise<{
    start?: string
    end?: string
    doctor?: string
    patient?: string
  }>
}

export const metadata = {
  title: 'Nueva Cita | VarixClinic',
  description: 'Crear nueva cita'
}

/**
 * New appointment page
 *
 * Fetches doctors and patients, prefills form from URL params
 * (calendar selection passes start/end times)
 */
export default async function NuevaCitaPage({ searchParams }: NuevaCitaPageProps) {
  const params = await searchParams

  // Fetch doctors for selection
  const doctors = await getDoctors()

  // Fetch patients for selection
  // searchPatients signature is (query: string, limit = 50)
  // Empty query returns recent patients sorted by created_at desc
  const patients = await searchPatients('', 100)

  // Transform patients for form
  const patientOptions = patients.map(p => ({
    id: p.id,
    cedula: p.cedula,
    nombre: p.nombre,
    apellido: p.apellido
  }))

  // Build default values from URL params
  const defaultValues = {
    fecha_hora_inicio: params.start,
    fecha_hora_fin: params.end,
    doctor_id: params.doctor,
    patient_id: params.patient
  }

  return (
    <div className="space-y-6">
      {/* Header with back link */}
      <div className="flex items-center gap-4">
        <Link
          href="/citas"
          className="text-gray-500 hover:text-gray-700"
        >
          <ChevronLeft className="h-5 w-5" />
        </Link>
        <div>
          <h1 className="text-2xl font-bold">Nueva Cita</h1>
          <p className="text-gray-500">Agendar una nueva cita con paciente existente</p>
        </div>
      </div>

      {/* Doctor availability warning */}
      {doctors.length === 0 && (
        <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded">
          No hay medicos disponibles. Asegurese de que existan usuarios con rol "medico".
        </div>
      )}

      {/* Patient availability warning */}
      {patientOptions.length === 0 && (
        <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded">
          No hay pacientes registrados.{' '}
          <Link href="/pacientes/nuevo" className="underline font-medium">
            Registrar paciente primero
          </Link>
        </div>
      )}

      {/* Form */}
      <div className="bg-white rounded-lg border p-6 max-w-2xl">
        <AppointmentForm
          doctors={doctors}
          patients={patientOptions}
          defaultValues={defaultValues}
        />
      </div>
    </div>
  )
}
```
  </action>
  <verify>
- File exists at `src/app/(protected)/citas/nueva/page.tsx`
- Route /citas/nueva renders the form
- Uses searchPatients('', 100) NOT searchPatients({ q, page, limit })
- `npm run build` passes
  </verify>
  <done>
- New appointment page at /citas/nueva
- Prefills datetime from URL params (from calendar selection)
- Shows patient dropdown with existing patients
- Shows doctor dropdown with medicos
- Back link to /citas
- Warnings if no doctors or patients available
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete appointment scheduling system:
1. Calendar with day/week views (APT-01)
2. Doctor filter dropdown (APT-02)
3. Status transitions via dialog with success feedback (APT-03)
4. Appointment creation linked to patients
5. Drag-and-drop rescheduling
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/citas
3. Verify calendar displays:
   - Week view by default
   - Day/Week toggle buttons work
   - Spanish locale (dias de la semana en espanol)
   - Business hours 8am-6pm visible
4. Test doctor filter:
   - Dropdown shows "Todos los medicos" and available doctors
   - Filtering changes displayed appointments (if any exist)
5. Test new appointment:
   - Click "Nueva Cita" button
   - Form shows patient dropdown, doctor dropdown, datetime pickers
   - Notes field is a multiline textarea
   - Submit creates appointment (check database)
   - Returns to calendar showing new event
6. Test appointment dialog:
   - Click on an appointment event
   - Dialog shows patient info, time, status
   - Status transition buttons appear based on current state
   - Click a transition button to change status
   - **SUCCESS TOAST should appear confirming status change**
7. Test drag-and-drop:
   - Drag an appointment to a new time slot
   - Verify time updates (or shows error toast if overlap)
   - **SUCCESS TOAST should appear confirming reschedule**

Expected behavior:
- All UI in Spanish
- Status colors: blue=programada, green=confirmada, yellow=en_sala, purple=en_atencion, gray=completada
- Toast notifications for success/error feedback
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. /citas route renders calendar
3. /citas/nueva renders form
4. Form validates and creates appointments
5. Calendar shows new appointments
6. Status updates show success toast
</verification>

<success_criteria>
- APT-01: Day and week views work
- APT-02: Doctor filter filters events
- APT-03: Status transitions work through dialog with success feedback
- Success Criteria #4: User can create appointment linked to patient
- Form prefills from URL params (calendar time selection)
- Spanish UI throughout
- Textarea component installed and working
</success_criteria>

<output>
After completion, create `.planning/phases/03-appointments/03-07-SUMMARY.md`
</output>
