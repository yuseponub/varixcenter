---
phase: 10-medias-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/020_medias_foundation.sql
autonomous: true

must_haves:
  truths:
    - "medias_products table exists with dual stock columns"
    - "medias_stock_movements table exists and is immutable"
    - "11 pre-loaded products exist with correct prices"
    - "RLS policies allow authenticated users to view, admin to manage"
  artifacts:
    - path: "supabase/migrations/020_medias_foundation.sql"
      provides: "Products catalog and stock movements schema"
      contains: "medias_products"
  key_links:
    - from: "medias_stock_movements"
      to: "medias_products"
      via: "FOREIGN KEY product_id"
      pattern: "REFERENCES.*medias_products"
---

<objective>
Create database schema for medias products catalog and stock movements

Purpose: Establish foundation tables for inventory tracking with immutability patterns
Output: Migration file with medias_products, medias_stock_movements, RLS, triggers, and seed data
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-medias-foundation/10-RESEARCH.md

# Pattern references
@supabase/migrations/008_services_catalog.sql
@supabase/migrations/010_payments_immutability.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medias_products table with dual stock columns</name>
  <files>supabase/migrations/020_medias_foundation.sql</files>
  <action>
Create migration file with:

1. ENUM type for product types:
```sql
CREATE TYPE public.medias_tipo AS ENUM ('Muslo', 'Panty', 'Rodilla');
CREATE TYPE public.medias_talla AS ENUM ('M', 'L', 'XL', 'XXL');
```

2. medias_products table:
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- tipo medias_tipo NOT NULL
- talla medias_talla NOT NULL
- codigo VARCHAR(20) NOT NULL UNIQUE
- precio DECIMAL(12,2) NOT NULL
- stock_normal INTEGER NOT NULL DEFAULT 0
- stock_devoluciones INTEGER NOT NULL DEFAULT 0
- activo BOOLEAN NOT NULL DEFAULT true
- created_at, updated_at TIMESTAMPTZ

3. CHECK constraints:
- stock_normal >= 0
- stock_devoluciones >= 0
- precio > 0
- UNIQUE(tipo, talla) -- Only one product per type/size combination

4. Indexes:
- idx_medias_products_activo (WHERE activo = true)
- idx_medias_products_tipo_talla

5. updated_at trigger (use existing update_updated_at function)

Follow pattern from 008_services_catalog.sql for structure.
  </action>
  <verify>Migration file contains CREATE TABLE medias_products with stock_normal and stock_devoluciones columns</verify>
  <done>medias_products table defined with dual stock columns and constraints</done>
</task>

<task type="auto">
  <name>Task 2: Create medias_stock_movements table with immutability</name>
  <files>supabase/migrations/020_medias_foundation.sql</files>
  <action>
Add to migration file:

1. ENUM type for movement types:
```sql
CREATE TYPE public.medias_movement_type AS ENUM (
  'compra',
  'venta',
  'devolucion',
  'ajuste_entrada',
  'ajuste_salida',
  'transferencia'
);
```

2. medias_stock_movements table:
- id UUID PRIMARY KEY DEFAULT gen_random_uuid()
- product_id UUID NOT NULL REFERENCES medias_products(id)
- tipo medias_movement_type NOT NULL
- cantidad INTEGER NOT NULL CHECK (cantidad > 0)
- stock_normal_antes INTEGER NOT NULL
- stock_normal_despues INTEGER NOT NULL
- stock_devoluciones_antes INTEGER NOT NULL
- stock_devoluciones_despues INTEGER NOT NULL
- referencia_id UUID (nullable - sale_id, purchase_id, etc)
- referencia_tipo VARCHAR(50) (nullable - 'venta', 'compra', etc)
- notas TEXT (nullable - for adjustments justification)
- created_by UUID NOT NULL REFERENCES auth.users(id)
- created_at TIMESTAMPTZ NOT NULL DEFAULT now()
- NO updated_at (immutable)

3. Immutability trigger function:
```sql
CREATE OR REPLACE FUNCTION public.enforce_stock_movement_immutability()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'DELETE' THEN
    RAISE EXCEPTION 'Los movimientos de stock no pueden ser eliminados';
  END IF;
  IF TG_OP = 'UPDATE' THEN
    RAISE EXCEPTION 'Los movimientos de stock son inmutables';
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

4. Trigger on medias_stock_movements:
```sql
CREATE TRIGGER tr_stock_movement_immutability
  BEFORE UPDATE OR DELETE ON public.medias_stock_movements
  FOR EACH ROW
  EXECUTE FUNCTION public.enforce_stock_movement_immutability();
```

5. Index on product_id for efficient stock history queries

Follow pattern from 010_payments_immutability.sql for immutability enforcement.
  </action>
  <verify>Migration file contains enforce_stock_movement_immutability function and trigger</verify>
  <done>medias_stock_movements table is immutable with before/after snapshots</done>
</task>

<task type="auto">
  <name>Task 3: Add RLS policies, audit, and seed data</name>
  <files>supabase/migrations/020_medias_foundation.sql</files>
  <action>
Add to migration file:

1. RLS for medias_products:
```sql
ALTER TABLE public.medias_products ENABLE ROW LEVEL SECURITY;

-- All authenticated can view
CREATE POLICY "Authenticated users can view medias products"
  ON public.medias_products FOR SELECT
  TO authenticated
  USING (true);

-- Only admin can insert/update/delete
CREATE POLICY "Admin can manage medias products"
  ON public.medias_products FOR ALL
  TO authenticated
  USING (
    EXISTS (SELECT 1 FROM public.user_roles WHERE user_id = auth.uid() AND role = 'admin')
  )
  WITH CHECK (
    EXISTS (SELECT 1 FROM public.user_roles WHERE user_id = auth.uid() AND role = 'admin')
  );
```

2. RLS for medias_stock_movements:
```sql
ALTER TABLE public.medias_stock_movements ENABLE ROW LEVEL SECURITY;

-- All authenticated can view movements
CREATE POLICY "Authenticated users can view stock movements"
  ON public.medias_stock_movements FOR SELECT
  TO authenticated
  USING (true);

-- INSERT allowed for authenticated (specific operations validate role)
CREATE POLICY "Authenticated users can insert stock movements"
  ON public.medias_stock_movements FOR INSERT
  TO authenticated
  WITH CHECK (created_by = auth.uid());
```

3. Enable audit logging:
```sql
SELECT enable_audit_for_table('public.medias_products');
SELECT enable_audit_for_table('public.medias_stock_movements');
```

4. Seed 11 products (CAT-05):
```sql
INSERT INTO public.medias_products (tipo, talla, codigo, precio, stock_normal, stock_devoluciones, activo) VALUES
  ('Muslo', 'M',   '74113', 175000, 0, 0, true),
  ('Muslo', 'L',   '74114', 175000, 0, 0, true),
  ('Muslo', 'XL',  '74115', 175000, 0, 0, true),
  ('Muslo', 'XXL', '74116', 175000, 0, 0, true),
  ('Panty', 'M',   '75406', 190000, 0, 0, true),
  ('Panty', 'L',   '75407', 190000, 0, 0, true),
  ('Panty', 'XL',  '75408', 190000, 0, 0, true),
  ('Panty', 'XXL', '75409', 190000, 0, 0, true),
  ('Rodilla', 'M', '79321', 130000, 0, 0, true),
  ('Rodilla', 'L', '79322', 130000, 0, 0, true),
  ('Rodilla', 'XL','79323', 130000, 0, 0, true);
```

5. Grant permissions:
```sql
GRANT SELECT, INSERT, UPDATE ON public.medias_products TO authenticated;
GRANT SELECT, INSERT ON public.medias_stock_movements TO authenticated;
```

6. Verification block at end (DO $$ ... $$)
  </action>
  <verify>Migration file contains INSERT INTO medias_products with 11 rows and RLS policies</verify>
  <done>11 products seeded, RLS enabled, audit logging configured</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Migration file is syntactically correct SQL
2. File contains medias_products and medias_stock_movements tables
3. Immutability trigger is defined
4. RLS policies are enabled on both tables
5. 11 products are seeded with correct prices (Muslo $175k, Panty $190k, Rodilla $130k)
</verification>

<success_criteria>
- [ ] supabase/migrations/020_medias_foundation.sql exists
- [ ] medias_products table has stock_normal and stock_devoluciones columns
- [ ] medias_stock_movements table is immutable (trigger blocks UPDATE/DELETE)
- [ ] 11 products pre-loaded with correct tipo/talla/precio
- [ ] RLS policies: authenticated can SELECT, admin can ALL
- [ ] Audit logging enabled for both tables
</success_criteria>

<output>
After completion, create `.planning/phases/10-medias-foundation/10-01-SUMMARY.md`
</output>
