---
phase: 11-sales-core
plan: 07
type: execute
wave: 5
depends_on: ["11-05", "11-06"]
files_modified:
  - src/components/medias/sales/sale-form.tsx
  - src/app/(protected)/medias/ventas/nueva/page.tsx
  - src/app/(protected)/medias/ventas/page.tsx
  - src/components/medias/sales/sales-table.tsx
autonomous: true

must_haves:
  truths:
    - "Sale form composes ProductSelector, SaleMethodForm, and SaleSummary"
    - "Form validates before submission and shows errors"
    - "Sales list page shows all sales with status badges"
  artifacts:
    - path: "src/components/medias/sales/sale-form.tsx"
      provides: "Main sale creation form"
      exports: ["SaleForm"]
    - path: "src/app/(protected)/medias/ventas/nueva/page.tsx"
      provides: "New sale page"
    - path: "src/app/(protected)/medias/ventas/page.tsx"
      provides: "Sales list page"
  key_links:
    - from: "sale-form.tsx"
      to: "createMediasSale action"
      via: "useActionState"
      pattern: "useActionState.*createMediasSale"
---

<objective>
Create main sale form, new sale page, and sales list page

Purpose: Implement sale creation UI and sales management page
Output: Complete sale creation workflow with listing page
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-sales-core/11-RESEARCH.md
@src/components/payments/payment-form.tsx
@src/app/(protected)/pagos/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SaleForm component</name>
  <files>src/components/medias/sales/sale-form.tsx</files>
  <action>
Create main form composing sub-components:

```tsx
'use client'

import { useActionState, useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Loader2 } from 'lucide-react'
import { ProductSelector } from './product-selector'
import { SaleMethodForm } from './sale-method-form'
import { SaleSummary } from './sale-summary'
import { PatientSearch } from '@/components/patients/patient-search'
import { createMediasSale, type SaleActionState } from '@/app/(protected)/medias/ventas/actions'
import type { MediasProduct } from '@/types/medias/products'
import type { CartItem, MediasSaleMethodInput } from '@/types/medias/sales'

interface SaleFormProps {
  products: MediasProduct[]
  staffUsers: { id: string; email: string }[]
}

export function SaleForm({ products, staffUsers }: SaleFormProps) {
  const router = useRouter()
  const [state, formAction, isPending] = useActionState<SaleActionState | null, FormData>(
    createMediasSale,
    null
  )

  // Form state
  const [cart, setCart] = useState<CartItem[]>([])
  const [methods, setMethods] = useState<MediasSaleMethodInput[]>([
    { metodo: 'efectivo', monto: 0, comprobante_path: null },
  ])
  const [patientId, setPatientId] = useState<string | null>(null)
  const [receptorId, setReceptorId] = useState<string | null>(null)

  // Calculate totals
  const total = cart.reduce((sum, item) => sum + item.subtotal, 0)

  // Auto-update first method amount when cart changes
  useEffect(() => {
    if (methods.length === 1 && methods[0].monto === 0) {
      setMethods([{ ...methods[0], monto: total }])
    }
  }, [total])

  // Handle successful submission
  useEffect(() => {
    if (state?.success && state.data) {
      router.push(`/medias/ventas/${state.data.id}`)
    }
  }, [state?.success, state?.data, router])

  // Validation
  const methodsTotal = methods.reduce((sum, m) => sum + m.monto, 0)
  const hasValidTotal = Math.abs(total - methodsTotal) < 0.01
  const hasComprobantes = methods.every(
    (m) => m.metodo === 'efectivo' || m.comprobante_path
  )
  const canSubmit =
    cart.length > 0 && methods.length > 0 && hasValidTotal && hasComprobantes

  const handleSubmit = (formData: FormData) => {
    // Add cart items as JSON
    formData.set(
      'items',
      JSON.stringify(
        cart.map((item) => ({
          product_id: item.product_id,
          quantity: item.quantity,
        }))
      )
    )

    // Add methods as JSON
    formData.set('methods', JSON.stringify(methods))

    // Add optional fields
    if (patientId) formData.set('patient_id', patientId)
    if (receptorId) formData.set('receptor_efectivo_id', receptorId)

    formAction(formData)
  }

  return (
    <form action={handleSubmit} className="space-y-8">
      {state?.error && (
        <Alert variant="destructive">
          <AlertDescription>{state.error}</AlertDescription>
        </Alert>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Left column: Products and Methods */}
        <div className="lg:col-span-2 space-y-8">
          {/* Product Selection */}
          <div>
            <h2 className="text-lg font-semibold mb-4">Productos</h2>
            <ProductSelector
              products={products}
              cart={cart}
              onChange={setCart}
              disabled={isPending}
            />
          </div>

          {/* Payment Methods */}
          <div>
            <h2 className="text-lg font-semibold mb-4">Pago</h2>
            <SaleMethodForm
              methods={methods}
              onChange={setMethods}
              totalRequired={total}
              disabled={isPending}
            />
          </div>

          {/* Optional: Patient Link (VTA-06) */}
          <div className="space-y-2">
            <Label>Paciente (opcional)</Label>
            <PatientSearch
              onSelect={(patient) => setPatientId(patient?.id || null)}
              disabled={isPending}
            />
          </div>

          {/* Optional: Cash Receiver (VTA-08) */}
          {methods.some((m) => m.metodo === 'efectivo') && (
            <div className="space-y-2">
              <Label htmlFor="receptor">
                Quien recibio efectivo (si diferente al vendedor)
              </Label>
              <Select
                value={receptorId || ''}
                onValueChange={(v) => setReceptorId(v || null)}
                disabled={isPending}
              >
                <SelectTrigger id="receptor">
                  <SelectValue placeholder="Mismo vendedor" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="">Mismo vendedor</SelectItem>
                  {staffUsers.map((user) => (
                    <SelectItem key={user.id} value={user.id}>
                      {user.email}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          )}
        </div>

        {/* Right column: Summary */}
        <div>
          <SaleSummary cart={cart} methods={methods} />

          <Button
            type="submit"
            className="w-full mt-4"
            size="lg"
            disabled={!canSubmit || isPending}
          >
            {isPending ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Procesando...
              </>
            ) : (
              'Registrar Venta'
            )}
          </Button>

          {!canSubmit && cart.length > 0 && (
            <p className="text-sm text-muted-foreground mt-2 text-center">
              {!hasValidTotal && 'El monto de pago debe coincidir con el total'}
              {hasValidTotal &&
                !hasComprobantes &&
                'Suba comprobante para pagos electronicos'}
            </p>
          )}
        </div>
      </div>
    </form>
  )
}
```
  </action>
  <verify>
Run: `grep "useActionState" src/components/medias/sales/sale-form.tsx` confirms action hook
Run: `grep "canSubmit" src/components/medias/sales/sale-form.tsx` confirms validation
  </verify>
  <done>
SaleForm composes all sub-components with validation and submission handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create new sale page and sales list</name>
  <files>
    src/app/(protected)/medias/ventas/nueva/page.tsx
    src/app/(protected)/medias/ventas/page.tsx
    src/components/medias/sales/sales-table.tsx
  </files>
  <action>
Create pages and table component:

**src/app/(protected)/medias/ventas/nueva/page.tsx:**
```tsx
import { createClient } from '@/lib/supabase/server'
import { SaleForm } from '@/components/medias/sales/sale-form'
import { getActiveSaleProducts } from '@/lib/queries/medias/sales'

export const metadata = {
  title: 'Nueva Venta | Varix Medias',
}

export default async function NewSalePage() {
  const supabase = await createClient()

  // Get products with stock
  const products = await getActiveSaleProducts()

  // Get staff users for receptor selection
  const { data: staffUsers } = await supabase
    .from('user_roles')
    .select('user_id, users:user_id(id, email)')
    .in('role', ['admin', 'medico', 'enfermera', 'secretaria'])

  const users = (staffUsers || [])
    .map((u) => u.users)
    .filter(Boolean)
    .map((u) => ({ id: u.id, email: u.email }))

  return (
    <div className="container mx-auto py-6">
      <h1 className="text-2xl font-bold mb-6">Nueva Venta</h1>
      <SaleForm products={products} staffUsers={users} />
    </div>
  )
}
```

**src/app/(protected)/medias/ventas/page.tsx:**
```tsx
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import { SalesTable } from '@/components/medias/sales/sales-table'
import { getSales } from '@/lib/queries/medias/sales'

export const metadata = {
  title: 'Ventas | Varix Medias',
}

export default async function SalesPage() {
  const sales = await getSales({ limit: 100 })

  return (
    <div className="container mx-auto py-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Ventas de Medias</h1>
        <Button asChild>
          <Link href="/medias/ventas/nueva">
            <Plus className="mr-2 h-4 w-4" />
            Nueva Venta
          </Link>
        </Button>
      </div>

      <SalesTable sales={sales} />
    </div>
  )
}
```

**src/components/medias/sales/sales-table.tsx:**
```tsx
'use client'

import Link from 'next/link'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Eye } from 'lucide-react'
import type { MediasSaleWithDetails } from '@/types/medias/sales'

interface SalesTableProps {
  sales: MediasSaleWithDetails[]
}

const formatCurrency = (amount: number) =>
  new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
  }).format(amount)

export function SalesTable({ sales }: SalesTableProps) {
  if (sales.length === 0) {
    return (
      <div className="text-center py-12 text-muted-foreground">
        No hay ventas registradas
      </div>
    )
  }

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>No. Venta</TableHead>
            <TableHead>Fecha</TableHead>
            <TableHead>Paciente</TableHead>
            <TableHead>Items</TableHead>
            <TableHead className="text-right">Total</TableHead>
            <TableHead>Estado</TableHead>
            <TableHead className="w-12"></TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {sales.map((sale) => (
            <TableRow key={sale.id}>
              <TableCell className="font-medium">{sale.numero_venta}</TableCell>
              <TableCell>
                {format(new Date(sale.created_at), 'dd MMM yyyy HH:mm', {
                  locale: es,
                })}
              </TableCell>
              <TableCell>
                {sale.patient?.nombre_completo || (
                  <span className="text-muted-foreground">Sin paciente</span>
                )}
              </TableCell>
              <TableCell>
                {sale.items.length} producto(s)
              </TableCell>
              <TableCell className="text-right font-medium">
                {formatCurrency(sale.total)}
              </TableCell>
              <TableCell>
                <Badge
                  variant={sale.estado === 'activo' ? 'default' : 'destructive'}
                >
                  {sale.estado === 'activo' ? 'Activo' : 'Anulado'}
                </Badge>
              </TableCell>
              <TableCell>
                <Button variant="ghost" size="icon" asChild>
                  <Link href={`/medias/ventas/${sale.id}`}>
                    <Eye className="h-4 w-4" />
                  </Link>
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}
```
  </action>
  <verify>
Run: `ls src/app/(protected)/medias/ventas/` shows page.tsx and nueva/page.tsx
Run: `grep "getSales" src/app/(protected)/medias/ventas/page.tsx` confirms data fetching
  </verify>
  <done>
New sale page and sales list page complete with table component
  </done>
</task>

</tasks>

<verification>
- [ ] SaleForm validates cart, methods, and comprobantes before enabling submit
- [ ] New sale page fetches products and staff users
- [ ] Sales list page shows all sales with links to detail
- [ ] SalesTable displays numero_venta, fecha, paciente, total, estado
- [ ] Status badge shows Activo/Anulado with appropriate colors
</verification>

<success_criteria>
Sale creation and listing pages are functional and navigate correctly
</success_criteria>

<output>
After completion, create `.planning/phases/11-sales-core/11-07-SUMMARY.md`
</output>
