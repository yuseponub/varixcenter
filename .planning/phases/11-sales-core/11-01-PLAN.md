---
phase: 11-sales-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/021_medias_sales.sql
autonomous: true

must_haves:
  truths:
    - "Sales table structure matches payments pattern (header + items + methods)"
    - "VTA counter initialized and generates gapless sequential numbers"
    - "Electronic payment methods enforce comprobante_path constraint"
  artifacts:
    - path: "supabase/migrations/021_medias_sales.sql"
      provides: "Sales tables, counter, and RLS"
      contains: "medias_sales"
  key_links:
    - from: "medias_sale_items"
      to: "medias_products"
      via: "product_id REFERENCES"
      pattern: "REFERENCES public.medias_products"
    - from: "medias_sale_methods"
      to: "medias_sales"
      via: "sale_id REFERENCES"
      pattern: "REFERENCES public.medias_sales"
---

<objective>
Create database migration for medias_sales tables with gapless VTA- numbering

Purpose: Establish the sales data structure following proven payments pattern (header + items + methods)
Output: Migration 021_medias_sales.sql with tables, counter, constraints, RLS, and indexes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS-MEDIAS.md
@.planning/phases/11-sales-core/11-RESEARCH.md
@supabase/migrations/009_payments_tables.sql
@supabase/migrations/020_medias_foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sales tables migration</name>
  <files>supabase/migrations/021_medias_sales.sql</files>
  <action>
Create migration following 009_payments_tables.sql pattern exactly:

1. **venta_counter table** (clone invoice_counter):
   - Single-row table with id=1 constraint
   - last_number BIGINT, prefix 'VTA'
   - Protection trigger for INSERT/DELETE
   - get_next_venta_number() function with FOR UPDATE lock

2. **medias_sales table** (header):
   - id UUID PRIMARY KEY
   - numero_venta VARCHAR(20) UNIQUE NOT NULL (VTA-000001)
   - patient_id UUID REFERENCES patients(id) NULLABLE (VTA-06)
   - subtotal, total DECIMAL(12,2) NOT NULL
   - estado payment_status DEFAULT 'activo' (reuse existing ENUM)
   - eliminado_por, eliminado_at, eliminacion_justificacion for admin delete
   - vendedor_id UUID NOT NULL REFERENCES auth.users (VTA-07)
   - receptor_efectivo_id UUID REFERENCES auth.users NULLABLE (VTA-08)
   - created_at TIMESTAMPTZ DEFAULT now()
   - NO updated_at (immutable)
   - CHECK total >= 0

3. **medias_sale_items table** (line items with snapshots):
   - id UUID PRIMARY KEY
   - sale_id UUID NOT NULL REFERENCES medias_sales ON DELETE RESTRICT
   - product_id UUID NOT NULL REFERENCES medias_products ON DELETE RESTRICT
   - Snapshot fields: product_codigo, product_tipo, product_talla VARCHAR
   - unit_price DECIMAL(12,2) NOT NULL (snapshot)
   - quantity INTEGER NOT NULL CHECK > 0
   - subtotal DECIMAL(12,2) NOT NULL
   - created_at TIMESTAMPTZ

4. **medias_sale_methods table** (payment methods):
   - id UUID PRIMARY KEY
   - sale_id UUID NOT NULL REFERENCES medias_sales ON DELETE RESTRICT
   - metodo payment_method_type NOT NULL (reuse existing ENUM)
   - monto DECIMAL(12,2) NOT NULL CHECK > 0
   - comprobante_path TEXT
   - CONSTRAINT comprobante_required_for_electronic CHECK (VTA-05)
   - created_at TIMESTAMPTZ

5. **Indexes**:
   - idx_medias_sales_patient, idx_medias_sales_estado, idx_medias_sales_created_at
   - idx_medias_sale_items_sale, idx_medias_sale_items_product
   - idx_medias_sale_methods_sale

6. **RLS Policies** (clone from payments):
   - All staff can SELECT all three tables
   - All staff can INSERT
   - NO UPDATE policies (immutability enforced by trigger in 022)
   - NO DELETE policies

7. **GRANT permissions** and verification DO block

Include inline comments referencing VTA requirements (VTA-01 through VTA-14).
  </action>
  <verify>
Run: `grep -c "CREATE TABLE" supabase/migrations/021_medias_sales.sql` shows 4 (counter + 3 tables)
Run: `grep "VTA-" supabase/migrations/021_medias_sales.sql` shows requirement references
  </verify>
  <done>
Migration creates medias_sales, medias_sale_items, medias_sale_methods, and venta_counter with all constraints, RLS, and indexes
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file follows 009_payments_tables.sql structure
- [ ] venta_counter initialized with prefix 'VTA' and last_number 0
- [ ] get_next_venta_number() uses FOR UPDATE lock for gapless numbering
- [ ] comprobante_required_for_electronic constraint on medias_sale_methods
- [ ] All three tables have RLS enabled with SELECT/INSERT policies
- [ ] No UPDATE or DELETE policies (immutability)
</verification>

<success_criteria>
Migration 021_medias_sales.sql exists with complete schema matching payments pattern, ready for immutability trigger in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/11-sales-core/11-01-SUMMARY.md`
</output>
