---
phase: 15-dashboard-inventory
plan: 07
type: execute
wave: 4
depends_on: ["15-03", "15-05"]
files_modified:
  - src/components/medias/movements/movements-table.tsx
  - src/components/medias/movements/movement-filters.tsx
  - src/app/(protected)/medias/movimientos/page.tsx
autonomous: true

must_haves:
  truths:
    - "Movements table shows all movement types with product info"
    - "Filters support product, date range, and type"
    - "Page shows adjustment dialog for admin/medico users"
  artifacts:
    - path: "src/components/medias/movements/movements-table.tsx"
      provides: "Stock movements history table"
      exports: ["MovementsTable"]
    - path: "src/components/medias/movements/movement-filters.tsx"
      provides: "Filter form for movements"
      exports: ["MovementFilters"]
    - path: "src/app/(protected)/medias/movimientos/page.tsx"
      provides: "Movements history page"
      min_lines: 40
  key_links:
    - from: "src/app/(protected)/medias/movimientos/page.tsx"
      to: "getStockMovements"
      via: "server-side query"
      pattern: "getStockMovements"
---

<objective>
Create movements history page with filterable table and adjustment capability.

Purpose: Provide full audit trail of stock movements with ability to make adjustments.
Output: Movements table, filters component, and page at /medias/movimientos.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-dashboard-inventory/15-CONTEXT.md
@.planning/phases/15-dashboard-inventory/15-RESEARCH.md
@src/lib/queries/medias/movements.ts
@src/components/medias/movements/adjustment-dialog.tsx
@src/types/medias/products.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create movements table and filters</name>
  <files>
    src/components/medias/movements/movements-table.tsx
    src/components/medias/movements/movement-filters.tsx
  </files>
  <action>
Create src/components/medias/movements/movements-table.tsx:
- 'use client'
- Props: data: StockMovementWithProduct[]
- Use TanStack Table (same pattern as products-table.tsx)
- Columns:
  - Fecha (created_at formatted with date-fns)
  - Producto (codigo - tipo talla from product relation)
  - Tipo (movement type with color-coded badge)
  - Cantidad (+ for entrada types, - for salida types)
  - Stock Antes (stock_normal_antes / stock_devoluciones_antes)
  - Stock Despues (stock_normal_despues / stock_devoluciones_despues)
  - Notas (truncated with tooltip if long)
- Type badge colors:
  - compra: green
  - venta: blue
  - devolucion: purple
  - ajuste_entrada: teal
  - ajuste_salida: orange
  - transferencia: gray

Create src/components/medias/movements/movement-filters.tsx:
- 'use client'
- Props: products: { id: string; codigo: string; tipo: string; talla: string }[], onFilter: (filters: MovementFilters) => void
- Form fields:
  - Product select (optional, shows "Todos los productos")
  - Date range: from_date and to_date inputs (type="date")
  - Tipo select (optional, shows all MOVEMENT_TYPES)
- Apply button triggers onFilter callback
- Clear button resets all filters
  </action>
  <verify>Run `cat src/components/medias/movements/movements-table.tsx src/components/medias/movements/movement-filters.tsx` to confirm table and filters</verify>
  <done>Movements table displays all columns with type badges and filters form provides all filter options</done>
</task>

<task type="auto">
  <name>Task 2: Create movements page</name>
  <files>src/app/(protected)/medias/movimientos/page.tsx</files>
  <action>
Create src/app/(protected)/medias/movimientos/page.tsx:

1. Server component with searchParams for filters
2. Import getStockMovements, movement components, AdjustmentDialog
3. Import getProducts for filter dropdown and adjustment form

4. Parse searchParams for filters:
   - product_id, tipo, from_date, to_date

5. Fetch data in parallel:
   - const [movements, products] = await Promise.all([getStockMovements(filters), getProducts()])

6. Get user role (for adjustment button visibility):
   - Use pattern from ventas/[id]/page.tsx
   - getUserRole function from JWT app_metadata

7. Page layout:
   - Header: "Historial de Movimientos" with subtitle
   - Action row: MovementFilters on left, AdjustmentDialog on right (only if admin/medico)
   - MovementsTable with fetched data

8. MovementFilters uses router.push with new searchParams to trigger refetch

9. Metadata: title: 'Medias | Movimientos'

Note: For products list, create a simple getProducts query that returns all products for dropdown (can add to dashboard.ts or separate).
  </action>
  <verify>Run `cat src/app/(protected)/medias/movimientos/page.tsx` to confirm page structure with filters and adjustment</verify>
  <done>Movements page shows filterable history with adjustment capability for authorized users</done>
</task>

</tasks>

<verification>
- [ ] src/components/medias/movements/movements-table.tsx exists
- [ ] Table shows fecha, producto, tipo, cantidad, stock antes/despues, notas
- [ ] Movement types have color-coded badges
- [ ] src/components/medias/movements/movement-filters.tsx exists
- [ ] Filters support product, date range, and type
- [ ] src/app/(protected)/medias/movimientos/page.tsx exists
- [ ] Page reads filters from searchParams
- [ ] AdjustmentDialog only visible for admin/medico
</verification>

<success_criteria>
Movements page provides complete audit trail with filters and adjustment capability.
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-inventory/15-07-SUMMARY.md`
</output>
