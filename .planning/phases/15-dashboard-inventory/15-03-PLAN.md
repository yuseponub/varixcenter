---
phase: 15-dashboard-inventory
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/lib/queries/medias/dashboard.ts
  - src/lib/queries/medias/movements.ts
autonomous: true

must_haves:
  truths:
    - "getDashboardMetrics returns efectivo from open cierre or 0"
    - "getLowStockProducts returns products where stock_normal < umbral_alerta"
    - "getStockMovements supports product, date, and type filters"
  artifacts:
    - path: "src/lib/queries/medias/dashboard.ts"
      provides: "Dashboard metrics and low stock queries"
      exports: ["getDashboardMetrics", "getLowStockProducts"]
    - path: "src/lib/queries/medias/movements.ts"
      provides: "Stock movement queries with filters"
      exports: ["getStockMovements"]
  key_links:
    - from: "getDashboardMetrics"
      to: "get_medias_cierre_summary RPC"
      via: "efectivo_neto from today's cierre"
      pattern: "get_medias_cierre_summary"
    - from: "getLowStockProducts"
      to: "medias_products"
      via: "stock_normal < umbral_alerta"
      pattern: "stock_normal.*<.*umbral_alerta"
---

<objective>
Create query functions for dashboard metrics, low stock products, and stock movements history.

Purpose: Enable server-side data fetching for dashboard and movements page.
Output: Two query files with getDashboardMetrics, getLowStockProducts, and getStockMovements functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-dashboard-inventory/15-CONTEXT.md
@.planning/phases/15-dashboard-inventory/15-RESEARCH.md
@src/lib/queries/medias/sales.ts
@src/lib/queries/medias/returns.ts
@src/lib/queries/medias/cierres.ts
@src/types/medias/products.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard queries</name>
  <files>src/lib/queries/medias/dashboard.ts</files>
  <action>
Create src/lib/queries/medias/dashboard.ts with:

1. Import createClient from '@/lib/supabase/server'
2. Import types from '@/types/medias/dashboard'
3. Import getSalesSummary from './sales' for reuse

4. getDashboardMetrics function:
   - Get today's date range (start of day to end of day)
   - Get month's date range (start of month to end of month)
   - Get efectivo_en_caja:
     - Call RPC get_medias_cierre_summary with today's date
     - Use efectivo_neto from response (or 0 if no sales)
   - Get ventas_hoy using getSalesSummary(todayStart, todayEnd)
   - Get ventas_mes using getSalesSummary(monthStart, monthEnd)
   - Get devoluciones_pendientes from getPendingReturnsCount (import from returns.ts)
   - Return DashboardMetrics object

5. getLowStockProducts function:
   - Query medias_products where activo = true
   - Use raw SQL filter: stock_normal < umbral_alerta
   - Select id, codigo, tipo, talla, stock_normal, umbral_alerta
   - Order by stock_normal ASC (most critical first)
   - Return LowStockProduct[]

6. getStockAlertsSummary function:
   - Call getLowStockProducts
   - Return StockAlertsSummary with count and products

Use eslint-disable for untyped table access (same pattern as sales.ts).
For efectivo_en_caja, use get_medias_cierre_summary RPC - it already calculates efectivo_neto correctly.
  </action>
  <verify>Run `cat src/lib/queries/medias/dashboard.ts` to confirm all functions exist with proper query logic</verify>
  <done>Dashboard queries fetch metrics from sales/cierres/returns and low stock products using umbral_alerta</done>
</task>

<task type="auto">
  <name>Task 2: Create movements query</name>
  <files>src/lib/queries/medias/movements.ts</files>
  <action>
Create src/lib/queries/medias/movements.ts with:

1. Import createClient from '@/lib/supabase/server'
2. Import MediasStockMovement, MediasMovementType from '@/types/medias/products'

3. MovementFilters interface:
   - product_id?: string
   - tipo?: MediasMovementType
   - from_date?: string (ISO date string)
   - to_date?: string (ISO date string)

4. StockMovementWithProduct interface (extends MediasStockMovement):
   - product: { id: string; codigo: string; tipo: string; talla: string }

5. getStockMovements function:
   - Parameters: filters?: MovementFilters, limit = 200
   - Build query from medias_stock_movements
   - Select *, product:medias_products(id, codigo, tipo, talla)
   - Order by created_at DESC
   - Apply filters if provided:
     - product_id: eq filter
     - tipo: eq filter
     - from_date: gte on created_at
     - to_date: lte on created_at
   - Apply limit
   - Return StockMovementWithProduct[]

6. getProductMovements function (for single product history):
   - Parameters: productId: string, limit = 50
   - Call getStockMovements with product_id filter
   - Return results

Use eslint-disable for untyped table access.
  </action>
  <verify>Run `cat src/lib/queries/medias/movements.ts` to confirm query with all filter options</verify>
  <done>Movements query supports product, date range, and type filters with product relation</done>
</task>

</tasks>

<verification>
- [ ] src/lib/queries/medias/dashboard.ts exists
- [ ] getDashboardMetrics returns efectivo_en_caja from cierre RPC
- [ ] getDashboardMetrics returns ventas counts/totals for today and month
- [ ] getLowStockProducts filters where stock_normal < umbral_alerta
- [ ] src/lib/queries/medias/movements.ts exists
- [ ] getStockMovements supports all filter types
- [ ] Movements include product relation (codigo, tipo, talla)
</verification>

<success_criteria>
Query functions ready for dashboard page and movements page data fetching.
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-inventory/15-03-SUMMARY.md`
</output>
