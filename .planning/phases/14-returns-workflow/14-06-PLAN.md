---
phase: 14-returns-workflow
plan: 06
type: execute
wave: 5
depends_on: ["14-04", "14-05"]
files_modified:
  - src/app/(protected)/medias/devoluciones/page.tsx
  - src/app/(protected)/medias/devoluciones/nueva/page.tsx
  - src/app/(protected)/medias/devoluciones/pendientes/page.tsx
  - src/app/(protected)/medias/devoluciones/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Returns list page shows all returns with filters"
    - "New return page requires selecting a sale first"
    - "Pending returns page shows only estado='pendiente' for quick admin access"
    - "Return detail page shows full return info with approval status"
  artifacts:
    - path: "src/app/(protected)/medias/devoluciones/page.tsx"
      provides: "Returns list page"
      min_lines: 60
    - path: "src/app/(protected)/medias/devoluciones/nueva/page.tsx"
      provides: "New return flow (select sale then items)"
      min_lines: 80
    - path: "src/app/(protected)/medias/devoluciones/pendientes/page.tsx"
      provides: "Pending returns admin view"
      min_lines: 40
    - path: "src/app/(protected)/medias/devoluciones/[id]/page.tsx"
      provides: "Return detail page"
      min_lines: 80
  key_links:
    - from: "page.tsx"
      to: "getReturns"
      via: "data fetching"
      pattern: "await getReturns"
    - from: "nueva/page.tsx"
      to: "ReturnForm"
      via: "component render"
      pattern: "<ReturnForm"
---

<objective>
Create pages for the returns workflow: list, new return, pending returns, and detail view.

Purpose: Provides complete user-facing navigation for returns with proper data fetching and role-based access.
Output: Four page files under /medias/devoluciones route.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-returns-workflow/14-CONTEXT.md
@src/app/(protected)/medias/ventas/page.tsx
@src/app/(protected)/medias/ventas/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create returns list page</name>
  <files>src/app/(protected)/medias/devoluciones/page.tsx</files>
  <action>
Create list page following ventas/page.tsx pattern:

```typescript
import { getReturns, getPendingReturnsCount } from '@/lib/queries/medias/returns'
import { ReturnsTable } from '@/components/medias/returns/returns-table'
import { getUserRole } from '@/lib/auth/get-user-role'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import Link from 'next/link'
import { Plus, Clock } from 'lucide-react'

export default async function DevolucionesPage() {
  const [returns, pendingCount, userRole] = await Promise.all([
    getReturns(),
    getPendingReturnsCount(),
    getUserRole(),
  ])

  return (
    <div className="container py-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Devoluciones</h1>
          <p className="text-muted-foreground">
            Gestiona las devoluciones de medias de compresion
          </p>
        </div>
        <div className="flex gap-2">
          {pendingCount > 0 && (
            <Button variant="outline" asChild>
              <Link href="/medias/devoluciones/pendientes">
                <Clock className="mr-2 h-4 w-4" />
                Pendientes
                <Badge variant="secondary" className="ml-2">
                  {pendingCount}
                </Badge>
              </Link>
            </Button>
          )}
          <Button asChild>
            <Link href="/medias/devoluciones/nueva">
              <Plus className="mr-2 h-4 w-4" />
              Nueva Devolucion
            </Link>
          </Button>
        </div>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Historial de Devoluciones</CardTitle>
          <CardDescription>
            Todas las solicitudes de devolucion
          </CardDescription>
        </CardHeader>
        <CardContent>
          <ReturnsTable returns={returns} userRole={userRole} />
        </CardContent>
      </Card>
    </div>
  )
}
```

Key features:
- Shows pending count badge linking to /pendientes
- Nueva Devolucion button for all users
- Passes userRole to table for conditional actions
  </action>
  <verify>Check page fetches returns and passes userRole to table</verify>
  <done>Returns list page displays all returns with navigation</done>
</task>

<task type="auto">
  <name>Task 2: Create new return page with sale selection</name>
  <files>src/app/(protected)/medias/devoluciones/nueva/page.tsx</files>
  <action>
Create two-step flow: first select sale, then show return form:

```typescript
import { Suspense } from 'react'
import { getSaleById } from '@/lib/queries/medias/sales'
import { getReturnableQuantity } from '@/lib/queries/medias/returns'
import { ReturnForm } from '@/components/medias/returns/return-form'
import { SaleSearchSelect } from '@/components/medias/returns/sale-search-select'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { ArrowLeft } from 'lucide-react'
import { redirect } from 'next/navigation'

interface Props {
  searchParams: Promise<{ sale_id?: string }>
}

export default async function NuevaDevolucionPage({ searchParams }: Props) {
  const params = await searchParams
  const saleId = params.sale_id

  // Step 1: No sale selected - show sale search
  if (!saleId) {
    return (
      <div className="container py-6 space-y-6">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" asChild>
            <Link href="/medias/devoluciones">
              <ArrowLeft className="h-4 w-4" />
            </Link>
          </Button>
          <div>
            <h1 className="text-3xl font-bold">Nueva Devolucion</h1>
            <p className="text-muted-foreground">Paso 1: Seleccione la venta original</p>
          </div>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Buscar Venta</CardTitle>
            <CardDescription>
              Busque por numero de venta (VTA-XXXXXX) o paciente
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Suspense fallback={<div>Cargando...</div>}>
              <SaleSearchForReturn />
            </Suspense>
          </CardContent>
        </Card>
      </div>
    )
  }

  // Step 2: Sale selected - fetch sale and show return form
  const sale = await getSaleById(saleId)

  if (!sale) {
    redirect('/medias/devoluciones/nueva')
  }

  if (sale.estado !== 'activo') {
    return (
      <div className="container py-6">
        <Card>
          <CardContent className="py-8 text-center">
            <p className="text-muted-foreground">
              No se pueden crear devoluciones para ventas anuladas.
            </p>
            <Button asChild className="mt-4">
              <Link href="/medias/devoluciones/nueva">
                Seleccionar otra venta
              </Link>
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  // Calculate returnable quantities for each item
  const returnableQuantities: Record<string, number> = {}
  for (const item of sale.items) {
    returnableQuantities[item.id] = await getReturnableQuantity(item.id)
  }

  return (
    <div className="container py-6 space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" asChild>
          <Link href="/medias/devoluciones/nueva">
            <ArrowLeft className="h-4 w-4" />
          </Link>
        </Button>
        <div>
          <h1 className="text-3xl font-bold">Nueva Devolucion</h1>
          <p className="text-muted-foreground">
            Venta: {sale.numero_venta}
            {sale.patient && ` - ${sale.patient.nombre} ${sale.patient.apellido}`}
          </p>
        </div>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Solicitud de Devolucion</CardTitle>
          <CardDescription>
            Seleccione el producto, cantidad y motivo de la devolucion
          </CardDescription>
        </CardHeader>
        <CardContent>
          <ReturnForm sale={sale} returnableQuantities={returnableQuantities} />
        </CardContent>
      </Card>
    </div>
  )
}

// Client component for sale search - create separate file or inline
async function SaleSearchForReturn() {
  // Show list of recent active sales with search
  // On select, redirect to ?sale_id=xxx
  // Uses getActiveSales query and search input
}
```

Also create `src/components/medias/returns/sale-search-select.tsx` client component:
- Search input for numero_venta
- Displays recent active sales
- On selection, calls router.push(`?sale_id=${saleId}`)
  </action>
  <verify>Check page handles both steps: no sale_id shows search, with sale_id shows form</verify>
  <done>New return page has two-step flow: select sale then create return</done>
</task>

<task type="auto">
  <name>Task 3: Create pending returns page</name>
  <files>src/app/(protected)/medias/devoluciones/pendientes/page.tsx</files>
  <action>
Create filtered view for Admin/Medico quick access:

```typescript
import { getReturns } from '@/lib/queries/medias/returns'
import { ReturnsTable } from '@/components/medias/returns/returns-table'
import { getUserRole } from '@/lib/auth/get-user-role'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import Link from 'next/link'
import { ArrowLeft } from 'lucide-react'

export default async function PendientesPage() {
  const [returns, userRole] = await Promise.all([
    getReturns({ estado: 'pendiente' }),
    getUserRole(),
  ])

  return (
    <div className="container py-6 space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" asChild>
          <Link href="/medias/devoluciones">
            <ArrowLeft className="h-4 w-4" />
          </Link>
        </Button>
        <div>
          <h1 className="text-3xl font-bold">Devoluciones Pendientes</h1>
          <p className="text-muted-foreground">
            {returns.length} solicitud(es) pendiente(s) de aprobacion
          </p>
        </div>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Solicitudes Pendientes</CardTitle>
          <CardDescription>
            Revise y apruebe o rechace las solicitudes de devolucion
          </CardDescription>
        </CardHeader>
        <CardContent>
          <ReturnsTable returns={returns} userRole={userRole} />
        </CardContent>
      </Card>
    </div>
  )
}
```

Simple filtered view - reuses ReturnsTable with estado='pendiente' filter.
  </action>
  <verify>Check page only shows pendiente returns</verify>
  <done>Pending returns page provides quick admin access to pending approvals</done>
</task>

<task type="auto">
  <name>Task 4: Create return detail page</name>
  <files>src/app/(protected)/medias/devoluciones/[id]/page.tsx</files>
  <action>
Create detail page following ventas/[id]/page.tsx pattern:

```typescript
import { getReturnById } from '@/lib/queries/medias/returns'
import { getUserRole } from '@/lib/auth/get-user-role'
import { ReturnStatusBadge } from '@/components/medias/returns/return-status-badge'
import { ApproveDialog } from '@/components/medias/returns/approve-dialog'
import { RejectDialog } from '@/components/medias/returns/reject-dialog'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { formatCurrency } from '@/lib/utils'
import { REEMBOLSO_METODO_LABELS } from '@/types/medias/returns'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import Link from 'next/link'
import { ArrowLeft, ExternalLink } from 'lucide-react'
import { notFound } from 'next/navigation'

interface Props {
  params: Promise<{ id: string }>
}

export default async function ReturnDetailPage({ params }: Props) {
  const { id } = await params
  const [ret, userRole] = await Promise.all([
    getReturnById(id),
    getUserRole(),
  ])

  if (!ret) {
    notFound()
  }

  const canApprove = ['admin', 'medico'].includes(userRole)

  return (
    <div className="container py-6 space-y-6">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" asChild>
            <Link href="/medias/devoluciones">
              <ArrowLeft className="h-4 w-4" />
            </Link>
          </Button>
          <div>
            <h1 className="text-3xl font-bold font-mono">{ret.numero_devolucion}</h1>
            <p className="text-muted-foreground">
              Solicitada el {format(new Date(ret.created_at), "d 'de' MMMM, yyyy HH:mm", { locale: es })}
            </p>
          </div>
        </div>
        <ReturnStatusBadge estado={ret.estado} />
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        {/* Return Details */}
        <Card>
          <CardHeader>
            <CardTitle>Detalles de la Devolucion</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <p className="text-sm text-muted-foreground">Venta Original</p>
              <Link
                href={`/medias/ventas/${ret.sale_id}`}
                className="font-mono hover:underline flex items-center gap-1"
              >
                {ret.sale?.numero_venta}
                <ExternalLink className="h-3 w-3" />
              </Link>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Producto</p>
              <p className="font-medium">
                {ret.product_codigo} - {ret.product_tipo} {ret.product_talla}
              </p>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-muted-foreground">Cantidad</p>
                <p className="font-medium">{ret.cantidad}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Monto</p>
                <p className="font-medium">{formatCurrency(ret.monto_devolucion)}</p>
              </div>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Metodo de Reembolso</p>
              <p className="font-medium">{REEMBOLSO_METODO_LABELS[ret.metodo_reembolso]}</p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Motivo</p>
              <p className="text-sm">{ret.motivo}</p>
            </div>
            {ret.foto_path && (
              <div>
                <p className="text-sm text-muted-foreground">Foto</p>
                {/* Add photo display */}
              </div>
            )}
          </CardContent>
        </Card>

        {/* Approval Info */}
        <Card>
          <CardHeader>
            <CardTitle>Estado de Aprobacion</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <p className="text-sm text-muted-foreground">Solicitante</p>
              <p className="font-medium">{ret.solicitante?.email}</p>
            </div>

            {ret.estado === 'pendiente' ? (
              canApprove ? (
                <div className="flex gap-2 pt-4">
                  <ApproveDialog returnId={ret.id} numeroDevolucion={ret.numero_devolucion} />
                  <RejectDialog returnId={ret.id} numeroDevolucion={ret.numero_devolucion} />
                </div>
              ) : (
                <p className="text-muted-foreground italic">
                  Esperando aprobacion de Admin o Medico
                </p>
              )
            ) : (
              <>
                <div>
                  <p className="text-sm text-muted-foreground">
                    {ret.estado === 'aprobada' ? 'Aprobado por' : 'Rechazado por'}
                  </p>
                  <p className="font-medium">{ret.aprobador?.email}</p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Fecha</p>
                  <p className="font-medium">
                    {ret.aprobado_at &&
                      format(new Date(ret.aprobado_at), "d 'de' MMMM, yyyy HH:mm", { locale: es })}
                  </p>
                </div>
                {ret.notas_aprobador && (
                  <div>
                    <p className="text-sm text-muted-foreground">Notas</p>
                    <p className="text-sm">{ret.notas_aprobador}</p>
                  </div>
                )}
              </>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  )
}
```

Key features:
- Links to original sale
- Shows all return details
- Shows approval status with approver info
- Approve/reject buttons for pending + admin/medico
  </action>
  <verify>Check page shows approve/reject buttons only for pendiente + admin/medico</verify>
  <done>Return detail page displays full return info with conditional approval actions</done>
</task>

</tasks>

<verification>
1. List page fetches all returns and shows pending count badge
2. New return page has two-step flow (select sale then create return)
3. Pending page filters to estado='pendiente'
4. Detail page shows full return info and conditional approve/reject
5. All pages follow existing medias page patterns
6. Navigation between pages works correctly
</verification>

<success_criteria>
- [ ] src/app/(protected)/medias/devoluciones/page.tsx created
- [ ] src/app/(protected)/medias/devoluciones/nueva/page.tsx created with sale search
- [ ] src/app/(protected)/medias/devoluciones/pendientes/page.tsx created
- [ ] src/app/(protected)/medias/devoluciones/[id]/page.tsx created
- [ ] All pages fetch data and render correctly
- [ ] Role-based actions (approve/reject) shown appropriately
- [ ] Spanish labels and formatting throughout
</success_criteria>

<output>
After completion, create `.planning/phases/14-returns-workflow/14-06-SUMMARY.md`
</output>
