---
phase: 15-dashboard-inventory
plan: 08
type: execute
wave: 4
depends_on: ["15-01", "15-03"]
files_modified:
  - src/components/medias/products/products-table.tsx
  - src/app/(protected)/medias/productos/page.tsx
autonomous: true

must_haves:
  truths:
    - "Products table shows low stock warning for products below threshold"
    - "Products table displays umbral_alerta column or indicator"
    - "Products page highlights critical stock items"
  artifacts:
    - path: "src/components/medias/products/products-table.tsx"
      provides: "Updated products table with stock alerts"
      contains: "umbral_alerta"
    - path: "src/app/(protected)/medias/productos/page.tsx"
      provides: "Products page with alerts section"
  key_links:
    - from: "products-table.tsx"
      to: "umbral_alerta"
      via: "stock comparison"
      pattern: "stock_normal.*<.*umbral_alerta"
---

<objective>
Update products table and page to show stock alert indicators based on per-product threshold.

Purpose: Make critical stock visible on the products management page.
Output: Updated table with alert styling and page with alert summary.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-dashboard-inventory/15-CONTEXT.md
@src/components/medias/products/products-table.tsx
@src/app/(protected)/medias/productos/page.tsx
@src/lib/queries/medias/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update products table with alert indicators</name>
  <files>src/components/medias/products/products-table.tsx</files>
  <action>
Update src/components/medias/products/products-table.tsx:

1. Add umbral_alerta to MediasProduct interface usage (the type already exists)

2. Update Stock column cell:
   - Current: Shows "X total" with "Y normal / Z dev"
   - Add: If stock_normal < umbral_alerta AND activo, show warning indicator
   - Use AlertTriangle icon from lucide-react next to stock_normal
   - Style critical stock in text-red-600
   - Tooltip or title explaining "Stock por debajo del umbral (X)"

3. Add optional Umbral column:
   - Shows umbral_alerta value for each product
   - Can be edited in product form if needed (future enhancement)
   - For now, just display the value

4. Row styling:
   - If stock_normal < umbral_alerta AND activo: add subtle red left border or bg-red-50
   - Helps scan for critical items quickly

Keep existing functionality (sorting, edit dialog, toggle active).
  </action>
  <verify>Run `cat src/components/medias/products/products-table.tsx` to confirm alert indicators added</verify>
  <done>Products table shows visual warning for products with stock below threshold</done>
</task>

<task type="auto">
  <name>Task 2: Update products page with alerts summary</name>
  <files>src/app/(protected)/medias/productos/page.tsx</files>
  <action>
Update src/app/(protected)/medias/productos/page.tsx:

1. Add import for getLowStockProducts from dashboard queries

2. Fetch low stock products alongside regular products

3. Add alert banner above table if there are critical products:
   - "X productos con stock critico" in a warning-styled div
   - Use AlertTriangle icon
   - Background: bg-amber-50 or bg-red-50 border-l-4 border-amber-500

4. Alternative: Add a collapsible section showing critical products list
   - Shows codigo, tipo, talla, stock_normal for each critical product
   - Provides quick overview before scrolling table

5. Ensure the table receives products with umbral_alerta field:
   - Update the Supabase query to select umbral_alerta
   - Or rely on the type including it (if column already exists from migration)

Note: The page is currently a client component. Either:
- Keep as client and fetch low stock in useEffect
- Or convert to hybrid (server fetch, client table)
Prefer the simpler option: add the alert check in existing fetchProducts logic.
  </action>
  <verify>Run `cat src/app/(protected)/medias/productos/page.tsx` to confirm alert summary added</verify>
  <done>Products page shows critical stock alert banner when products are below threshold</done>
</task>

</tasks>

<verification>
- [ ] products-table.tsx shows warning icon for low stock products
- [ ] Table highlights rows with critical stock
- [ ] Stock column shows threshold comparison visually
- [ ] productos/page.tsx shows alert banner when products are critical
- [ ] Alert count is accurate (products where stock_normal < umbral_alerta)
</verification>

<success_criteria>
Products page clearly shows which items need restocking based on per-product thresholds.
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-inventory/15-08-SUMMARY.md`
</output>
