---
phase: 12-cash-closing-medias
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/types/medias/cierres.ts
  - src/lib/validations/medias/cierre.ts
autonomous: true

must_haves:
  truths:
    - "MediasCierre type matches medias_cierres database schema"
    - "MediasCierreSummary type matches get_medias_cierre_summary RPC return"
    - "Zod schema validates cierre form data with zero-tolerance refinement"
  artifacts:
    - path: "src/types/medias/cierres.ts"
      provides: "TypeScript types for medias cierres"
      exports: ["MediasCierre", "MediasCierreSummary", "CreateMediasCierreInput"]
    - path: "src/lib/validations/medias/cierre.ts"
      provides: "Zod validation schemas"
      exports: ["mediasCierreSchema", "reopenMediasCierreSchema"]
  key_links:
    - from: "src/types/medias/cierres.ts"
      to: "medias_cierres table"
      via: "matching column types"
      pattern: "interface MediasCierre"
---

<objective>
Create TypeScript types and Zod validation schemas for medias cash closing.

Purpose: Provides type safety and form validation for the medias cierre feature, adapted from clinic's cash-closing types with medias-specific naming.

Output: src/types/medias/cierres.ts and src/lib/validations/medias/cierre.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-cash-closing-medias/12-RESEARCH.md
@src/types/cash-closing.ts (pattern to adapt)
@src/lib/validations/cash-closing.ts (pattern to adapt)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medias cierre TypeScript types</name>
  <files>src/types/medias/cierres.ts</files>
  <action>
Create src/types/medias/cierres.ts (adapt from src/types/cash-closing.ts):

```typescript
/**
 * Medias Cash Closing (Cierre de Caja Medias) Type Definitions
 *
 * Types matching the medias_cierres database schema (024_medias_cierres.sql)
 * Used by: Closing forms, reports, audit trail
 *
 * NOTE: CIE-08 - Independent from clinic cash closings
 * Uses CIM- prefix instead of CIE-
 */

import { CierreEstado, CIERRE_ESTADOS, CIERRE_ESTADO_LABELS, CIERRE_ESTADO_VARIANTS } from '@/types/cash-closing'

// Re-export estado types (shared with clinic)
export { CierreEstado, CIERRE_ESTADOS, CIERRE_ESTADO_LABELS, CIERRE_ESTADO_VARIANTS }

/**
 * Base medias closing type from database Row.
 * Matches the medias_cierres table schema exactly.
 *
 * NOTE: Does NOT include total_descuentos or total_anulaciones
 * (medias sales model is simpler - no discounts)
 */
export interface MediasCierre {
  id: string
  cierre_numero: string        // CIM-000001 (not CIE-)
  fecha_cierre: string         // DATE as string
  total_efectivo: number
  total_tarjeta: number
  total_transferencia: number
  total_nequi: number
  grand_total: number
  conteo_fisico_efectivo: number
  diferencia: number
  diferencia_justificacion: string | null
  cierre_photo_path: string    // Required (NOT NULL in schema)
  estado: CierreEstado
  notas: string | null
  closed_by: string
  reopened_by: string | null
  reopened_at: string | null
  reopen_justificacion: string | null
  created_at: string
  updated_at: string
}

/**
 * Medias closing with related user data for display
 */
export interface MediasCierreWithDetails extends MediasCierre {
  closed_by_user?: {
    email: string
  }
  reopened_by_user?: {
    email: string
  } | null
}

/**
 * Closing summary returned by get_medias_cierre_summary RPC
 * Used for preview before closing
 *
 * NOTE: Uses sale_count (not payment_count) since this is for medias sales
 */
export interface MediasCierreSummary {
  fecha: string
  total_efectivo: number
  total_tarjeta: number
  total_transferencia: number
  total_nequi: number
  grand_total: number
  sale_count: number           // Different from clinic's payment_count
  has_existing_closing: boolean
  existing_closing_id: string | null
}

/**
 * Input type for creating a medias cierre
 */
export interface CreateMediasCierreInput {
  fecha: string
  conteo_fisico: number
  diferencia_justificacion?: string
  cierre_photo_path: string    // Required (not optional like clinic)
  notas?: string
}

/**
 * Result type from create_medias_cierre RPC
 */
export interface CreateMediasCierreResult {
  id: string
  cierre_numero: string
  fecha_cierre: string
  total_efectivo: number
  total_tarjeta: number
  total_transferencia: number
  total_nequi: number
  grand_total: number
  conteo_fisico_efectivo: number
  diferencia: number
}

/**
 * Result type from reopen_medias_cierre RPC
 */
export interface ReopenMediasCierreResult {
  id: string
  cierre_numero: string
  estado: 'reabierto'
  reopened_by: string
  reopened_at: string
}
```

Key differences from clinic types:
- cierre_numero uses CIM- prefix (documented in comment)
- cierre_photo_path is NOT optional (required in schema)
- sale_count instead of payment_count
- No total_descuentos or total_anulaciones (simpler model)
  </action>
  <verify>File created with all types, exports MediasCierre and MediasCierreSummary</verify>
  <done>TypeScript types match medias_cierres schema with CIM- prefix documentation</done>
</task>

<task type="auto">
  <name>Task 2: Create medias cierre Zod validation schemas</name>
  <files>src/lib/validations/medias/cierre.ts</files>
  <action>
Create src/lib/validations/medias/cierre.ts (adapt from src/lib/validations/cash-closing.ts):

```typescript
import { z } from 'zod'

/**
 * Medias cash closing creation schema
 * Used by: Closing form, createMediasCierre server action
 *
 * All messages in Spanish for Colombian users
 *
 * NOTE: CIE-04 - Zero tolerance for differences (no $10k threshold like clinic)
 */
export const mediasCierreSchema = z.object({
  fecha: z
    .string()
    .min(1, { error: 'La fecha es requerida' })
    .regex(/^\d{4}-\d{2}-\d{2}$/, { error: 'Formato de fecha invalido' }),

  conteo_fisico: z
    .number()
    .min(0, { error: 'El conteo no puede ser negativo' }),

  diferencia_justificacion: z
    .string()
    .max(500, { error: 'La justificacion es muy larga' })
    .nullable()
    .optional(),

  // Required for medias (different from clinic where it's optional)
  cierre_photo_path: z
    .string()
    .min(1, { error: 'La foto del cierre es obligatoria' }),

  notas: z
    .string()
    .max(500, { error: 'Las notas son muy largas' })
    .nullable()
    .optional(),
})

/**
 * Schema with zero-tolerance difference validation
 * CRITICAL: ANY difference requires justification (CIE-04)
 */
export const mediasCierreWithDifferenceSchema = (diferencia: number) =>
  mediasCierreSchema.refine(
    (data) => {
      // If there's any difference, justification must be >= 10 chars
      if (diferencia !== 0) {
        return (
          data.diferencia_justificacion !== null &&
          data.diferencia_justificacion !== undefined &&
          data.diferencia_justificacion.trim().length >= 10
        )
      }
      return true
    },
    {
      message: 'Las diferencias requieren justificacion de al menos 10 caracteres',
      path: ['diferencia_justificacion'],
    }
  )

/**
 * Reopen schema
 * Used by: Reopen dialog, reopenMediasCierre server action
 * ANTI-FRAUD: Requires detailed justification (10+ chars) for audit trail
 * CIE-07: Only Admin can reopen
 */
export const reopenMediasCierreSchema = z.object({
  cierre_id: z.string().uuid({ error: 'ID de cierre invalido' }),
  justificacion: z
    .string()
    .min(10, { error: 'La justificacion debe tener al menos 10 caracteres' })
    .max(500, { error: 'La justificacion es muy larga' }),
})

/**
 * TypeScript types inferred from schemas
 */
export type MediasCierreFormData = z.infer<typeof mediasCierreSchema>
export type ReopenMediasCierreFormData = z.infer<typeof reopenMediasCierreSchema>
```

Key differences from clinic validation:
- cierre_photo_path is required (min 1 char) not optional
- mediasCierreWithDifferenceSchema takes diferencia as parameter for zero-tolerance check
- Uses Zod v4 API syntax ({ error: } instead of { required_error: }) per 10-02 decision
  </action>
  <verify>File created with schemas, exports mediasCierreSchema and reopenMediasCierreSchema</verify>
  <done>Zod schemas enforce zero-tolerance and required photo with Spanish messages</done>
</task>

<task type="auto">
  <name>Task 3: Add medias cierre types to barrel export</name>
  <files>src/types/index.ts</files>
  <action>
Add export to src/types/index.ts:

```typescript
// Add this line with other medias exports
export * from './medias/cierres'
```

Ensure the exports are grouped with other medias types (near sales exports if they exist).
  </action>
  <verify>Types importable from @/types</verify>
  <done>MediasCierre types accessible via @/types barrel export</done>
</task>

</tasks>

<verification>
1. Types file exists at src/types/medias/cierres.ts
2. Validation file exists at src/lib/validations/medias/cierre.ts
3. MediasCierre interface has cierre_photo_path as required string (not optional)
4. MediasCierreSummary uses sale_count (not payment_count)
5. Zod schema marks cierre_photo_path as required
6. Zero-tolerance refinement checks diferencia !== 0
7. Types exportable from @/types
</verification>

<success_criteria>
- src/types/medias/cierres.ts created with MediasCierre, MediasCierreSummary, CreateMediasCierreInput
- src/lib/validations/medias/cierre.ts created with Zod schemas
- Photo is required (not optional like clinic)
- Zero-tolerance refinement validates any difference requires 10+ char justification
- Types use Zod v4 API syntax (error: not required_error:)
</success_criteria>

<output>
After completion, create `.planning/phases/12-cash-closing-medias/12-03-SUMMARY.md`
</output>
