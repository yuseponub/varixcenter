---
phase: 04-payments-core
plan: 07
type: execute
wave: 3
depends_on: ["04-04", "04-05"]
files_modified:
  - src/app/(protected)/servicios/page.tsx
  - src/app/(protected)/servicios/actions.ts
  - src/components/services/service-form.tsx
  - src/components/services/services-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see list of all services"
    - "Admin can create new service"
    - "Admin can edit existing service"
    - "Admin can deactivate service (soft delete)"
  artifacts:
    - path: "src/app/(protected)/servicios/page.tsx"
      provides: "Service catalog admin page"
      contains: "Catalogo de Servicios"
    - path: "src/app/(protected)/servicios/actions.ts"
      provides: "CRUD server actions for services"
      contains: "createService"
  key_links:
    - from: "servicios/actions.ts"
      to: "lib/validations/service.ts"
      via: "schema validation"
      pattern: "serviceSchema.safeParse"
---

<objective>
Create service catalog admin interface for managing services and prices.

Purpose: Allow admin to maintain the service catalog used in payment forms.
Output: Services admin page with CRUD operations
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-payments-core/04-RESEARCH.md
@.planning/phases/04-payments-core/04-04-SUMMARY.md

Reference existing patterns:
@src/app/(protected)/pacientes/page.tsx
@src/app/(protected)/pacientes/nuevo/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service CRUD server actions</name>
  <files>src/app/(protected)/servicios/actions.ts</files>
  <action>
Create src/app/(protected)/servicios/actions.ts with:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { serviceSchema, serviceUpdateSchema } from '@/lib/validations/service'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

export type ServiceActionState = {
  error?: string
  errors?: Record<string, string[]>
  success?: boolean
}

/**
 * Create a new service (Admin only)
 */
export async function createService(
  prevState: ServiceActionState | null,
  formData: FormData
): Promise<ServiceActionState> {
  const supabase = await createClient()

  // Verify admin role
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return { error: 'No autorizado' }
  }

  // Parse form data
  const rawData = {
    nombre: formData.get('nombre'),
    descripcion: formData.get('descripcion') || null,
    precio_base: parseFloat(formData.get('precio_base') as string || '0'),
    precio_variable: formData.get('precio_variable') === 'true',
    precio_minimo: formData.get('precio_minimo') ? parseFloat(formData.get('precio_minimo') as string) : null,
    precio_maximo: formData.get('precio_maximo') ? parseFloat(formData.get('precio_maximo') as string) : null,
    activo: formData.get('activo') !== 'false',
  }

  // Validate
  const validated = serviceSchema.safeParse(rawData)
  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
      error: 'Por favor corrija los errores'
    }
  }

  // Insert
  const { error } = await supabase
    .from('services')
    .insert({
      ...validated.data,
      created_by: user.id
    })

  if (error) {
    if (error.code === '23505') { // unique violation
      return { error: 'Ya existe un servicio con ese nombre' }
    }
    console.error('Service creation error:', error)
    return { error: 'Error al crear el servicio' }
  }

  revalidatePath('/servicios')
  return { success: true }
}

/**
 * Update an existing service (Admin only)
 */
export async function updateService(
  id: string,
  prevState: ServiceActionState | null,
  formData: FormData
): Promise<ServiceActionState> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return { error: 'No autorizado' }
  }

  const rawData = {
    nombre: formData.get('nombre'),
    descripcion: formData.get('descripcion') || null,
    precio_base: parseFloat(formData.get('precio_base') as string || '0'),
    precio_variable: formData.get('precio_variable') === 'true',
    precio_minimo: formData.get('precio_minimo') ? parseFloat(formData.get('precio_minimo') as string) : null,
    precio_maximo: formData.get('precio_maximo') ? parseFloat(formData.get('precio_maximo') as string) : null,
    activo: formData.get('activo') !== 'false',
  }

  const validated = serviceUpdateSchema.safeParse(rawData)
  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
      error: 'Por favor corrija los errores'
    }
  }

  const { error } = await supabase
    .from('services')
    .update(validated.data)
    .eq('id', id)

  if (error) {
    if (error.code === '23505') {
      return { error: 'Ya existe un servicio con ese nombre' }
    }
    console.error('Service update error:', error)
    return { error: 'Error al actualizar el servicio' }
  }

  revalidatePath('/servicios')
  return { success: true }
}

/**
 * Toggle service active status (soft delete/restore)
 */
export async function toggleServiceActive(id: string, activo: boolean): Promise<ServiceActionState> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return { error: 'No autorizado' }
  }

  const { error } = await supabase
    .from('services')
    .update({ activo })
    .eq('id', id)

  if (error) {
    console.error('Service toggle error:', error)
    return { error: 'Error al actualizar el servicio' }
  }

  revalidatePath('/servicios')
  return { success: true }
}
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/app/\(protected\)/servicios/actions.ts 2>&1 | head -20
```
  </verify>
  <done>src/app/(protected)/servicios/actions.ts exists with createService, updateService, toggleServiceActive server actions with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create services admin page and components</name>
  <files>
    src/app/(protected)/servicios/page.tsx
    src/components/services/service-form.tsx
    src/components/services/services-table.tsx
  </files>
  <action>
Create src/components/services/service-form.tsx:
- Form for creating/editing services
- Fields: nombre, descripcion, precio_base, precio_variable checkbox
- Conditional fields: precio_minimo, precio_maximo (show when variable)
- Uses react-hook-form + zod resolver
- Submit calls server action

Create src/components/services/services-table.tsx:
- Table showing all services
- Columns: nombre, precio_base, tipo (fijo/variable), estado (activo/inactivo)
- Actions: edit (dialog), toggle active
- Badge for variable price showing rango
- Sort by nombre

Create src/app/(protected)/servicios/page.tsx:
- Title: "Catalogo de Servicios"
- Button to open "Nuevo Servicio" dialog
- ServicesTable component
- Dialog for create/edit service
- Admin-only access check

Key implementation details:
1. Use Dialog component for form (not separate page)
2. Format prices with Colombian peso format
3. Show "(Precio variable)" badge for variable services
4. Inactive services shown with opacity
5. Use useActionState for form submission
  </action>
  <verify>
```bash
mkdir -p src/components/services
npx tsc --noEmit src/app/\(protected\)/servicios/page.tsx 2>&1 | head -20
```
  </verify>
  <done>Services admin page exists with ServicesTable (list with toggle), ServiceForm (create/edit dialog), proper admin access check</done>
</task>

</tasks>

<verification>
1. All files compile without TypeScript errors
2. createService validates with serviceSchema
3. updateService validates with serviceUpdateSchema
4. toggleServiceActive updates only activo field
5. Page shows all services including inactive
6. Dialog form shows/hides variable price fields correctly
7. Price format uses Colombian locale
</verification>

<success_criteria>
- src/app/(protected)/servicios/actions.ts: CRUD actions with validation
- src/app/(protected)/servicios/page.tsx: Admin page with table and dialogs
- src/components/services/: Form and table components
- Admin can manage full service lifecycle
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments-core/04-07-SUMMARY.md`
</output>
