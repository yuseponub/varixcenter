---
phase: 03-appointments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - supabase/migrations/003_appointments.sql
autonomous: true

must_haves:
  truths:
    - "FullCalendar packages are installed and importable"
    - "sonner package is installed for toast notifications"
    - "Appointments table exists with overlap prevention constraint"
    - "RLS policies allow staff to manage appointments"
  artifacts:
    - path: "package.json"
      provides: "FullCalendar and sonner dependencies"
      contains: "@fullcalendar/react"
    - path: "supabase/migrations/003_appointments.sql"
      provides: "Appointments table with exclusion constraint"
      contains: "EXCLUDE USING gist"
  key_links:
    - from: "appointments.doctor_id"
      to: "auth.users.id"
      via: "foreign key"
      pattern: "REFERENCES auth.users"
    - from: "appointments.patient_id"
      to: "patients.id"
      via: "foreign key"
      pattern: "REFERENCES public.patients"
---

<objective>
Install FullCalendar packages, sonner for toasts, and create appointments database schema with PostgreSQL exclusion constraint for overlap prevention.

Purpose: Establish the foundation for the appointments feature - npm dependencies and database structure must exist before any components or queries can be built.
Output: FullCalendar packages installed, sonner installed, appointments table created with RLS and btree_gist exclusion constraint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-appointments/03-RESEARCH.md
@.planning/phases/03-appointments/03-CONTEXT.md
@src/types/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install FullCalendar and sonner packages</name>
  <files>package.json</files>
  <action>
Install FullCalendar v6.1.x packages as specified in 03-RESEARCH.md plus sonner for toast notifications:

```bash
npm install @fullcalendar/react@^6.1.20 @fullcalendar/core@^6.1.20 @fullcalendar/timegrid@^6.1.20 @fullcalendar/interaction@^6.1.20 @fullcalendar/daygrid@^6.1.20 sonner
```

These packages provide:
- @fullcalendar/react: React wrapper (uses Preact internally, compatible with React 19)
- @fullcalendar/core: Core engine + locale support (esLocale bundled)
- @fullcalendar/timegrid: Day and week time views (APT-01)
- @fullcalendar/interaction: Drag-drop, click, select (tablet support)
- @fullcalendar/daygrid: Month view (optional future use)
- sonner: Toast notification library (used for success/error feedback in calendar)

Verify packages are correctly added to dependencies.
  </action>
  <verify>
- `npm ls @fullcalendar/react` shows installed version
- `npm ls sonner` shows installed version
- `npm run build` passes (no import errors)
  </verify>
  <done>FullCalendar packages and sonner installed in package.json dependencies section</done>
</task>

<task type="auto">
  <name>Task 2: Create appointments database migration</name>
  <files>supabase/migrations/003_appointments.sql</files>
  <action>
Create migration file at `supabase/migrations/003_appointments.sql` with:

1. **Enable btree_gist extension** (required for exclusion constraint):
```sql
CREATE EXTENSION IF NOT EXISTS btree_gist;
```

2. **Create appointment_status enum** (from CONTEXT.md):
```sql
CREATE TYPE public.appointment_status AS ENUM (
  'programada',
  'confirmada',
  'en_sala',
  'en_atencion',
  'completada',
  'cancelada',
  'no_asistio'
);
```

3. **Create appointments table**:
```sql
CREATE TABLE public.appointments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES public.patients(id) ON DELETE RESTRICT,
  doctor_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE RESTRICT,

  -- Time range
  fecha_hora_inicio TIMESTAMPTZ NOT NULL,
  fecha_hora_fin TIMESTAMPTZ NOT NULL,

  -- Status (APT-03) - using enum type
  estado public.appointment_status NOT NULL DEFAULT 'programada',

  -- Optional fields
  notas TEXT,
  motivo_consulta TEXT,

  -- Audit
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Constraints
  CONSTRAINT valid_time_range CHECK (fecha_hora_fin > fecha_hora_inicio),

  -- CRITICAL: Prevent overlapping appointments for same doctor
  -- Only applies to active appointments (not cancelled/no-show)
  CONSTRAINT no_overlapping_appointments
    EXCLUDE USING gist (
      doctor_id WITH =,
      tstzrange(fecha_hora_inicio, fecha_hora_fin, '[)') WITH &&
    ) WHERE (estado NOT IN ('cancelada', 'no_asistio'))
);
```

4. **Create indexes**:
```sql
CREATE INDEX idx_appointments_patient ON public.appointments(patient_id);
CREATE INDEX idx_appointments_doctor ON public.appointments(doctor_id);
CREATE INDEX idx_appointments_fecha ON public.appointments(fecha_hora_inicio);
CREATE INDEX idx_appointments_estado ON public.appointments(estado);
```

5. **Create updated_at trigger**:
```sql
CREATE TRIGGER set_appointments_updated_at
  BEFORE UPDATE ON public.appointments
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at();
```

6. **Create RLS policies** (all staff roles can manage appointments):
```sql
ALTER TABLE public.appointments ENABLE ROW LEVEL SECURITY;

-- All authenticated staff can view appointments
CREATE POLICY "Staff can view appointments"
  ON public.appointments FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.user_roles
      WHERE user_id = auth.uid()
      AND role IN ('admin', 'medico', 'enfermera', 'secretaria')
    )
  );

-- All staff can create appointments
CREATE POLICY "Staff can create appointments"
  ON public.appointments FOR INSERT
  TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.user_roles
      WHERE user_id = auth.uid()
      AND role IN ('admin', 'medico', 'enfermera', 'secretaria')
    )
  );

-- All staff can update appointments (per CONTEXT.md - any role can cancel)
CREATE POLICY "Staff can update appointments"
  ON public.appointments FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.user_roles
      WHERE user_id = auth.uid()
      AND role IN ('admin', 'medico', 'enfermera', 'secretaria')
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.user_roles
      WHERE user_id = auth.uid()
      AND role IN ('admin', 'medico', 'enfermera', 'secretaria')
    )
  );

-- Only admin can delete appointments (soft delete via estado = 'cancelada' preferred)
CREATE POLICY "Admin can delete appointments"
  ON public.appointments FOR DELETE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.user_roles
      WHERE user_id = auth.uid()
      AND role = 'admin'
    )
  );
```

7. **Create audit trigger** (following 01-04 pattern):
```sql
CREATE TRIGGER tr_audit_appointments
  AFTER INSERT OR UPDATE OR DELETE ON public.appointments
  FOR EACH ROW
  EXECUTE FUNCTION public.log_audit_event();
```

8. **Grant permissions**:
```sql
GRANT SELECT, INSERT, UPDATE, DELETE ON public.appointments TO authenticated;
```
  </action>
  <verify>
- Migration file exists at `supabase/migrations/003_appointments.sql`
- File contains: CREATE EXTENSION btree_gist, CREATE TYPE appointment_status, CREATE TABLE appointments, EXCLUDE USING gist constraint, RLS policies
- SQL syntax is valid (no obvious errors)
  </verify>
  <done>
- appointments table schema created with all 7 states as enum
- btree_gist exclusion constraint prevents double-booking
- RLS allows staff to manage, only admin can DELETE
- Audit trigger logs all changes
  </done>
</task>

</tasks>

<verification>
1. `npm ls @fullcalendar/react` shows version 6.1.x installed
2. `npm ls sonner` shows installed version
3. `npm run build` passes without errors
4. Migration file exists with btree_gist extension and exclusion constraint
5. Migration includes RLS policies for all staff roles
</verification>

<success_criteria>
- FullCalendar packages (react, core, timegrid, interaction, daygrid) installed
- sonner toast library installed
- appointments table migration ready with enum type for estado
- Exclusion constraint prevents overlapping appointments per doctor
- RLS policies match CONTEXT.md (any role can cancel, admin-only DELETE)
- Audit trigger follows existing tr_audit_{table} pattern
</success_criteria>

<output>
After completion, create `.planning/phases/03-appointments/03-01-SUMMARY.md`
</output>
