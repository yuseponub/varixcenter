---
phase: 15-dashboard-inventory
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/036_dashboard_inventory.sql
autonomous: true

must_haves:
  truths:
    - "Products table has umbral_alerta column with default 3"
    - "Inventory adjustment RPC validates admin/medico role"
    - "Adjustment RPC creates movement record with stock snapshots"
  artifacts:
    - path: "supabase/migrations/036_dashboard_inventory.sql"
      provides: "umbral_alerta column and adjustment RPC"
      contains: "umbral_alerta"
  key_links:
    - from: "create_inventory_adjustment RPC"
      to: "medias_stock_movements"
      via: "INSERT movement record"
      pattern: "INSERT INTO.*medias_stock_movements"
---

<objective>
Add database infrastructure for dashboard inventory features: per-product stock alert threshold and inventory adjustment RPC with role validation.

Purpose: Enable configurable low-stock alerts and admin/medico inventory adjustments with full audit trail.
Output: Migration file with umbral_alerta column and create_inventory_adjustment RPC function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-dashboard-inventory/15-CONTEXT.md
@.planning/phases/15-dashboard-inventory/15-RESEARCH.md
@supabase/migrations/020_medias_foundation.sql
@supabase/migrations/034_medias_returns_rpc.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for umbral_alerta and adjustment RPC</name>
  <files>supabase/migrations/036_dashboard_inventory.sql</files>
  <action>
Create migration 036_dashboard_inventory.sql with:

1. Add umbral_alerta column to medias_products:
   - INTEGER NOT NULL DEFAULT 3
   - Comment: "Umbral para alertas de stock critico. Alerta cuando stock_normal < umbral_alerta"

2. Create create_inventory_adjustment RPC function:
   - Parameters: p_product_id UUID, p_cantidad INTEGER, p_tipo TEXT ('entrada' or 'salida'), p_stock_type TEXT ('normal' or 'devoluciones'), p_razon TEXT
   - SECURITY DEFINER, search_path = public
   - Role validation: Check JWT app_metadata.user_role IN ('admin', 'medico'), raise EXCEPTION if not authorized
   - Get current user ID from auth.uid()
   - Lock product row FOR UPDATE
   - Validate stock doesn't go negative on salida
   - Update appropriate stock column (stock_normal or stock_devoluciones)
   - Create movement record with tipo = ajuste_entrada or ajuste_salida
   - Movement referencia_tipo = 'ajuste'
   - Movement notas = p_razon
   - Return JSONB with success status, new stock values, movement_id

3. Add verification block checking:
   - umbral_alerta column exists with default 3
   - RPC function exists
   - All existing products have umbral_alerta = 3

Follow patterns from 034_medias_returns_rpc.sql for role validation and RPC structure.
  </action>
  <verify>
Run `cat supabase/migrations/036_dashboard_inventory.sql` and verify:
- ALTER TABLE adds umbral_alerta INTEGER NOT NULL DEFAULT 3
- Function create_inventory_adjustment exists with role check
- Stock validation prevents negative
- Movement record created with snapshots
  </verify>
  <done>Migration file creates umbral_alerta column and adjustment RPC with role validation, stock validation, and movement logging</done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/036_dashboard_inventory.sql
- [ ] umbral_alerta column added with DEFAULT 3
- [ ] create_inventory_adjustment RPC validates admin/medico role
- [ ] RPC prevents negative stock on salida
- [ ] RPC creates movement record with before/after snapshots
</verification>

<success_criteria>
Database has umbral_alerta column on products and RPC for inventory adjustments that validates roles, prevents negative stock, and logs all movements.
</success_criteria>

<output>
After completion, create `.planning/phases/15-dashboard-inventory/15-01-SUMMARY.md`
</output>
