---
phase: 08-reports-alerts
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - supabase/migrations/029_reports_rpc.sql
  - src/lib/queries/reports.ts
  - src/lib/queries/alerts.ts
  - src/app/(protected)/reportes/actions.ts
autonomous: true

must_haves:
  truths:
    - "RPC function returns aggregated income report"
    - "Query functions fetch alerts with filters"
    - "Server action resolves alerts with user tracking"
  artifacts:
    - path: "supabase/migrations/029_reports_rpc.sql"
      provides: "get_income_report and get_daily_income_breakdown RPC functions"
      exports: ["get_income_report", "get_daily_income_breakdown"]
    - path: "src/lib/queries/reports.ts"
      provides: "getIncomeReport, getDailyIncomeBreakdown functions"
      min_lines: 30
    - path: "src/lib/queries/alerts.ts"
      provides: "getAlerts, getUnreadAlertCount, getAlertById functions"
      min_lines: 40
    - path: "src/app/(protected)/reportes/actions.ts"
      provides: "getReportData, resolveAlert server actions"
      contains: "use server"
  key_links:
    - from: "src/lib/queries/reports.ts"
      to: "supabase RPC"
      via: "supabase.rpc('get_income_report')"
      pattern: "rpc\\('get_income_report'"
    - from: "src/lib/queries/alerts.ts"
      to: "alerts table"
      via: "supabase.from('alerts')"
      pattern: "from\\('alerts'\\)"
---

<objective>
Create RPC functions for report aggregation and query functions for alerts.

Purpose: Provides efficient database-side aggregation for financial reports and CRUD operations for alerts.
Output: RPC migration, query functions for reports and alerts, server actions for data fetching.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-reports-alerts/08-CONTEXT.md
@.planning/phases/08-reports-alerts/08-RESEARCH.md

# Prior phase outputs
@.planning/phases/08-reports-alerts/08-01-SUMMARY.md
@.planning/phases/08-reports-alerts/08-02-SUMMARY.md

# Existing patterns
@src/lib/queries/payments.ts (query function pattern)
@src/lib/queries/cash-closings.ts (query function pattern)
@supabase/migrations/016_cash_closing_rpc.sql (RPC function pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create report RPC functions migration</name>
  <files>supabase/migrations/029_reports_rpc.sql</files>
  <action>
Create migration 029_reports_rpc.sql with two RPC functions:

1. get_income_report(p_start_date DATE, p_end_date DATE):
   - Returns JSON with aggregated totals
   - Aggregates from payments table joined with payment_methods
   - Only counts 'activo' payments for grand_total
   - Counts anulaciones separately
   - Counts citas_atendidas from appointments with estado='completada'

   Return structure:
   ```json
   {
     "total_efectivo": number,
     "total_tarjeta": number,
     "total_transferencia": number,
     "total_nequi": number,
     "total_descuentos": number,
     "total_anulaciones": number,
     "grand_total": number,
     "payment_count": number,
     "citas_atendidas": number
   }
   ```

2. get_daily_income_breakdown(p_start_date DATE, p_end_date DATE):
   - Returns JSON array of daily totals
   - Groups by DATE(p.created_at)
   - Orders by date ASC

   Return structure:
   ```json
   [
     {
       "fecha": "2026-01-26",
       "efectivo": number,
       "tarjeta": number,
       "transferencia": number,
       "nequi": number,
       "total": number
     }
   ]
   ```

Both functions:
- SECURITY DEFINER
- GRANT EXECUTE TO authenticated
- Use COALESCE for null handling
- Filter by DATE(p.created_at) BETWEEN p_start_date AND p_end_date
- Only include 'activo' payments in method totals
  </action>
  <verify>
- File exists: `ls supabase/migrations/029_reports_rpc.sql`
- Has two functions: `grep -c "CREATE OR REPLACE FUNCTION" supabase/migrations/029_reports_rpc.sql` shows 2
- Has grants: `grep -c "GRANT EXECUTE" supabase/migrations/029_reports_rpc.sql` shows 2
- Returns JSON: `grep "RETURNS JSON" supabase/migrations/029_reports_rpc.sql`
  </verify>
  <done>Report RPC functions created for income aggregation and daily breakdown</done>
</task>

<task type="auto">
  <name>Task 2: Create report and alert query functions</name>
  <files>src/lib/queries/reports.ts, src/lib/queries/alerts.ts</files>
  <action>
Create src/lib/queries/reports.ts:
1. Import createClient from '@/lib/supabase/server'
2. Import types from '@/types/reports'

3. getIncomeReport(filters: ReportFilters): Promise<IncomeReport>
   - Calls supabase.rpc('get_income_report', { p_start_date, p_end_date })
   - Returns typed IncomeReport

4. getDailyIncomeBreakdown(filters: ReportFilters): Promise<DailyIncomeData[]>
   - Calls supabase.rpc('get_daily_income_breakdown', { p_start_date, p_end_date })
   - Returns array of DailyIncomeData

Create src/lib/queries/alerts.ts:
1. Import createClient from '@/lib/supabase/server'
2. Import Alert type from '@/types/alerts'

3. getAlerts(filters?: { resuelta?: boolean, limit?: number }): Promise<Alert[]>
   - Queries alerts table with optional resuelta filter
   - Orders by created_at DESC
   - Default limit 20

4. getUnreadAlertCount(): Promise<number>
   - Counts alerts where resuelta = false
   - Uses { count: 'exact', head: true }

5. getAlertById(id: string): Promise<Alert | null>
   - Fetches single alert by ID

6. markAlertResolved(id: string, userId: string, notas: string): Promise<Alert>
   - Updates alert with resuelta=true, resuelta_por, resuelta_at=now(), resuelta_notas
   - Returns updated alert
  </action>
  <verify>
- Files exist: `ls src/lib/queries/reports.ts src/lib/queries/alerts.ts`
- Reports has functions: `grep -c "export async function" src/lib/queries/reports.ts` shows 2
- Alerts has functions: `grep -c "export async function" src/lib/queries/alerts.ts` shows 4
- Uses RPC: `grep "rpc(" src/lib/queries/reports.ts`
- Uses from: `grep "from('alerts')" src/lib/queries/alerts.ts`
  </verify>
  <done>Query functions created for reports (RPC calls) and alerts (CRUD)</done>
</task>

<task type="auto">
  <name>Task 3: Create server actions for reports page</name>
  <files>src/app/(protected)/reportes/actions.ts</files>
  <action>
Create src/app/(protected)/reportes/actions.ts with 'use server':

1. Import createClient from '@/lib/supabase/server'
2. Import query functions from '@/lib/queries/reports' and '@/lib/queries/alerts'
3. Import validation schema from '@/lib/validations/alerts'
4. Import revalidatePath from 'next/cache'

5. getReportData(startDate: string, endDate: string):
   - Auth check: get user role from session
   - Role check: only admin/medico allowed
   - Return { error } if unauthorized
   - Calls getIncomeReport and getDailyIncomeBreakdown
   - Returns { report, dailyBreakdown }

6. resolveAlertAction(formData: FormData):
   - Auth check: get user and role from session
   - Role check: only admin/medico allowed
   - Parse and validate with resolveAlertSchema
   - Call markAlertResolved with user.id
   - revalidatePath('/dashboard')
   - Return { success: true } or { error }

Follow existing action patterns:
- Extract role from JWT payload
- Return { error: string } on failure
- Return typed data on success
  </action>
  <verify>
- File exists: `ls src/app/(protected)/reportes/actions.ts`
- Has use server: `grep "'use server'" src/app/(protected)/reportes/actions.ts`
- Has getReportData: `grep "getReportData" src/app/(protected)/reportes/actions.ts`
- Has resolveAlertAction: `grep "resolveAlertAction" src/app/(protected)/reportes/actions.ts`
- Auth checks: `grep -c "get_user_role\|role" src/app/(protected)/reportes/actions.ts` shows multiple
  </verify>
  <done>Server actions created with role-based access control for reports and alert resolution</done>
</task>

</tasks>

<verification>
1. Migration syntax valid: Review SQL for syntax errors
2. Query functions type-check: `npx tsc --noEmit src/lib/queries/reports.ts src/lib/queries/alerts.ts`
3. Server actions type-check: `npx tsc --noEmit src/app/(protected)/reportes/actions.ts`
4. All imports resolve correctly
</verification>

<success_criteria>
- RPC migration (029) with get_income_report and get_daily_income_breakdown
- src/lib/queries/reports.ts with typed RPC wrappers
- src/lib/queries/alerts.ts with CRUD operations
- src/app/(protected)/reportes/actions.ts with role-protected server actions
- Only admin/medico can access reports and resolve alerts
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-alerts/08-03-SUMMARY.md`
</output>
