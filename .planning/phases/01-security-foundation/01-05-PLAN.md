---
phase: 01-security-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - docs/SETUP.md
  - supabase/config.toml
autonomous: false

must_haves:
  truths:
    - "User can sign in with email/password"
    - "User role appears in dashboard after sign-in"
    - "Audit log captures login-related actions"
    - "RLS verification returns 0 vulnerable tables"
  artifacts:
    - path: "docs/SETUP.md"
      provides: "Setup instructions for new developers"
      min_lines: 50
    - path: "supabase/config.toml"
      provides: "Local Supabase configuration"
      contains: "custom_access_token"
  key_links:
    - from: "supabase/config.toml"
      to: "public.custom_access_token_hook"
      via: "hook configuration"
      pattern: "custom_access_token_hook"
---

<objective>
Complete security foundation with setup documentation and verification checkpoint.

Purpose: Document the setup process and verify all security requirements are met through human testing.
Output: Setup documentation and verified working auth system with role-based access.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-RESEARCH.md
@.planning/phases/01-security-foundation/01-03-SUMMARY.md
@.planning/phases/01-security-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase local config</name>
  <files>supabase/config.toml</files>
  <action>
Create local Supabase configuration with custom access token hook enabled:

```toml
# supabase/config.toml
# Local development configuration for Supabase

[api]
enabled = true
port = 54321
schemas = ["public", "graphql_public"]
extra_search_path = ["public", "extensions"]
max_rows = 1000

[db]
port = 54322
shadow_port = 54320
major_version = 15

[studio]
enabled = true
port = 54323
api_url = "http://127.0.0.1"

[inbucket]
enabled = true
port = 54324
smtp_port = 54325
pop3_port = 54326

[storage]
enabled = true
file_size_limit = "50MiB"

[auth]
enabled = true
site_url = "http://127.0.0.1:3000"
additional_redirect_urls = ["http://localhost:3000"]
jwt_expiry = 3600
enable_refresh_token_rotation = true
refresh_token_reuse_interval = 10
enable_signup = false  # Only admin can create users for clinic

[auth.email]
enable_signup = false
double_confirm_changes = true
enable_confirmations = false  # Skip email confirmation for clinic internal users

[auth.sms]
enable_signup = false
enable_confirmations = false

# Custom Access Token Hook - CRITICAL for role-based access
[auth.hook.custom_access_token]
enabled = true
uri = "pg-functions://postgres/public/custom_access_token_hook"

# Rate limiting
[auth.rate_limit]
email_sent = 60  # emails per hour per user

[realtime]
enabled = true

[analytics]
enabled = false
```

IMPORTANT NOTES:
- `enable_signup = false` because only admin creates clinic users
- Custom access token hook MUST be enabled for roles to work
- This config is for local `supabase start`, production uses Dashboard settings
  </action>
  <verify>
    - File exists at supabase/config.toml
    - Contains [auth.hook.custom_access_token] section
    - Hook URI points to custom_access_token_hook function
  </verify>
  <done>Supabase local config created with custom access token hook</done>
</task>

<task type="auto">
  <name>Task 2: Create setup documentation</name>
  <files>docs/SETUP.md</files>
  <action>
Create comprehensive setup documentation:

```markdown
# VarixClinic - Guia de Configuracion

## Requisitos Previos

- Node.js 18+ (recomendado 20 LTS)
- npm o pnpm
- Cuenta de Supabase (https://supabase.com)
- Git

## 1. Clonar y Configurar

```bash
git clone <repo-url>
cd varix-clinic
npm install
```

## 2. Configurar Supabase

### 2.1 Crear Proyecto en Supabase

1. Ir a https://supabase.com/dashboard
2. Click "New project"
3. Configurar:
   - Name: `varixclinic` (o similar)
   - Database Password: guardar en lugar seguro
   - Region: South America (Sao Paulo) - mas cercano a Colombia

### 2.2 Obtener Credenciales

En Supabase Dashboard -> Project Settings -> API:

1. **Project URL**: Copiar `https://xxx.supabase.co`
2. **anon public key**: Copiar (empieza con `eyJ...`)
3. **service_role key**: Copiar (secreto, solo backend)

### 2.3 Configurar Variables de Entorno

```bash
cp .env.local.example .env.local
```

Editar `.env.local`:
```
NEXT_PUBLIC_SUPABASE_URL=https://tu-proyecto.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...tu-anon-key
SUPABASE_SERVICE_ROLE_KEY=eyJ...tu-service-role-key
```

## 3. Aplicar Migraciones

### Opcion A: Via Supabase Dashboard (recomendado para produccion)

1. Ir a SQL Editor en Supabase Dashboard
2. Ejecutar cada archivo en orden:
   - `supabase/migrations/001_user_roles.sql`
   - `supabase/migrations/002_audit_infrastructure.sql`
   - `supabase/migrations/003_custom_access_token_hook.sql`
   - `supabase/migrations/004_audit_user_roles.sql`
   - `supabase/migrations/005_rls_verification.sql`
   - `supabase/seed.sql`

### Opcion B: Via CLI (desarrollo local)

```bash
# Instalar Supabase CLI si no esta instalado
npm install -g supabase

# Iniciar Supabase local
supabase start

# Aplicar migraciones
supabase db push
```

## 4. Habilitar Custom Access Token Hook

**CRITICO: Sin esto, los roles no funcionan.**

1. Ir a Authentication -> Hooks en Supabase Dashboard
2. Encontrar "Custom Access Token"
3. Habilitar el toggle
4. Seleccionar funcion: `public.custom_access_token_hook`
5. Guardar

## 5. Crear Primer Usuario Admin

### 5.1 Crear Usuario

En Authentication -> Users -> Add user:
- Email: tu-email@ejemplo.com
- Password: contrasena segura
- Click "Create user"

### 5.2 Asignar Rol Admin

Opcion A - Via SQL Editor:
```sql
-- Obtener el UUID del usuario recien creado
SELECT id, email FROM auth.users WHERE email = 'tu-email@ejemplo.com';

-- Asignar rol admin (reemplazar UUID)
INSERT INTO public.user_roles (user_id, role)
VALUES ('uuid-del-usuario', 'admin');
```

Opcion B - Via la app (despues de hacer login):
```sql
-- Ejecutar como el usuario autenticado
SELECT public.bootstrap_first_admin();
```

**IMPORTANTE:** Despues de asignar el rol, cerrar sesion y volver a entrar para que el token JWT se actualice con el nuevo rol.

## 6. Iniciar Desarrollo

```bash
npm run dev
```

Abrir http://localhost:3000

## 7. Verificar Configuracion

### Verificar Login
1. Ir a /login
2. Ingresar credenciales del admin creado
3. Dashboard debe mostrar: email + rol "Administrador"

### Verificar RLS
En SQL Editor ejecutar:
```sql
SELECT * FROM public.verify_rls_enabled();
```
Debe retornar 0 filas (todas las tablas protegidas).

### Verificar Auditoria
Despues de algunas acciones, verificar en SQL Editor:
```sql
SELECT * FROM public.audit_log ORDER BY changed_at DESC LIMIT 10;
```

## Solucionar Problemas

### "Sin rol asignado" en dashboard
- Verificar que el custom access token hook esta habilitado
- Verificar que existe registro en user_roles para el usuario
- Cerrar sesion y volver a entrar (el token se actualiza al login)

### Error de autenticacion
- Verificar variables de entorno en .env.local
- Verificar que el proyecto Supabase esta activo
- Revisar consola del navegador para errores

### RLS blocking queries
- Verificar que el usuario tiene rol asignado
- Verificar politicas RLS de la tabla en cuestion
- Usar service_role key temporalmente para debug (solo desarrollo)

## Crear Usuarios Adicionales

Solo el admin puede crear usuarios. Usar Authentication -> Users en Dashboard.

Para asignar rol:
```sql
SELECT public.assign_role('email@ejemplo.com', 'medico');
-- Roles disponibles: admin, medico, enfermera, secretaria
```

## Estructura del Proyecto

```
varix-clinic/
├── src/
│   ├── app/
│   │   ├── (auth)/login/     # Pagina de login
│   │   └── (protected)/      # Rutas protegidas
│   ├── lib/supabase/         # Clientes Supabase
│   └── types/                # TypeScript types
├── supabase/
│   ├── migrations/           # SQL migrations
│   └── config.toml           # Config local
└── docs/
    └── SETUP.md              # Esta guia
```
```

This documentation covers the complete setup process in Spanish, matching the PROJECT.md language requirement.
  </action>
  <verify>
    - File exists at docs/SETUP.md
    - Contains Supabase setup instructions
    - Contains migration application steps
    - Contains custom access token hook setup
    - Contains first admin creation steps
    - Contains verification steps
  </verify>
  <done>Complete setup documentation created in Spanish</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete security foundation:
    - Next.js 15 project with Supabase SSR auth
    - Login page with email/password
    - Role-based access (admin, medico, enfermera, secretaria)
    - Audit logging infrastructure
    - RLS on all tables
    - Custom access token hook for JWT role injection
  </what-built>
  <how-to-verify>
    1. **Setup Supabase** (if not done):
       - Create Supabase project
       - Apply migrations via SQL Editor
       - Enable Custom Access Token Hook in Auth -> Hooks
       - Create test user in Auth -> Users
       - Assign admin role via bootstrap_first_admin() or SQL

    2. **Test Authentication**:
       - Run `npm run dev`
       - Visit http://localhost:3000
       - Verify redirect to /login
       - Login with test user credentials
       - Verify dashboard shows email and role

    3. **Test Session Persistence**:
       - Refresh the page
       - Verify still logged in
       - Sign out
       - Verify redirected to login

    4. **Test RLS Verification**:
       - In Supabase SQL Editor run: `SELECT * FROM public.verify_rls_enabled();`
       - Should return 0 rows (all tables protected)

    5. **Test Audit Log**:
       - In Supabase SQL Editor run: `SELECT * FROM public.audit_log ORDER BY changed_at DESC LIMIT 5;`
       - Should show recent role assignment

    6. **Verify Success Criteria**:
       - [ ] Usuario puede iniciar sesion con email/contrasena y mantener sesion activa
       - [ ] Sistema distingue 4 roles (Admin, Medico, Enfermera, Secretaria) con permisos diferenciados
       - [ ] Toda accion de usuario queda registrada en log con quien, que, cuando, IP
       - [ ] RLS esta habilitado en TODAS las tablas (verificable con verify_rls_enabled())
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Human verification checkpoint covers all success criteria from ROADMAP.md Phase 1:
1. Login with email/password works
2. Role displays correctly in dashboard
3. Audit log captures actions
4. RLS verification passes
</verification>

<success_criteria>
- Setup documentation complete and accurate
- Supabase local config enables custom access token hook
- Human verification confirms all Phase 1 success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-05-SUMMARY.md`
</output>
