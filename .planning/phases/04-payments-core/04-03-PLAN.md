---
phase: 04-payments-core
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/payments.ts
  - src/types/services.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript types match database schema exactly"
    - "Payment status const array exists for runtime validation"
    - "Payment method types include comprobante requirement"
  artifacts:
    - path: "src/types/payments.ts"
      provides: "Payment, PaymentItem, PaymentMethod types"
      contains: "PAYMENT_STATES"
    - path: "src/types/services.ts"
      provides: "Service type with variable price fields"
      contains: "precio_variable"
  key_links:
    - from: "src/types/index.ts"
      to: "payments.ts, services.ts"
      via: "re-export"
      pattern: "export.*from.*payments|services"
---

<objective>
Create TypeScript type definitions for services and payments.

Purpose: Ensure compile-time type safety matching the database schema.
Output: Type definition files for services and payments with status constants
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-payments-core/04-RESEARCH.md

Reference existing patterns:
@src/types/appointments.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create services type definitions</name>
  <files>src/types/services.ts</files>
  <action>
Create src/types/services.ts with:

1. **Service interface matching database:**
```typescript
export interface Service {
  id: string
  nombre: string
  descripcion: string | null
  precio_base: number
  precio_variable: boolean
  precio_minimo: number | null
  precio_maximo: number | null
  activo: boolean
  created_at: string
  updated_at: string
  created_by: string | null
}
```

2. **ServiceInsert type (for creation):**
```typescript
export interface ServiceInsert {
  nombre: string
  descripcion?: string | null
  precio_base: number
  precio_variable?: boolean
  precio_minimo?: number | null
  precio_maximo?: number | null
  activo?: boolean
}
```

3. **ServiceUpdate type (for editing):**
```typescript
export interface ServiceUpdate {
  nombre?: string
  descripcion?: string | null
  precio_base?: number
  precio_variable?: boolean
  precio_minimo?: number | null
  precio_maximo?: number | null
  activo?: boolean
}
```

4. **Helper type for service selection in payment form:**
```typescript
export interface ServiceOption {
  id: string
  nombre: string
  precio_base: number
  precio_variable: boolean
  precio_minimo: number | null
  precio_maximo: number | null
}
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/types/services.ts 2>&1 | head -20
```
  </verify>
  <done>src/types/services.ts exists with Service, ServiceInsert, ServiceUpdate, and ServiceOption interfaces matching database schema</done>
</task>

<task type="auto">
  <name>Task 2: Create payments type definitions</name>
  <files>src/types/payments.ts</files>
  <action>
Create src/types/payments.ts with:

1. **Payment status constants (like APPOINTMENT_STATES):**
```typescript
export const PAYMENT_STATES = ['activo', 'anulado'] as const
export type PaymentStatus = typeof PAYMENT_STATES[number]

export function isValidPaymentStatus(status: unknown): status is PaymentStatus {
  return typeof status === 'string' && PAYMENT_STATES.includes(status as PaymentStatus)
}
```

2. **Payment method constants:**
```typescript
export const PAYMENT_METHODS = ['efectivo', 'tarjeta', 'transferencia', 'nequi'] as const
export type PaymentMethodType = typeof PAYMENT_METHODS[number]

export const PAYMENT_METHOD_LABELS: Record<PaymentMethodType, string> = {
  efectivo: 'Efectivo',
  tarjeta: 'Tarjeta',
  transferencia: 'Transferencia',
  nequi: 'Nequi'
}

// Methods that require comprobante photo
export const ELECTRONIC_METHODS: PaymentMethodType[] = ['tarjeta', 'transferencia', 'nequi']

export function requiresComprobante(metodo: PaymentMethodType): boolean {
  return ELECTRONIC_METHODS.includes(metodo)
}
```

3. **Payment interface:**
```typescript
export interface Payment {
  id: string
  patient_id: string
  numero_factura: string
  subtotal: number
  descuento: number
  descuento_justificacion: string | null
  total: number
  estado: PaymentStatus
  anulado_por: string | null
  anulado_at: string | null
  anulacion_justificacion: string | null
  created_by: string
  created_at: string
}
```

4. **PaymentItem interface (snapshot of service):**
```typescript
export interface PaymentItem {
  id: string
  payment_id: string
  service_id: string
  service_name: string  // snapshot
  unit_price: number    // snapshot
  quantity: number
  subtotal: number
  created_at: string
}
```

5. **PaymentMethod interface:**
```typescript
export interface PaymentMethod {
  id: string
  payment_id: string
  metodo: PaymentMethodType
  monto: number
  comprobante_path: string | null
  created_at: string
}
```

6. **Payment with relations (for display):**
```typescript
export interface PaymentWithDetails extends Payment {
  patients: {
    id: string
    cedula: string
    nombre: string
    apellido: string
  }
  payment_items: PaymentItem[]
  payment_methods: PaymentMethod[]
}
```

7. **Form data types (for server actions):**
```typescript
export interface PaymentItemInput {
  service_id: string
  service_name: string
  unit_price: number
  quantity: number
}

export interface PaymentMethodInput {
  metodo: PaymentMethodType
  monto: number
  comprobante_path: string | null
}
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/types/payments.ts 2>&1 | head -20
```
  </verify>
  <done>src/types/payments.ts exists with PAYMENT_STATES, PAYMENT_METHODS, requiresComprobante helper, Payment, PaymentItem, PaymentMethod interfaces, and PaymentWithDetails for display</done>
</task>

<task type="auto">
  <name>Task 3: Update types index to export new types</name>
  <files>src/types/index.ts</files>
  <action>
Update src/types/index.ts to re-export new types:

Add these exports:
```typescript
// Re-export payment types
export * from './payments'

// Re-export service types
export * from './services'
```

Keep existing exports for supabase, appointments.
  </action>
  <verify>
```bash
npx tsc --noEmit src/types/index.ts 2>&1 | head -10
```
  </verify>
  <done>src/types/index.ts re-exports payments and services types alongside existing exports</done>
</task>

</tasks>

<verification>
1. All types compile without errors
2. PAYMENT_STATES matches database enum
3. PAYMENT_METHODS matches database enum
4. requiresComprobante returns true for tarjeta/transferencia/nequi
5. PaymentWithDetails includes nested relations
6. Types index exports all new types
</verification>

<success_criteria>
- src/types/services.ts: Service types with variable price support
- src/types/payments.ts: Payment types with status/method constants, comprobante helper
- src/types/index.ts: Re-exports all types
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments-core/04-03-SUMMARY.md`
</output>
