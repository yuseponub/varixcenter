---
phase: 13-purchases
plan: 09
type: execute
wave: 5
depends_on: ["13-06", "13-07", "13-08"]
files_modified:
  - src/app/(protected)/compras/page.tsx
  - src/app/(protected)/compras/nueva/page.tsx
  - src/app/(protected)/compras/nueva/new-purchase-flow.tsx
  - src/app/(protected)/compras/[id]/page.tsx
  - src/app/(protected)/compras/[id]/purchase-detail-actions.tsx
  - src/app/(protected)/compras/[id]/cancel-purchase-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Purchases list page shows table with filters"
    - "New purchase page has OCR-assisted flow"
    - "Detail page shows purchase with items and actions"
    - "Reception confirmation available on detail page"
  artifacts:
    - path: "src/app/(protected)/compras/page.tsx"
      provides: "Purchases list page"
      exports: ["default"]
    - path: "src/app/(protected)/compras/nueva/page.tsx"
      provides: "New purchase flow"
      exports: ["default"]
    - path: "src/app/(protected)/compras/[id]/page.tsx"
      provides: "Purchase detail page"
      exports: ["default"]
  key_links:
    - from: "src/app/(protected)/compras/page.tsx"
      to: "src/lib/queries/purchases.ts"
      via: "getPurchases call"
      pattern: "getPurchases"
    - from: "src/app/(protected)/compras/nueva/new-purchase-flow.tsx"
      to: "src/components/purchases/purchase-form.tsx"
      via: "PurchaseForm import"
      pattern: "import.*PurchaseForm.*from.*@/components/purchases/purchase-form"
---

<objective>
Create purchase pages: list, new purchase flow, and detail view

Purpose: Complete UI for purchase management including OCR-assisted creation
Output: Three pages for purchase CRUD operations
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-purchases/13-CONTEXT.md
@src/app/(protected)/medias/ventas/page.tsx
@src/app/(protected)/medias/ventas/nueva/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create purchases list page</name>
  <files>src/app/(protected)/compras/page.tsx</files>
  <action>
Create list page following existing patterns:

```typescript
import { Metadata } from 'next'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import { getPurchases, countPurchasesByEstado } from '@/lib/queries/purchases'
import { PurchasesTable } from '@/components/purchases/purchases-table'
import { Badge } from '@/components/ui/badge'

export const metadata: Metadata = {
  title: 'Compras | VarixClinic',
  description: 'Gestion de compras de mercancia',
}

export default async function ComprasPage() {
  const [purchases, counts] = await Promise.all([
    getPurchases(),
    countPurchasesByEstado(),
  ])

  return (
    <div className="container mx-auto py-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Compras</h1>
          <p className="text-gray-500">
            Registro de compras de mercancia
          </p>
        </div>
        <Link href="/compras/nueva">
          <Button>
            <Plus className="mr-2 h-4 w-4" />
            Nueva Compra
          </Button>
        </Link>
      </div>

      {/* Stats badges */}
      <div className="flex gap-4">
        <div className="flex items-center gap-2">
          <Badge variant="secondary" className="text-sm">
            {counts.pendiente_recepcion}
          </Badge>
          <span className="text-sm text-gray-600">Pendientes de recepcion</span>
        </div>
        <div className="flex items-center gap-2">
          <Badge variant="default" className="text-sm">
            {counts.recibido}
          </Badge>
          <span className="text-sm text-gray-600">Recibidos</span>
        </div>
      </div>

      {/* Purchases table */}
      <PurchasesTable purchases={purchases} />
    </div>
  )
}
```
  </action>
  <verify>
Run: `cat src/app/(protected)/compras/page.tsx | head -40`
Verify: Server component with getPurchases and table
  </verify>
  <done>
- Purchases list page created
- Shows stats badges (pendientes, recibidos)
- Links to new purchase page
- Renders PurchasesTable component
  </done>
</task>

<task type="auto">
  <name>Task 2: Create new purchase page with OCR flow</name>
  <files>
    src/app/(protected)/compras/nueva/page.tsx
    src/app/(protected)/compras/nueva/new-purchase-flow.tsx
  </files>
  <action>
Create new purchase page with multi-step flow that imports PurchaseForm from 13-08:

```typescript
// src/app/(protected)/compras/nueva/page.tsx
import { Metadata } from 'next'
import { getProductsForMatching } from '@/lib/queries/purchases'
import { NewPurchaseFlow } from './new-purchase-flow'

export const metadata: Metadata = {
  title: 'Nueva Compra | VarixClinic',
  description: 'Registrar nueva compra de mercancia',
}

export default async function NuevaCompraPage() {
  const products = await getProductsForMatching()

  return (
    <div className="container mx-auto py-6 max-w-4xl">
      <h1 className="text-2xl font-bold mb-6">Nueva Compra</h1>
      <NewPurchaseFlow products={products} />
    </div>
  )
}
```

Create the client component for the flow (imports PurchaseForm):

```typescript
// src/app/(protected)/compras/nueva/new-purchase-flow.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Loader2, ArrowLeft, ArrowRight } from 'lucide-react'
import { toast } from 'sonner'
import { InvoiceUpload } from '@/components/purchases/invoice-upload'
import { OCRProductReview } from '@/components/purchases/ocr-product-review'
import { PurchaseForm, calculatePurchaseTotal } from '@/components/purchases/purchase-form'
import { createPurchase } from '@/app/(protected)/compras/actions'
import type { OCRInvoiceResult, PurchaseItemInput } from '@/types/purchases'

interface Product {
  id: string
  codigo: string
  tipo: string
  talla: string
  precio: number
}

interface NewPurchaseFlowProps {
  products: Product[]
}

type FlowStep = 'upload' | 'review' | 'form' | 'saving'

export function NewPurchaseFlow({ products }: NewPurchaseFlowProps) {
  const router = useRouter()
  const [step, setStep] = useState<FlowStep>('upload')
  const [invoicePath, setInvoicePath] = useState<string | null>(null)
  const [ocrResult, setOcrResult] = useState<OCRInvoiceResult | null>(null)

  // Form state (controlled by PurchaseForm)
  const [proveedor, setProveedor] = useState('')
  const [fechaFactura, setFechaFactura] = useState('')
  const [numeroFactura, setNumeroFactura] = useState('')
  const [notas, setNotas] = useState('')
  const [items, setItems] = useState<PurchaseItemInput[]>([])

  const handleUploadComplete = (path: string, ocr?: OCRInvoiceResult) => {
    setInvoicePath(path)
    if (ocr && ocr.productos.length > 0) {
      setOcrResult(ocr)
      // Pre-fill form fields from OCR
      if (ocr.proveedor) setProveedor(ocr.proveedor)
      if (ocr.fecha_factura) setFechaFactura(ocr.fecha_factura)
      if (ocr.numero_factura) setNumeroFactura(ocr.numero_factura)
      setStep('review')
    } else {
      // No OCR results, go directly to form
      setStep('form')
    }
  }

  const handleOCRConfirm = (
    confirmedItems: PurchaseItemInput[],
    metadata: { proveedor?: string; fecha_factura?: string; numero_factura?: string; total?: number }
  ) => {
    setItems(confirmedItems)
    if (metadata.proveedor && !proveedor) setProveedor(metadata.proveedor)
    if (metadata.fecha_factura && !fechaFactura) setFechaFactura(metadata.fecha_factura)
    if (metadata.numero_factura && !numeroFactura) setNumeroFactura(metadata.numero_factura)
    setStep('form')
  }

  const handleOCRSkip = () => {
    setStep('form')
  }

  const handleSubmit = async () => {
    if (!invoicePath) {
      toast.error('Debe subir la foto de la factura')
      return
    }

    if (!proveedor || !fechaFactura) {
      toast.error('Proveedor y fecha de factura son obligatorios')
      return
    }

    if (items.length === 0 || items.some((i) => !i.product_id)) {
      toast.error('Debe agregar al menos un producto')
      return
    }

    setStep('saving')

    try {
      const result = await createPurchase({
        proveedor,
        fecha_factura: fechaFactura,
        numero_factura: numeroFactura || null,
        total: calculatePurchaseTotal(items),
        factura_path: invoicePath,
        notas: notas || null,
        items,
      })

      if (result.success) {
        toast.success('Compra registrada', {
          description: `Numero: ${result.numero_compra}`,
        })
        router.push(`/compras/${result.purchase_id}`)
      } else {
        toast.error('Error', { description: result.error })
        setStep('form')
      }
    } catch (error) {
      toast.error('Error inesperado')
      setStep('form')
    }
  }

  return (
    <div className="space-y-6">
      {/* Step 1: Upload Invoice */}
      {step === 'upload' && (
        <InvoiceUpload
          onUploadComplete={handleUploadComplete}
          onError={(msg) => toast.error(msg)}
        />
      )}

      {/* Step 2: Review OCR Results */}
      {step === 'review' && ocrResult && (
        <OCRProductReview
          ocrResult={ocrResult}
          products={products}
          onConfirm={handleOCRConfirm}
          onSkip={handleOCRSkip}
        />
      )}

      {/* Step 3: Form (using PurchaseForm component) */}
      {(step === 'form' || step === 'saving') && (
        <div className="space-y-6">
          <PurchaseForm
            products={products}
            proveedor={proveedor}
            setProveedor={setProveedor}
            fechaFactura={fechaFactura}
            setFechaFactura={setFechaFactura}
            numeroFactura={numeroFactura}
            setNumeroFactura={setNumeroFactura}
            notas={notas}
            setNotas={setNotas}
            items={items}
            setItems={setItems}
            disabled={step === 'saving'}
          />

          {/* Actions */}
          <div className="flex gap-4">
            <Button
              variant="outline"
              onClick={() => setStep('upload')}
              disabled={step === 'saving'}
            >
              <ArrowLeft className="h-4 w-4 mr-1" />
              Cambiar Factura
            </Button>
            <Button
              className="flex-1"
              onClick={handleSubmit}
              disabled={step === 'saving' || !invoicePath || items.length === 0}
            >
              {step === 'saving' ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Guardando...
                </>
              ) : (
                <>
                  <ArrowRight className="h-4 w-4 mr-2" />
                  Registrar Compra
                </>
              )}
            </Button>
          </div>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>
Run: `ls -la src/app/(protected)/compras/nueva/`
Verify: page.tsx and new-purchase-flow.tsx exist
Run: `grep -E "import.*PurchaseForm" src/app/(protected)/compras/nueva/new-purchase-flow.tsx`
Verify: PurchaseForm is imported from @/components/purchases/purchase-form
  </verify>
  <done>
- New purchase page created
- Server component loads products for matching
- Client component manages multi-step flow
- Step 1: Upload invoice (triggers OCR)
- Step 2: Review OCR results (if available)
- Step 3: Uses PurchaseForm component (from Plan 13-08)
- calculatePurchaseTotal imported from PurchaseForm
- Submits via createPurchase action
  </done>
</task>

<task type="auto">
  <name>Task 3: Create purchase detail page</name>
  <files>
    src/app/(protected)/compras/[id]/page.tsx
    src/app/(protected)/compras/[id]/purchase-detail-actions.tsx
    src/app/(protected)/compras/[id]/cancel-purchase-dialog.tsx
  </files>
  <action>
Create detail page with actions:

```typescript
// src/app/(protected)/compras/[id]/page.tsx
import { Metadata } from 'next'
import { notFound } from 'next/navigation'
import Link from 'next/link'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { ArrowLeft, FileText, PackageCheck, Trash2 } from 'lucide-react'
import { getPurchaseById } from '@/lib/queries/purchases'
import { getInvoicePublicUrl } from '@/lib/storage/purchases'
import { PurchaseStatusBadge } from '@/components/purchases/purchase-status-badge'
import { PurchaseDetailActions } from './purchase-detail-actions'

export const metadata: Metadata = {
  title: 'Detalle de Compra | VarixClinic',
}

interface PageProps {
  params: Promise<{ id: string }>
}

export default async function CompraDetailPage({ params }: PageProps) {
  const { id } = await params
  const purchase = await getPurchaseById(id)

  if (!purchase) {
    notFound()
  }

  const invoiceUrl = purchase.factura_path
    ? await getInvoicePublicUrl(purchase.factura_path)
    : null

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
    }).format(amount)
  }

  return (
    <div className="container mx-auto py-6 max-w-4xl space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link href="/compras">
            <Button variant="ghost" size="icon">
              <ArrowLeft className="h-4 w-4" />
            </Button>
          </Link>
          <div>
            <h1 className="text-2xl font-bold font-mono">
              {purchase.numero_compra}
            </h1>
            <p className="text-gray-500">
              {format(new Date(purchase.created_at), "dd 'de' MMMM, yyyy", {
                locale: es,
              })}
            </p>
          </div>
        </div>
        <PurchaseStatusBadge estado={purchase.estado} />
      </div>

      {/* Actions (client component) */}
      <PurchaseDetailActions
        purchaseId={purchase.id}
        numeroCompra={purchase.numero_compra}
        estado={purchase.estado}
        itemCount={purchase.items.length}
      />

      {/* Purchase Info */}
      <div className="grid grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Informacion de Factura</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div>
              <p className="text-sm text-gray-500">Proveedor</p>
              <p className="font-medium">{purchase.proveedor}</p>
            </div>
            <div>
              <p className="text-sm text-gray-500">Fecha de Factura</p>
              <p className="font-medium">
                {format(new Date(purchase.fecha_factura), 'dd/MM/yyyy')}
              </p>
            </div>
            {purchase.numero_factura && (
              <div>
                <p className="text-sm text-gray-500">Numero de Factura</p>
                <p className="font-medium">{purchase.numero_factura}</p>
              </div>
            )}
            <div>
              <p className="text-sm text-gray-500">Total</p>
              <p className="text-xl font-bold">{formatCurrency(purchase.total)}</p>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Documento</CardTitle>
          </CardHeader>
          <CardContent>
            {invoiceUrl ? (
              <a
                href={invoiceUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-3 p-4 border rounded-lg hover:bg-gray-50 transition-colors"
              >
                <FileText className="h-10 w-10 text-red-500" />
                <div>
                  <p className="font-medium">Ver Factura</p>
                  <p className="text-sm text-gray-500">
                    Abrir en nueva pestana
                  </p>
                </div>
              </a>
            ) : (
              <p className="text-gray-500">No hay documento adjunto</p>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Reception Info (if received) */}
      {purchase.estado === 'recibido' && purchase.recibido_at && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <PackageCheck className="h-5 w-5 text-green-600" />
              Recepcion Confirmada
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-gray-500">
              Confirmado el{' '}
              {format(new Date(purchase.recibido_at), "dd/MM/yyyy 'a las' HH:mm", {
                locale: es,
              })}
            </p>
          </CardContent>
        </Card>
      )}

      {/* Anulacion Info (if cancelled) */}
      {purchase.estado === 'anulado' && purchase.anulado_at && (
        <Card className="border-red-200 bg-red-50">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-red-700">
              <Trash2 className="h-5 w-5" />
              Compra Anulada
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-gray-600">
              Anulada el{' '}
              {format(new Date(purchase.anulado_at), "dd/MM/yyyy 'a las' HH:mm", {
                locale: es,
              })}
            </p>
            {purchase.anulacion_justificacion && (
              <p className="mt-2 text-sm">
                <span className="font-medium">Motivo:</span>{' '}
                {purchase.anulacion_justificacion}
              </p>
            )}
          </CardContent>
        </Card>
      )}

      {/* Items Table */}
      <Card>
        <CardHeader>
          <CardTitle>
            Productos ({purchase.items.length})
          </CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Codigo</TableHead>
                <TableHead>Tipo</TableHead>
                <TableHead>Talla</TableHead>
                <TableHead className="text-right">Cantidad</TableHead>
                <TableHead className="text-right">Costo Unit.</TableHead>
                <TableHead className="text-right">Subtotal</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {purchase.items.map((item) => (
                <TableRow key={item.id}>
                  <TableCell className="font-mono">{item.product_codigo}</TableCell>
                  <TableCell>{item.product_tipo}</TableCell>
                  <TableCell>{item.product_talla}</TableCell>
                  <TableCell className="text-right">{item.cantidad}</TableCell>
                  <TableCell className="text-right">
                    {formatCurrency(item.costo_unitario)}
                  </TableCell>
                  <TableCell className="text-right font-medium">
                    {formatCurrency(item.subtotal)}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* Notes */}
      {purchase.notas && (
        <Card>
          <CardHeader>
            <CardTitle>Notas</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="whitespace-pre-wrap">{purchase.notas}</p>
          </CardContent>
        </Card>
      )}
    </div>
  )
}
```

Create the client component for actions:

```typescript
// src/app/(protected)/compras/[id]/purchase-detail-actions.tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { PackageCheck, Trash2 } from 'lucide-react'
import { ConfirmReceptionDialog } from '@/components/purchases/confirm-reception-dialog'
import { CancelPurchaseDialog } from './cancel-purchase-dialog'
import type { PurchaseState } from '@/types/purchases'

interface PurchaseDetailActionsProps {
  purchaseId: string
  numeroCompra: string
  estado: PurchaseState
  itemCount: number
}

export function PurchaseDetailActions({
  purchaseId,
  numeroCompra,
  estado,
  itemCount,
}: PurchaseDetailActionsProps) {
  const [showConfirmDialog, setShowConfirmDialog] = useState(false)
  const [showCancelDialog, setShowCancelDialog] = useState(false)

  if (estado === 'anulado') {
    return null // No actions for cancelled purchases
  }

  return (
    <div className="flex gap-2">
      {estado === 'pendiente_recepcion' && (
        <Button onClick={() => setShowConfirmDialog(true)}>
          <PackageCheck className="h-4 w-4 mr-2" />
          Confirmar Recepcion
        </Button>
      )}

      <Button
        variant="outline"
        className="text-red-600 hover:text-red-700"
        onClick={() => setShowCancelDialog(true)}
      >
        <Trash2 className="h-4 w-4 mr-2" />
        Anular Compra
      </Button>

      <ConfirmReceptionDialog
        open={showConfirmDialog}
        onOpenChange={setShowConfirmDialog}
        purchaseId={purchaseId}
        numeroCompra={numeroCompra}
        itemCount={itemCount}
      />

      <CancelPurchaseDialog
        open={showCancelDialog}
        onOpenChange={setShowCancelDialog}
        purchaseId={purchaseId}
        numeroCompra={numeroCompra}
        estado={estado}
      />
    </div>
  )
}
```

Create cancel dialog:

```typescript
// src/app/(protected)/compras/[id]/cancel-purchase-dialog.tsx
'use client'

import { useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { Label } from '@/components/ui/label'
import { Loader2, Trash2 } from 'lucide-react'
import { cancelPurchase } from '@/app/(protected)/compras/actions'
import { useRouter } from 'next/navigation'
import { toast } from 'sonner'
import type { PurchaseState } from '@/types/purchases'

interface CancelPurchaseDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  purchaseId: string
  numeroCompra: string
  estado: PurchaseState
}

export function CancelPurchaseDialog({
  open,
  onOpenChange,
  purchaseId,
  numeroCompra,
  estado,
}: CancelPurchaseDialogProps) {
  const [justificacion, setJustificacion] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()

  const handleCancel = async () => {
    if (justificacion.length < 10) {
      toast.error('La justificacion debe tener al menos 10 caracteres')
      return
    }

    setIsLoading(true)
    try {
      const result = await cancelPurchase(purchaseId, justificacion)

      if (result.success) {
        toast.success('Compra anulada')
        onOpenChange(false)
        router.refresh()
      } else {
        toast.error('Error', {
          description: result.error || 'No se pudo anular la compra',
        })
      }
    } catch (error) {
      toast.error('Error inesperado')
    } finally {
      setIsLoading(false)
    }
  }

  const willReverseStock = estado === 'recibido'

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-red-600">
            <Trash2 className="h-5 w-5" />
            Anular Compra
          </DialogTitle>
          <DialogDescription>
            Esta accion anulara la compra{' '}
            <span className="font-mono font-medium">{numeroCompra}</span>.
          </DialogDescription>
        </DialogHeader>

        {willReverseStock && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-sm">
            <p className="font-medium text-red-800 mb-1">Atencion:</p>
            <p className="text-red-700">
              Esta compra ya fue recibida. El stock sera revertido automaticamente.
            </p>
          </div>
        )}

        <div>
          <Label>
            Justificacion <span className="text-red-500">*</span>
          </Label>
          <Textarea
            value={justificacion}
            onChange={(e) => setJustificacion(e.target.value)}
            placeholder="Explique el motivo de la anulacion (minimo 10 caracteres)"
            className="mt-1"
            disabled={isLoading}
          />
        </div>

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isLoading}
          >
            Cancelar
          </Button>
          <Button
            variant="destructive"
            onClick={handleCancel}
            disabled={isLoading || justificacion.length < 10}
          >
            {isLoading ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Anulando...
              </>
            ) : (
              <>
                <Trash2 className="mr-2 h-4 w-4" />
                Anular Compra
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```
  </action>
  <verify>
Run: `ls -la src/app/(protected)/compras/[id]/`
Verify: page.tsx and supporting components exist
  </verify>
  <done>
- Purchase detail page created
- Shows purchase info, items table, invoice link
- Client component handles actions (confirm reception, cancel)
- ConfirmReceptionDialog for stock increment
- CancelPurchaseDialog with justification requirement
- Shows warning about stock reversal if already received
  </done>
</task>

</tasks>

<verification>
- [ ] /compras page shows purchases list with filters
- [ ] /compras/nueva has OCR-assisted multi-step flow
- [ ] /compras/nueva imports PurchaseForm from components
- [ ] /compras/[id] shows purchase details with items
- [ ] Confirm reception dialog works
- [ ] Cancel purchase dialog requires justification
- [ ] Navigation between pages works correctly
</verification>

<success_criteria>
- Users can register purchases with OCR assistance
- Pending purchases appear first in list
- Reception confirmation increments stock
- Admin/medico can cancel with justification
- Full audit trail maintained
</success_criteria>

<output>
After completion, create `.planning/phases/13-purchases/13-09-SUMMARY.md`
</output>
