---
phase: 08-reports-alerts
plan: 06
type: execute
wave: 4
depends_on: ["08-03", "08-04", "08-05"]
files_modified:
  - src/app/(protected)/reportes/page.tsx
  - src/app/(protected)/dashboard/page.tsx
  - src/app/(protected)/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Admin/Medico can view income reports with date filtering"
    - "Dashboard shows alerts widget for Admin/Medico"
    - "Navigation shows alert badge with unread count"
    - "Reports page displays chart and summary cards"
  artifacts:
    - path: "src/app/(protected)/reportes/page.tsx"
      provides: "Reports page with chart and summary cards"
      min_lines: 80
    - path: "src/app/(protected)/dashboard/page.tsx"
      provides: "Dashboard with alerts widget"
      contains: "AlertsWidget"
    - path: "src/app/(protected)/layout.tsx"
      provides: "Navigation with alert badge"
      contains: "AlertBadge"
  key_links:
    - from: "src/app/(protected)/reportes/page.tsx"
      to: "src/app/(protected)/reportes/actions.ts"
      via: "getReportData"
      pattern: "getReportData"
    - from: "src/app/(protected)/dashboard/page.tsx"
      to: "src/lib/queries/alerts.ts"
      via: "getAlerts"
      pattern: "getAlerts"
---

<objective>
Create reports page and integrate alerts into dashboard and navigation.

Purpose: Completes Phase 8 by providing the user-facing pages for financial reporting and anomaly alerting.
Output: Working reports page with charts, dashboard with alerts widget, navigation with alert badge.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-reports-alerts/08-CONTEXT.md
@.planning/phases/08-reports-alerts/08-RESEARCH.md

# Prior phase outputs
@.planning/phases/08-reports-alerts/08-03-SUMMARY.md (actions)
@.planning/phases/08-reports-alerts/08-04-SUMMARY.md (alert components)
@.planning/phases/08-reports-alerts/08-05-SUMMARY.md (report components)

# Existing pages
@src/app/(protected)/dashboard/page.tsx
@src/app/(protected)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reports page</name>
  <files>src/app/(protected)/reportes/page.tsx</files>
  <action>
Create src/app/(protected)/reportes/page.tsx:

This is a mixed page: Server component that fetches initial data, with client components for interactivity.

1. Create a client wrapper component ReportsPageClient ('use client') that handles:
   - State for startDate, endDate
   - State for report data and dailyBreakdown
   - DateRangePicker with onRangeChange
   - Fetches data via getReportData action when dates change
   - Displays loading state

2. Server component (default export) that:
   - Gets user role from session
   - If not admin/medico, show "Acceso denegado" message
   - Fetches initial data for today's date
   - Renders ReportsPageClient with initial data

3. ReportsPageClient renders:
   - Page title "Reportes Financieros"
   - DateRangePicker component
   - Grid of ReportSummaryCard components:
     - Total Ingresos (grand_total) - variant success
     - Efectivo (total_efectivo)
     - Tarjeta (total_tarjeta)
     - Transferencia (total_transferencia)
     - Nequi (total_nequi)
     - Descuentos (total_descuentos)
     - Anulaciones (total_anulaciones) - variant warning
     - Pagos Registrados (payment_count)
     - Citas Atendidas (citas_atendidas)
   - IncomeBarChart with dailyBreakdown data
   - Use formatCurrency for monetary values

Icons for cards (from lucide-react):
- Total: DollarSign
- Efectivo: Banknote
- Tarjeta: CreditCard
- Transferencia: ArrowRightLeft
- Nequi: Smartphone
- Descuentos: Percent
- Anulaciones: XCircle
- Pagos: FileText
- Citas: Calendar

Layout:
- Summary cards in grid: 3 columns on lg, 2 on md, 1 on sm
- Chart below cards, full width
  </action>
  <verify>
- File exists: `ls src/app/(protected)/reportes/page.tsx`
- Has role check: `grep "admin\|medico" src/app/(protected)/reportes/page.tsx`
- Uses DateRangePicker: `grep "DateRangePicker" src/app/(protected)/reportes/page.tsx`
- Uses IncomeBarChart: `grep "IncomeBarChart" src/components/reports/income-bar-chart.tsx`
- Uses ReportSummaryCard: `grep "ReportSummaryCard" src/app/(protected)/reportes/page.tsx`
  </verify>
  <done>Reports page created with date filtering, summary cards, and income chart</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard with alerts widget</name>
  <files>src/app/(protected)/dashboard/page.tsx</files>
  <action>
Update src/app/(protected)/dashboard/page.tsx:

1. Add imports:
   - getAlerts from '@/lib/queries/alerts'
   - AlertsWidget from '@/components/alerts/alerts-widget'

2. In the server component:
   - Get user role from session (existing code)
   - If role is admin or medico, fetch unresolved alerts: getAlerts({ resuelta: false, limit: 10 })

3. Update the render:
   - Keep existing welcome/role/status cards
   - Below existing content, add conditional section for admin/medico:
     - Section title "Panel de Seguridad"
     - AlertsWidget with fetched alerts
   - Keep the existing "Fase 1" note at the bottom

4. If user is NOT admin/medico, don't show the alerts section (they shouldn't see it per requirements)

Layout:
- Existing cards stay as-is (grid 3 cols)
- AlertsWidget below in full width section
- Use Card wrapper with title "Alertas de Seguridad"
  </action>
  <verify>
- File modified: `grep "AlertsWidget" src/app/(protected)/dashboard/page.tsx`
- Has conditional: `grep -c "admin\|medico" src/app/(protected)/dashboard/page.tsx` shows multiple
- Fetches alerts: `grep "getAlerts" src/app/(protected)/dashboard/page.tsx`
  </verify>
  <done>Dashboard updated with alerts widget visible only to Admin/Medico</done>
</task>

<task type="auto">
  <name>Task 3: Update navigation with alert badge and reportes link</name>
  <files>src/app/(protected)/layout.tsx</files>
  <action>
Update src/app/(protected)/layout.tsx:

1. Add imports:
   - AlertBadge from '@/components/alerts/alert-badge'
   - Link from 'next/link'

2. Add navigation links section between logo and user info:
   - Create nav links array based on role:
     - Dashboard: /dashboard (all roles)
     - Pacientes: /pacientes (all roles)
     - Citas: /citas (all roles)
     - Pagos: /pagos (all roles)
     - Servicios: /servicios (admin, medico only)
     - Reportes: /reportes (admin, medico only)
     - Medias: /medias/productos (all roles for now)

3. Add AlertBadge next to user email (before sign out button):
   - Only render for admin/medico roles
   - Wrap in Link to /dashboard (clicking goes to dashboard to see alerts)
   - Add hover styling

4. Keep existing sign out button

Navigation styling:
- Horizontal nav links with space-x-4
- Active link detection using pathname (client component or just always show all)
- Text-sm text-gray-600 hover:text-gray-900

Note: For simplicity, make navigation links static (no active state highlighting). Just add the links.

AlertBadge placement:
- In the right section, before email
- `<Link href="/dashboard"><AlertBadge /></Link>` wrapped in flex with gap
  </action>
  <verify>
- File modified: `grep "AlertBadge" src/app/(protected)/layout.tsx`
- Has nav links: `grep -c "Link href" src/app/(protected)/layout.tsx` shows multiple
- Has reportes link: `grep "/reportes" src/app/(protected)/layout.tsx`
- Conditional badge: `grep -c "admin\|medico" src/app/(protected)/layout.tsx` shows multiple for role checks
  </verify>
  <done>Navigation updated with links and alert badge for Admin/Medico</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete reports and alerts system: reports page with charts, dashboard alerts widget, navigation badge</what-built>
  <how-to-verify>
1. Login as admin or medico user
2. Check navigation bar shows alert badge (bell icon) and "Reportes" link
3. Click "Reportes" - should see:
   - Date range picker (Diario/Mensual/Rango buttons)
   - Summary cards with financial totals
   - Bar chart showing income by payment method
4. Go to Dashboard - should see:
   - Existing welcome cards
   - "Alertas de Seguridad" section with AlertsWidget
   - If there are alerts, they should show with severity styling
5. Click "Resolver" on an alert - dialog should open with notas textarea
6. Submit resolution - alert should disappear from unresolved list, badge count should update

Test alert generation (requires database access):
- Anular a payment -> should create 'pago_anulado' alert (advertencia)
- Create cash closing with diferencia != 0 -> should create 'diferencia_cierre' alert

Note: If no alerts exist, the widget should show "No hay alertas pendientes"
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. All pages type-check: `npx tsc --noEmit`
2. Reports page accessible at /reportes
3. Dashboard shows alerts widget for admin/medico
4. Navigation has alert badge that updates
5. Role-based access control working (non-admin/medico denied)
</verification>

<success_criteria>
- src/app/(protected)/reportes/page.tsx: Full reports page with chart and cards
- src/app/(protected)/dashboard/page.tsx: Alerts widget integrated
- src/app/(protected)/layout.tsx: Navigation with links and alert badge
- Only Admin/Medico can see reports and alerts
- Alert badge shows unread count (or hidden if 0)
- Reports show real data from payments and appointments
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-alerts/08-06-SUMMARY.md`
</output>
