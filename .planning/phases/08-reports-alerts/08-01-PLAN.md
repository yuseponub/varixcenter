---
phase: 08-reports-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/ui/chart.tsx
  - supabase/migrations/027_alerts_table.sql
  - supabase/migrations/028_alert_triggers.sql
autonomous: true

must_haves:
  truths:
    - "Recharts is installed and chart component exists"
    - "Alerts table exists with proper schema"
    - "Payment annulation automatically creates alert"
    - "Cash closing with difference automatically creates alert"
  artifacts:
    - path: "src/components/ui/chart.tsx"
      provides: "ChartContainer, ChartTooltip, ChartLegend components"
      min_lines: 50
    - path: "supabase/migrations/027_alerts_table.sql"
      provides: "alerts table with ENUMs and RLS"
      contains: "CREATE TABLE alerts"
    - path: "supabase/migrations/028_alert_triggers.sql"
      provides: "Triggers for payment anulacion and cierre diferencia"
      contains: "CREATE TRIGGER"
  key_links:
    - from: "supabase/migrations/028_alert_triggers.sql"
      to: "payments table"
      via: "AFTER UPDATE trigger"
      pattern: "tr_alert_payment_anulacion"
    - from: "supabase/migrations/028_alert_triggers.sql"
      to: "cash_closings table"
      via: "AFTER INSERT trigger"
      pattern: "tr_alert_cierre_diferencia"
---

<objective>
Install Recharts chart library via shadcn/ui and create database infrastructure for alerts system.

Purpose: Establishes the foundation for financial reporting (charts) and anomaly alerting (database tables and auto-triggers).
Output: Working chart component, alerts table with RLS, automatic alert generation on payment anulacion and cash closing diferencia.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-reports-alerts/08-CONTEXT.md
@.planning/phases/08-reports-alerts/08-RESEARCH.md

# Key existing files
@supabase/migrations/010_payments_immutability.sql (payment anulacion pattern)
@supabase/migrations/015_cash_closings.sql (cierre schema)
@src/app/globals.css (has chart CSS variables --chart-1 through --chart-5)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui chart component with React 19 compatibility</name>
  <files>package.json, src/components/ui/chart.tsx</files>
  <action>
1. Add react-is override to package.json for React 19 compatibility:
   ```json
   "overrides": {
     "react-is": "^19.0.0"
   }
   ```

2. Run shadcn CLI to add chart component:
   ```bash
   npx shadcn@latest add chart
   ```

3. If prompted about dependencies, use --legacy-peer-deps

4. Verify chart.tsx exists in src/components/ui/ with ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent exports

5. Verify recharts is in package.json dependencies

Note: The project already has chart CSS variables defined in globals.css (--chart-1 through --chart-5), so no CSS changes needed.
  </action>
  <verify>
- `cat package.json | grep -A2 '"overrides"'` shows react-is override
- `cat package.json | grep recharts` shows recharts dependency
- `ls src/components/ui/chart.tsx` exists
- `grep -c "ChartContainer\|ChartTooltip" src/components/ui/chart.tsx` shows multiple exports
  </verify>
  <done>Recharts installed via shadcn/ui chart component with React 19 compatibility override</done>
</task>

<task type="auto">
  <name>Task 2: Create alerts table migration with ENUMs and RLS</name>
  <files>supabase/migrations/027_alerts_table.sql</files>
  <action>
Create migration 027_alerts_table.sql with:

1. Create ENUMs:
   - alert_tipo: 'pago_anulado', 'diferencia_cierre'
   - alert_severidad: 'info', 'advertencia', 'critico'

2. Create alerts table:
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - tipo alert_tipo NOT NULL
   - severidad alert_severidad NOT NULL
   - titulo VARCHAR(100) NOT NULL
   - descripcion TEXT NOT NULL
   - referencia_tipo VARCHAR(50) -- 'payment', 'cash_closing'
   - referencia_id UUID -- ID of related record
   - resuelta BOOLEAN NOT NULL DEFAULT false
   - resuelta_por UUID REFERENCES auth.users(id)
   - resuelta_at TIMESTAMPTZ
   - resuelta_notas TEXT
   - created_at TIMESTAMPTZ NOT NULL DEFAULT now()

3. Create indexes:
   - idx_alerts_created_at ON alerts(created_at DESC)
   - idx_alerts_referencia ON alerts(referencia_tipo, referencia_id)
   - idx_alerts_unread ON alerts(resuelta, created_at DESC)

4. Enable RLS and create policies:
   - SELECT: Only admin/medico can view (using public.get_user_role())
   - UPDATE: Only admin/medico can update (for resolving alerts)
   - INSERT: Allow from trigger (SECURITY DEFINER functions handle this)
  </action>
  <verify>
- File exists: `ls supabase/migrations/027_alerts_table.sql`
- Has ENUMs: `grep -c "CREATE TYPE alert" supabase/migrations/027_alerts_table.sql` shows 2
- Has table: `grep "CREATE TABLE alerts" supabase/migrations/027_alerts_table.sql`
- Has RLS: `grep "ENABLE ROW LEVEL SECURITY" supabase/migrations/027_alerts_table.sql`
- Has indexes: `grep -c "CREATE INDEX" supabase/migrations/027_alerts_table.sql` shows 3
  </verify>
  <done>Alerts table created with proper ENUMs, indexes, and RLS policies for admin/medico access only</done>
</task>

<task type="auto">
  <name>Task 3: Create alert trigger functions and triggers</name>
  <files>supabase/migrations/028_alert_triggers.sql</files>
  <action>
Create migration 028_alert_triggers.sql with:

1. Function generate_payment_anulacion_alert():
   - SECURITY DEFINER (bypasses RLS for insert)
   - Triggers when payment.estado changes from 'activo' to 'anulado'
   - Creates alert with:
     - tipo: 'pago_anulado'
     - severidad: 'advertencia'
     - titulo: 'Pago Anulado'
     - descripcion: format with numero_factura, total, anulacion_justificacion
     - referencia_tipo: 'payment'
     - referencia_id: payment.id

2. Trigger tr_alert_payment_anulacion:
   - AFTER UPDATE ON payments
   - FOR EACH ROW
   - EXECUTE FUNCTION generate_payment_anulacion_alert()

3. Function generate_cierre_diferencia_alert():
   - SECURITY DEFINER
   - Triggers when cash_closings.diferencia != 0
   - Creates alert with:
     - tipo: 'diferencia_cierre'
     - severidad: 'critico' if diferencia < 0 (faltante), 'advertencia' if > 0 (sobrante)
     - titulo: 'Faltante en Cierre' or 'Sobrante en Cierre'
     - descripcion: format with cierre_numero, fecha_cierre, ABS(diferencia), diferencia_justificacion
     - referencia_tipo: 'cash_closing'
     - referencia_id: cash_closing.id

4. Trigger tr_alert_cierre_diferencia:
   - AFTER INSERT ON cash_closings
   - FOR EACH ROW
   - EXECUTE FUNCTION generate_cierre_diferencia_alert()

Note: Use COALESCE for nullable justification fields to show 'Sin motivo' or 'Sin justificacion' if null.
  </action>
  <verify>
- File exists: `ls supabase/migrations/028_alert_triggers.sql`
- Has functions: `grep -c "CREATE OR REPLACE FUNCTION generate_" supabase/migrations/028_alert_triggers.sql` shows 2
- Has triggers: `grep -c "CREATE TRIGGER tr_alert" supabase/migrations/028_alert_triggers.sql` shows 2
- Uses SECURITY DEFINER: `grep -c "SECURITY DEFINER" supabase/migrations/028_alert_triggers.sql` shows 2
  </verify>
  <done>Alert triggers created that auto-generate alerts on payment anulacion and cash closing with diferencia</done>
</task>

</tasks>

<verification>
1. Recharts installed: `npm ls recharts` shows version
2. Chart component exists with exports: `grep "export" src/components/ui/chart.tsx | head -10`
3. Migrations created in correct order (027, 028)
4. All migrations have proper syntax (no SQL errors when reviewed)
</verification>

<success_criteria>
- Recharts 3.x installed with react-is override for React 19
- shadcn/ui chart.tsx component exists with ChartContainer, ChartTooltip, ChartLegend
- alerts table migration (027) with ENUMs, indexes, RLS
- alert triggers migration (028) with payment anulacion and cierre diferencia triggers
- Both triggers use SECURITY DEFINER for RLS bypass
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-alerts/08-01-SUMMARY.md`
</output>
