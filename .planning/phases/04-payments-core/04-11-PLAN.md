---
phase: 04-payments-core
plan: 11
type: execute
wave: 4
depends_on: ["04-08", "04-05"]
files_modified:
  - src/app/(protected)/pagos/page.tsx
  - src/app/(protected)/pagos/[id]/page.tsx
  - src/components/payments/payments-table.tsx
  - src/components/payments/anulacion-dialog.tsx
autonomous: false

must_haves:
  truths:
    - "User can see list of all payments"
    - "User can view payment detail with items and methods"
    - "Admin/Medico can anular payment with justification"
    - "Anulado payments show visual distinction"
  artifacts:
    - path: "src/app/(protected)/pagos/page.tsx"
      provides: "Payments list page"
      contains: "Pagos"
    - path: "src/app/(protected)/pagos/[id]/page.tsx"
      provides: "Payment detail page"
      contains: "PaymentDetail"
    - path: "src/components/payments/anulacion-dialog.tsx"
      provides: "Anulacion dialog with justification"
      contains: "AnulacionDialog"
  key_links:
    - from: "anulacion-dialog.tsx"
      to: "pagos/actions.ts"
      via: "anularPayment action"
      pattern: "anularPayment"
---

<objective>
Create the payments list page, detail page, and anulacion functionality.

Purpose: Allow viewing payments and performing anulacion with proper justification.
Output: Payments list, detail page, table component, and anulacion dialog
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-payments-core/04-05-SUMMARY.md
@.planning/phases/04-payments-core/04-08-SUMMARY.md

Reference existing patterns:
@src/app/(protected)/pacientes/page.tsx
@src/app/(protected)/pacientes/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payments table component</name>
  <files>src/components/payments/payments-table.tsx</files>
  <action>
Create src/components/payments/payments-table.tsx with:

```typescript
'use client'

import Link from 'next/link'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Eye } from 'lucide-react'
import type { PaymentWithDetails } from '@/types/payments'

interface PaymentsTableProps {
  payments: PaymentWithDetails[]
}

const formatCurrency = (amount: number) =>
  new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount)

const formatDate = (dateStr: string) =>
  new Intl.DateTimeFormat('es-CO', {
    dateStyle: 'medium',
    timeStyle: 'short'
  }).format(new Date(dateStr))

export function PaymentsTable({ payments }: PaymentsTableProps) {
  if (payments.length === 0) {
    return (
      <div className="text-center py-12 text-muted-foreground">
        No hay pagos registrados
      </div>
    )
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Factura</TableHead>
          <TableHead>Paciente</TableHead>
          <TableHead>Fecha</TableHead>
          <TableHead className="text-right">Total</TableHead>
          <TableHead>Estado</TableHead>
          <TableHead className="w-[80px]"></TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {payments.map(payment => (
          <TableRow
            key={payment.id}
            className={payment.estado === 'anulado' ? 'opacity-60' : ''}
          >
            <TableCell className="font-mono text-sm">
              {payment.numero_factura}
            </TableCell>
            <TableCell>
              <Link
                href={`/pacientes/${payment.patient_id}`}
                className="hover:underline"
              >
                {payment.patients.nombre} {payment.patients.apellido}
              </Link>
              <p className="text-xs text-muted-foreground">{payment.patients.cedula}</p>
            </TableCell>
            <TableCell className="text-sm">
              {formatDate(payment.created_at)}
            </TableCell>
            <TableCell className="text-right font-medium">
              {formatCurrency(payment.total)}
            </TableCell>
            <TableCell>
              <Badge variant={payment.estado === 'activo' ? 'default' : 'destructive'}>
                {payment.estado === 'activo' ? 'Activo' : 'Anulado'}
              </Badge>
            </TableCell>
            <TableCell>
              <Button asChild variant="ghost" size="icon">
                <Link href={`/pagos/${payment.id}`}>
                  <Eye className="h-4 w-4" />
                  <span className="sr-only">Ver detalle</span>
                </Link>
              </Button>
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  )
}
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/components/payments/payments-table.tsx 2>&1 | head -20
```
  </verify>
  <done>src/components/payments/payments-table.tsx exists with PaymentsTable showing invoice number, patient, date, total, estado badge, and view link</done>
</task>

<task type="auto">
  <name>Task 2: Create anulacion dialog</name>
  <files>src/components/payments/anulacion-dialog.tsx</files>
  <action>
Create src/components/payments/anulacion-dialog.tsx with:

```typescript
'use client'

import { useActionState, useEffect, useState } from 'react'
import { Button } from '@/components/ui/button'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { AlertTriangle, Loader2 } from 'lucide-react'
import { toast } from 'sonner'
import { anularPayment, type PaymentActionState } from '@/app/(protected)/pagos/actions'

interface AnulacionDialogProps {
  paymentId: string
  numeroFactura: string
  onSuccess?: () => void
}

export function AnulacionDialog({ paymentId, numeroFactura, onSuccess }: AnulacionDialogProps) {
  const [open, setOpen] = useState(false)
  const [justificacion, setJustificacion] = useState('')

  const [state, formAction, isPending] = useActionState<PaymentActionState | null, FormData>(
    anularPayment,
    null
  )

  useEffect(() => {
    if (state?.success) {
      toast.success('Pago anulado correctamente')
      setOpen(false)
      setJustificacion('')
      onSuccess?.()
    } else if (state?.error) {
      toast.error(state.error)
    }
  }, [state, onSuccess])

  const handleSubmit = (formData: FormData) => {
    formData.set('payment_id', paymentId)
    formData.set('justificacion', justificacion)
    formAction(formData)
  }

  const isValid = justificacion.trim().length >= 10

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button variant="destructive">Anular Pago</Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <AlertTriangle className="h-5 w-5 text-destructive" />
            Anular Pago {numeroFactura}
          </DialogTitle>
          <DialogDescription>
            Esta accion no se puede deshacer. El pago quedara marcado como anulado
            pero permanecera en el sistema para auditoria.
          </DialogDescription>
        </DialogHeader>

        <form action={handleSubmit} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="justificacion" className="after:content-['*'] after:ml-0.5 after:text-red-500">
              Justificacion de la anulacion
            </Label>
            <Textarea
              id="justificacion"
              value={justificacion}
              onChange={e => setJustificacion(e.target.value)}
              placeholder="Explique la razon por la cual se anula este pago (minimo 10 caracteres)"
              rows={3}
              disabled={isPending}
            />
            <p className="text-xs text-muted-foreground">
              {justificacion.length}/10 caracteres minimos
            </p>
            {state?.errors?.justificacion && (
              <p className="text-sm text-red-500">{state.errors.justificacion[0]}</p>
            )}
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => setOpen(false)}
              disabled={isPending}
            >
              Cancelar
            </Button>
            <Button
              type="submit"
              variant="destructive"
              disabled={isPending || !isValid}
            >
              {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Confirmar Anulacion
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/components/payments/anulacion-dialog.tsx 2>&1 | head -20
```
  </verify>
  <done>src/components/payments/anulacion-dialog.tsx exists with AnulacionDialog that requires 10+ char justification, shows warning, and calls anularPayment action</done>
</task>

<task type="auto">
  <name>Task 3: Create payments list and detail pages</name>
  <files>
    src/app/(protected)/pagos/page.tsx
    src/app/(protected)/pagos/[id]/page.tsx
  </files>
  <action>
Create src/app/(protected)/pagos/page.tsx:

```typescript
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import { getPayments } from '@/lib/queries/payments'
import { PaymentsTable } from '@/components/payments/payments-table'
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb'

export default async function PaymentsPage() {
  const { payments } = await getPayments({ limit: 50 })

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <Breadcrumb>
        <BreadcrumbList>
          <BreadcrumbItem>
            <BreadcrumbLink href="/dashboard">Inicio</BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbPage>Pagos</BreadcrumbPage>
          </BreadcrumbItem>
        </BreadcrumbList>
      </Breadcrumb>

      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold tracking-tight">Pagos</h1>
          <p className="text-muted-foreground">
            Registro de pagos de la clinica
          </p>
        </div>
        <Button asChild>
          <Link href="/pagos/nuevo">
            <Plus className="mr-2 h-4 w-4" />
            Nuevo Pago
          </Link>
        </Button>
      </div>

      {/* Table */}
      <PaymentsTable payments={payments} />
    </div>
  )
}
```

Create src/app/(protected)/pagos/[id]/page.tsx:

```typescript
import { notFound } from 'next/navigation'
import Link from 'next/link'
import { createClient } from '@/lib/supabase/server'
import { getPaymentWithDetails } from '@/lib/queries/payments'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Separator } from '@/components/ui/separator'
import { AnulacionDialog } from '@/components/payments/anulacion-dialog'
import { PAYMENT_METHOD_LABELS } from '@/types/payments'
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb'

interface PaymentDetailPageProps {
  params: Promise<{ id: string }>
}

const formatCurrency = (amount: number) =>
  new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(amount)

const formatDate = (dateStr: string) =>
  new Intl.DateTimeFormat('es-CO', {
    dateStyle: 'full',
    timeStyle: 'short'
  }).format(new Date(dateStr))

async function canAnular(): Promise<boolean> {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return false

  const role = user.app_metadata?.role
  return role === 'admin' || role === 'medico'
}

export default async function PaymentDetailPage({ params }: PaymentDetailPageProps) {
  const { id } = await params
  const [payment, userCanAnular] = await Promise.all([
    getPaymentWithDetails(id),
    canAnular()
  ])

  if (!payment) {
    notFound()
  }

  return (
    <div className="space-y-6">
      {/* Breadcrumb */}
      <Breadcrumb>
        <BreadcrumbList>
          <BreadcrumbItem>
            <BreadcrumbLink href="/dashboard">Inicio</BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbLink href="/pagos">Pagos</BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbPage>{payment.numero_factura}</BreadcrumbPage>
          </BreadcrumbItem>
        </BreadcrumbList>
      </Breadcrumb>

      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-bold tracking-tight font-mono">
              {payment.numero_factura}
            </h1>
            <Badge variant={payment.estado === 'activo' ? 'default' : 'destructive'}>
              {payment.estado === 'activo' ? 'Activo' : 'Anulado'}
            </Badge>
          </div>
          <p className="text-muted-foreground">
            {formatDate(payment.created_at)}
          </p>
        </div>

        {userCanAnular && payment.estado === 'activo' && (
          <AnulacionDialog
            paymentId={payment.id}
            numeroFactura={payment.numero_factura}
          />
        )}
      </div>

      {/* Anulacion info */}
      {payment.estado === 'anulado' && payment.anulacion_justificacion && (
        <Card className="border-destructive">
          <CardHeader className="pb-2">
            <CardTitle className="text-destructive">Pago Anulado</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm">{payment.anulacion_justificacion}</p>
            <p className="text-xs text-muted-foreground mt-2">
              Anulado el {payment.anulado_at ? formatDate(payment.anulado_at) : 'N/A'}
            </p>
          </CardContent>
        </Card>
      )}

      <div className="grid gap-6 md:grid-cols-2">
        {/* Patient info */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Paciente</CardTitle>
          </CardHeader>
          <CardContent>
            <Link href={`/pacientes/${payment.patient_id}`} className="hover:underline font-medium">
              {payment.patients.nombre} {payment.patients.apellido}
            </Link>
            <p className="text-sm text-muted-foreground">{payment.patients.cedula}</p>
          </CardContent>
        </Card>

        {/* Total */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Total</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">{formatCurrency(payment.total)}</p>
            {payment.descuento > 0 && (
              <p className="text-sm text-amber-600">
                Descuento: -{formatCurrency(payment.descuento)}
              </p>
            )}
          </CardContent>
        </Card>
      </div>

      {/* Items */}
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Servicios</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            {payment.payment_items.map(item => (
              <div key={item.id} className="flex justify-between">
                <span>
                  {item.service_name}
                  {item.quantity > 1 && ` x${item.quantity}`}
                </span>
                <span className="font-medium">{formatCurrency(item.subtotal)}</span>
              </div>
            ))}
            <Separator />
            <div className="flex justify-between font-medium">
              <span>Subtotal</span>
              <span>{formatCurrency(payment.subtotal)}</span>
            </div>
            {payment.descuento > 0 && (
              <>
                <div className="flex justify-between text-amber-600">
                  <span>Descuento</span>
                  <span>-{formatCurrency(payment.descuento)}</span>
                </div>
                {payment.descuento_justificacion && (
                  <p className="text-xs text-muted-foreground italic">
                    "{payment.descuento_justificacion}"
                  </p>
                )}
              </>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Payment methods */}
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Metodos de Pago</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {payment.payment_methods.map(method => (
              <div key={method.id} className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span>{PAYMENT_METHOD_LABELS[method.metodo]}</span>
                  {method.comprobante_path && (
                    <Badge variant="outline" className="text-xs">
                      Con comprobante
                    </Badge>
                  )}
                </div>
                <span className="font-medium">{formatCurrency(method.monto)}</span>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```
  </action>
  <verify>
```bash
mkdir -p src/app/\(protected\)/pagos/\[id\]
npx tsc --noEmit src/app/\(protected\)/pagos/page.tsx 2>&1 | head -20
npx tsc --noEmit src/app/\(protected\)/pagos/\[id\]/page.tsx 2>&1 | head -20
```
  </verify>
  <done>Payments list page with PaymentsTable, detail page with items/methods/anulacion info, AnulacionDialog only shown for admin/medico on active payments</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete payments module: list page, detail page, new payment form, service selector, payment methods with comprobante upload, anulacion dialog</what-built>
  <how-to-verify>
    1. Apply migrations: `npx supabase db push`
    2. Start dev server: `npm run dev`
    3. Navigate to /servicios - should see service catalog (admin only)
    4. Add a test service with fixed price
    5. Add a test service with variable price (min/max)
    6. Navigate to /pagos/nuevo
    7. Select a patient
    8. Add services, adjust quantity
    9. For variable price service, adjust price within range
    10. Add descuento and provide justification
    11. Select payment method - if electronic, upload comprobante
    12. Submit and verify invoice number is generated
    13. View payment detail at /pagos/{id}
    14. If admin/medico: test anulacion with justification
    15. Verify anulado badge appears and anulacion info shown
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. All files compile without TypeScript errors
2. Payments list shows all payments with invoice, patient, date, total, estado
3. Detail page shows full payment info including items and methods
4. AnulacionDialog validates 10+ char justification
5. Anular button only shows for admin/medico on active payments
6. Anulado payments show red border card with justification
</verification>

<success_criteria>
- src/app/(protected)/pagos/page.tsx: List with table and new payment button
- src/app/(protected)/pagos/[id]/page.tsx: Full detail with anulacion capability
- src/components/payments/payments-table.tsx: Table with status badges
- src/components/payments/anulacion-dialog.tsx: Dialog with justification
- Human verification confirms complete payment flow works
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments-core/04-11-SUMMARY.md`
</output>
