---
phase: 03-appointments
plan: 06
type: execute
wave: 4
depends_on: ["03-03", "03-04", "03-05"]
files_modified:
  - src/app/(protected)/citas/page.tsx
  - src/components/appointments/appointment-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can view agenda in day and week view (APT-01)"
    - "User can filter by doctor (APT-02)"
    - "Clicking appointment shows detail dialog with status controls"
    - "Appointments transition through states (APT-03)"
  artifacts:
    - path: "src/app/(protected)/citas/page.tsx"
      provides: "Calendar page with doctor filter"
      contains: "AppointmentCalendar"
    - path: "src/components/appointments/appointment-dialog.tsx"
      provides: "Appointment detail dialog"
      contains: "Dialog"
  key_links:
    - from: "src/app/(protected)/citas/page.tsx"
      to: "getAppointmentsForCalendar"
      via: "import"
      pattern: "import.*getAppointmentsForCalendar"
    - from: "src/components/appointments/appointment-dialog.tsx"
      to: "updateAppointmentStatus"
      via: "server action"
      pattern: "updateAppointmentStatus"
---

<objective>
Create the main calendar page with data fetching, doctor filter, and appointment detail dialog.

Purpose: Deliver the core agenda view (APT-01, APT-02) with interactive appointment management.
Output: Fully functional calendar page where users can view, filter, and manage appointments.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-appointments/03-RESEARCH.md
@src/app/(protected)/pacientes/page.tsx
@src/components/appointments/appointment-calendar.tsx
@src/components/appointments/doctor-filter.tsx
@src/lib/queries/appointments.ts
@src/app/(protected)/citas/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create appointment detail dialog</name>
  <files>src/components/appointments/appointment-dialog.tsx</files>
  <action>
Create `src/components/appointments/appointment-dialog.tsx`:

```typescript
'use client'

import { useActionState, useState, useTransition } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { StatusBadge } from './status-badge'
import { AppointmentWithRelations, AppointmentStatus } from '@/types/appointments'
import {
  getAvailableTransitions,
  STATUS_LABELS
} from '@/lib/appointments/state-machine'
import { updateAppointmentStatus } from '@/app/(protected)/citas/actions'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'

interface AppointmentDialogProps {
  appointment: AppointmentWithRelations | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onStatusChange?: () => void
}

/**
 * Appointment detail dialog
 *
 * Shows appointment details and status transition buttons
 * Allows any valid transition per state machine
 */
export function AppointmentDialog({
  appointment,
  open,
  onOpenChange,
  onStatusChange
}: AppointmentDialogProps) {
  const [isPending, startTransition] = useTransition()

  if (!appointment) return null

  const availableTransitions = getAvailableTransitions(appointment.estado)

  const handleStatusChange = (newStatus: AppointmentStatus) => {
    const boundAction = updateAppointmentStatus.bind(null, appointment.id)
    const formData = new FormData()
    formData.append('estado', newStatus)

    startTransition(async () => {
      const result = await boundAction({ success: false, message: '' }, formData)
      if (result.success) {
        onStatusChange?.()
        onOpenChange(false)
      }
    })
  }

  const formatDateTime = (dateString: string) => {
    return format(new Date(dateString), "EEEE d 'de' MMMM, HH:mm", { locale: es })
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            Cita: {appointment.patient.nombre} {appointment.patient.apellido}
            <StatusBadge status={appointment.estado} />
          </DialogTitle>
          <DialogDescription>
            {formatDateTime(appointment.fecha_hora_inicio)}
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Patient info */}
          <div>
            <h4 className="text-sm font-medium text-gray-500">Paciente</h4>
            <p className="text-sm">
              {appointment.patient.nombre} {appointment.patient.apellido}
            </p>
            <p className="text-sm text-gray-500">
              CC: {appointment.patient.cedula} | Tel: {appointment.patient.celular}
            </p>
          </div>

          {/* Time info */}
          <div>
            <h4 className="text-sm font-medium text-gray-500">Horario</h4>
            <p className="text-sm">
              {format(new Date(appointment.fecha_hora_inicio), 'HH:mm')} -
              {format(new Date(appointment.fecha_hora_fin), 'HH:mm')}
            </p>
          </div>

          {/* Consultation reason */}
          {appointment.motivo_consulta && (
            <div>
              <h4 className="text-sm font-medium text-gray-500">Motivo</h4>
              <p className="text-sm">{appointment.motivo_consulta}</p>
            </div>
          )}

          {/* Notes */}
          {appointment.notas && (
            <div>
              <h4 className="text-sm font-medium text-gray-500">Notas</h4>
              <p className="text-sm">{appointment.notas}</p>
            </div>
          )}

          {/* Status transitions */}
          {availableTransitions.length > 0 && (
            <div>
              <h4 className="text-sm font-medium text-gray-500 mb-2">
                Cambiar estado
              </h4>
              <div className="flex flex-wrap gap-2">
                {availableTransitions.map((status) => (
                  <Button
                    key={status}
                    variant="outline"
                    size="sm"
                    disabled={isPending}
                    onClick={() => handleStatusChange(status)}
                  >
                    {STATUS_LABELS[status]}
                  </Button>
                ))}
              </div>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

Note: This component requires date-fns. Check if it's installed, if not add to package.json. Actually, let's check first - it may already be installed or we can use Intl.DateTimeFormat instead.

**If date-fns not installed, use Intl instead:**
```typescript
const formatDateTime = (dateString: string) => {
  const date = new Date(dateString)
  return new Intl.DateTimeFormat('es-CO', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  }).format(date)
}

const formatTime = (dateString: string) => {
  const date = new Date(dateString)
  return new Intl.DateTimeFormat('es-CO', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  }).format(date)
}
```

Choose the Intl approach to avoid adding date-fns dependency.
  </action>
  <verify>
- File exists at `src/components/appointments/appointment-dialog.tsx`
- Uses shadcn/ui Dialog component
- `npm run build` passes
  </verify>
  <done>
- Dialog shows appointment details (patient, time, motivo, notes)
- Status transition buttons based on state machine
- Spanish date formatting with Intl.DateTimeFormat (es-CO)
- Calls updateAppointmentStatus action on button click
  </done>
</task>

<task type="auto">
  <name>Task 2: Create calendar page with data fetching</name>
  <files>src/app/(protected)/citas/page.tsx</files>
  <action>
Create `src/app/(protected)/citas/page.tsx`:

```typescript
import { Suspense } from 'react'
import { CalendarView } from './calendar-view'
import { getDoctors } from '@/lib/queries/appointments'

export const metadata = {
  title: 'Agenda de Citas | VarixClinic',
  description: 'Gestionar citas de pacientes'
}

/**
 * Calendar page - main agenda view
 *
 * Server component that fetches doctors and renders client CalendarView
 */
export default async function CitasPage() {
  // Fetch doctors for filter (server-side)
  const doctors = await getDoctors()

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Agenda de Citas</h1>
          <p className="text-gray-500">Vista dia y semana con filtro por medico</p>
        </div>
      </div>

      <Suspense fallback={<CalendarSkeleton />}>
        <CalendarView doctors={doctors} />
      </Suspense>
    </div>
  )
}

function CalendarSkeleton() {
  return (
    <div className="bg-white rounded-lg border p-4 animate-pulse">
      <div className="h-8 bg-gray-200 rounded w-1/3 mb-4"></div>
      <div className="h-[500px] bg-gray-100 rounded"></div>
    </div>
  )
}
```

Now create the CalendarView client component at `src/app/(protected)/citas/calendar-view.tsx`:

```typescript
'use client'

import { useState, useCallback, useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { AppointmentCalendar } from '@/components/appointments/appointment-calendar'
import { DoctorFilter } from '@/components/appointments/doctor-filter'
import { AppointmentDialog } from '@/components/appointments/appointment-dialog'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import Link from 'next/link'
import { Doctor, CalendarEvent, AppointmentWithRelations } from '@/types/appointments'
import { getAppointmentsForCalendar, getAppointmentById } from '@/lib/queries/appointments'
import { rescheduleAppointment } from './actions'
import { toast } from 'sonner'

interface CalendarViewProps {
  doctors: Doctor[]
}

/**
 * Client component for calendar interactions
 *
 * Handles:
 * - Doctor filtering (APT-02)
 * - Event click -> dialog
 * - Date select -> navigate to new appointment
 * - Event drop -> reschedule
 */
export function CalendarView({ doctors }: CalendarViewProps) {
  const router = useRouter()
  const [isPending, startTransition] = useTransition()

  // Calendar state
  const [events, setEvents] = useState<CalendarEvent[]>([])
  const [selectedDoctor, setSelectedDoctor] = useState<string | null>(null)
  const [dateRange, setDateRange] = useState<{ start: string; end: string } | null>(null)

  // Dialog state
  const [selectedAppointment, setSelectedAppointment] = useState<AppointmentWithRelations | null>(null)
  const [dialogOpen, setDialogOpen] = useState(false)

  // Fetch events when date range or doctor filter changes
  const fetchEvents = useCallback(async (start: string, end: string, doctorId: string | null) => {
    try {
      const data = await getAppointmentsForCalendar(start, end, doctorId)
      setEvents(data)
    } catch (error) {
      console.error('Error fetching appointments:', error)
      toast.error('Error al cargar las citas')
    }
  }, [])

  // Handle date range change from calendar
  const handleDatesChange = useCallback((start: string, end: string) => {
    setDateRange({ start, end })
    fetchEvents(start, end, selectedDoctor)
  }, [selectedDoctor, fetchEvents])

  // Handle doctor filter change
  const handleDoctorChange = useCallback((doctorId: string | null) => {
    setSelectedDoctor(doctorId)
    if (dateRange) {
      fetchEvents(dateRange.start, dateRange.end, doctorId)
    }
  }, [dateRange, fetchEvents])

  // Handle event click -> show dialog
  const handleEventClick = useCallback(async (eventId: string) => {
    try {
      const appointment = await getAppointmentById(eventId)
      if (appointment) {
        setSelectedAppointment(appointment)
        setDialogOpen(true)
      }
    } catch (error) {
      console.error('Error fetching appointment:', error)
      toast.error('Error al cargar la cita')
    }
  }, [])

  // Handle date select -> navigate to new appointment with prefilled times
  const handleDateSelect = useCallback((start: Date, end: Date) => {
    const params = new URLSearchParams({
      start: start.toISOString(),
      end: end.toISOString(),
      ...(selectedDoctor && { doctor: selectedDoctor })
    })
    router.push(`/citas/nueva?${params.toString()}`)
  }, [router, selectedDoctor])

  // Handle event drop (drag-and-drop reschedule)
  const handleEventDrop = useCallback(async (eventId: string, newStart: string, newEnd: string) => {
    startTransition(async () => {
      const result = await rescheduleAppointment(eventId, newStart, newEnd)
      if (result.success) {
        toast.success(result.message)
        if (dateRange) {
          fetchEvents(dateRange.start, dateRange.end, selectedDoctor)
        }
      } else {
        toast.error(result.message)
        // Refresh to revert visual change
        if (dateRange) {
          fetchEvents(dateRange.start, dateRange.end, selectedDoctor)
        }
      }
    })
  }, [dateRange, selectedDoctor, fetchEvents])

  // Handle status change from dialog
  const handleStatusChange = useCallback(() => {
    if (dateRange) {
      fetchEvents(dateRange.start, dateRange.end, selectedDoctor)
    }
  }, [dateRange, selectedDoctor, fetchEvents])

  return (
    <div className="space-y-4">
      {/* Toolbar */}
      <div className="flex items-center justify-between flex-wrap gap-4">
        <DoctorFilter
          doctors={doctors}
          value={selectedDoctor}
          onChange={handleDoctorChange}
        />

        <Button asChild>
          <Link href="/citas/nueva">
            <Plus className="h-4 w-4 mr-2" />
            Nueva Cita
          </Link>
        </Button>
      </div>

      {/* Calendar */}
      <AppointmentCalendar
        events={events}
        onEventClick={handleEventClick}
        onDateSelect={handleDateSelect}
        onEventDrop={handleEventDrop}
        onDatesChange={handleDatesChange}
      />

      {/* Appointment detail dialog */}
      <AppointmentDialog
        appointment={selectedAppointment}
        open={dialogOpen}
        onOpenChange={setDialogOpen}
        onStatusChange={handleStatusChange}
      />
    </div>
  )
}
```

Note: The code uses `toast` from sonner. Check if sonner is installed - if not, we'll handle errors differently or add it. Looking at package.json from earlier, sonner is not installed. Let's use a simple approach without toast for now:

Replace toast calls with console.error and basic error handling. Or better, let's add sonner since it's commonly used with shadcn/ui.

Actually, let's just remove toast calls and use basic state for error display, to avoid adding dependencies in this plan. The calendar will simply refresh on error.
  </action>
  <verify>
- File exists at `src/app/(protected)/citas/page.tsx`
- File exists at `src/app/(protected)/citas/calendar-view.tsx`
- `npm run build` passes
- Doctor filter is visible
- Calendar renders
  </verify>
  <done>
- Calendar page shows agenda with day/week views (APT-01)
- Doctor filter dropdown filters appointments (APT-02)
- Event click opens detail dialog with status transitions (APT-03)
- Date select navigates to new appointment page
- Event drop reschedules appointment
- Nueva Cita button links to /citas/nueva
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `/citas` route renders calendar
3. Doctor filter dropdown shows doctors
4. Calendar shows week view by default
5. Event click opens dialog
</verification>

<success_criteria>
- APT-01: Day and week views work with toggle button
- APT-02: Doctor filter filters displayed appointments
- APT-03: Dialog shows status transition buttons
- Drag-drop reschedules appointments
- Spanish UI throughout
</success_criteria>

<output>
After completion, create `.planning/phases/03-appointments/03-06-SUMMARY.md`
</output>
