---
phase: 13-purchases
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - supabase/migrations/031_purchase_rpc.sql
  - supabase/migrations/032_purchase_alert_types.sql
autonomous: true

must_haves:
  truths:
    - "confirm_purchase_reception RPC atomically increments stock_normal"
    - "Stock movements logged with referencia_tipo = 'compra'"
    - "Alert types extended for purchase modification requests"
  artifacts:
    - path: "supabase/migrations/031_purchase_rpc.sql"
      provides: "Atomic reception confirmation with stock increment"
      contains: "confirm_purchase_reception"
    - path: "supabase/migrations/032_purchase_alert_types.sql"
      provides: "Extended alert types for purchase requests"
      contains: "solicitud_edicion_compra"
  key_links:
    - from: "confirm_purchase_reception"
      to: "medias_stock_movements"
      via: "INSERT with referencia_tipo = 'compra'"
      pattern: "referencia_tipo.*compra"
---

<objective>
Create RPC for atomic stock increment on reception confirmation and extend alerts for enfermera requests

Purpose: Stock only increases when reception is confirmed (not at registration). Enfermera edit/delete requests go through approval.
Output: Two migrations - RPC function and alert type extension
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-purchases/13-CONTEXT.md
@.planning/phases/13-purchases/13-RESEARCH.md
@supabase/migrations/023_create_medias_sale_rpc.sql
@supabase/migrations/027_alerts_table.sql
@supabase/migrations/020_medias_foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create confirm_purchase_reception RPC</name>
  <files>supabase/migrations/031_purchase_rpc.sql</files>
  <action>
Create RPC function following the pattern from 023_create_medias_sale_rpc.sql:

```sql
CREATE OR REPLACE FUNCTION public.confirm_purchase_reception(
  p_purchase_id UUID,
  p_confirmed_by UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
```

Implementation:
1. Lock purchase row with FOR UPDATE
2. Validate purchase exists and estado = 'pendiente_recepcion'
3. For each item in purchase_items:
   - Lock product row with FOR UPDATE
   - Increment stock_normal by cantidad
   - Log stock movement with:
     - tipo = 'compra'
     - referencia_id = p_purchase_id
     - referencia_tipo = 'compra'
     - stock_normal_antes/despues snapshots
4. Update purchase: estado = 'recibido', recibido_por, recibido_at = now()
5. Return success JSON with purchase_id

Include:
- SET LOCAL lock_timeout = '10s'
- Proper error messages in Spanish
- GRANT EXECUTE to authenticated
- Verification DO block
  </action>
  <verify>
Run: `grep -A5 "confirm_purchase_reception" supabase/migrations/031_purchase_rpc.sql`
Verify: Function signature, FOR UPDATE locking, stock_normal increment
  </verify>
  <done>
- confirm_purchase_reception function created
- Uses FOR UPDATE row locking pattern
- Increments stock_normal (not stock_devoluciones)
- Logs movements with referencia_tipo = 'compra'
- Updates purchase estado to 'recibido'
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend alert types for purchase modification requests</name>
  <files>supabase/migrations/032_purchase_alert_types.sql</files>
  <action>
Extend the alert_tipo ENUM to add purchase-related alert types:

```sql
-- Add new values to existing alert_tipo enum
ALTER TYPE public.alert_tipo ADD VALUE IF NOT EXISTS 'solicitud_edicion_compra';
ALTER TYPE public.alert_tipo ADD VALUE IF NOT EXISTS 'solicitud_eliminacion_compra';
```

Also create a helper function for enfermera to create modification requests:

```sql
CREATE OR REPLACE FUNCTION public.create_purchase_modification_request(
  p_purchase_id UUID,
  p_request_type TEXT,  -- 'edicion' or 'eliminacion'
  p_motivo TEXT,
  p_requested_by UUID
)
RETURNS UUID  -- Returns alert ID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
```

Implementation:
1. Validate purchase exists
2. Validate request_type is 'edicion' or 'eliminacion'
3. Insert into alerts table with:
   - tipo = 'solicitud_edicion_compra' or 'solicitud_eliminacion_compra'
   - severidad = 'advertencia'
   - titulo = 'Solicitud de [edicion/eliminacion] de compra'
   - descripcion = motivo + purchase details
   - referencia_tipo = 'purchase'
   - referencia_id = p_purchase_id
4. Return the alert ID

Grant execute to authenticated.
Include verification block.
  </action>
  <verify>
Run: `grep -E "(solicitud_edicion|solicitud_eliminacion)" supabase/migrations/032_purchase_alert_types.sql`
Verify: New enum values and helper function defined
  </verify>
  <done>
- alert_tipo ENUM extended with solicitud_edicion_compra, solicitud_eliminacion_compra
- create_purchase_modification_request function created
- Function inserts alert with appropriate type and severity
- Enfermera can request modifications through alerts system
  </done>
</task>

</tasks>

<verification>
- [ ] confirm_purchase_reception RPC uses FOR UPDATE locking
- [ ] Stock movements logged with tipo = 'compra'
- [ ] Purchase estado transitions to 'recibido'
- [ ] Alert types extended for modification requests
- [ ] create_purchase_modification_request function works
- [ ] Both migrations have verification blocks
</verification>

<success_criteria>
- Atomic stock increment on reception confirmation
- Race conditions prevented via FOR UPDATE
- Enfermera modification requests routed through alerts
- Admin/medico can approve/reject via existing alert resolution
</success_criteria>

<output>
After completion, create `.planning/phases/13-purchases/13-02-SUMMARY.md`
</output>
