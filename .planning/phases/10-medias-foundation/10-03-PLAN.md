---
phase: 10-medias-foundation
plan: 03
type: execute
wave: 2
depends_on: ["10-02"]
files_modified:
  - src/app/(protected)/medias/productos/actions.ts
  - src/components/medias/products/products-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of all products with price and stock"
    - "Admin can toggle product active status"
    - "Table displays stock_normal and stock_devoluciones separately"
  artifacts:
    - path: "src/app/(protected)/medias/productos/actions.ts"
      provides: "Server actions for product CRUD"
      exports: ["createProduct", "updateProduct", "toggleProductActive"]
    - path: "src/components/medias/products/products-table.tsx"
      provides: "Product list table component"
      exports: ["ProductsTable"]
  key_links:
    - from: "src/components/medias/products/products-table.tsx"
      to: "src/app/(protected)/medias/productos/actions.ts"
      via: "import toggleProductActive"
      pattern: "import.*toggleProductActive.*actions"
---

<objective>
Create server actions and products table component for admin product management

Purpose: Enable admin to view and manage product catalog with stock visibility
Output: Server actions file and ProductsTable component following services pattern
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-medias-foundation/10-RESEARCH.md
@.planning/phases/10-medias-foundation/10-02-SUMMARY.md

# Pattern references
@src/app/(protected)/servicios/actions.ts
@src/components/services/services-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for product management</name>
  <files>src/app/(protected)/medias/productos/actions.ts</files>
  <action>
Create directory structure src/app/(protected)/medias/productos/ if needed.

Create actions.ts with server actions following servicios/actions.ts pattern:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { mediasProductSchema, mediasProductUpdateSchema } from '@/lib/validations/medias/product'
import { revalidatePath } from 'next/cache'

export type ProductActionState = {
  error?: string
  errors?: Record<string, string[]>
  success?: boolean
}

/**
 * Create a new product (Admin only)
 */
export async function createProduct(
  prevState: ProductActionState | null,
  formData: FormData
): Promise<ProductActionState> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return { error: 'No autorizado' }
  }

  const rawData = {
    tipo: formData.get('tipo'),
    talla: formData.get('talla'),
    codigo: formData.get('codigo'),
    precio: parseFloat(formData.get('precio') as string || '0'),
    activo: formData.get('activo') !== 'false',
  }

  const validated = mediasProductSchema.safeParse(rawData)
  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
      error: 'Por favor corrija los errores'
    }
  }

  const { error } = await supabase
    .from('medias_products')
    .insert(validated.data)

  if (error) {
    if (error.code === '23505') {
      // Unique constraint violation
      if (error.message.includes('codigo')) {
        return { error: 'Ya existe un producto con ese codigo' }
      }
      return { error: 'Ya existe un producto con ese tipo y talla' }
    }
    console.error('Product creation error:', error)
    return { error: 'Error al crear el producto' }
  }

  revalidatePath('/medias/productos')
  return { success: true }
}

/**
 * Update an existing product (Admin only)
 * Only precio and activo can be updated
 */
export async function updateProduct(
  id: string,
  prevState: ProductActionState | null,
  formData: FormData
): Promise<ProductActionState> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return { error: 'No autorizado' }
  }

  const rawData = {
    precio: parseFloat(formData.get('precio') as string || '0'),
    activo: formData.get('activo') !== 'false',
  }

  const validated = mediasProductUpdateSchema.safeParse(rawData)
  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
      error: 'Por favor corrija los errores'
    }
  }

  const { error } = await supabase
    .from('medias_products')
    .update(validated.data)
    .eq('id', id)

  if (error) {
    console.error('Product update error:', error)
    return { error: 'Error al actualizar el producto' }
  }

  revalidatePath('/medias/productos')
  return { success: true }
}

/**
 * Toggle product active status (soft delete/restore)
 */
export async function toggleProductActive(
  id: string,
  activo: boolean
): Promise<ProductActionState> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return { error: 'No autorizado' }
  }

  const { error } = await supabase
    .from('medias_products')
    .update({ activo })
    .eq('id', id)

  if (error) {
    console.error('Product toggle error:', error)
    return { error: 'Error al actualizar el producto' }
  }

  revalidatePath('/medias/productos')
  return { success: true }
}
```
  </action>
  <verify>File exports createProduct, updateProduct, toggleProductActive functions</verify>
  <done>Server actions created for product CRUD operations</done>
</task>

<task type="auto">
  <name>Task 2: Create products table component</name>
  <files>src/components/medias/products/products-table.tsx</files>
  <action>
Create directory structure src/components/medias/products/ if needed.

Create products-table.tsx following services-table.tsx pattern:

```typescript
'use client'

import { useState, useTransition } from 'react'
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  flexRender,
  type ColumnDef,
  type SortingState,
} from '@tanstack/react-table'
import type { MediasProduct } from '@/types/medias/products'
import { toggleProductActive } from '@/app/(protected)/medias/productos/actions'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { ProductForm } from './product-form'

interface ProductsTableProps {
  data: MediasProduct[]
  onRefresh?: () => void
}

/**
 * Format number as Colombian peso
 */
function formatCurrency(value: number): string {
  return new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value)
}

/**
 * Products table with sorting, edit dialog, and toggle active
 * Shows dual stock columns (stock_normal and stock_devoluciones)
 */
export function ProductsTable({ data, onRefresh }: ProductsTableProps) {
  const [sorting, setSorting] = useState<SortingState>([{ id: 'tipo', desc: false }])
  const [editProduct, setEditProduct] = useState<MediasProduct | null>(null)
  const [isPending, startTransition] = useTransition()
  const [togglingId, setTogglingId] = useState<string | null>(null)

  const handleToggleActive = async (product: MediasProduct) => {
    setTogglingId(product.id)
    startTransition(async () => {
      await toggleProductActive(product.id, !product.activo)
      setTogglingId(null)
      onRefresh?.()
    })
  }

  const columns: ColumnDef<MediasProduct>[] = [
    {
      accessorKey: 'codigo',
      header: 'Codigo',
      cell: ({ row }) => (
        <span className={`font-mono ${row.original.activo ? '' : 'opacity-50'}`}>
          {row.getValue('codigo')}
        </span>
      ),
    },
    {
      accessorKey: 'tipo',
      header: 'Tipo',
      cell: ({ row }) => (
        <span className={row.original.activo ? '' : 'opacity-50'}>
          {row.getValue('tipo')}
        </span>
      ),
    },
    {
      accessorKey: 'talla',
      header: 'Talla',
      cell: ({ row }) => (
        <Badge variant="outline" className={row.original.activo ? '' : 'opacity-50'}>
          {row.getValue('talla')}
        </Badge>
      ),
    },
    {
      accessorKey: 'precio',
      header: 'Precio',
      cell: ({ row }) => (
        <span className={`font-mono ${row.original.activo ? '' : 'opacity-50'}`}>
          {formatCurrency(row.getValue('precio'))}
        </span>
      ),
    },
    {
      id: 'stock',
      header: 'Stock',
      cell: ({ row }) => {
        const product = row.original
        const total = product.stock_normal + product.stock_devoluciones
        return (
          <div className={`text-sm ${product.activo ? '' : 'opacity-50'}`}>
            <div className="font-medium">{total} total</div>
            <div className="text-muted-foreground text-xs">
              {product.stock_normal} normal / {product.stock_devoluciones} dev
            </div>
          </div>
        )
      },
    },
    {
      accessorKey: 'activo',
      header: 'Estado',
      cell: ({ row }) => {
        const activo = row.getValue('activo') as boolean
        return (
          <Badge variant={activo ? 'default' : 'destructive'}>
            {activo ? 'Activo' : 'Inactivo'}
          </Badge>
        )
      },
    },
    {
      id: 'actions',
      header: '',
      cell: ({ row }) => {
        const product = row.original
        const isToggling = togglingId === product.id
        return (
          <div className="flex items-center justify-end gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setEditProduct(product)}
            >
              Editar
            </Button>
            <Button
              variant={product.activo ? 'destructive' : 'default'}
              size="sm"
              onClick={() => handleToggleActive(product)}
              disabled={isToggling}
            >
              {isToggling ? '...' : product.activo ? 'Desactivar' : 'Activar'}
            </Button>
          </div>
        )
      },
    },
  ]

  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    onSortingChange: setSorting,
    state: {
      sorting,
    },
  })

  return (
    <>
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            {table.getHeaderGroups().map((headerGroup) => (
              <TableRow key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <TableHead
                    key={header.id}
                    className={header.column.getCanSort() ? 'cursor-pointer select-none' : ''}
                    onClick={header.column.getToggleSortingHandler()}
                  >
                    {header.isPlaceholder ? null : (
                      <div className="flex items-center gap-2">
                        {flexRender(
                          header.column.columnDef.header,
                          header.getContext()
                        )}
                        {{
                          asc: ' ^',
                          desc: ' v',
                        }[header.column.getIsSorted() as string] ?? null}
                      </div>
                    )}
                  </TableHead>
                ))}
              </TableRow>
            ))}
          </TableHeader>
          <TableBody>
            {table.getRowModel().rows.length ? (
              table.getRowModel().rows.map((row) => (
                <TableRow key={row.id}>
                  {row.getVisibleCells().map((cell) => (
                    <TableCell key={cell.id}>
                      {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </TableCell>
                  ))}
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={columns.length} className="h-24 text-center">
                  No hay productos registrados
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>

      {/* Edit Product Dialog */}
      <Dialog open={!!editProduct} onOpenChange={(open) => !open && setEditProduct(null)}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Editar Producto</DialogTitle>
          </DialogHeader>
          {editProduct && (
            <ProductForm
              product={editProduct}
              onSuccess={() => {
                setEditProduct(null)
                onRefresh?.()
              }}
            />
          )}
        </DialogContent>
      </Dialog>
    </>
  )
}
```

Key differences from services-table.tsx:
- Shows codigo, tipo, talla columns instead of nombre/descripcion
- Stock column shows both stock_normal and stock_devoluciones with total
- Uses ProductForm (will be created in plan 04)
  </action>
  <verify>ProductsTable component renders with codigo, tipo, talla, precio, stock columns</verify>
  <done>Products table component created with dual stock display</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Server actions compile without TypeScript errors
2. ProductsTable component compiles without TypeScript errors
3. Table displays codigo, tipo, talla, precio, stock (normal/dev), estado columns
4. Edit dialog opens when clicking "Editar" button
5. Toggle active calls toggleProductActive server action
</verification>

<success_criteria>
- [ ] src/app/(protected)/medias/productos/actions.ts exports createProduct, updateProduct, toggleProductActive
- [ ] src/components/medias/products/products-table.tsx exports ProductsTable
- [ ] Table shows stock_normal and stock_devoluciones separately
- [ ] Admin can toggle product active status
- [ ] Edit dialog integrates with ProductForm (placeholder import for now)
</success_criteria>

<output>
After completion, create `.planning/phases/10-medias-foundation/10-03-SUMMARY.md`
</output>
