---
phase: 10-medias-foundation
plan: 04
type: execute
wave: 2
depends_on: ["10-02"]
files_modified:
  - src/components/medias/products/product-form.tsx
  - src/app/(protected)/medias/productos/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create new products with tipo, talla, codigo, precio"
    - "Admin can edit price of existing products"
    - "Products page shows all products with create button"
  artifacts:
    - path: "src/components/medias/products/product-form.tsx"
      provides: "Product create/edit form component"
      exports: ["ProductForm"]
    - path: "src/app/(protected)/medias/productos/page.tsx"
      provides: "Products catalog admin page"
      exports: ["default"]
  key_links:
    - from: "src/app/(protected)/medias/productos/page.tsx"
      to: "src/components/medias/products/products-table.tsx"
      via: "import { ProductsTable }"
      pattern: "import.*ProductsTable"
    - from: "src/components/medias/products/product-form.tsx"
      to: "src/app/(protected)/medias/productos/actions.ts"
      via: "import createProduct, updateProduct"
      pattern: "import.*createProduct.*updateProduct.*actions"
---

<objective>
Create product form component and products admin page

Purpose: Complete admin UI for product catalog management (CAT-01, CAT-02, CAT-03, CAT-04)
Output: ProductForm component and /medias/productos page following servicios patterns
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-medias-foundation/10-RESEARCH.md
@.planning/phases/10-medias-foundation/10-02-SUMMARY.md
@.planning/phases/10-medias-foundation/10-03-SUMMARY.md

# Pattern references
@src/components/services/service-form.tsx
@src/app/(protected)/servicios/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create product form component</name>
  <files>src/components/medias/products/product-form.tsx</files>
  <action>
Create product-form.tsx following service-form.tsx pattern:

```typescript
'use client'

import { useActionState, useEffect, useState } from 'react'
import type { MediasProduct } from '@/types/medias/products'
import { PRODUCT_TYPES, PRODUCT_SIZES } from '@/types/medias/products'
import type { ProductActionState } from '@/app/(protected)/medias/productos/actions'
import { createProduct, updateProduct } from '@/app/(protected)/medias/productos/actions'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'

interface ProductFormProps {
  product?: MediasProduct | null
  onSuccess?: () => void
}

function formatCurrency(value: number): string {
  return new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value)
}

export function ProductForm({ product, onSuccess }: ProductFormProps) {
  const isEditing = Boolean(product)

  const boundUpdateAction = product
    ? updateProduct.bind(null, product.id)
    : createProduct

  const [state, formAction, isPending] = useActionState<ProductActionState | null, FormData>(
    boundUpdateAction,
    null
  )

  const [precio, setPrecio] = useState(product?.precio || 0)
  const [tipo, setTipo] = useState<string>(product?.tipo || '')
  const [talla, setTalla] = useState<string>(product?.talla || '')

  useEffect(() => {
    if (state?.success) {
      onSuccess?.()
    }
  }, [state?.success, onSuccess])

  return (
    <form action={formAction} className="space-y-4">
      {state?.error && (
        <div className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
          {state.error}
        </div>
      )}

      {/* Tipo (only editable on create) */}
      <div className="space-y-2">
        <Label htmlFor="tipo">Tipo *</Label>
        {isEditing ? (
          <>
            <Input
              id="tipo_display"
              value={product?.tipo}
              disabled
              className="bg-muted"
            />
            <input type="hidden" name="tipo" value={product?.tipo} />
            <p className="text-xs text-muted-foreground">El tipo no puede ser modificado</p>
          </>
        ) : (
          <>
            <Select value={tipo} onValueChange={setTipo} name="tipo" required>
              <SelectTrigger>
                <SelectValue placeholder="Seleccionar tipo" />
              </SelectTrigger>
              <SelectContent>
                {PRODUCT_TYPES.map((t) => (
                  <SelectItem key={t} value={t}>
                    {t}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <input type="hidden" name="tipo" value={tipo} />
          </>
        )}
        {state?.errors?.tipo && (
          <p className="text-sm text-destructive">{state.errors.tipo[0]}</p>
        )}
      </div>

      {/* Talla (only editable on create) */}
      <div className="space-y-2">
        <Label htmlFor="talla">Talla *</Label>
        {isEditing ? (
          <>
            <Input
              id="talla_display"
              value={product?.talla}
              disabled
              className="bg-muted"
            />
            <input type="hidden" name="talla" value={product?.talla} />
            <p className="text-xs text-muted-foreground">La talla no puede ser modificada</p>
          </>
        ) : (
          <>
            <Select value={talla} onValueChange={setTalla} name="talla" required>
              <SelectTrigger>
                <SelectValue placeholder="Seleccionar talla" />
              </SelectTrigger>
              <SelectContent>
                {PRODUCT_SIZES.map((s) => (
                  <SelectItem key={s} value={s}>
                    {s}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <input type="hidden" name="talla" value={talla} />
          </>
        )}
        {state?.errors?.talla && (
          <p className="text-sm text-destructive">{state.errors.talla[0]}</p>
        )}
      </div>

      {/* Codigo (only editable on create) */}
      <div className="space-y-2">
        <Label htmlFor="codigo">Codigo *</Label>
        {isEditing ? (
          <>
            <Input
              id="codigo_display"
              value={product?.codigo}
              disabled
              className="bg-muted font-mono"
            />
            <input type="hidden" name="codigo" value={product?.codigo} />
            <p className="text-xs text-muted-foreground">El codigo no puede ser modificado</p>
          </>
        ) : (
          <Input
            id="codigo"
            name="codigo"
            placeholder="Ej: 74113"
            className="font-mono"
            required
          />
        )}
        {state?.errors?.codigo && (
          <p className="text-sm text-destructive">{state.errors.codigo[0]}</p>
        )}
      </div>

      {/* Precio (always editable) */}
      <div className="space-y-2">
        <Label htmlFor="precio">Precio (COP) *</Label>
        <Input
          id="precio"
          name="precio"
          type="number"
          min={1}
          step={1000}
          placeholder="0"
          value={precio}
          onChange={(e) => setPrecio(parseFloat(e.target.value) || 0)}
          required
        />
        {precio > 0 && (
          <p className="text-sm text-muted-foreground">{formatCurrency(precio)}</p>
        )}
        {state?.errors?.precio && (
          <p className="text-sm text-destructive">{state.errors.precio[0]}</p>
        )}
      </div>

      {/* Hidden field for activo */}
      <input type="hidden" name="activo" value="true" />

      {/* Submit Button */}
      <div className="flex justify-end gap-2">
        <Button type="submit" disabled={isPending}>
          {isPending ? 'Guardando...' : isEditing ? 'Actualizar Precio' : 'Crear Producto'}
        </Button>
      </div>
    </form>
  )
}
```

Key differences from service-form.tsx:
- tipo, talla, codigo are disabled when editing (immutable after creation)
- Uses Select components for tipo and talla
- Button text is "Actualizar Precio" when editing (only price changes)
  </action>
  <verify>ProductForm renders with tipo, talla, codigo selects (disabled when editing) and precio input</verify>
  <done>Product form component created with immutable fields handling</done>
</task>

<task type="auto">
  <name>Task 2: Create products admin page</name>
  <files>src/app/(protected)/medias/productos/page.tsx</files>
  <action>
Create page.tsx following servicios/page.tsx pattern:

```typescript
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import type { MediasProduct } from '@/types/medias/products'
import { ProductsTable } from '@/components/medias/products/products-table'
import { ProductForm } from '@/components/medias/products/product-form'
import { Button } from '@/components/ui/button'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'

/**
 * Medias products catalog admin page
 * Allows admin to manage products and view stock
 */
export default function ProductosPage() {
  const [products, setProducts] = useState<MediasProduct[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isDialogOpen, setIsDialogOpen] = useState(false)

  // Fetch products on mount and after changes
  const fetchProducts = async () => {
    const supabase = createClient()
    const { data, error } = await supabase
      .from('medias_products')
      .select('*')
      .order('tipo')
      .order('talla')

    if (error) {
      console.error('Error fetching products:', error)
    } else {
      setProducts(data || [])
    }
    setIsLoading(false)
  }

  useEffect(() => {
    fetchProducts()
  }, [])

  // Refetch when dialog closes after success
  const handleDialogChange = (open: boolean) => {
    setIsDialogOpen(open)
    if (!open) {
      fetchProducts()
    }
  }

  const handleSuccess = () => {
    setIsDialogOpen(false)
    fetchProducts()
  }

  return (
    <div className="container mx-auto py-6">
      {/* Header */}
      <div className="mb-6 flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Catalogo de Productos</h1>
          <p className="text-muted-foreground">Medias de compresion</p>
        </div>
        <Dialog open={isDialogOpen} onOpenChange={handleDialogChange}>
          <DialogTrigger asChild>
            <Button>Nuevo Producto</Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Nuevo Producto</DialogTitle>
            </DialogHeader>
            <ProductForm onSuccess={handleSuccess} />
          </DialogContent>
        </Dialog>
      </div>

      {/* Products Table */}
      {isLoading ? (
        <div className="flex h-64 items-center justify-center">
          <div className="h-8 w-8 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600" />
        </div>
      ) : (
        <ProductsTable data={products} onRefresh={fetchProducts} />
      )}
    </div>
  )
}
```

Key features:
- Fetches from medias_products table
- Orders by tipo then talla for logical grouping
- "Nuevo Producto" button opens create dialog
- ProductsTable handles edit dialog internally
  </action>
  <verify>Page renders at /medias/productos with product list and create button</verify>
  <done>Products admin page created with table and create dialog</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. ProductForm handles create mode (all fields editable) and edit mode (only precio editable)
2. Page fetches and displays products from medias_products table
3. "Nuevo Producto" button opens form dialog
4. Edit from table opens dialog with product data
5. Both forms call appropriate server actions
</verification>

<success_criteria>
- [ ] src/components/medias/products/product-form.tsx exports ProductForm
- [ ] src/app/(protected)/medias/productos/page.tsx exists
- [ ] Create form allows tipo, talla, codigo, precio selection
- [ ] Edit form shows tipo, talla, codigo as disabled, only precio editable
- [ ] Page fetches products ordered by tipo, talla
- [ ] CAT-01: Admin can view listado de productos con precio y stock
- [ ] CAT-02: Admin can editar precio
- [ ] CAT-03: Admin can agregar nuevos productos
- [ ] CAT-04: Admin can desactivar producto (via table toggle)
</success_criteria>

<output>
After completion, create `.planning/phases/10-medias-foundation/10-04-SUMMARY.md`
</output>
