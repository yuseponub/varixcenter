---
phase: 12-cash-closing-medias
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/024_medias_cierres.sql
autonomous: true

must_haves:
  truths:
    - "Medias cierre counter exists with CIM prefix"
    - "Medias cierres table stores closing records with zero-tolerance constraint"
    - "Closing records are immutable (no UPDATE on core fields, no DELETE)"
    - "Sales are blocked on closed days via BEFORE INSERT trigger"
  artifacts:
    - path: "supabase/migrations/024_medias_cierres.sql"
      provides: "Counter, table, immutability, lockdown trigger"
      contains: "medias_cierre_counter"
  key_links:
    - from: "medias_cierres"
      to: "auth.users"
      via: "closed_by FK"
      pattern: "closed_by UUID.*REFERENCES auth.users"
    - from: "tr_block_medias_sales_on_closed_day"
      to: "medias_sales"
      via: "BEFORE INSERT trigger"
      pattern: "BEFORE INSERT ON.*medias_sales"
---

<objective>
Create the medias cash closing database schema with counter, table, immutability trigger, and sales lockdown trigger.

Purpose: Establishes the database foundation for Phase 12 cash closing, adapted from clinic's cash_closings (015) with CIM- prefix and zero-tolerance policy.

Output: Migration 024_medias_cierres.sql with all tables, triggers, and RLS policies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-cash-closing-medias/12-RESEARCH.md
@supabase/migrations/015_cash_closings.sql (pattern to adapt)
@supabase/migrations/021_medias_sales.sql (venta_counter pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create medias_cierre_counter table and protection trigger</name>
  <files>supabase/migrations/024_medias_cierres.sql</files>
  <action>
Create migration 024_medias_cierres.sql with:

1. **Counter table** (adapt from closing_counter in 015):
```sql
CREATE TABLE public.medias_cierre_counter (
  id INTEGER PRIMARY KEY DEFAULT 1,
  last_number BIGINT NOT NULL DEFAULT 0,
  prefix VARCHAR(10) NOT NULL DEFAULT 'CIM',
  CONSTRAINT medias_cierre_single_row CHECK (id = 1)
);
INSERT INTO public.medias_cierre_counter (id, last_number, prefix) VALUES (1, 0, 'CIM');
```

2. **Protection trigger** (reuse protect_venta_counter function pattern from 021):
```sql
CREATE OR REPLACE FUNCTION public.protect_medias_cierre_counter()
-- Same pattern as protect_venta_counter but for medias_cierre_counter
```

3. **Get next number function**:
```sql
CREATE OR REPLACE FUNCTION public.get_next_medias_cierre_number()
RETURNS TEXT
-- Same pattern as get_next_venta_number() but returns 'CIM-000001' format
```

CRITICAL: Use CIM prefix (not CIE) per CIE-08 requirement for independence from clinic.
  </action>
  <verify>SQL syntax valid, counter table created with single row, protection trigger exists</verify>
  <done>medias_cierre_counter table with CIM prefix and get_next_medias_cierre_number() function exist</done>
</task>

<task type="auto">
  <name>Task 2: Create medias_cierres table with zero-tolerance constraint</name>
  <files>supabase/migrations/024_medias_cierres.sql</files>
  <action>
Add to migration 024_medias_cierres.sql the main table (adapt from cash_closings in 015):

```sql
CREATE TABLE public.medias_cierres (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  cierre_numero VARCHAR(20) NOT NULL UNIQUE,  -- CIM-000001
  fecha_cierre DATE NOT NULL UNIQUE,          -- One closing per day

  -- Calculated totals (snapshot at closing time)
  total_efectivo DECIMAL(12,2) NOT NULL DEFAULT 0,
  total_tarjeta DECIMAL(12,2) NOT NULL DEFAULT 0,
  total_transferencia DECIMAL(12,2) NOT NULL DEFAULT 0,
  total_nequi DECIMAL(12,2) NOT NULL DEFAULT 0,
  grand_total DECIMAL(12,2) NOT NULL DEFAULT 0,

  -- Physical cash count
  conteo_fisico_efectivo DECIMAL(12,2) NOT NULL,

  -- Difference (conteo - total_efectivo)
  diferencia DECIMAL(12,2) NOT NULL DEFAULT 0,
  diferencia_justificacion TEXT,

  -- Photo evidence (NOT NULL as required)
  cierre_photo_path TEXT NOT NULL,

  -- Status (reuse cierre_estado ENUM from 015)
  estado public.cierre_estado NOT NULL DEFAULT 'cerrado',

  -- Notes
  notas TEXT,

  -- Who closed
  closed_by UUID NOT NULL REFERENCES auth.users(id),

  -- Reopen tracking (admin only)
  reopened_by UUID REFERENCES auth.users(id),
  reopened_at TIMESTAMPTZ,
  reopen_justificacion TEXT,

  -- Audit
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- CONSTRAINTS
  CONSTRAINT medias_cierre_totals_positive CHECK (
    total_efectivo >= 0 AND total_tarjeta >= 0 AND
    total_transferencia >= 0 AND total_nequi >= 0 AND
    grand_total >= 0 AND conteo_fisico_efectivo >= 0
  ),

  -- CIE-04: ZERO TOLERANCE (differs from clinic's $10k threshold)
  CONSTRAINT medias_diferencia_requires_justificacion CHECK (
    diferencia = 0 OR
    (diferencia_justificacion IS NOT NULL AND LENGTH(TRIM(diferencia_justificacion)) >= 10)
  ),

  -- Reopen must have justification
  CONSTRAINT medias_reopen_requires_justificacion CHECK (
    reopened_by IS NULL OR
    (reopen_justificacion IS NOT NULL AND LENGTH(TRIM(reopen_justificacion)) >= 10)
  )
);
```

Add indexes:
- idx_medias_cierres_fecha (fecha_cierre DESC)
- idx_medias_cierres_estado (estado)
- idx_medias_cierres_created_at (created_at DESC)

CRITICAL: Zero-tolerance constraint: `diferencia = 0 OR justificacion` (NOT `ABS(diferencia) <= 10000`)
  </action>
  <verify>Table created with all columns, zero-tolerance CHECK constraint exists</verify>
  <done>medias_cierres table with CIE-04 zero-tolerance constraint exists</done>
</task>

<task type="auto">
  <name>Task 3: Create immutability trigger and sales lockdown trigger with RLS</name>
  <files>supabase/migrations/024_medias_cierres.sql</files>
  <action>
Add to migration 024_medias_cierres.sql:

1. **Immutability trigger** (adapt from enforce_cash_closing_immutability):
```sql
CREATE OR REPLACE FUNCTION public.enforce_medias_cierre_immutability()
RETURNS TRIGGER
-- Same pattern: block DELETE, block UPDATE on core fields
-- Allow estado transitions: cerrado -> reabierto, reabierto -> cerrado
```

2. **Sales lockdown trigger** (CIE-05 - adapt from block_payments_on_closed_day):
```sql
CREATE OR REPLACE FUNCTION public.block_medias_sales_on_closed_day()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
  v_sale_date DATE;
  v_closing_exists BOOLEAN;
BEGIN
  v_sale_date := DATE(NEW.created_at);

  SELECT EXISTS (
    SELECT 1 FROM public.medias_cierres
    WHERE fecha_cierre = v_sale_date
    AND estado = 'cerrado'
  ) INTO v_closing_exists;

  IF v_closing_exists THEN
    RAISE EXCEPTION 'No se pueden crear ventas en un dia cerrado (%). El cierre debe reabrirse primero.', v_sale_date;
  END IF;

  RETURN NEW;
END;
$$;

CREATE TRIGGER tr_block_medias_sales_on_closed_day
  BEFORE INSERT ON public.medias_sales
  FOR EACH ROW
  EXECUTE FUNCTION public.block_medias_sales_on_closed_day();
```

3. **RLS Policies**:
- All staff can view closings
- Only secretaria and admin can create closings
- Only admin can update (reopen) closings
- NO DELETE policy (closings cannot be deleted)

4. **Grant permissions**:
```sql
GRANT SELECT, INSERT ON public.medias_cierres TO authenticated;
GRANT UPDATE (estado, reopened_by, reopen_justificacion, reopened_at, notas, updated_at) ON public.medias_cierres TO authenticated;
GRANT SELECT, UPDATE ON public.medias_cierre_counter TO authenticated;
```

5. **Verification block** at end of migration.

CRITICAL: Lockdown blocks medias_sales (NOT payments) per CIE-08 independence.
  </action>
  <verify>Migration runs without errors, RLS enabled on medias_cierres, lockdown trigger created on medias_sales</verify>
  <done>Immutability trigger protects medias_cierres, sales lockdown blocks medias_sales on closed days</done>
</task>

</tasks>

<verification>
Run SQL syntax check (or verify manually):
1. Counter table has exactly one row with CIM prefix
2. medias_cierres table has zero-tolerance CHECK constraint
3. Immutability trigger blocks UPDATE on cierre_numero, fecha_cierre, totals
4. Lockdown trigger is BEFORE INSERT on medias_sales (not payments)
5. RLS enabled on both tables
</verification>

<success_criteria>
- Migration 024_medias_cierres.sql creates all required objects
- Counter uses CIM prefix (not CIE)
- Zero-tolerance constraint enforces justification for ANY difference
- Sales lockdown trigger blocks medias_sales (independent from clinic)
- RLS policies restrict create to secretaria/admin, update to admin only
</success_criteria>

<output>
After completion, create `.planning/phases/12-cash-closing-medias/12-01-SUMMARY.md`
</output>
