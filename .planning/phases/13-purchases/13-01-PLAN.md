---
phase: 13-purchases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/030_purchases_tables.sql
autonomous: true

must_haves:
  truths:
    - "purchases table exists with estado column"
    - "purchase_items table exists with product snapshot columns"
    - "purchase_counter table exists for gapless COM- numbers"
    - "compra_estado ENUM has pendiente_recepcion, recibido, anulado values"
    - "RLS enabled on both tables"
  artifacts:
    - path: "supabase/migrations/030_purchases_tables.sql"
      provides: "Purchase schema with header + items pattern"
      contains: "CREATE TABLE public.purchases"
  key_links:
    - from: "purchase_items"
      to: "medias_products"
      via: "product_id foreign key"
      pattern: "REFERENCES public.medias_products"
---

<objective>
Create purchases and purchase_items database schema with gapless purchase numbers

Purpose: Establish foundation for purchase registration with two-step reception flow (pendiente_recepcion -> recibido)
Output: Migration file with tables, enums, indexes, triggers, RLS policies
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-purchases/13-CONTEXT.md
@.planning/phases/13-purchases/13-RESEARCH.md
@supabase/migrations/020_medias_foundation.sql
@supabase/migrations/021_medias_sales.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create purchases database migration</name>
  <files>supabase/migrations/030_purchases_tables.sql</files>
  <action>
Create migration with:

1. **ENUM: compra_estado**
   - Values: 'pendiente_recepcion', 'recibido', 'anulado'

2. **purchases table** (header):
   - id UUID PK
   - numero_compra VARCHAR(20) NOT NULL UNIQUE (COM-000001 format)
   - proveedor VARCHAR(200) NOT NULL (free text per CONTEXT.md)
   - fecha_factura DATE NOT NULL
   - numero_factura VARCHAR(100) (optional per CONTEXT.md)
   - total DECIMAL(12,2) NOT NULL
   - factura_path VARCHAR(500) NOT NULL (storage path for invoice photo/PDF - REQUIRED)
   - estado compra_estado DEFAULT 'pendiente_recepcion'
   - notas TEXT (optional)
   - created_by UUID FK auth.users NOT NULL
   - recibido_por UUID FK auth.users (who confirmed reception)
   - recibido_at TIMESTAMPTZ (when reception was confirmed)
   - anulado_por UUID FK auth.users
   - anulado_at TIMESTAMPTZ
   - anulacion_justificacion TEXT
   - created_at, updated_at timestamps

3. **purchase_items table** (line items):
   - id UUID PK
   - purchase_id UUID FK purchases NOT NULL
   - product_id UUID FK medias_products NOT NULL
   - product_codigo VARCHAR(20) NOT NULL (snapshot)
   - product_tipo VARCHAR(20) NOT NULL (snapshot)
   - product_talla VARCHAR(10) NOT NULL (snapshot)
   - cantidad INTEGER NOT NULL CHECK > 0
   - costo_unitario DECIMAL(12,2) NOT NULL (for margin analysis per CONTEXT.md)
   - subtotal DECIMAL(12,2) NOT NULL
   - created_at timestamp

4. **purchase_counter table** for gapless numbers:
   - last_number INTEGER DEFAULT 0

5. **Function get_next_compra_number()** - returns COM-000001 format

6. **Indexes**:
   - purchases: estado, fecha_factura, proveedor, created_at DESC
   - purchase_items: purchase_id

7. **updated_at trigger** on purchases

8. **RLS Policies**:
   - SELECT: all authenticated users can view
   - INSERT: all authenticated users can create (per CONTEXT.md)
   - UPDATE: admin/medico can update directly, enfermera restricted (handled in app layer via alerts)
   - DELETE: admin/medico only with justification

Include verification DO block at end.
  </action>
  <verify>
Run: `cat supabase/migrations/030_purchases_tables.sql | head -100`
Verify: Tables, enums, counter function, RLS policies are defined
  </verify>
  <done>
- purchases table exists with all required columns
- purchase_items table exists with product snapshots
- purchase_counter initialized with last_number = 0
- get_next_compra_number() function returns COM-000001 format
- RLS enabled with appropriate policies
- Verification block passes
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/030_purchases_tables.sql
- [ ] compra_estado ENUM defined with correct values
- [ ] purchases table has estado, factura_path, recibido_por columns
- [ ] purchase_items has product snapshot columns
- [ ] purchase_counter has get_next_compra_number function
- [ ] RLS policies defined for all required operations
- [ ] Verification DO block included
</verification>

<success_criteria>
Database schema ready for purchase registration:
- Two-step flow supported (pendiente_recepcion -> recibido states)
- Gapless COM- number generation
- Invoice photo path required
- Product snapshots captured in items
- All authenticated users can create, admin/medico can modify
</success_criteria>

<output>
After completion, create `.planning/phases/13-purchases/13-01-SUMMARY.md`
</output>
