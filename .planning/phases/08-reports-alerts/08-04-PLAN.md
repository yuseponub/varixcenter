---
phase: 08-reports-alerts
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - src/components/alerts/alert-badge.tsx
  - src/components/alerts/alert-item.tsx
  - src/components/alerts/alerts-widget.tsx
  - src/components/alerts/resolve-alert-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Alert badge shows unread count"
    - "Alert items display with correct severity styling"
    - "Alerts widget shows recent alerts with resolve action"
    - "Resolve dialog accepts notas and submits form"
  artifacts:
    - path: "src/components/alerts/alert-badge.tsx"
      provides: "Badge component showing unread alert count"
      min_lines: 15
    - path: "src/components/alerts/alert-item.tsx"
      provides: "Individual alert row with severity styling"
      min_lines: 30
    - path: "src/components/alerts/alerts-widget.tsx"
      provides: "Dashboard widget with alert list"
      min_lines: 40
    - path: "src/components/alerts/resolve-alert-dialog.tsx"
      provides: "Dialog for marking alert as resolved"
      min_lines: 50
  key_links:
    - from: "src/components/alerts/alert-badge.tsx"
      to: "src/lib/queries/alerts.ts"
      via: "getUnreadAlertCount"
      pattern: "getUnreadAlertCount"
    - from: "src/components/alerts/resolve-alert-dialog.tsx"
      to: "src/app/(protected)/reportes/actions.ts"
      via: "resolveAlertAction"
      pattern: "resolveAlertAction"
---

<objective>
Create alert UI components: badge, item, widget, and resolve dialog.

Purpose: Provides visual representation of alerts for the dashboard, enabling Admin/Medico to see and resolve anomalies.
Output: Complete set of alert components ready for dashboard integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-reports-alerts/08-CONTEXT.md
@.planning/phases/08-reports-alerts/08-RESEARCH.md

# Prior phase outputs
@.planning/phases/08-reports-alerts/08-02-SUMMARY.md (types)
@.planning/phases/08-reports-alerts/08-03-SUMMARY.md (queries, actions)

# Existing patterns
@src/components/ui/badge.tsx (Badge component)
@src/components/ui/card.tsx (Card component)
@src/components/ui/dialog.tsx (Dialog component)
@src/components/cash-closing/reopen-cierre-dialog.tsx (dialog form pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create alert badge component</name>
  <files>src/components/alerts/alert-badge.tsx</files>
  <action>
Create src/components/alerts/alert-badge.tsx as a SERVER component:

1. Import getUnreadAlertCount from '@/lib/queries/alerts'
2. Import Badge from '@/components/ui/badge'
3. Import Bell icon from 'lucide-react'

4. Export async function AlertBadge():
   - Calls getUnreadAlertCount()
   - Returns Bell icon with relative positioned badge showing count
   - If count is 0, show Bell without badge
   - If count > 9, show "9+"
   - Badge uses variant="destructive" for visibility

Styling:
- Bell icon: h-5 w-5
- Badge: absolute -top-2 -right-2 h-5 w-5 p-0 flex items-center justify-center text-xs rounded-full
- Container: relative inline-flex

This is a server component - no 'use client' needed since getUnreadAlertCount uses server supabase.
  </action>
  <verify>
- File exists: `ls src/components/alerts/alert-badge.tsx`
- Is async function: `grep "async function AlertBadge" src/components/alerts/alert-badge.tsx`
- Uses getUnreadAlertCount: `grep "getUnreadAlertCount" src/components/alerts/alert-badge.tsx`
- Uses Badge: `grep "Badge" src/components/alerts/alert-badge.tsx`
- Uses Bell: `grep "Bell" src/components/alerts/alert-badge.tsx`
  </verify>
  <done>Alert badge server component created showing unread alert count</done>
</task>

<task type="auto">
  <name>Task 2: Create alert item component</name>
  <files>src/components/alerts/alert-item.tsx</files>
  <action>
Create src/components/alerts/alert-item.tsx as a CLIENT component ('use client'):

1. Import Alert, ALERT_SEVERIDAD_CONFIG, ALERT_TIPO_LABELS from '@/types/alerts'
2. Import Badge from '@/components/ui/badge'
3. Import Info, AlertTriangle, AlertCircle icons from 'lucide-react'
4. Import format from 'date-fns'
5. Import es locale from 'date-fns/locale/es'
6. Import Link from 'next/link'

7. Props interface:
   - alert: Alert
   - onResolve?: (alert: Alert) => void

8. Component renders:
   - Container with severity bgColor (from config)
   - Icon based on severity (Info/AlertTriangle/AlertCircle)
   - Severity badge with variant from config
   - Titulo (bold)
   - Descripcion (text-sm text-gray-600)
   - Created at timestamp formatted with date-fns (dd MMM yyyy HH:mm)
   - If not resuelta, show "Resolver" button that calls onResolve
   - If resuelta, show "Resuelta" text with resuelta_at date
   - Link to referencia if referencia_tipo is 'payment' (/pagos/[id]) or 'cash_closing' (/cierres/[id])

Icon mapping:
```typescript
const SEVERITY_ICONS = {
  info: Info,
  advertencia: AlertTriangle,
  critico: AlertCircle,
}
```
  </action>
  <verify>
- File exists: `ls src/components/alerts/alert-item.tsx`
- Has 'use client': `grep "'use client'" src/components/alerts/alert-item.tsx`
- Has AlertItem: `grep "AlertItem" src/components/alerts/alert-item.tsx`
- Uses severity config: `grep "ALERT_SEVERIDAD_CONFIG" src/components/alerts/alert-item.tsx`
- Has date formatting: `grep "format" src/components/alerts/alert-item.tsx`
  </verify>
  <done>Alert item component created with severity styling and resolve action</done>
</task>

<task type="auto">
  <name>Task 3: Create alerts widget and resolve dialog</name>
  <files>src/components/alerts/alerts-widget.tsx, src/components/alerts/resolve-alert-dialog.tsx</files>
  <action>
Create src/components/alerts/resolve-alert-dialog.tsx ('use client'):

1. Import Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter from '@/components/ui/dialog'
2. Import Button from '@/components/ui/button'
3. Import Textarea from '@/components/ui/textarea'
4. Import Label from '@/components/ui/label'
5. Import Alert type from '@/types/alerts'
6. Import resolveAlertAction from '@/app/(protected)/reportes/actions'
7. Import useState, useTransition from 'react'
8. Import toast from 'sonner'

Props:
- alert: Alert | null
- open: boolean
- onOpenChange: (open: boolean) => void

Component:
- Controlled dialog with open/onOpenChange
- Shows alert.titulo and alert.descripcion as context
- Textarea for notas (required)
- Submit button with loading state using useTransition
- On submit: call resolveAlertAction, show toast, close dialog

---

Create src/components/alerts/alerts-widget.tsx ('use client'):

1. Import Card, CardHeader, CardTitle, CardContent from '@/components/ui/card'
2. Import AlertItem from './alert-item'
3. Import ResolveAlertDialog from './resolve-alert-dialog'
4. Import Alert type from '@/types/alerts'
5. Import useState from 'react'
6. Import Bell icon from 'lucide-react'

Props:
- alerts: Alert[] (passed from server component)

Component:
- Card with header "Alertas Recientes" and Bell icon
- If alerts.length === 0, show "No hay alertas pendientes" message
- Map over alerts, render AlertItem for each
- Track selectedAlert state for resolve dialog
- When AlertItem onResolve is clicked, set selectedAlert and open dialog
- ResolveAlertDialog with open state

Styling:
- Card with max-h-96 overflow-y-auto for scrolling if many alerts
- Divide-y for alert items separation
  </action>
  <verify>
- Files exist: `ls src/components/alerts/alerts-widget.tsx src/components/alerts/resolve-alert-dialog.tsx`
- Both have 'use client': `grep -l "'use client'" src/components/alerts/alerts-widget.tsx src/components/alerts/resolve-alert-dialog.tsx | wc -l` shows 2
- Widget uses AlertItem: `grep "AlertItem" src/components/alerts/alerts-widget.tsx`
- Dialog uses resolveAlertAction: `grep "resolveAlertAction" src/components/alerts/resolve-alert-dialog.tsx`
- Dialog has Textarea: `grep "Textarea" src/components/alerts/resolve-alert-dialog.tsx`
  </verify>
  <done>Alerts widget and resolve dialog created for dashboard integration</done>
</task>

</tasks>

<verification>
1. All components type-check: `npx tsc --noEmit src/components/alerts/*.tsx`
2. AlertBadge is server component (no 'use client')
3. AlertItem, AlertsWidget, ResolveAlertDialog are client components
4. All imports resolve correctly
</verification>

<success_criteria>
- src/components/alerts/alert-badge.tsx: Server component with unread count badge
- src/components/alerts/alert-item.tsx: Client component with severity styling and resolve button
- src/components/alerts/alerts-widget.tsx: Client component with card layout and alert list
- src/components/alerts/resolve-alert-dialog.tsx: Client component with form and server action
- Severity colors/icons match ALERT_SEVERIDAD_CONFIG
- Links to payment/cierre detail pages work
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-alerts/08-04-SUMMARY.md`
</output>
