---
phase: 14-returns-workflow
plan: 05
type: execute
wave: 4
depends_on: ["14-03", "14-04"]
files_modified:
  - src/components/medias/returns/returns-table.tsx
  - src/components/medias/returns/return-form.tsx
  - src/components/medias/returns/approve-dialog.tsx
  - src/components/medias/returns/reject-dialog.tsx
  - src/components/medias/returns/return-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "ReturnsTable displays returns with estado badges and action buttons"
    - "ReturnForm allows selecting sale item, quantity, motivo, and refund method"
    - "ApproveDialog and RejectDialog use useActionState pattern"
    - "Only admin/medico see approve/reject buttons"
  artifacts:
    - path: "src/components/medias/returns/returns-table.tsx"
      provides: "Returns list table component"
      min_lines: 80
    - path: "src/components/medias/returns/return-form.tsx"
      provides: "Return creation form"
      min_lines: 100
    - path: "src/components/medias/returns/approve-dialog.tsx"
      provides: "Approval dialog with optional notes"
      min_lines: 60
    - path: "src/components/medias/returns/reject-dialog.tsx"
      provides: "Rejection dialog with optional notes"
      min_lines: 60
    - path: "src/components/medias/returns/return-status-badge.tsx"
      provides: "Status badge component"
      min_lines: 20
  key_links:
    - from: "return-form.tsx"
      to: "actions.ts"
      via: "useActionState"
      pattern: "useActionState.*createReturn"
    - from: "approve-dialog.tsx"
      to: "actions.ts"
      via: "useActionState"
      pattern: "useActionState.*approveReturn"
---

<objective>
Create UI components for the returns workflow: table display, creation form, and approval/rejection dialogs.

Purpose: Provides the user interface for all return operations following existing medias component patterns.
Output: Five component files matching existing sales component patterns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-returns-workflow/14-CONTEXT.md
@src/components/medias/sales/sales-table.tsx
@src/components/medias/sales/delete-sale-dialog.tsx
@src/components/medias/sales/sale-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create return status badge component</name>
  <files>src/components/medias/returns/return-status-badge.tsx</files>
  <action>
Create simple badge component for return status:

```typescript
import { DevolucionEstado, DEVOLUCION_ESTADO_LABELS, DEVOLUCION_ESTADO_COLORS } from '@/types/medias/returns'
import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'

interface ReturnStatusBadgeProps {
  estado: DevolucionEstado
}

export function ReturnStatusBadge({ estado }: ReturnStatusBadgeProps) {
  return (
    <Badge className={cn('font-medium', DEVOLUCION_ESTADO_COLORS[estado])}>
      {DEVOLUCION_ESTADO_LABELS[estado]}
    </Badge>
  )
}
```

Simple, reusable component used by table and detail views.
  </action>
  <verify>Check Badge renders with correct color for each estado</verify>
  <done>ReturnStatusBadge component displays estado with appropriate styling</done>
</task>

<task type="auto">
  <name>Task 2: Create returns table component</name>
  <files>src/components/medias/returns/returns-table.tsx</files>
  <action>
Create table component following sales-table.tsx pattern:

```typescript
'use client'

import { MediasReturnWithDetails, DevolucionEstado } from '@/types/medias/returns'
import { ReturnStatusBadge } from './return-status-badge'
import { ApproveDialog } from './approve-dialog'
import { RejectDialog } from './reject-dialog'
import { formatCurrency } from '@/lib/utils'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import Link from 'next/link'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { Eye } from 'lucide-react'

interface ReturnsTableProps {
  returns: MediasReturnWithDetails[]
  userRole: string
  showActions?: boolean
}

export function ReturnsTable({ returns, userRole, showActions = true }: ReturnsTableProps) {
  const canApprove = ['admin', 'medico'].includes(userRole)

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Numero</TableHead>
          <TableHead>Venta</TableHead>
          <TableHead>Producto</TableHead>
          <TableHead className="text-right">Cantidad</TableHead>
          <TableHead className="text-right">Monto</TableHead>
          <TableHead>Reembolso</TableHead>
          <TableHead>Estado</TableHead>
          <TableHead>Fecha</TableHead>
          {showActions && <TableHead className="text-right">Acciones</TableHead>}
        </TableRow>
      </TableHeader>
      <TableBody>
        {returns.map((ret) => (
          <TableRow key={ret.id}>
            <TableCell className="font-mono">{ret.numero_devolucion}</TableCell>
            <TableCell>
              <Link href={`/medias/ventas/${ret.sale_id}`} className="hover:underline">
                {ret.sale?.numero_venta}
              </Link>
            </TableCell>
            <TableCell>
              {ret.product_codigo} - {ret.product_tipo} {ret.product_talla}
            </TableCell>
            <TableCell className="text-right">{ret.cantidad}</TableCell>
            <TableCell className="text-right font-medium">
              {formatCurrency(ret.monto_devolucion)}
            </TableCell>
            <TableCell>{REEMBOLSO_METODO_LABELS[ret.metodo_reembolso]}</TableCell>
            <TableCell>
              <ReturnStatusBadge estado={ret.estado} />
            </TableCell>
            <TableCell>
              {format(new Date(ret.created_at), 'dd/MM/yyyy', { locale: es })}
            </TableCell>
            {showActions && (
              <TableCell className="text-right space-x-1">
                <Button variant="ghost" size="icon" asChild>
                  <Link href={`/medias/devoluciones/${ret.id}`}>
                    <Eye className="h-4 w-4" />
                  </Link>
                </Button>
                {canApprove && ret.estado === 'pendiente' && (
                  <>
                    <ApproveDialog returnId={ret.id} numeroDevolucion={ret.numero_devolucion} />
                    <RejectDialog returnId={ret.id} numeroDevolucion={ret.numero_devolucion} />
                  </>
                )}
              </TableCell>
            )}
          </TableRow>
        ))}
        {returns.length === 0 && (
          <TableRow>
            <TableCell colSpan={showActions ? 9 : 8} className="text-center text-muted-foreground">
              No hay devoluciones
            </TableCell>
          </TableRow>
        )}
      </TableBody>
    </Table>
  )
}
```

Include import for REEMBOLSO_METODO_LABELS from types.
  </action>
  <verify>Check approve/reject buttons only show for pendiente returns and admin/medico users</verify>
  <done>ReturnsTable displays returns with conditional action buttons</done>
</task>

<task type="auto">
  <name>Task 3: Create return form component</name>
  <files>src/components/medias/returns/return-form.tsx</files>
  <action>
Create form component for creating return requests:

```typescript
'use client'

import { useActionState, useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { createReturn, ReturnActionState } from '@/app/(protected)/medias/devoluciones/actions'
import { MediasSaleWithDetails, MediasSaleItem } from '@/types/medias/sales'
import { REEMBOLSO_METODOS, REEMBOLSO_METODO_LABELS } from '@/types/medias/returns'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Input } from '@/components/ui/input'
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { toast } from 'sonner'
import { Loader2 } from 'lucide-react'

interface ReturnFormProps {
  sale: MediasSaleWithDetails
  returnableQuantities: Record<string, number>  // sale_item_id -> max returnable
}

export function ReturnForm({ sale, returnableQuantities }: ReturnFormProps) {
  const router = useRouter()
  const [state, formAction, isPending] = useActionState<ReturnActionState | null, FormData>(
    createReturn,
    null
  )

  const [selectedItemId, setSelectedItemId] = useState<string>('')
  const [cantidad, setCantidad] = useState(1)
  const [metodoReembolso, setMetodoReembolso] = useState<string>('efectivo')

  // Filter to items with returnable quantity > 0
  const returnableItems = sale.items.filter(
    (item) => (returnableQuantities[item.id] ?? 0) > 0
  )

  const selectedItem = sale.items.find((item) => item.id === selectedItemId)
  const maxQuantity = selectedItem ? (returnableQuantities[selectedItem.id] ?? 0) : 0

  useEffect(() => {
    if (state?.success) {
      toast.success(`Devolucion ${state.data?.numero_devolucion} creada`)
      router.push('/medias/devoluciones')
    } else if (state?.error) {
      toast.error(state.error)
    }
  }, [state, router])

  // Auto-select first returnable item
  useEffect(() => {
    if (returnableItems.length > 0 && !selectedItemId) {
      setSelectedItemId(returnableItems[0].id)
    }
  }, [returnableItems, selectedItemId])

  if (returnableItems.length === 0) {
    return (
      <div className="text-center text-muted-foreground py-8">
        No hay productos disponibles para devolucion en esta venta.
        <br />
        (Todos los productos ya han sido devueltos o tienen solicitudes pendientes)
      </div>
    )
  }

  return (
    <form action={formAction} className="space-y-6">
      <input type="hidden" name="sale_id" value={sale.id} />
      <input type="hidden" name="sale_item_id" value={selectedItemId} />
      <input type="hidden" name="metodo_reembolso" value={metodoReembolso} />

      {/* Item selection */}
      <div className="space-y-2">
        <Label htmlFor="item">Producto a devolver</Label>
        <Select value={selectedItemId} onValueChange={setSelectedItemId}>
          <SelectTrigger>
            <SelectValue placeholder="Seleccione producto" />
          </SelectTrigger>
          <SelectContent>
            {returnableItems.map((item) => (
              <SelectItem key={item.id} value={item.id}>
                {item.product_codigo} - {item.product_tipo} {item.product_talla}
                (Max: {returnableQuantities[item.id]})
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Quantity */}
      <div className="space-y-2">
        <Label htmlFor="cantidad">Cantidad (max: {maxQuantity})</Label>
        <Input
          type="number"
          name="cantidad"
          min={1}
          max={maxQuantity}
          value={cantidad}
          onChange={(e) => setCantidad(Math.min(parseInt(e.target.value) || 1, maxQuantity))}
        />
        {state?.errors?.cantidad && (
          <p className="text-sm text-destructive">{state.errors.cantidad[0]}</p>
        )}
      </div>

      {/* Refund method */}
      <div className="space-y-2">
        <Label>Metodo de reembolso</Label>
        <RadioGroup value={metodoReembolso} onValueChange={setMetodoReembolso}>
          {REEMBOLSO_METODOS.map((metodo) => (
            <div key={metodo} className="flex items-center space-x-2">
              <RadioGroupItem value={metodo} id={metodo} />
              <Label htmlFor={metodo}>{REEMBOLSO_METODO_LABELS[metodo]}</Label>
            </div>
          ))}
        </RadioGroup>
      </div>

      {/* Motivo */}
      <div className="space-y-2">
        <Label htmlFor="motivo">Motivo de la devolucion (minimo 10 caracteres)</Label>
        <Textarea
          name="motivo"
          placeholder="Describa el motivo de la devolucion..."
          rows={3}
        />
        {state?.errors?.motivo && (
          <p className="text-sm text-destructive">{state.errors.motivo[0]}</p>
        )}
      </div>

      {/* Optional photo - hidden for now, can add ReceiptUpload later */}
      <input type="hidden" name="foto_path" value="" />

      <Button type="submit" disabled={isPending || !selectedItemId}>
        {isPending ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            Creando...
          </>
        ) : (
          'Crear Solicitud de Devolucion'
        )}
      </Button>
    </form>
  )
}
```

Key features:
- Filters to only show items with returnable quantity > 0
- Validates quantity against max returnable
- Uses RadioGroup for refund method selection
- foto_path is optional (empty for now)
  </action>
  <verify>Check form validates quantity against returnableQuantities prop</verify>
  <done>ReturnForm allows selecting item, quantity, and refund method with validation</done>
</task>

<task type="auto">
  <name>Task 4: Create approve and reject dialogs</name>
  <files>src/components/medias/returns/approve-dialog.tsx, src/components/medias/returns/reject-dialog.tsx</files>
  <action>
Create dialog components following delete-sale-dialog.tsx pattern:

**approve-dialog.tsx:**
```typescript
'use client'

import { useState, useEffect, useActionState } from 'react'
import { approveReturn, ReturnActionState } from '@/app/(protected)/medias/devoluciones/actions'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { toast } from 'sonner'
import { Check, Loader2 } from 'lucide-react'

interface ApproveDialogProps {
  returnId: string
  numeroDevolucion: string
}

export function ApproveDialog({ returnId, numeroDevolucion }: ApproveDialogProps) {
  const [open, setOpen] = useState(false)
  const [notas, setNotas] = useState('')

  const [state, formAction, isPending] = useActionState<ReturnActionState | null, FormData>(
    approveReturn,
    null
  )

  useEffect(() => {
    if (state?.success) {
      toast.success(`Devolucion ${numeroDevolucion} aprobada`)
      setOpen(false)
      setNotas('')
    } else if (state?.error) {
      toast.error(state.error)
    }
  }, [state, numeroDevolucion])

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button variant="ghost" size="icon" className="text-green-600 hover:text-green-700">
          <Check className="h-4 w-4" />
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Aprobar Devolucion</DialogTitle>
          <DialogDescription>
            Esta accion aprobara la devolucion {numeroDevolucion}.
            El stock de devoluciones se incrementara automaticamente.
          </DialogDescription>
        </DialogHeader>
        <form action={formAction}>
          <input type="hidden" name="return_id" value={returnId} />
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="notas">Notas (opcional)</Label>
              <Textarea
                name="notas"
                value={notas}
                onChange={(e) => setNotas(e.target.value)}
                placeholder="Notas adicionales..."
                rows={2}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" type="button" onClick={() => setOpen(false)}>
              Cancelar
            </Button>
            <Button type="submit" disabled={isPending}>
              {isPending ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Aprobando...
                </>
              ) : (
                'Aprobar Devolucion'
              )}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

**reject-dialog.tsx:**
Same pattern but with:
- Red/orange styling for reject button (X icon)
- "Rechazar Devolucion" title
- "Sin efecto en el stock" in description
- Calls rejectReturn action
  </action>
  <verify>Check both dialogs close on success and show toast messages</verify>
  <done>ApproveDialog and RejectDialog provide approval/rejection UI with optional notes</done>
</task>

</tasks>

<verification>
1. ReturnStatusBadge uses colors from DEVOLUCION_ESTADO_COLORS
2. ReturnsTable conditionally shows approve/reject for admin/medico only
3. ReturnForm filters items to only those with returnable quantity > 0
4. ReturnForm validates cantidad <= maxQuantity
5. Dialogs use useActionState pattern matching existing codebase
6. All components use Spanish labels and messages
</verification>

<success_criteria>
- [ ] src/components/medias/returns/return-status-badge.tsx created
- [ ] src/components/medias/returns/returns-table.tsx created with role-based actions
- [ ] src/components/medias/returns/return-form.tsx created with quantity validation
- [ ] src/components/medias/returns/approve-dialog.tsx created
- [ ] src/components/medias/returns/reject-dialog.tsx created
- [ ] All components follow existing medias patterns
- [ ] Toast notifications on success/error
</success_criteria>

<output>
After completion, create `.planning/phases/14-returns-workflow/14-05-SUMMARY.md`
</output>
