---
phase: 02-patients
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/app/(protected)/pacientes/nuevo/actions.ts
  - src/app/(protected)/pacientes/[id]/editar/actions.ts
  - src/components/patients/patient-form.tsx
autonomous: true

must_haves:
  truths:
    - "Server action validates data with Zod before database insert"
    - "Server action returns field-level errors for form display"
    - "Form component uses react-hook-form with zodResolver"
    - "Form shows loading state during submission"
    - "Edit form has cedula field disabled"
  artifacts:
    - path: "src/app/(protected)/pacientes/nuevo/actions.ts"
      provides: "createPatient server action"
      exports: ["createPatient"]
    - path: "src/app/(protected)/pacientes/[id]/editar/actions.ts"
      provides: "updatePatient server action"
      exports: ["updatePatient"]
    - path: "src/components/patients/patient-form.tsx"
      provides: "Reusable patient form component"
      exports: ["PatientForm"]
  key_links:
    - from: "src/app/(protected)/pacientes/nuevo/actions.ts"
      to: "src/lib/validations/patient.ts"
      via: "patientSchema import"
      pattern: "patientSchema.safeParse"
    - from: "src/components/patients/patient-form.tsx"
      to: "react-hook-form"
      via: "useForm hook"
      pattern: "useForm.*zodResolver"
---

<objective>
Create server actions for patient CRUD and reusable form component

Purpose: Implements the create/update flow with proper server-side validation and a form component that handles both create and edit modes. The form uses React Hook Form + Zod for instant client validation plus server-side validation for security.
Output: Server actions and form component ready for page integration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-patients/02-RESEARCH.md

# Validation schemas from 02-03
@src/lib/validations/patient.ts

# Supabase server client
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for patient CRUD</name>
  <files>
    src/app/(protected)/pacientes/nuevo/actions.ts
    src/app/(protected)/pacientes/[id]/editar/actions.ts
  </files>
  <action>
Create the directory structure:
```bash
mkdir -p src/app/\(protected\)/pacientes/nuevo
mkdir -p src/app/\(protected\)/pacientes/\[id\]/editar
```

Create `src/app/(protected)/pacientes/nuevo/actions.ts`:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { patientSchema } from '@/lib/validations/patient'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

export type ActionState = {
  error?: string
  errors?: Record<string, string[]>
  success?: boolean
}

/**
 * Server action to create a new patient
 * Uses Zod validation on server side for security
 */
export async function createPatient(
  prevState: ActionState | null,
  formData: FormData
): Promise<ActionState> {
  const supabase = await createClient()

  // Verify user is authenticated
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    return { error: 'No autorizado. Por favor inicie sesion.' }
  }

  // Parse form data
  const rawData = {
    cedula: formData.get('cedula'),
    nombre: formData.get('nombre'),
    apellido: formData.get('apellido'),
    celular: formData.get('celular'),
    email: formData.get('email') || '',
    fecha_nacimiento: formData.get('fecha_nacimiento') || '',
    direccion: formData.get('direccion') || '',
    contacto_emergencia_nombre: formData.get('contacto_emergencia_nombre'),
    contacto_emergencia_telefono: formData.get('contacto_emergencia_telefono'),
    contacto_emergencia_parentesco: formData.get('contacto_emergencia_parentesco'),
  }

  // Validate with Zod
  const validated = patientSchema.safeParse(rawData)

  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
      error: 'Por favor corrija los errores en el formulario',
    }
  }

  // Prepare data for insert (handle empty strings -> null)
  const insertData = {
    ...validated.data,
    email: validated.data.email || null,
    fecha_nacimiento: validated.data.fecha_nacimiento || null,
    direccion: validated.data.direccion || null,
    created_by: user.id,
  }

  // Insert into database
  const { data, error } = await supabase
    .from('patients')
    .insert(insertData)
    .select('id')
    .single()

  if (error) {
    // Handle unique constraint violation (duplicate cedula)
    if (error.code === '23505') {
      return {
        error: 'Ya existe un paciente con esta cedula',
        errors: { cedula: ['Esta cedula ya esta registrada'] },
      }
    }
    console.error('Patient creation error:', error)
    return { error: 'Error al crear paciente. Por favor intente de nuevo.' }
  }

  // Revalidate patient list and redirect to new patient
  revalidatePath('/pacientes')
  redirect(`/pacientes/${data.id}`)
}
```

Create `src/app/(protected)/pacientes/[id]/editar/actions.ts`:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { patientUpdateSchema } from '@/lib/validations/patient'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

export type ActionState = {
  error?: string
  errors?: Record<string, string[]>
  success?: boolean
}

/**
 * Server action to update an existing patient
 * NOTE: cedula cannot be updated (enforced by Zod schema AND database trigger)
 */
export async function updatePatient(
  patientId: string,
  prevState: ActionState | null,
  formData: FormData
): Promise<ActionState> {
  const supabase = await createClient()

  // Verify user is authenticated
  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (!user) {
    return { error: 'No autorizado. Por favor inicie sesion.' }
  }

  // Parse form data (cedula intentionally omitted)
  const rawData = {
    nombre: formData.get('nombre'),
    apellido: formData.get('apellido'),
    celular: formData.get('celular'),
    email: formData.get('email') || '',
    fecha_nacimiento: formData.get('fecha_nacimiento') || '',
    direccion: formData.get('direccion') || '',
    contacto_emergencia_nombre: formData.get('contacto_emergencia_nombre'),
    contacto_emergencia_telefono: formData.get('contacto_emergencia_telefono'),
    contacto_emergencia_parentesco: formData.get('contacto_emergencia_parentesco'),
  }

  // Validate with update schema (no cedula)
  const validated = patientUpdateSchema.safeParse(rawData)

  if (!validated.success) {
    return {
      errors: validated.error.flatten().fieldErrors as Record<string, string[]>,
      error: 'Por favor corrija los errores en el formulario',
    }
  }

  // Prepare data for update (handle empty strings -> null)
  const updateData = {
    ...validated.data,
    email: validated.data.email || null,
    fecha_nacimiento: validated.data.fecha_nacimiento || null,
    direccion: validated.data.direccion || null,
  }

  // Update in database
  const { error } = await supabase
    .from('patients')
    .update(updateData)
    .eq('id', patientId)

  if (error) {
    console.error('Patient update error:', error)
    return { error: 'Error al actualizar paciente. Por favor intente de nuevo.' }
  }

  // Revalidate and redirect
  revalidatePath('/pacientes')
  revalidatePath(`/pacientes/${patientId}`)
  redirect(`/pacientes/${patientId}`)
}
```

Key points:
1. Both actions use 'use server' directive
2. Both validate with Zod schema BEFORE database operation
3. createPatient uses full schema, updatePatient uses schema.omit({cedula})
4. Duplicate cedula returns user-friendly Spanish error
5. Both redirect after success (createPatient to detail, updatePatient to detail)
6. Both revalidate the patients list cache
  </action>
  <verify>
Run:
- `cat src/app/\(protected\)/pacientes/nuevo/actions.ts | grep -E "(use server|safeParse|redirect)"` - should show all 3 patterns
- `cat src/app/\(protected\)/pacientes/\[id\]/editar/actions.ts | grep -E "(patientUpdateSchema|cedula)"` - should show schema import, NO cedula in rawData
  </verify>
  <done>
Server actions created with Zod validation, Spanish error messages, and proper redirects
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reusable patient form component</name>
  <files>src/components/patients/patient-form.tsx</files>
  <action>
Create the directory: `mkdir -p src/components/patients`

Create `src/components/patients/patient-form.tsx`:

```typescript
'use client'

import { useActionState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import {
  patientSchema,
  patientUpdateSchema,
  type PatientFormData,
  type PatientUpdateData,
} from '@/lib/validations/patient'
import { createPatient } from '@/app/(protected)/pacientes/nuevo/actions'
import { updatePatient } from '@/app/(protected)/pacientes/[id]/editar/actions'
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

interface PatientFormProps {
  mode: 'create' | 'edit'
  patientId?: string
  defaultValues?: Partial<PatientFormData>
}

/**
 * Reusable patient form for create and edit operations
 *
 * In edit mode:
 * - cedula field is disabled (database trigger also prevents changes)
 * - Uses patientUpdateSchema (cedula omitted from validation)
 */
export function PatientForm({ mode, patientId, defaultValues }: PatientFormProps) {
  const isEdit = mode === 'edit'

  // Server action with state
  const boundUpdateAction = patientId
    ? updatePatient.bind(null, patientId)
    : undefined

  const [state, formAction, pending] = useActionState(
    isEdit && boundUpdateAction ? boundUpdateAction : createPatient,
    null
  )

  // Form with Zod validation
  const form = useForm<PatientFormData>({
    resolver: zodResolver(isEdit ? patientUpdateSchema : patientSchema),
    defaultValues: {
      cedula: '',
      nombre: '',
      apellido: '',
      celular: '',
      email: '',
      fecha_nacimiento: '',
      direccion: '',
      contacto_emergencia_nombre: '',
      contacto_emergencia_telefono: '',
      contacto_emergencia_parentesco: '',
      ...defaultValues,
    },
  })

  return (
    <Form {...form}>
      <form action={formAction} className="space-y-6">
        {/* Server error message */}
        {state?.error && (
          <div className="rounded-md bg-red-50 p-4 text-sm text-red-700">
            {state.error}
          </div>
        )}

        {/* Personal Information */}
        <Card>
          <CardHeader>
            <CardTitle>Informacion Personal</CardTitle>
          </CardHeader>
          <CardContent className="grid gap-4 sm:grid-cols-2">
            {/* Cedula */}
            <FormField
              control={form.control}
              name="cedula"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Cedula *</FormLabel>
                  <FormControl>
                    <Input
                      {...field}
                      placeholder="1234567890"
                      disabled={isEdit}
                      className={isEdit ? 'bg-gray-100' : ''}
                    />
                  </FormControl>
                  <FormMessage />
                  {state?.errors?.cedula && (
                    <p className="text-sm text-red-600">{state.errors.cedula[0]}</p>
                  )}
                  {isEdit && (
                    <p className="text-xs text-gray-500">
                      La cedula no puede ser modificada
                    </p>
                  )}
                </FormItem>
              )}
            />

            {/* Nombre */}
            <FormField
              control={form.control}
              name="nombre"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nombre *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Juan" />
                  </FormControl>
                  <FormMessage />
                  {state?.errors?.nombre && (
                    <p className="text-sm text-red-600">{state.errors.nombre[0]}</p>
                  )}
                </FormItem>
              )}
            />

            {/* Apellido */}
            <FormField
              control={form.control}
              name="apellido"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Apellido *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Perez" />
                  </FormControl>
                  <FormMessage />
                  {state?.errors?.apellido && (
                    <p className="text-sm text-red-600">{state.errors.apellido[0]}</p>
                  )}
                </FormItem>
              )}
            />

            {/* Celular */}
            <FormField
              control={form.control}
              name="celular"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Celular *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="3001234567" type="tel" />
                  </FormControl>
                  <FormMessage />
                  {state?.errors?.celular && (
                    <p className="text-sm text-red-600">{state.errors.celular[0]}</p>
                  )}
                </FormItem>
              )}
            />

            {/* Email */}
            <FormField
              control={form.control}
              name="email"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Email</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="juan@ejemplo.com" type="email" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Fecha de Nacimiento */}
            <FormField
              control={form.control}
              name="fecha_nacimiento"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Fecha de Nacimiento</FormLabel>
                  <FormControl>
                    <Input {...field} type="date" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Direccion */}
            <FormField
              control={form.control}
              name="direccion"
              render={({ field }) => (
                <FormItem className="sm:col-span-2">
                  <FormLabel>Direccion</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Calle 123 #45-67, Bucaramanga" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Emergency Contact */}
        <Card>
          <CardHeader>
            <CardTitle>Contacto de Emergencia</CardTitle>
          </CardHeader>
          <CardContent className="grid gap-4 sm:grid-cols-2">
            {/* Nombre Contacto */}
            <FormField
              control={form.control}
              name="contacto_emergencia_nombre"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Nombre *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Maria Garcia" />
                  </FormControl>
                  <FormMessage />
                  {state?.errors?.contacto_emergencia_nombre && (
                    <p className="text-sm text-red-600">
                      {state.errors.contacto_emergencia_nombre[0]}
                    </p>
                  )}
                </FormItem>
              )}
            />

            {/* Telefono Contacto */}
            <FormField
              control={form.control}
              name="contacto_emergencia_telefono"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Telefono *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="3009876543" type="tel" />
                  </FormControl>
                  <FormMessage />
                  {state?.errors?.contacto_emergencia_telefono && (
                    <p className="text-sm text-red-600">
                      {state.errors.contacto_emergencia_telefono[0]}
                    </p>
                  )}
                </FormItem>
              )}
            />

            {/* Parentesco */}
            <FormField
              control={form.control}
              name="contacto_emergencia_parentesco"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Parentesco *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Esposa, Hijo, Hermano..." />
                  </FormControl>
                  <FormMessage />
                  {state?.errors?.contacto_emergencia_parentesco && (
                    <p className="text-sm text-red-600">
                      {state.errors.contacto_emergencia_parentesco[0]}
                    </p>
                  )}
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Submit Button */}
        <div className="flex justify-end gap-4">
          <Button type="submit" disabled={pending}>
            {pending ? 'Guardando...' : isEdit ? 'Actualizar Paciente' : 'Registrar Paciente'}
          </Button>
        </div>
      </form>
    </Form>
  )
}
```

Key points:
1. Component handles both create and edit modes via `mode` prop
2. Edit mode: cedula disabled with visual indicator and helper text
3. Uses useActionState for server action integration
4. Uses react-hook-form with zodResolver for instant client validation
5. Shows both client-side errors (FormMessage) and server-side errors (state.errors)
6. Card layout groups related fields
7. All labels and messages in Spanish
8. Loading state disables submit and shows "Guardando..."
  </action>
  <verify>
Run `cat src/components/patients/patient-form.tsx | grep -E "(useActionState|useForm|zodResolver|disabled.*isEdit)"` - should show form hooks and edit mode disabled pattern.
  </verify>
  <done>
Patient form component created with create/edit modes, RHF+Zod validation, and Spanish labels
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` should pass
2. Server actions exist in correct locations
3. Form component handles both create and edit modes
</verification>

<success_criteria>
- createPatient action validates with patientSchema and redirects on success
- updatePatient action validates with patientUpdateSchema (no cedula)
- PatientForm uses useForm with zodResolver
- Edit mode disables cedula field with visual feedback
- Loading state shows during submission
- Spanish error messages display correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-patients/02-04-SUMMARY.md`
</output>
