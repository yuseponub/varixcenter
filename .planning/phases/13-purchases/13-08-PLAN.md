---
phase: 13-purchases
plan: 08
type: execute
wave: 4
depends_on: ["13-03", "13-05"]
files_modified:
  - src/components/purchases/purchase-form.tsx
  - src/components/purchases/purchases-table.tsx
  - src/components/purchases/confirm-reception-dialog.tsx
  - src/components/purchases/purchase-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "PurchaseForm allows manual product entry"
    - "PurchasesTable shows purchases with estado badges"
    - "ConfirmReceptionDialog confirms stock increment"
    - "Table filters by estado, proveedor, fecha"
  artifacts:
    - path: "src/components/purchases/purchase-form.tsx"
      provides: "Purchase creation form"
      exports: ["PurchaseForm"]
    - path: "src/components/purchases/purchases-table.tsx"
      provides: "Purchases list with filters"
      exports: ["PurchasesTable"]
    - path: "src/components/purchases/confirm-reception-dialog.tsx"
      provides: "Reception confirmation dialog"
      exports: ["ConfirmReceptionDialog"]
    - path: "src/components/purchases/purchase-status-badge.tsx"
      provides: "Estado badge component"
      exports: ["PurchaseStatusBadge"]
  key_links:
    - from: "src/components/purchases/purchases-table.tsx"
      to: "src/types/purchases.ts"
      via: "type imports"
      pattern: "import.*from.*@/types/purchases"
    - from: "src/components/purchases/purchase-form.tsx"
      to: "src/types/purchases.ts"
      via: "PurchaseItemInput type"
      pattern: "import.*PurchaseItemInput.*from.*@/types/purchases"
---

<objective>
Create purchase form, table, and dialog components

Purpose: UI components for purchase creation, listing, and reception confirmation
Output: Core purchase UI components
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-purchases/13-CONTEXT.md
@src/components/medias/products-table.tsx
@src/components/appointments/appointment-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PurchaseStatusBadge component</name>
  <files>src/components/purchases/purchase-status-badge.tsx</files>
  <action>
Create simple badge component for purchase states:

```typescript
import { Badge } from '@/components/ui/badge'
import type { PurchaseState } from '@/types/purchases'
import { PURCHASE_STATE_LABELS } from '@/types/purchases'

const STATE_VARIANTS: Record<PurchaseState, 'secondary' | 'default' | 'destructive'> = {
  'pendiente_recepcion': 'secondary',
  'recibido': 'default',
  'anulado': 'destructive',
}

interface PurchaseStatusBadgeProps {
  estado: PurchaseState
}

export function PurchaseStatusBadge({ estado }: PurchaseStatusBadgeProps) {
  return (
    <Badge variant={STATE_VARIANTS[estado]}>
      {PURCHASE_STATE_LABELS[estado]}
    </Badge>
  )
}
```
  </action>
  <verify>
Run: `cat src/components/purchases/purchase-status-badge.tsx`
Verify: Badge component with correct variants
  </verify>
  <done>
- PurchaseStatusBadge component created
- Uses Badge from shadcn/ui
- Maps estado to variant (secondary/default/destructive)
- Shows Spanish label
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PurchasesTable component</name>
  <files>src/components/purchases/purchases-table.tsx</files>
  <action>
Create table component following existing patterns:

```typescript
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Eye, Package, Search } from 'lucide-react'
import { PurchaseStatusBadge } from './purchase-status-badge'
import type { Purchase, PurchaseState } from '@/types/purchases'
import { PURCHASE_STATES, PURCHASE_STATE_LABELS } from '@/types/purchases'

interface PurchasesTableProps {
  purchases: Purchase[]
  onFilterChange?: (filters: {
    estado?: PurchaseState
    proveedor?: string
  }) => void
}

export function PurchasesTable({ purchases, onFilterChange }: PurchasesTableProps) {
  const [estadoFilter, setEstadoFilter] = useState<PurchaseState | 'all'>('all')
  const [proveedorFilter, setProveedorFilter] = useState('')

  const handleEstadoChange = (value: string) => {
    const estado = value === 'all' ? undefined : (value as PurchaseState)
    setEstadoFilter(value as PurchaseState | 'all')
    onFilterChange?.({ estado, proveedor: proveedorFilter || undefined })
  }

  const handleProveedorChange = (value: string) => {
    setProveedorFilter(value)
    onFilterChange?.({
      estado: estadoFilter === 'all' ? undefined : estadoFilter,
      proveedor: value || undefined,
    })
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
    }).format(amount)
  }

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="flex gap-4">
        <div className="flex-1">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              placeholder="Buscar por proveedor..."
              value={proveedorFilter}
              onChange={(e) => handleProveedorChange(e.target.value)}
              className="pl-10"
            />
          </div>
        </div>
        <Select value={estadoFilter} onValueChange={handleEstadoChange}>
          <SelectTrigger className="w-[200px]">
            <SelectValue placeholder="Filtrar por estado" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Todos los estados</SelectItem>
            {PURCHASE_STATES.map((estado) => (
              <SelectItem key={estado} value={estado}>
                {PURCHASE_STATE_LABELS[estado]}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Table */}
      <div className="border rounded-lg">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>No. Compra</TableHead>
              <TableHead>Fecha Factura</TableHead>
              <TableHead>Proveedor</TableHead>
              <TableHead>Total</TableHead>
              <TableHead>Estado</TableHead>
              <TableHead className="text-right">Acciones</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {purchases.length === 0 ? (
              <TableRow>
                <TableCell colSpan={6} className="text-center py-8 text-gray-500">
                  <Package className="mx-auto h-12 w-12 text-gray-300 mb-2" />
                  <p>No hay compras registradas</p>
                </TableCell>
              </TableRow>
            ) : (
              purchases.map((purchase) => (
                <TableRow key={purchase.id}>
                  <TableCell className="font-mono">
                    {purchase.numero_compra}
                  </TableCell>
                  <TableCell>
                    {format(new Date(purchase.fecha_factura), 'dd MMM yyyy', {
                      locale: es,
                    })}
                  </TableCell>
                  <TableCell className="max-w-[200px] truncate">
                    {purchase.proveedor}
                  </TableCell>
                  <TableCell className="font-medium">
                    {formatCurrency(purchase.total)}
                  </TableCell>
                  <TableCell>
                    <PurchaseStatusBadge estado={purchase.estado} />
                  </TableCell>
                  <TableCell className="text-right">
                    <Link href={`/compras/${purchase.id}`}>
                      <Button variant="ghost" size="sm">
                        <Eye className="h-4 w-4 mr-1" />
                        Ver
                      </Button>
                    </Link>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run: `grep -E "(export function|TableRow|SelectItem)" src/components/purchases/purchases-table.tsx`
Verify: Table component with filters
  </verify>
  <done>
- PurchasesTable component created
- Shows purchases in table format
- Estado filter with dropdown
- Proveedor filter with search input
- Links to detail page
- Empty state handled
- Currency formatting with es-CO locale
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ConfirmReceptionDialog component</name>
  <files>src/components/purchases/confirm-reception-dialog.tsx</files>
  <action>
Create dialog for reception confirmation:

```typescript
'use client'

import { useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Loader2, PackageCheck } from 'lucide-react'
import { confirmReception } from '@/app/(protected)/compras/actions'
import { useRouter } from 'next/navigation'
import { toast } from 'sonner'

interface ConfirmReceptionDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  purchaseId: string
  numeroCompra: string
  itemCount: number
}

export function ConfirmReceptionDialog({
  open,
  onOpenChange,
  purchaseId,
  numeroCompra,
  itemCount,
}: ConfirmReceptionDialogProps) {
  const [isLoading, setIsLoading] = useState(false)
  const router = useRouter()

  const handleConfirm = async () => {
    setIsLoading(true)
    try {
      const result = await confirmReception(purchaseId)

      if (result.success) {
        toast.success('Recepcion confirmada', {
          description: `Stock actualizado para ${itemCount} producto(s)`,
        })
        onOpenChange(false)
        router.refresh()
      } else {
        toast.error('Error', {
          description: result.error || 'No se pudo confirmar la recepcion',
        })
      }
    } catch (error) {
      toast.error('Error', {
        description: 'Error inesperado al confirmar recepcion',
      })
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <PackageCheck className="h-5 w-5 text-green-600" />
            Confirmar Recepcion
          </DialogTitle>
          <DialogDescription>
            Esta accion incrementara el stock para {itemCount} producto(s) de la
            compra <span className="font-mono font-medium">{numeroCompra}</span>.
          </DialogDescription>
        </DialogHeader>

        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm">
          <p className="font-medium text-yellow-800 mb-1">Importante:</p>
          <ul className="list-disc list-inside text-yellow-700 space-y-1">
            <li>Verifique que la mercancia fisica coincida con la factura</li>
            <li>El stock se actualizara inmediatamente</li>
            <li>Esta accion no se puede deshacer facilmente</li>
          </ul>
        </div>

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isLoading}
          >
            Cancelar
          </Button>
          <Button onClick={handleConfirm} disabled={isLoading}>
            {isLoading ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Confirmando...
              </>
            ) : (
              <>
                <PackageCheck className="mr-2 h-4 w-4" />
                Confirmar Recepcion
              </>
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```
  </action>
  <verify>
Run: `grep -E "(export function|confirmReception|Dialog)" src/components/purchases/confirm-reception-dialog.tsx`
Verify: Dialog component with confirmation action
  </verify>
  <done>
- ConfirmReceptionDialog component created
- Shows warning about stock update
- Calls confirmReception server action
- Shows loading state during confirmation
- Toast notifications for success/error
- Refreshes page after confirmation
  </done>
</task>

<task type="auto">
  <name>Task 4: Create PurchaseForm component</name>
  <files>src/components/purchases/purchase-form.tsx</files>
  <action>
Create reusable purchase form component for manual product entry:

```typescript
'use client'

import { useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Plus, Trash2 } from 'lucide-react'
import type { PurchaseItemInput } from '@/types/purchases'

interface Product {
  id: string
  codigo: string
  tipo: string
  talla: string
  precio: number
}

interface PurchaseFormProps {
  products: Product[]
  // Initial values (can come from OCR)
  initialProveedor?: string
  initialFechaFactura?: string
  initialNumeroFactura?: string
  initialNotas?: string
  initialItems?: PurchaseItemInput[]
  // Controlled form values
  proveedor: string
  setProveedor: (value: string) => void
  fechaFactura: string
  setFechaFactura: (value: string) => void
  numeroFactura: string
  setNumeroFactura: (value: string) => void
  notas: string
  setNotas: (value: string) => void
  items: PurchaseItemInput[]
  setItems: (items: PurchaseItemInput[]) => void
  disabled?: boolean
}

export function PurchaseForm({
  products,
  proveedor,
  setProveedor,
  fechaFactura,
  setFechaFactura,
  numeroFactura,
  setNumeroFactura,
  notas,
  setNotas,
  items,
  setItems,
  disabled = false,
}: PurchaseFormProps) {
  const addItem = () => {
    setItems([...items, { product_id: '', cantidad: 1, costo_unitario: 0 }])
  }

  const removeItem = (index: number) => {
    setItems(items.filter((_, i) => i !== index))
  }

  const updateItem = (index: number, updates: Partial<PurchaseItemInput>) => {
    setItems(
      items.map((item, i) => (i === index ? { ...item, ...updates } : item))
    )
  }

  const calculateTotal = () => {
    return items.reduce((sum, item) => sum + item.cantidad * item.costo_unitario, 0)
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
    }).format(amount)
  }

  return (
    <div className="space-y-6">
      {/* Invoice info */}
      <Card>
        <CardHeader>
          <CardTitle>Datos de la Factura</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label>
                Proveedor <span className="text-red-500">*</span>
              </Label>
              <Input
                value={proveedor}
                onChange={(e) => setProveedor(e.target.value)}
                placeholder="Nombre del proveedor"
                disabled={disabled}
              />
            </div>
            <div>
              <Label>
                Fecha de Factura <span className="text-red-500">*</span>
              </Label>
              <Input
                type="date"
                value={fechaFactura}
                onChange={(e) => setFechaFactura(e.target.value)}
                disabled={disabled}
              />
            </div>
            <div>
              <Label>Numero de Factura</Label>
              <Input
                value={numeroFactura}
                onChange={(e) => setNumeroFactura(e.target.value)}
                placeholder="Opcional"
                disabled={disabled}
              />
            </div>
          </div>
          <div>
            <Label>Notas</Label>
            <Textarea
              value={notas}
              onChange={(e) => setNotas(e.target.value)}
              placeholder="Notas adicionales (opcional)"
              disabled={disabled}
            />
          </div>
        </CardContent>
      </Card>

      {/* Products */}
      <Card>
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle>Productos</CardTitle>
          <Button
            variant="outline"
            size="sm"
            onClick={addItem}
            disabled={disabled}
          >
            <Plus className="h-4 w-4 mr-1" />
            Agregar
          </Button>
        </CardHeader>
        <CardContent>
          {items.length === 0 ? (
            <p className="text-center text-gray-500 py-4">
              No hay productos. Haga clic en "Agregar" para comenzar.
            </p>
          ) : (
            <div className="space-y-3">
              {items.map((item, index) => (
                <div
                  key={index}
                  className="grid grid-cols-12 gap-2 items-end border-b pb-3"
                >
                  <div className="col-span-5">
                    <Label className="text-xs">Producto</Label>
                    <Select
                      value={item.product_id}
                      onValueChange={(v) => updateItem(index, { product_id: v })}
                      disabled={disabled}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Seleccionar..." />
                      </SelectTrigger>
                      <SelectContent>
                        {products.map((p) => (
                          <SelectItem key={p.id} value={p.id}>
                            {p.codigo} - {p.tipo} {p.talla}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="col-span-2">
                    <Label className="text-xs">Cantidad</Label>
                    <Input
                      type="number"
                      min={1}
                      value={item.cantidad}
                      onChange={(e) =>
                        updateItem(index, {
                          cantidad: parseInt(e.target.value) || 1,
                        })
                      }
                      disabled={disabled}
                    />
                  </div>
                  <div className="col-span-3">
                    <Label className="text-xs">Costo Unitario</Label>
                    <Input
                      type="number"
                      min={0}
                      value={item.costo_unitario}
                      onChange={(e) =>
                        updateItem(index, {
                          costo_unitario: parseFloat(e.target.value) || 0,
                        })
                      }
                      disabled={disabled}
                    />
                  </div>
                  <div className="col-span-1 text-right">
                    <p className="text-xs text-gray-500 mb-1">Subtotal</p>
                    <p className="font-medium text-sm">
                      {formatCurrency(item.cantidad * item.costo_unitario)}
                    </p>
                  </div>
                  <div className="col-span-1 text-right">
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => removeItem(index)}
                      disabled={disabled}
                    >
                      <Trash2 className="h-4 w-4 text-red-500" />
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Total */}
          {items.length > 0 && (
            <div className="flex justify-end pt-4 border-t mt-4">
              <div className="text-right">
                <p className="text-sm text-gray-500">Total</p>
                <p className="text-2xl font-bold">
                  {formatCurrency(calculateTotal())}
                </p>
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}

// Export calculateTotal as utility for parent components
export function calculatePurchaseTotal(items: PurchaseItemInput[]): number {
  return items.reduce((sum, item) => sum + item.cantidad * item.costo_unitario, 0)
}
```
  </action>
  <verify>
Run: `grep -E "(export function|PurchaseForm|calculatePurchaseTotal)" src/components/purchases/purchase-form.tsx`
Verify: PurchaseForm and calculatePurchaseTotal exported
  </verify>
  <done>
- PurchaseForm component created
- Controlled form with all purchase fields
- Product selection from dropdown
- Add/remove items functionality
- Calculates and displays subtotals and total
- Disabled state for saving mode
- calculatePurchaseTotal utility exported
  </done>
</task>

</tasks>

<verification>
- [ ] PurchaseStatusBadge shows correct variants for each estado
- [ ] PurchasesTable displays purchases with all columns
- [ ] Table filters by estado and proveedor
- [ ] ConfirmReceptionDialog calls server action
- [ ] PurchaseForm handles manual product entry
- [ ] All components properly typed
</verification>

<success_criteria>
- Purchase list displays correctly with filters
- Estado badges show appropriate colors
- Reception confirmation works with proper UX
- Purchase form supports manual product entry
</success_criteria>

<output>
After completion, create `.planning/phases/13-purchases/13-08-SUMMARY.md`
</output>
