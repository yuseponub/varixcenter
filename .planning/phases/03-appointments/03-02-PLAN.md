---
phase: 03-appointments
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/types/appointments.ts
  - src/lib/appointments/state-machine.ts
  - src/lib/validations/appointment.ts
autonomous: true

must_haves:
  truths:
    - "Appointment TypeScript types match database schema"
    - "State machine validates all allowed transitions per CONTEXT.md"
    - "Zod schemas validate appointment creation and status updates"
  artifacts:
    - path: "src/types/appointments.ts"
      provides: "Appointment type definitions"
      contains: "AppointmentStatus"
    - path: "src/lib/appointments/state-machine.ts"
      provides: "State transition logic"
      exports: ["canTransition", "getAvailableTransitions", "APPOINTMENT_STATES"]
    - path: "src/lib/validations/appointment.ts"
      provides: "Zod validation schemas"
      exports: ["appointmentSchema", "appointmentStatusSchema"]
  key_links:
    - from: "src/lib/appointments/state-machine.ts"
      to: "src/types/appointments.ts"
      via: "import"
      pattern: "import.*AppointmentStatus"
    - from: "src/lib/validations/appointment.ts"
      to: "src/lib/appointments/state-machine.ts"
      via: "import"
      pattern: "import.*APPOINTMENT_STATES"
---

<objective>
Create TypeScript types, state machine logic, and Zod validation schemas for appointments.

Purpose: Define the type-safe foundation that all appointment components and server actions will use. The state machine enforces transition rules from CONTEXT.md.
Output: TypeScript types matching DB schema, state machine with transition validation, Zod schemas with Spanish error messages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-appointments/03-RESEARCH.md
@.planning/phases/03-appointments/03-CONTEXT.md
@src/lib/validations/patient.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create appointment TypeScript types</name>
  <files>src/types/appointments.ts</files>
  <action>
Create `src/types/appointments.ts` with types matching the database schema:

```typescript
/**
 * Appointment Type Definitions
 *
 * Types for the appointments system matching PostgreSQL schema.
 * Used by: Calendar components, server actions, queries
 */

/**
 * Appointment status enum matching database appointment_status type.
 * Flow: programada -> confirmada -> en_sala -> en_atencion -> completada
 * Additional: cancelada, no_asistio (terminal states that allow reschedule)
 */
export const APPOINTMENT_STATES = [
  'programada',
  'confirmada',
  'en_sala',
  'en_atencion',
  'completada',
  'cancelada',
  'no_asistio'
] as const

export type AppointmentStatus = typeof APPOINTMENT_STATES[number]

/**
 * Core appointment record from database
 */
export interface Appointment {
  id: string
  patient_id: string
  doctor_id: string
  fecha_hora_inicio: string // ISO timestamp
  fecha_hora_fin: string    // ISO timestamp
  estado: AppointmentStatus
  notas: string | null
  motivo_consulta: string | null
  created_by: string | null
  created_at: string
  updated_at: string
}

/**
 * Appointment with joined patient data (for display)
 */
export interface AppointmentWithPatient extends Appointment {
  patient: {
    id: string
    nombre: string
    apellido: string
    cedula: string
    celular: string
  }
}

/**
 * Appointment with full relations (patient + doctor info)
 */
export interface AppointmentWithRelations extends AppointmentWithPatient {
  doctor: {
    id: string
    email: string
  }
}

/**
 * FullCalendar event format
 * Used by: AppointmentCalendar component
 */
export interface CalendarEvent {
  id: string
  title: string
  start: string       // ISO timestamp
  end: string         // ISO timestamp
  backgroundColor: string
  borderColor: string
  extendedProps: {
    patientId: string
    patientName: string
    doctorId: string
    doctorName: string
    status: AppointmentStatus
    notas: string | null
  }
}

/**
 * Doctor info for filter dropdown (APT-02)
 */
export interface Doctor {
  id: string
  nombre: string  // Display name (from user metadata or email)
}

/**
 * Type guard to check if a string is a valid AppointmentStatus
 */
export function isValidAppointmentStatus(status: unknown): status is AppointmentStatus {
  return (
    typeof status === 'string' &&
    APPOINTMENT_STATES.includes(status as AppointmentStatus)
  )
}
```

Also update `src/types/index.ts` to re-export appointment types:
```typescript
// Add at the end of the file:
export * from './appointments'
```
  </action>
  <verify>
- File exists at `src/types/appointments.ts`
- `npm run build` passes (TypeScript compiles)
- All 7 states are defined in APPOINTMENT_STATES array
  </verify>
  <done>
- Appointment types defined matching database schema
- CalendarEvent type ready for FullCalendar integration
- Doctor type ready for APT-02 filter
- Types re-exported from src/types/index.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create appointment state machine</name>
  <files>src/lib/appointments/state-machine.ts</files>
  <action>
Create directory and file `src/lib/appointments/state-machine.ts`:

```typescript
/**
 * Appointment State Machine
 *
 * Defines valid state transitions per CONTEXT.md decisions:
 * - Any role can cancel (no restrictions)
 * - Reversion to previous states is allowed
 * - no_asistio tracks no-shows separately from cancellations
 *
 * Flow: programada -> confirmada -> en_sala -> en_atencion -> completada
 */

import { AppointmentStatus, APPOINTMENT_STATES } from '@/types/appointments'

/**
 * Allowed transitions map.
 *
 * Rules from CONTEXT.md:
 * 1. Cancelacion: Any state can go to cancelada
 * 2. No-show: States before completada can mark as no_asistio
 * 3. Completar: Only from en_atencion
 * 4. Reversion: Allowed freely (backwards transitions)
 * 5. Reschedule: cancelada and no_asistio can return to programada
 */
const TRANSITIONS: Record<AppointmentStatus, AppointmentStatus[]> = {
  // Initial state - can advance, cancel, or mark no-show
  programada: ['confirmada', 'cancelada', 'no_asistio'],

  // Confirmed - can revert, advance, cancel, or mark no-show
  confirmada: ['programada', 'en_sala', 'cancelada', 'no_asistio'],

  // In waiting room - can revert, advance, cancel, or mark no-show
  en_sala: ['confirmada', 'en_atencion', 'cancelada', 'no_asistio'],

  // Being attended - can revert, complete, or cancel
  en_atencion: ['en_sala', 'completada', 'cancelada'],

  // Completed - can only revert to en_atencion (for corrections)
  completada: ['en_atencion'],

  // Cancelled - can reschedule back to programada
  cancelada: ['programada'],

  // No-show - can reschedule back to programada
  no_asistio: ['programada']
}

/**
 * Check if a state transition is allowed
 *
 * @param from - Current appointment status
 * @param to - Desired new status
 * @returns true if transition is valid
 */
export function canTransition(
  from: AppointmentStatus,
  to: AppointmentStatus
): boolean {
  return TRANSITIONS[from].includes(to)
}

/**
 * Get all valid transitions from a given state
 *
 * @param current - Current appointment status
 * @returns Array of valid target states
 */
export function getAvailableTransitions(
  current: AppointmentStatus
): AppointmentStatus[] {
  return TRANSITIONS[current]
}

/**
 * Status display labels in Spanish
 */
export const STATUS_LABELS: Record<AppointmentStatus, string> = {
  programada: 'Programada',
  confirmada: 'Confirmada',
  en_sala: 'En Sala de Espera',
  en_atencion: 'En Atencion',
  completada: 'Completada',
  cancelada: 'Cancelada',
  no_asistio: 'No Asistio'
}

/**
 * Tailwind classes for status badges
 * Colors follow conventional meanings:
 * - Blue: scheduled/pending
 * - Green: confirmed/positive
 * - Yellow: waiting/attention needed
 * - Purple: in progress
 * - Gray: completed/done
 * - Red: cancelled/negative
 * - Orange: no-show/warning
 */
export const STATUS_COLORS: Record<AppointmentStatus, string> = {
  programada: 'bg-blue-100 text-blue-800',
  confirmada: 'bg-green-100 text-green-800',
  en_sala: 'bg-yellow-100 text-yellow-800',
  en_atencion: 'bg-purple-100 text-purple-800',
  completada: 'bg-gray-100 text-gray-800',
  cancelada: 'bg-red-100 text-red-800',
  no_asistio: 'bg-orange-100 text-orange-800'
}

/**
 * Hex colors for FullCalendar events
 */
export const STATUS_HEX_COLORS: Record<AppointmentStatus, string> = {
  programada: '#3B82F6',    // blue-500
  confirmada: '#10B981',    // green-500
  en_sala: '#F59E0B',       // yellow-500
  en_atencion: '#8B5CF6',   // purple-500
  completada: '#6B7280',    // gray-500
  cancelada: '#EF4444',     // red-500
  no_asistio: '#F97316'     // orange-500
}

// Re-export for convenience
export { APPOINTMENT_STATES }
```
  </action>
  <verify>
- File exists at `src/lib/appointments/state-machine.ts`
- `npm run build` passes
- All 7 states have transitions defined
- canTransition function is exported
  </verify>
  <done>
- State machine validates transitions per CONTEXT.md rules
- STATUS_LABELS provides Spanish display text
- STATUS_COLORS provides Tailwind badge classes
- STATUS_HEX_COLORS ready for FullCalendar
  </done>
</task>

<task type="auto">
  <name>Task 3: Create appointment Zod validation schemas</name>
  <files>src/lib/validations/appointment.ts</files>
  <action>
Create `src/lib/validations/appointment.ts` following the pattern from patient.ts:

```typescript
import { z } from 'zod'
import { APPOINTMENT_STATES } from '@/lib/appointments/state-machine'

/**
 * Appointment creation/update schema
 *
 * Used by: AppointmentForm, createAppointment, updateAppointment server actions
 * All messages in Spanish for Colombian users (following patient.ts pattern)
 */
export const appointmentSchema = z.object({
  // Required relations
  patient_id: z
    .string()
    .uuid('ID de paciente invalido'),

  doctor_id: z
    .string()
    .uuid('ID de medico invalido'),

  // Time range (ISO 8601 format from datetime-local inputs)
  fecha_hora_inicio: z
    .string()
    .min(1, 'La fecha y hora de inicio es requerida')
    .refine(
      (val) => !isNaN(Date.parse(val)),
      'Formato de fecha/hora invalido'
    ),

  fecha_hora_fin: z
    .string()
    .min(1, 'La fecha y hora de fin es requerida')
    .refine(
      (val) => !isNaN(Date.parse(val)),
      'Formato de fecha/hora invalido'
    ),

  // Optional fields
  notas: z
    .string()
    .max(500, 'Las notas no pueden exceder 500 caracteres')
    .nullable()
    .optional()
    .transform(val => val === '' ? null : val),

  motivo_consulta: z
    .string()
    .max(200, 'El motivo no puede exceder 200 caracteres')
    .nullable()
    .optional()
    .transform(val => val === '' ? null : val),
}).refine(
  data => new Date(data.fecha_hora_fin) > new Date(data.fecha_hora_inicio),
  {
    message: 'La hora de fin debe ser posterior a la hora de inicio',
    path: ['fecha_hora_fin']
  }
)

/**
 * Schema for updating appointment status only
 * Used by: updateAppointmentStatus server action
 */
export const appointmentStatusSchema = z.object({
  estado: z.enum(APPOINTMENT_STATES, {
    errorMap: () => ({ message: 'Estado de cita invalido' })
  })
})

/**
 * Schema for appointment reschedule (time change only)
 * Used by: drag-and-drop reschedule in calendar
 */
export const appointmentRescheduleSchema = z.object({
  fecha_hora_inicio: z
    .string()
    .min(1, 'La fecha y hora de inicio es requerida')
    .refine(
      (val) => !isNaN(Date.parse(val)),
      'Formato de fecha/hora invalido'
    ),

  fecha_hora_fin: z
    .string()
    .min(1, 'La fecha y hora de fin es requerida')
    .refine(
      (val) => !isNaN(Date.parse(val)),
      'Formato de fecha/hora invalido'
    ),
}).refine(
  data => new Date(data.fecha_hora_fin) > new Date(data.fecha_hora_inicio),
  {
    message: 'La hora de fin debe ser posterior a la hora de inicio',
    path: ['fecha_hora_fin']
  }
)

/**
 * TypeScript types inferred from schemas
 */
export type AppointmentFormData = z.infer<typeof appointmentSchema>
export type AppointmentStatusData = z.infer<typeof appointmentStatusSchema>
export type AppointmentRescheduleData = z.infer<typeof appointmentRescheduleSchema>
```
  </action>
  <verify>
- File exists at `src/lib/validations/appointment.ts`
- `npm run build` passes
- All error messages are in Spanish
- appointmentSchema exports correctly
  </verify>
  <done>
- appointmentSchema validates create/update forms
- appointmentStatusSchema validates status changes
- appointmentRescheduleSchema validates drag-drop time changes
- Empty strings transform to null (matching patient.ts pattern)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without TypeScript errors
2. Types are exported from `src/types/index.ts`
3. State machine exports canTransition, getAvailableTransitions
4. Zod schemas export appointmentSchema, appointmentStatusSchema
5. All validation messages are in Spanish
</verification>

<success_criteria>
- AppointmentStatus type includes all 7 states from CONTEXT.md
- CalendarEvent type matches FullCalendar event interface
- canTransition enforces CONTEXT.md rules (any role can cancel, reversion allowed)
- Zod schemas have Spanish error messages
- Empty string to null transformation matches existing pattern
</success_criteria>

<output>
After completion, create `.planning/phases/03-appointments/03-02-SUMMARY.md`
</output>
