---
phase: 09-notifications
plan: 03
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - src/lib/twilio/client.ts
  - src/lib/twilio/sms.ts
  - src/lib/twilio/message-builder.ts
autonomous: true
user_setup:
  - service: twilio
    why: "SMS sending via Twilio API"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Active Numbers (E.164 format)"
      - name: CLINIC_PHONE_NUMBER
        source: "Clinic contact phone for appointment changes (e.g., 6077001234)"

must_haves:
  truths:
    - "Twilio client can send SMS to Colombian numbers"
    - "SMS errors are captured with Twilio error codes"
    - "Message templates use Spanish without accented vowels"
  artifacts:
    - path: "src/lib/twilio/client.ts"
      provides: "Twilio client singleton"
      exports: ["twilioClient", "TWILIO_PHONE_NUMBER"]
    - path: "src/lib/twilio/sms.ts"
      provides: "sendSMS function with error handling"
      exports: ["sendSMS"]
    - path: "src/lib/twilio/message-builder.ts"
      provides: "Message template builder"
      exports: ["buildReminderMessage"]
  key_links:
    - from: "src/lib/twilio/sms.ts"
      to: "twilio"
      via: "twilioClient.messages.create"
      pattern: "twilioClient\\.messages\\.create"
---

<objective>
Create Twilio client integration for sending SMS reminders with proper error handling.

Purpose: Core SMS sending capability using Twilio SDK. Handles authentication, error codes, and message building.
Output: Twilio client module with sendSMS function and message template builder.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-notifications/09-RESEARCH.md
@src/types/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install twilio package</name>
  <files>package.json</files>
  <action>
Install the Twilio SDK:

```bash
npm install twilio
```

This adds `twilio` to dependencies. Version will be ^5.x (latest).
  </action>
  <verify>
Run `npm list twilio` and confirm package is installed.
Check package.json has twilio in dependencies.
  </verify>
  <done>
Twilio SDK installed and available for import.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Twilio client and SMS functions</name>
  <files>
    src/lib/twilio/client.ts
    src/lib/twilio/sms.ts
    src/lib/twilio/message-builder.ts
  </files>
  <action>
Create three files in src/lib/twilio/:

**1. src/lib/twilio/client.ts** - Twilio client singleton:

```typescript
/**
 * Twilio Client Configuration
 *
 * Singleton client for sending SMS via Twilio API.
 * Requires environment variables:
 * - TWILIO_ACCOUNT_SID
 * - TWILIO_AUTH_TOKEN
 * - TWILIO_PHONE_NUMBER
 */
import twilio from 'twilio'

// Validate environment variables at module load time
// This will throw during build if env vars are missing (which is desired)
const accountSid = process.env.TWILIO_ACCOUNT_SID
const authToken = process.env.TWILIO_AUTH_TOKEN
export const TWILIO_PHONE_NUMBER = process.env.TWILIO_PHONE_NUMBER

// In development, allow missing credentials with warning
if (!accountSid || !authToken) {
  if (process.env.NODE_ENV === 'production') {
    throw new Error('Missing Twilio credentials: TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN are required')
  }
  console.warn('[Twilio] Missing credentials - SMS sending will be disabled')
}

// Create client only if credentials exist
export const twilioClient = accountSid && authToken ? twilio(accountSid, authToken) : null

/**
 * Check if Twilio is configured
 */
export function isTwilioConfigured(): boolean {
  return twilioClient !== null && !!TWILIO_PHONE_NUMBER
}
```

**2. src/lib/twilio/sms.ts** - Send SMS function with error handling:

```typescript
/**
 * SMS Sending Functions
 *
 * Wraps Twilio API with proper error handling and logging.
 */
import { twilioClient, TWILIO_PHONE_NUMBER, isTwilioConfigured } from './client'
import type { SendSMSResult } from '@/types/notifications'

// Twilio error codes that should NOT be retried
// https://www.twilio.com/docs/api/errors
const PERMANENT_ERROR_CODES = [
  21211, // Invalid 'To' phone number
  21212, // Invalid 'From' phone number
  21214, // 'To' phone number cannot be reached
  21217, // Phone number not verified
  21608, // Unverified phone number
]

/**
 * Send SMS via Twilio
 *
 * @param to - Recipient phone number in E.164 format (+573001234567)
 * @param body - Message body (max 160 chars recommended)
 * @returns SendSMSResult with success status and messageSid or error details
 */
export async function sendSMS(to: string, body: string): Promise<SendSMSResult> {
  // Check if Twilio is configured
  if (!isTwilioConfigured()) {
    console.warn('[SMS] Twilio not configured, skipping send to:', to)
    return {
      success: false,
      errorCode: 0,
      errorMessage: 'Twilio not configured',
    }
  }

  if (!twilioClient || !TWILIO_PHONE_NUMBER) {
    return {
      success: false,
      errorCode: 0,
      errorMessage: 'Twilio client not initialized',
    }
  }

  try {
    const message = await twilioClient.messages.create({
      body,
      from: TWILIO_PHONE_NUMBER,
      to,
    })

    console.log('[SMS] Sent successfully:', {
      sid: message.sid,
      to,
      status: message.status,
    })

    return {
      success: true,
      messageSid: message.sid,
    }
  } catch (error) {
    // Handle Twilio-specific errors
    if (error && typeof error === 'object' && 'code' in error && 'message' in error) {
      const twilioError = error as { code: number; message: string }

      console.error('[SMS] Twilio error:', {
        code: twilioError.code,
        message: twilioError.message,
        to,
      })

      return {
        success: false,
        errorCode: twilioError.code,
        errorMessage: twilioError.message,
      }
    }

    // Handle unexpected errors
    console.error('[SMS] Unexpected error:', error)
    return {
      success: false,
      errorCode: -1,
      errorMessage: error instanceof Error ? error.message : 'Unknown error',
    }
  }
}

/**
 * Check if an error code is permanent (should not retry)
 */
export function isPermanentError(errorCode: number | null): boolean {
  if (errorCode === null) return false
  return PERMANENT_ERROR_CODES.includes(errorCode)
}
```

**3. src/lib/twilio/message-builder.ts** - Message template builder:

```typescript
/**
 * SMS Message Builder
 *
 * Builds reminder messages for appointments.
 * Messages are in Spanish but avoid accented vowels (a,e,i,o,u with tildes)
 * to stay within GSM-7 encoding (160 char limit vs 70 for UCS-2).
 */

const CLINIC_PHONE = process.env.CLINIC_PHONE_NUMBER || '607-XXX-XXXX'

/**
 * Format date for SMS message
 * Output: "lunes 27 de enero a las 3:00 PM"
 */
function formatAppointmentDate(date: Date): string {
  const options: Intl.DateTimeFormatOptions = {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: 'America/Bogota',
  }

  return new Intl.DateTimeFormat('es-CO', options).format(date)
}

/**
 * Get time reference word based on reminder type
 */
function getTimeReference(reminderType: '24h' | '2h'): string {
  return reminderType === '24h' ? 'manana' : 'en 2 horas'
}

/**
 * Build appointment reminder message
 *
 * Template: "Hola [Nombre], te recordamos tu cita [tiempo] [fecha] en Varix Center. Para cambios: [telefono]"
 *
 * Note: Uses "manana" instead of "mañana" to stay in GSM-7 encoding.
 *
 * @param patientName - Patient's first name
 * @param appointmentDate - Appointment date/time
 * @param reminderType - '24h' or '2h'
 * @returns Message string (target: under 160 chars)
 */
export function buildReminderMessage(
  patientName: string,
  appointmentDate: Date,
  reminderType: '24h' | '2h'
): string {
  const timeRef = getTimeReference(reminderType)
  const formattedDate = formatAppointmentDate(appointmentDate)

  // Build message - keep under 160 chars for single segment
  // Avoid accented vowels for GSM-7 encoding
  const message = `Hola ${patientName}, te recordamos tu cita ${timeRef} ${formattedDate} en Varix Center. Para cambios: ${CLINIC_PHONE}`

  // Log warning if message is too long
  if (message.length > 160) {
    console.warn('[SMS] Message exceeds 160 chars:', message.length, 'chars')
  }

  return message
}

/**
 * Sanitize patient name for SMS
 * - Capitalize first letter
 * - Limit length
 * - Remove special characters
 */
export function sanitizePatientName(name: string): string {
  const cleaned = name
    .trim()
    .replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')
    .split(' ')[0] // First name only

  // Capitalize first letter
  return cleaned.charAt(0).toUpperCase() + cleaned.slice(1).toLowerCase()
}
```
  </action>
  <verify>
1. Files exist at:
   - src/lib/twilio/client.ts
   - src/lib/twilio/sms.ts
   - src/lib/twilio/message-builder.ts

2. Exports are correct:
   - client.ts exports: twilioClient, TWILIO_PHONE_NUMBER, isTwilioConfigured
   - sms.ts exports: sendSMS, isPermanentError
   - message-builder.ts exports: buildReminderMessage, sanitizePatientName

3. Run TypeScript check: `npx tsc --noEmit` passes
  </verify>
  <done>
Twilio integration complete with:
- Client singleton with graceful degradation in development
- sendSMS function with Twilio error code handling
- isPermanentError helper for retry logic
- Message builder avoiding accented vowels for GSM-7 encoding
  </done>
</task>

</tasks>

<verification>
- [ ] twilio package installed in package.json
- [ ] src/lib/twilio/client.ts creates Twilio client with env validation
- [ ] src/lib/twilio/sms.ts exports sendSMS function
- [ ] src/lib/twilio/message-builder.ts exports buildReminderMessage
- [ ] Error handling captures Twilio error codes
- [ ] PERMANENT_ERROR_CODES list includes invalid number errors
- [ ] Message builder uses GSM-7 safe text (no accented vowels in template)
</verification>

<success_criteria>
Twilio module can send SMS to Colombian phone numbers (+57...) with proper error handling. Messages are built with GSM-7 safe encoding. Permanent errors (invalid numbers) are distinguished from retryable errors.
</success_criteria>

<output>
After completion, create `.planning/phases/09-notifications/09-03-SUMMARY.md`
</output>
