---
phase: 09-notifications
plan: 05
type: execute
wave: 3
depends_on: ["09-01", "09-02", "09-04"]
files_modified:
  - src/components/notifications/notifications-table.tsx
  - src/components/notifications/notification-status-badge.tsx
  - src/app/(protected)/notificaciones/page.tsx
  - src/lib/queries/patients.ts
  - src/components/patients/patient-timeline.tsx
autonomous: true

must_haves:
  truths:
    - "Staff can view list of all notifications"
    - "Notifications show status (enviado, fallido, etc)"
    - "Patient timeline includes SMS reminders"
    - "Notifications page filters by status"
  artifacts:
    - path: "src/app/(protected)/notificaciones/page.tsx"
      provides: "Notifications list page"
      min_lines: 30
    - path: "src/components/notifications/notifications-table.tsx"
      provides: "Table component for notification history"
      exports: ["NotificationsTable"]
    - path: "src/components/notifications/notification-status-badge.tsx"
      provides: "Badge component for notification status"
      exports: ["NotificationStatusBadge"]
  key_links:
    - from: "src/app/(protected)/notificaciones/page.tsx"
      to: "src/lib/queries/notifications.ts"
      via: "getNotifications import"
      pattern: "import.*getNotifications.*from.*queries"
    - from: "src/components/patients/patient-timeline.tsx"
      to: "notifications"
      via: "sms_reminder event type"
      pattern: "sms_reminder"
---

<objective>
Create the notifications history page and update patient timeline to show SMS reminders.

Purpose: Admin visibility into notification history and patient-centric view of reminders sent.
Output: Notifications list page with filters and updated patient timeline component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-notifications/09-CONTEXT.md
@src/types/notifications.ts
@src/lib/queries/notifications.ts
@src/components/patients/patient-timeline.tsx
@src/lib/queries/patients.ts
@src/app/(protected)/pacientes/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification UI components</name>
  <files>
    src/components/notifications/notification-status-badge.tsx
    src/components/notifications/notifications-table.tsx
  </files>
  <action>
Create notification UI components:

**1. src/components/notifications/notification-status-badge.tsx**:

```typescript
/**
 * Notification Status Badge
 *
 * Displays notification status with appropriate color and icon.
 */
import { Badge } from '@/components/ui/badge'
import { CheckCircle, XCircle, Clock, RefreshCw } from 'lucide-react'
import type { NotificationStatus } from '@/types/notifications'

const STATUS_CONFIG: Record<
  NotificationStatus,
  { label: string; variant: 'default' | 'secondary' | 'destructive' | 'outline'; Icon: typeof Clock }
> = {
  pendiente: { label: 'Pendiente', variant: 'secondary', Icon: Clock },
  enviado: { label: 'Enviado', variant: 'default', Icon: CheckCircle },
  fallido: { label: 'Fallido', variant: 'destructive', Icon: XCircle },
  reintentando: { label: 'Reintentando', variant: 'outline', Icon: RefreshCw },
}

interface NotificationStatusBadgeProps {
  status: NotificationStatus
}

export function NotificationStatusBadge({ status }: NotificationStatusBadgeProps) {
  const config = STATUS_CONFIG[status]
  const { Icon } = config

  return (
    <Badge variant={config.variant} className="gap-1">
      <Icon className="h-3 w-3" />
      {config.label}
    </Badge>
  )
}
```

**2. src/components/notifications/notifications-table.tsx**:

```typescript
/**
 * Notifications Table
 *
 * Displays list of SMS notifications with patient info and status.
 */
'use client'

import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { NotificationStatusBadge } from './notification-status-badge'
import type { NotificationWithDetails } from '@/types/notifications'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import Link from 'next/link'

interface NotificationsTableProps {
  notifications: NotificationWithDetails[]
}

export function NotificationsTable({ notifications }: NotificationsTableProps) {
  if (notifications.length === 0) {
    return (
      <div className="rounded-md border border-dashed p-8 text-center">
        <p className="text-sm text-muted-foreground">
          No hay notificaciones registradas
        </p>
      </div>
    )
  }

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Paciente</TableHead>
            <TableHead>Telefono</TableHead>
            <TableHead>Tipo</TableHead>
            <TableHead>Cita</TableHead>
            <TableHead>Estado</TableHead>
            <TableHead>Fecha</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {notifications.map((notif) => (
            <TableRow key={notif.id}>
              <TableCell>
                <Link
                  href={`/pacientes/${notif.patient_id}`}
                  className="font-medium hover:underline"
                >
                  {notif.patients.nombre} {notif.patients.apellido}
                </Link>
              </TableCell>
              <TableCell className="font-mono text-sm">
                {notif.telefono_destino}
              </TableCell>
              <TableCell>
                {notif.tipo_recordatorio === '24h' ? '24 horas' : '2 horas'}
              </TableCell>
              <TableCell>
                {format(
                  new Date(notif.appointments.fecha_hora_inicio),
                  "d 'de' MMMM, h:mm a",
                  { locale: es }
                )}
              </TableCell>
              <TableCell>
                <NotificationStatusBadge status={notif.estado} />
              </TableCell>
              <TableCell className="text-sm text-muted-foreground">
                {notif.enviado_at
                  ? format(new Date(notif.enviado_at), "d MMM, h:mm a", { locale: es })
                  : format(new Date(notif.created_at), "d MMM, h:mm a", { locale: es })}
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}
```
  </action>
  <verify>
Files exist at:
- src/components/notifications/notification-status-badge.tsx
- src/components/notifications/notifications-table.tsx

Both export their respective components.
  </verify>
  <done>
Notification UI components created with status badges and table display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notifications page</name>
  <files>src/app/(protected)/notificaciones/page.tsx</files>
  <action>
Create the notifications list page:

```typescript
/**
 * Notifications Page
 *
 * Shows history of SMS reminders sent to patients.
 * Accessible to all staff roles.
 */
import { getNotifications } from '@/lib/queries/notifications'
import { NotificationsTable } from '@/components/notifications/notifications-table'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { MessageSquare } from 'lucide-react'

export const dynamic = 'force-dynamic'

export default async function NotificacionesPage() {
  const notifications = await getNotifications({ limit: 100 })

  // Count by status
  const statusCounts = notifications.reduce(
    (acc, n) => {
      acc[n.estado] = (acc[n.estado] || 0) + 1
      return acc
    },
    {} as Record<string, number>
  )

  return (
    <div className="container mx-auto py-6">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold">Notificaciones SMS</h1>
        <p className="text-muted-foreground">
          Historial de recordatorios de citas enviados a pacientes
        </p>
      </div>

      {/* Stats Cards */}
      <div className="mb-6 grid gap-4 md:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total</CardTitle>
            <MessageSquare className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{notifications.length}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Enviados</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-green-600">
              {statusCounts['enviado'] || 0}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Fallidos</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">
              {statusCounts['fallido'] || 0}
            </div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Pendientes</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-yellow-600">
              {(statusCounts['pendiente'] || 0) + (statusCounts['reintentando'] || 0)}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Notifications Table */}
      <Card>
        <CardHeader>
          <CardTitle>Historial de Notificaciones</CardTitle>
          <CardDescription>
            Ultimas {notifications.length} notificaciones enviadas
          </CardDescription>
        </CardHeader>
        <CardContent>
          <NotificationsTable notifications={notifications} />
        </CardContent>
      </Card>
    </div>
  )
}
```
  </action>
  <verify>
File exists at src/app/(protected)/notificaciones/page.tsx with:
- Page component export
- getNotifications call
- NotificationsTable usage
- Stats cards showing counts by status
  </verify>
  <done>
Notifications page created with summary stats and table of all notifications.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update patient timeline to include SMS notifications</name>
  <files>
    src/lib/queries/patients.ts
    src/components/patients/patient-timeline.tsx
  </files>
  <action>
Update patient timeline to show SMS reminders:

**1. Update src/lib/queries/patients.ts** - Modify getPatientTimeline to include notifications:

Add import at top:
```typescript
import { getPatientNotifications } from './notifications'
```

Update getPatientTimeline function to merge notifications:

```typescript
/**
 * Get patient timeline from audit_log AND notifications
 * Shows history of changes and SMS reminders
 *
 * @param patientId - Patient UUID
 * @param limit - Max events to return (default 20)
 * @returns Timeline events sorted by most recent first
 */
export async function getPatientTimeline(patientId: string, limit = 20) {
  const supabase = await createClient()

  // Get audit log entries
  const { data, error } = await supabase
    .from('audit_log')
    .select('id, action, changed_fields, changed_at, old_data, new_data')
    .eq('table_name', 'patients')
    .eq('record_id', patientId)
    .order('changed_at', { ascending: false })
    .limit(limit)

  if (error) throw error

  // Transform audit log entries into timeline events
  const auditEvents = data.map((entry) => ({
    id: String(entry.id),
    type: 'patient_record' as const,
    action: entry.action,
    changedFields: entry.changed_fields,
    timestamp: entry.changed_at,
    details: getTimelineEventDetails(entry),
  }))

  // Get notifications for this patient
  let notificationEvents: Array<{
    id: string
    type: 'sms_reminder'
    action: string
    changedFields: null
    timestamp: string
    details: string
  }> = []

  try {
    const notifications = await getPatientNotifications(patientId, limit)
    notificationEvents = notifications.map((notif) => ({
      id: notif.id,
      type: 'sms_reminder' as const,
      action: notif.estado,
      changedFields: null,
      timestamp: notif.enviado_at || notif.created_at,
      details: `Recordatorio ${notif.tipo_recordatorio === '24h' ? '24 horas' : '2 horas'} - ${
        notif.estado === 'enviado'
          ? 'Enviado'
          : notif.estado === 'fallido'
            ? 'Fallido'
            : 'Pendiente'
      }`,
    }))
  } catch (err) {
    // If notifications table doesn't exist yet, continue without
    console.warn('Could not fetch notifications for timeline:', err)
  }

  // Merge and sort by timestamp
  const allEvents = [...auditEvents, ...notificationEvents].sort(
    (a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
  )

  return allEvents.slice(0, limit)
}
```

**2. Update src/components/patients/patient-timeline.tsx** - Add SMS reminder display:

Update the TimelineEvent type to include 'sms_reminder':

```typescript
type TimelineEvent = {
  id: string
  type: 'patient_record' | 'payment' | 'appointment' | 'procedure' | 'sms_reminder'
  action: string
  timestamp: string
  details: string
  changedFields?: string[] | null
}
```

Update the getEventColor function to handle 'sms_reminder':

```typescript
function getEventColor(type: TimelineEvent['type']): string {
  switch (type) {
    case 'patient_record':
      return 'bg-blue-500'
    case 'payment':
      return 'bg-green-500'
    case 'appointment':
      return 'bg-purple-500'
    case 'procedure':
      return 'bg-orange-500'
    case 'sms_reminder':
      return 'bg-cyan-500'
    default:
      return 'bg-gray-500'
  }
}
```

Update the getEventTitle function to handle 'sms_reminder':

```typescript
function getEventTitle(event: TimelineEvent): string {
  switch (event.type) {
    case 'patient_record':
      return event.action === 'INSERT' ? 'Registro creado' : 'Datos actualizados'
    case 'payment':
      return 'Pago registrado'
    case 'appointment':
      return 'Cita'
    case 'procedure':
      return 'Procedimiento'
    case 'sms_reminder':
      return 'Recordatorio SMS'
    default:
      return 'Evento'
  }
}
```
  </action>
  <verify>
1. src/lib/queries/patients.ts:
   - Imports getPatientNotifications
   - getPatientTimeline returns events with type 'sms_reminder'

2. src/components/patients/patient-timeline.tsx:
   - Handles 'sms_reminder' event type
   - Uses MessageSquare icon for SMS events
  </verify>
  <done>
Patient timeline now includes SMS reminder events showing status (enviado, fallido, etc.) alongside other patient events.
  </done>
</task>

</tasks>

<verification>
- [ ] src/components/notifications/notification-status-badge.tsx exists and exports NotificationStatusBadge
- [ ] src/components/notifications/notifications-table.tsx exists and exports NotificationsTable
- [ ] src/app/(protected)/notificaciones/page.tsx exists and is accessible
- [ ] Patient timeline shows SMS reminder events
- [ ] Notifications page shows stats cards with counts
- [ ] TypeScript compiles without errors: `npx tsc --noEmit`
- [ ] Navigate to /notificaciones shows the page
</verification>

<success_criteria>
Notifications are visible to all staff through /notificaciones page with summary stats and detailed table. Patient detail pages show SMS reminders in the timeline alongside other events.
</success_criteria>

<output>
After completion, create `.planning/phases/09-notifications/09-05-SUMMARY.md`
</output>
