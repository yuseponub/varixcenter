---
phase: 09-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/030_notifications.sql
autonomous: true

must_haves:
  truths:
    - "Tabla notifications existe con columnas requeridas"
    - "RLS permite a todo el staff ver notificaciones"
    - "Solo service_role puede insertar/actualizar"
    - "Constraint previene duplicados por cita+tipo"
  artifacts:
    - path: "supabase/migrations/030_notifications.sql"
      provides: "Notifications table with ENUMs, RLS, and indexes"
      contains: "CREATE TABLE public.notifications"
  key_links:
    - from: "notifications"
      to: "appointments"
      via: "REFERENCES public.appointments(id)"
      pattern: "REFERENCES public\\.appointments"
---

<objective>
Create the notifications database schema with status tracking, retry support, and RLS policies.

Purpose: Foundation for SMS reminder system - must store notification history with Twilio message IDs and error tracking for retry logic.
Output: Migration file 030_notifications.sql with table, ENUMs, indexes, and RLS policies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-notifications/09-CONTEXT.md
@.planning/phases/09-notifications/09-RESEARCH.md
@supabase/migrations/007_appointments.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notifications migration with ENUMs and table</name>
  <files>supabase/migrations/030_notifications.sql</files>
  <action>
Create migration file with:

1. **ENUMs** (check if not exists to avoid conflicts):
```sql
-- Notification status enum
DO $$ BEGIN
  CREATE TYPE public.notification_status AS ENUM (
    'pendiente',     -- Scheduled, not yet sent
    'enviado',       -- Sent to Twilio successfully
    'fallido',       -- Failed after retries
    'reintentando'   -- Will retry in 30 min
  );
EXCEPTION WHEN duplicate_object THEN NULL;
END $$;

-- Reminder type enum
DO $$ BEGIN
  CREATE TYPE public.reminder_type AS ENUM (
    '24h',
    '2h'
  );
EXCEPTION WHEN duplicate_object THEN NULL;
END $$;
```

2. **notifications table**:
```sql
CREATE TABLE public.notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- References
  appointment_id UUID NOT NULL REFERENCES public.appointments(id) ON DELETE CASCADE,
  patient_id UUID NOT NULL REFERENCES public.patients(id) ON DELETE RESTRICT,

  -- Notification details
  tipo_recordatorio public.reminder_type NOT NULL,
  telefono_destino VARCHAR(15) NOT NULL,  -- E.164 format (+573001234567)
  mensaje TEXT NOT NULL,

  -- Status tracking
  estado public.notification_status NOT NULL DEFAULT 'pendiente',
  twilio_message_sid VARCHAR(50),
  error_code INTEGER,
  error_message TEXT,
  intentos INTEGER NOT NULL DEFAULT 0,

  -- Timestamps
  enviado_at TIMESTAMPTZ,
  siguiente_reintento_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Unique constraint: one notification per appointment per type
  CONSTRAINT unique_notification_per_appointment_type
    UNIQUE (appointment_id, tipo_recordatorio)
);
```

3. **Indexes**:
```sql
CREATE INDEX idx_notifications_appointment ON public.notifications(appointment_id);
CREATE INDEX idx_notifications_patient ON public.notifications(patient_id);
CREATE INDEX idx_notifications_estado ON public.notifications(estado);
CREATE INDEX idx_notifications_created_at ON public.notifications(created_at DESC);
CREATE INDEX idx_notifications_retry ON public.notifications(siguiente_reintento_at)
  WHERE estado = 'reintentando';
```

4. **RLS policies**:
```sql
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

-- All staff can view notifications
CREATE POLICY "Staff can view notifications"
  ON public.notifications FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.user_roles
      WHERE user_id = auth.uid()
      AND role IN ('admin', 'medico', 'enfermera', 'secretaria')
    )
  );

-- Service role has full access (for cron job)
CREATE POLICY "Service role full access"
  ON public.notifications FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);
```

5. **Grant permissions**:
```sql
GRANT SELECT ON public.notifications TO authenticated;
GRANT ALL ON public.notifications TO service_role;
```

6. **Comments**:
```sql
COMMENT ON TABLE public.notifications IS 'Historial de recordatorios SMS enviados a pacientes';
COMMENT ON COLUMN public.notifications.tipo_recordatorio IS '24h o 2h antes de la cita';
COMMENT ON COLUMN public.notifications.estado IS 'pendiente, enviado, fallido, reintentando';
```

7. **Verification block** at the end to confirm RLS is enabled.
  </action>
  <verify>
File exists at supabase/migrations/030_notifications.sql with:
- CREATE TYPE notification_status
- CREATE TYPE reminder_type
- CREATE TABLE public.notifications
- CREATE POLICY statements
- All required columns (appointment_id, patient_id, tipo_recordatorio, telefono_destino, mensaje, estado, twilio_message_sid, error_code, error_message, intentos, enviado_at, siguiente_reintento_at, created_at)
  </verify>
  <done>
Migration file creates notifications table with:
- Status enum (pendiente, enviado, fallido, reintentando)
- Reminder type enum (24h, 2h)
- All required columns for Twilio tracking
- RLS enabled with staff read access
- Unique constraint preventing duplicate reminders per appointment+type
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/030_notifications.sql
- [ ] Contains CREATE TYPE for notification_status and reminder_type
- [ ] Contains CREATE TABLE public.notifications with all required columns
- [ ] RLS policies defined for staff SELECT and service_role ALL
- [ ] Unique constraint on (appointment_id, tipo_recordatorio)
- [ ] Indexes created for common query patterns
</verification>

<success_criteria>
Migration file is syntactically correct SQL ready to apply to Supabase. Contains all infrastructure for notification tracking with Twilio integration.
</success_criteria>

<output>
After completion, create `.planning/phases/09-notifications/09-01-SUMMARY.md`
</output>
