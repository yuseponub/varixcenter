---
phase: 02-patients
plan: 07
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - src/components/patients/patient-timeline.tsx
  - src/app/(protected)/pacientes/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view patient detail at /pacientes/[id]"
    - "Patient profile shows all personal information"
    - "Patient profile shows emergency contact information"
    - "Timeline shows patient events (empty placeholder for future phases)"
    - "Edit button links to edit page"
  artifacts:
    - path: "src/components/patients/patient-timeline.tsx"
      provides: "Timeline component for patient events"
      exports: ["PatientTimeline"]
    - path: "src/app/(protected)/pacientes/[id]/page.tsx"
      provides: "Patient detail page with profile and timeline"
  key_links:
    - from: "src/app/(protected)/pacientes/[id]/page.tsx"
      to: "src/lib/queries/patients.ts"
      via: "getPatientById, getPatientTimeline imports"
      pattern: "getPatientById|getPatientTimeline"
    - from: "src/components/patients/patient-timeline.tsx"
      to: "audit_log data"
      via: "events prop from getPatientTimeline"
      pattern: "events.*map"
---

<objective>
Create patient detail page with profile information and timeline component

Purpose: Enables staff to view complete patient information including personal data, emergency contact, and activity history. The timeline currently shows audit events and will be extended in future phases to include payments, appointments, and procedures (PAT-03).
Output: Patient detail page at /pacientes/[id] with full profile and expandable timeline
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-patients/02-RESEARCH.md

# Query functions from 02-03
@src/lib/queries/patients.ts

# UI components from 02-01
@src/components/ui/card.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patient timeline component</name>
  <files>src/components/patients/patient-timeline.tsx</files>
  <action>
Create `src/components/patients/patient-timeline.tsx`:

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

type TimelineEvent = {
  id: string
  type: 'patient_record' | 'payment' | 'appointment' | 'procedure'
  action: string
  timestamp: string
  details: string
  changedFields?: string[] | null
}

interface PatientTimelineProps {
  events: TimelineEvent[]
}

/**
 * Timeline component showing patient events
 *
 * Phase 2: Shows only patient record changes from audit_log
 * Future phases will add:
 * - Phase 3: Appointments
 * - Phase 4: Payments
 * - Phase 6: Medical procedures
 */
export function PatientTimeline({ events }: PatientTimelineProps) {
  if (events.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Historial de Actividad</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-col items-center justify-center py-8 text-center text-gray-500">
            <svg
              className="mb-4 h-12 w-12 text-gray-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <p className="text-sm">No hay eventos registrados</p>
            <p className="mt-1 text-xs text-gray-400">
              Los pagos, citas y procedimientos apareceran aqui
            </p>
          </div>
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Historial de Actividad</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="relative">
          {/* Timeline line */}
          <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200" />

          {/* Events */}
          <div className="space-y-6">
            {events.map((event) => (
              <div key={event.id} className="relative pl-10">
                {/* Timeline dot */}
                <div
                  className={`absolute left-2.5 top-1 h-3 w-3 rounded-full border-2 border-white ${getEventColor(event.type)}`}
                />

                {/* Event content */}
                <div className="rounded-lg border bg-white p-3 shadow-sm">
                  <div className="flex items-start justify-between gap-2">
                    <div>
                      <p className="font-medium text-gray-900">
                        {getEventTitle(event)}
                      </p>
                      <p className="text-sm text-gray-600">{event.details}</p>
                    </div>
                    <time className="shrink-0 text-xs text-gray-400">
                      {formatTimestamp(event.timestamp)}
                    </time>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </CardContent>
    </Card>
  )
}

/**
 * Get color class based on event type
 */
function getEventColor(type: TimelineEvent['type']): string {
  switch (type) {
    case 'patient_record':
      return 'bg-blue-500'
    case 'payment':
      return 'bg-green-500'
    case 'appointment':
      return 'bg-purple-500'
    case 'procedure':
      return 'bg-orange-500'
    default:
      return 'bg-gray-500'
  }
}

/**
 * Get human-readable title for event
 */
function getEventTitle(event: TimelineEvent): string {
  switch (event.type) {
    case 'patient_record':
      return event.action === 'INSERT' ? 'Registro creado' : 'Datos actualizados'
    case 'payment':
      return 'Pago registrado'
    case 'appointment':
      return 'Cita'
    case 'procedure':
      return 'Procedimiento'
    default:
      return 'Evento'
  }
}

/**
 * Format timestamp for display in Spanish locale
 */
function formatTimestamp(timestamp: string): string {
  const date = new Date(timestamp)
  return new Intl.DateTimeFormat('es-CO', {
    dateStyle: 'medium',
    timeStyle: 'short',
  }).format(date)
}
```

Key points:
1. Handles empty state with placeholder message mentioning future phases
2. Vertical timeline design with colored dots per event type
3. Extensible type system for future event types (payment, appointment, procedure)
4. Spanish locale for date formatting
5. Clear visual hierarchy with timestamp on right
  </action>
  <verify>
Run `cat src/components/patients/patient-timeline.tsx | grep -E "(TimelineEvent|Historial|es-CO|payment|appointment)"` - should show type definition, Spanish text, and future event types.
  </verify>
  <done>
Patient timeline component created with extensible event types and empty state placeholder
  </done>
</task>

<task type="auto">
  <name>Task 2: Create patient detail page</name>
  <files>src/app/(protected)/pacientes/[id]/page.tsx</files>
  <action>
Create the directory if needed: `mkdir -p src/app/\(protected\)/pacientes/\[id\]`

Create `src/app/(protected)/pacientes/[id]/page.tsx`:

```typescript
import Link from 'next/link'
import { notFound } from 'next/navigation'
import { getPatientById, getPatientTimeline } from '@/lib/queries/patients'
import { PatientTimeline } from '@/components/patients/patient-timeline'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'

interface PageProps {
  params: Promise<{ id: string }>
}

export default async function PacienteDetailPage({ params }: PageProps) {
  const { id } = await params

  // Fetch patient and timeline data in parallel
  const [patient, timelineEvents] = await Promise.all([
    getPatientById(id),
    getPatientTimeline(id),
  ])

  if (!patient) {
    notFound()
  }

  return (
    <div className="container mx-auto py-6">
      {/* Breadcrumb */}
      <nav className="mb-6 text-sm text-gray-600">
        <Link href="/pacientes" className="hover:text-gray-900">
          Pacientes
        </Link>
        <span className="mx-2">/</span>
        <span className="text-gray-900">
          {patient.nombre} {patient.apellido}
        </span>
      </nav>

      {/* Header */}
      <div className="mb-6 flex items-start justify-between">
        <div>
          <h1 className="text-2xl font-bold">
            {patient.nombre} {patient.apellido}
          </h1>
          <p className="mt-1 text-gray-600">
            Cedula: <span className="font-mono">{patient.cedula}</span>
          </p>
        </div>
        <Link href={`/pacientes/${id}/editar`}>
          <Button variant="outline">Editar Paciente</Button>
        </Link>
      </div>

      <div className="grid gap-6 lg:grid-cols-3">
        {/* Left column: Patient info */}
        <div className="space-y-6 lg:col-span-2">
          {/* Personal Information */}
          <Card>
            <CardHeader>
              <CardTitle>Informacion Personal</CardTitle>
            </CardHeader>
            <CardContent>
              <dl className="grid gap-4 sm:grid-cols-2">
                <div>
                  <dt className="text-sm font-medium text-gray-500">Nombre Completo</dt>
                  <dd className="mt-1 text-gray-900">
                    {patient.nombre} {patient.apellido}
                  </dd>
                </div>
                <div>
                  <dt className="text-sm font-medium text-gray-500">Cedula</dt>
                  <dd className="mt-1 font-mono text-gray-900">{patient.cedula}</dd>
                </div>
                <div>
                  <dt className="text-sm font-medium text-gray-500">Celular</dt>
                  <dd className="mt-1 font-mono text-gray-900">{patient.celular}</dd>
                </div>
                <div>
                  <dt className="text-sm font-medium text-gray-500">Email</dt>
                  <dd className="mt-1 text-gray-900">
                    {patient.email || <span className="text-gray-400">No registrado</span>}
                  </dd>
                </div>
                <div>
                  <dt className="text-sm font-medium text-gray-500">Fecha de Nacimiento</dt>
                  <dd className="mt-1 text-gray-900">
                    {patient.fecha_nacimiento ? (
                      new Intl.DateTimeFormat('es-CO', { dateStyle: 'long' }).format(
                        new Date(patient.fecha_nacimiento)
                      )
                    ) : (
                      <span className="text-gray-400">No registrada</span>
                    )}
                  </dd>
                </div>
                <div className="sm:col-span-2">
                  <dt className="text-sm font-medium text-gray-500">Direccion</dt>
                  <dd className="mt-1 text-gray-900">
                    {patient.direccion || <span className="text-gray-400">No registrada</span>}
                  </dd>
                </div>
              </dl>
            </CardContent>
          </Card>

          {/* Emergency Contact */}
          <Card>
            <CardHeader>
              <CardTitle>Contacto de Emergencia</CardTitle>
            </CardHeader>
            <CardContent>
              <dl className="grid gap-4 sm:grid-cols-3">
                <div>
                  <dt className="text-sm font-medium text-gray-500">Nombre</dt>
                  <dd className="mt-1 text-gray-900">
                    {patient.contacto_emergencia_nombre}
                  </dd>
                </div>
                <div>
                  <dt className="text-sm font-medium text-gray-500">Telefono</dt>
                  <dd className="mt-1 font-mono text-gray-900">
                    {patient.contacto_emergencia_telefono}
                  </dd>
                </div>
                <div>
                  <dt className="text-sm font-medium text-gray-500">Parentesco</dt>
                  <dd className="mt-1 text-gray-900">
                    {patient.contacto_emergencia_parentesco}
                  </dd>
                </div>
              </dl>
            </CardContent>
          </Card>

          {/* Registration Info */}
          <Card>
            <CardHeader>
              <CardTitle>Informacion del Registro</CardTitle>
            </CardHeader>
            <CardContent>
              <dl className="grid gap-4 sm:grid-cols-2">
                <div>
                  <dt className="text-sm font-medium text-gray-500">Fecha de Registro</dt>
                  <dd className="mt-1 text-gray-900">
                    {new Intl.DateTimeFormat('es-CO', {
                      dateStyle: 'long',
                      timeStyle: 'short',
                    }).format(new Date(patient.created_at))}
                  </dd>
                </div>
                <div>
                  <dt className="text-sm font-medium text-gray-500">Ultima Actualizacion</dt>
                  <dd className="mt-1 text-gray-900">
                    {new Intl.DateTimeFormat('es-CO', {
                      dateStyle: 'long',
                      timeStyle: 'short',
                    }).format(new Date(patient.updated_at))}
                  </dd>
                </div>
              </dl>
            </CardContent>
          </Card>
        </div>

        {/* Right column: Timeline */}
        <div>
          <PatientTimeline events={timelineEvents} />
        </div>
      </div>
    </div>
  )
}
```

Key points:
1. Fetches patient and timeline in parallel with Promise.all for performance
2. Returns 404 for invalid patient IDs
3. Shows all patient information organized in cards
4. Emergency contact prominently displayed (required per PAT-04)
5. Timeline in right column (responsive: full width on mobile)
6. Edit button in header
7. All dates formatted with Spanish locale (es-CO)
8. Graceful handling of optional fields with "No registrado" placeholder
  </action>
  <verify>
Run `cat src/app/\(protected\)/pacientes/\[id\]/page.tsx | grep -E "(getPatientById|getPatientTimeline|PatientTimeline|Contacto de Emergencia)"` - should show query functions, timeline component, and emergency contact section.
  </verify>
  <done>
Patient detail page created with profile information, emergency contact, and timeline integration
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` should pass
2. Navigate to /pacientes/[valid-id] should show patient profile and timeline
3. Navigate to /pacientes/[invalid-id] should return 404
4. Timeline shows "No hay eventos registrados" for new patients
5. Edit button links to /pacientes/[id]/editar
</verification>

<success_criteria>
- /pacientes/[id] renders patient profile with all fields
- Emergency contact information displayed prominently
- Timeline component shows patient events or empty state placeholder
- Edit button navigates to edit page
- Invalid patient ID returns 404 page
- All dates use Spanish (es-CO) locale formatting
</success_criteria>

<output>
After completion, create `.planning/phases/02-patients/02-07-SUMMARY.md`
</output>
