---
phase: 11-sales-core
plan: 08
type: execute
wave: 5
depends_on: ["11-05", "11-06"]
files_modified:
  - src/app/(protected)/medias/ventas/[id]/page.tsx
  - src/components/medias/sales/receipt-preview.tsx
  - src/components/medias/sales/delete-sale-dialog.tsx
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "Sale detail page shows all items, methods, and receipt option"
    - "Thermal receipt prints at 58mm width with proper formatting"
    - "Admin delete dialog requires justification and reverses stock"
  artifacts:
    - path: "src/app/(protected)/medias/ventas/[id]/page.tsx"
      provides: "Sale detail page"
    - path: "src/components/medias/sales/receipt-preview.tsx"
      provides: "Thermal printer receipt"
      exports: ["ReceiptPreview"]
    - path: "src/components/medias/sales/delete-sale-dialog.tsx"
      provides: "Admin delete dialog"
      exports: ["DeleteSaleDialog"]
  key_links:
    - from: "receipt-preview.tsx"
      to: "window.print()"
      via: "print button"
      pattern: "window\\.print\\(\\)"
    - from: "delete-sale-dialog.tsx"
      to: "deleteMediasSale action"
      via: "useActionState"
      pattern: "deleteMediasSale"
---

<objective>
Create sale detail page with thermal receipt and admin delete functionality

Purpose: Complete sale workflow with receipt printing (VTA-14) and admin delete (VTA-09, VTA-13)
Output: Detail page, receipt component with print styles, delete dialog
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-sales-core/11-RESEARCH.md
@src/components/payments/anulacion-dialog.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thermal receipt component</name>
  <files>src/components/medias/sales/receipt-preview.tsx</files>
  <action>
Create receipt component optimized for 58mm thermal printer:

```tsx
'use client'

import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import { Button } from '@/components/ui/button'
import { Printer } from 'lucide-react'
import type {
  MediasSaleWithDetails,
  MediasSaleItem,
  MediasSaleMethod,
} from '@/types/medias/sales'
import { PAYMENT_METHOD_LABELS } from '@/types/medias/sales'

interface ReceiptPreviewProps {
  sale: MediasSaleWithDetails
}

const formatCurrency = (amount: number) =>
  new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
  }).format(amount)

export function ReceiptPreview({ sale }: ReceiptPreviewProps) {
  const handlePrint = () => {
    window.print()
  }

  return (
    <>
      {/* Print button (hidden when printing) */}
      <Button onClick={handlePrint} className="no-print mb-4">
        <Printer className="mr-2 h-4 w-4" />
        Imprimir Recibo
      </Button>

      {/* Receipt content */}
      <div className="receipt" id="receipt-content">
        {/* Header */}
        <div className="receipt-header">
          <h1 className="text-lg font-bold">VARIX MEDIAS</h1>
          <p className="text-xs">Medias de Compresion Medica</p>
          <p className="text-xs">Bucaramanga, Colombia</p>
        </div>

        {/* Sale info */}
        <div className="receipt-info">
          <p className="font-bold text-center">{sale.numero_venta}</p>
          <p className="text-xs text-center">
            {format(new Date(sale.created_at), "dd/MM/yyyy HH:mm", {
              locale: es,
            })}
          </p>
          {sale.patient && (
            <p className="text-xs text-center mt-1">
              Cliente: {sale.patient.nombre_completo}
            </p>
          )}
        </div>

        {/* Separator */}
        <div className="receipt-separator">--------------------------------</div>

        {/* Items */}
        <div className="receipt-items">
          {sale.items.map((item) => (
            <div key={item.id} className="receipt-item">
              <div className="flex justify-between">
                <span>
                  {item.product_tipo} {item.product_talla}
                </span>
                <span>{formatCurrency(item.subtotal)}</span>
              </div>
              <div className="text-xs text-muted-foreground">
                {item.quantity} x {formatCurrency(item.unit_price)}
              </div>
            </div>
          ))}
        </div>

        {/* Separator */}
        <div className="receipt-separator">--------------------------------</div>

        {/* Total */}
        <div className="receipt-total">
          <div className="flex justify-between font-bold text-lg">
            <span>TOTAL</span>
            <span>{formatCurrency(sale.total)}</span>
          </div>
        </div>

        {/* Separator */}
        <div className="receipt-separator">--------------------------------</div>

        {/* Payment methods */}
        <div className="receipt-methods">
          <p className="text-xs font-medium mb-1">Forma de Pago:</p>
          {sale.methods.map((method) => (
            <div key={method.id} className="flex justify-between text-xs">
              <span>{PAYMENT_METHOD_LABELS[method.metodo]}</span>
              <span>{formatCurrency(method.monto)}</span>
            </div>
          ))}
        </div>

        {/* Footer */}
        <div className="receipt-footer">
          <p className="text-xs text-center mt-4">Gracias por su compra</p>
          <p className="text-xs text-center">VarixCenter</p>
        </div>
      </div>
    </>
  )
}
```
  </action>
  <verify>
Run: `grep "window.print" src/components/medias/sales/receipt-preview.tsx` confirms print function
  </verify>
  <done>
ReceiptPreview component renders receipt content and triggers print
  </done>
</task>

<task type="auto">
  <name>Task 2: Add thermal receipt print styles</name>
  <files>src/app/globals.css</files>
  <action>
Add CSS for 58mm thermal receipt printing at the END of globals.css (after existing styles):

```css
/* ============================================
   THERMAL RECEIPT PRINTING STYLES (58mm)
   Phase 11: Sales Core - VTA-14
   ============================================ */

/* Receipt base styles (always applied) */
.receipt {
  width: 58mm;
  max-width: 58mm;
  font-family: 'Courier New', Courier, monospace;
  font-size: 12px;
  line-height: 1.3;
  padding: 4mm;
  background: white;
  color: black;
}

.receipt-header {
  text-align: center;
  margin-bottom: 2mm;
}

.receipt-info {
  margin-bottom: 2mm;
}

.receipt-separator {
  text-align: center;
  font-size: 10px;
  margin: 1mm 0;
  overflow: hidden;
}

.receipt-items {
  margin: 2mm 0;
}

.receipt-item {
  margin-bottom: 1mm;
}

.receipt-total {
  margin: 2mm 0;
}

.receipt-methods {
  margin: 2mm 0;
}

.receipt-footer {
  margin-top: 4mm;
}

/* Print-specific styles */
@media print {
  /* Hide everything except receipt */
  body * {
    visibility: hidden;
  }

  .receipt,
  .receipt * {
    visibility: visible;
  }

  .receipt {
    position: absolute;
    left: 0;
    top: 0;
    margin: 0;
    padding: 2mm;
  }

  /* Hide non-printable elements */
  .no-print {
    display: none !important;
  }

  /* Reset page margins for thermal printer */
  @page {
    size: 58mm auto;
    margin: 0;
  }
}
```

Make sure to NOT modify any existing styles in globals.css, only APPEND these new styles.
  </action>
  <verify>
Run: `grep "@media print" src/app/globals.css` confirms print media query exists
Run: `grep "58mm" src/app/globals.css` confirms thermal width
  </verify>
  <done>
Print styles enable 58mm thermal receipt output with proper formatting
  </done>
</task>

<task type="auto">
  <name>Task 3: Create delete sale dialog and detail page</name>
  <files>
    src/components/medias/sales/delete-sale-dialog.tsx
    src/app/(protected)/medias/ventas/[id]/page.tsx
  </files>
  <action>
**src/components/medias/sales/delete-sale-dialog.tsx:**
```tsx
'use client'

import { useActionState, useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Loader2, Trash2 } from 'lucide-react'
import {
  deleteMediasSale,
  type SaleActionState,
} from '@/app/(protected)/medias/ventas/actions'

interface DeleteSaleDialogProps {
  saleId: string
  numeroVenta: string
}

export function DeleteSaleDialog({ saleId, numeroVenta }: DeleteSaleDialogProps) {
  const router = useRouter()
  const [open, setOpen] = useState(false)
  const [justificacion, setJustificacion] = useState('')

  const [state, formAction, isPending] = useActionState<
    SaleActionState | null,
    FormData
  >(deleteMediasSale, null)

  useEffect(() => {
    if (state?.success) {
      setOpen(false)
      router.push('/medias/ventas')
    }
  }, [state?.success, router])

  const handleSubmit = (formData: FormData) => {
    formData.set('sale_id', saleId)
    formData.set('justificacion', justificacion)
    formAction(formData)
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button variant="destructive">
          <Trash2 className="mr-2 h-4 w-4" />
          Eliminar Venta
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Eliminar Venta {numeroVenta}</DialogTitle>
          <DialogDescription>
            Esta accion eliminara la venta y revertira el stock de los productos.
            Esta accion no se puede deshacer.
          </DialogDescription>
        </DialogHeader>

        <form action={handleSubmit} className="space-y-4">
          {state?.error && (
            <Alert variant="destructive">
              <AlertDescription>{state.error}</AlertDescription>
            </Alert>
          )}

          <div className="space-y-2">
            <Label htmlFor="justificacion">
              Justificacion (minimo 10 caracteres)
            </Label>
            <Textarea
              id="justificacion"
              value={justificacion}
              onChange={(e) => setJustificacion(e.target.value)}
              placeholder="Explique la razon de la eliminacion..."
              rows={3}
              disabled={isPending}
            />
            <p className="text-xs text-muted-foreground">
              {justificacion.length}/10 caracteres minimos
            </p>
          </div>

          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => setOpen(false)}
              disabled={isPending}
            >
              Cancelar
            </Button>
            <Button
              type="submit"
              variant="destructive"
              disabled={isPending || justificacion.length < 10}
            >
              {isPending ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Eliminando...
                </>
              ) : (
                'Confirmar Eliminacion'
              )}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

**src/app/(protected)/medias/ventas/[id]/page.tsx:**
```tsx
import { notFound } from 'next/navigation'
import Link from 'next/link'
import { format } from 'date-fns'
import { es } from 'date-fns/locale'
import { createClient } from '@/lib/supabase/server'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { ArrowLeft } from 'lucide-react'
import { getSaleById } from '@/lib/queries/medias/sales'
import { ReceiptPreview } from '@/components/medias/sales/receipt-preview'
import { DeleteSaleDialog } from '@/components/medias/sales/delete-sale-dialog'
import { PAYMENT_METHOD_LABELS } from '@/types/medias/sales'

interface SaleDetailPageProps {
  params: Promise<{ id: string }>
}

const formatCurrency = (amount: number) =>
  new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
  }).format(amount)

export default async function SaleDetailPage({ params }: SaleDetailPageProps) {
  const { id } = await params
  const sale = await getSaleById(id)

  if (!sale) {
    notFound()
  }

  // Check if current user is admin
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  const { data: userRole } = await supabase
    .from('user_roles')
    .select('role')
    .eq('user_id', user?.id)
    .single()

  const isAdmin = userRole?.role === 'admin'

  return (
    <div className="container mx-auto py-6">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6 no-print">
        <Button variant="ghost" size="icon" asChild>
          <Link href="/medias/ventas">
            <ArrowLeft className="h-4 w-4" />
          </Link>
        </Button>
        <div className="flex-1">
          <h1 className="text-2xl font-bold">{sale.numero_venta}</h1>
          <p className="text-muted-foreground">
            {format(new Date(sale.created_at), "EEEE d 'de' MMMM yyyy, HH:mm", {
              locale: es,
            })}
          </p>
        </div>
        <Badge
          variant={sale.estado === 'activo' ? 'default' : 'destructive'}
          className="text-sm"
        >
          {sale.estado === 'activo' ? 'Activo' : 'Anulado'}
        </Badge>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Sale Details */}
        <div className="space-y-6 no-print">
          {/* Items */}
          <Card>
            <CardHeader>
              <CardTitle>Productos</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {sale.items.map((item) => (
                  <div
                    key={item.id}
                    className="flex justify-between items-center"
                  >
                    <div>
                      <p className="font-medium">
                        {item.product_tipo} {item.product_talla}
                      </p>
                      <p className="text-sm text-muted-foreground">
                        {item.quantity} x {formatCurrency(item.unit_price)}
                      </p>
                    </div>
                    <p className="font-medium">{formatCurrency(item.subtotal)}</p>
                  </div>
                ))}
                <div className="border-t pt-3 flex justify-between font-bold text-lg">
                  <span>Total</span>
                  <span>{formatCurrency(sale.total)}</span>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Payment Methods */}
          <Card>
            <CardHeader>
              <CardTitle>Metodos de Pago</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                {sale.methods.map((method) => (
                  <div key={method.id} className="flex justify-between">
                    <span>{PAYMENT_METHOD_LABELS[method.metodo]}</span>
                    <span>{formatCurrency(method.monto)}</span>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* Patient */}
          {sale.patient && (
            <Card>
              <CardHeader>
                <CardTitle>Paciente</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="font-medium">{sale.patient.nombre_completo}</p>
                <p className="text-sm text-muted-foreground">
                  CC: {sale.patient.cedula}
                </p>
              </CardContent>
            </Card>
          )}

          {/* Anulacion info */}
          {sale.estado === 'anulado' && (
            <Card className="border-destructive">
              <CardHeader>
                <CardTitle className="text-destructive">
                  Informacion de Eliminacion
                </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm">
                  <strong>Fecha:</strong>{' '}
                  {sale.eliminado_at &&
                    format(new Date(sale.eliminado_at), "dd/MM/yyyy HH:mm", {
                      locale: es,
                    })}
                </p>
                <p className="text-sm mt-2">
                  <strong>Justificacion:</strong>{' '}
                  {sale.eliminacion_justificacion}
                </p>
              </CardContent>
            </Card>
          )}

          {/* Admin delete button */}
          {isAdmin && sale.estado === 'activo' && (
            <DeleteSaleDialog
              saleId={sale.id}
              numeroVenta={sale.numero_venta}
            />
          )}
        </div>

        {/* Receipt Preview */}
        <div>
          <Card className="no-print mb-4">
            <CardHeader>
              <CardTitle>Recibo</CardTitle>
            </CardHeader>
            <CardContent>
              <ReceiptPreview sale={sale} />
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run: `grep "DeleteSaleDialog" src/app/(protected)/medias/ventas/[id]/page.tsx` confirms dialog used
Run: `grep "ReceiptPreview" src/app/(protected)/medias/ventas/[id]/page.tsx` confirms receipt used
  </verify>
  <done>
Sale detail page shows complete sale info with print receipt and admin delete
  </done>
</task>

</tasks>

<verification>
- [ ] ReceiptPreview renders at 58mm width with monospace font
- [ ] Print button triggers window.print()
- [ ] @media print hides everything except receipt
- [ ] DeleteSaleDialog requires 10+ char justification
- [ ] Delete only visible to admin users
- [ ] Detail page shows items, methods, patient, and anulacion info
</verification>

<success_criteria>
Sale detail page with thermal receipt printing and admin delete functionality complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-sales-core/11-08-SUMMARY.md`
</output>
