---
phase: 04-payments-core
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-03"]
files_modified:
  - src/lib/validations/service.ts
  - src/lib/validations/payment.ts
autonomous: true

must_haves:
  truths:
    - "Service schema validates nombre, precio_base, variable price constraints"
    - "Payment schema validates items array, methods array, comprobante requirement"
    - "Anulacion schema requires 10+ character justificacion"
  artifacts:
    - path: "src/lib/validations/service.ts"
      provides: "Zod schemas for service CRUD"
      contains: "serviceSchema"
    - path: "src/lib/validations/payment.ts"
      provides: "Zod schemas for payment creation and anulacion"
      contains: "paymentSchema"
  key_links:
    - from: "paymentMethodSchema"
      to: "requiresComprobante"
      via: "refine validation"
      pattern: "metodo.*efectivo.*comprobante"
---

<objective>
Create Zod validation schemas for services and payments.

Purpose: Validate form data before server actions, enforce business rules at application level.
Output: Two validation files with Spanish error messages
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-payments-core/04-RESEARCH.md

Reference existing patterns:
@src/lib/validations/patient.ts
@src/lib/validations/appointment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service validation schemas</name>
  <files>src/lib/validations/service.ts</files>
  <action>
Create src/lib/validations/service.ts with:

1. **serviceSchema (for creation):**
```typescript
import { z } from 'zod'

export const serviceSchema = z.object({
  nombre: z
    .string()
    .min(2, 'El nombre debe tener al menos 2 caracteres')
    .max(100, 'El nombre es muy largo'),

  descripcion: z
    .string()
    .max(500, 'La descripcion es muy larga')
    .optional()
    .or(z.literal('')),

  precio_base: z
    .number({ message: 'El precio base es requerido' })
    .min(0, 'El precio no puede ser negativo')
    .max(100000000, 'El precio es muy alto'),  // 100 million COP max

  precio_variable: z
    .boolean()
    .default(false),

  precio_minimo: z
    .number()
    .min(0, 'El precio minimo no puede ser negativo')
    .nullable()
    .optional(),

  precio_maximo: z
    .number()
    .min(0, 'El precio maximo no puede ser negativo')
    .nullable()
    .optional(),

  activo: z
    .boolean()
    .default(true),
})
.refine(
  data => !data.precio_variable || (data.precio_minimo !== null && data.precio_maximo !== null),
  { message: 'Servicios de precio variable requieren precio minimo y maximo', path: ['precio_variable'] }
)
.refine(
  data => !data.precio_variable || (data.precio_minimo! <= data.precio_base && data.precio_base <= data.precio_maximo!),
  { message: 'El precio base debe estar entre el minimo y maximo', path: ['precio_base'] }
)
```

2. **serviceUpdateSchema:**
```typescript
export const serviceUpdateSchema = serviceSchema.partial()
```

3. **Type exports:**
```typescript
export type ServiceFormData = z.infer<typeof serviceSchema>
export type ServiceUpdateData = z.infer<typeof serviceUpdateSchema>
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/lib/validations/service.ts 2>&1 | head -20
```
  </verify>
  <done>src/lib/validations/service.ts exists with serviceSchema (validates variable price constraints), serviceUpdateSchema (partial), and type exports</done>
</task>

<task type="auto">
  <name>Task 2: Create payment validation schemas</name>
  <files>src/lib/validations/payment.ts</files>
  <action>
Create src/lib/validations/payment.ts with:

1. **paymentItemSchema:**
```typescript
import { z } from 'zod'

export const paymentItemSchema = z.object({
  service_id: z.string().uuid('ID de servicio invalido'),
  service_name: z.string().min(1, 'Nombre de servicio requerido'),
  unit_price: z.number().min(0, 'El precio debe ser positivo o cero'),
  quantity: z.number().int().positive('La cantidad debe ser positiva'),
})
```

2. **paymentMethodSchema with comprobante validation:**
```typescript
export const paymentMethodSchema = z.object({
  metodo: z.enum(['efectivo', 'tarjeta', 'transferencia', 'nequi'], {
    error: 'Metodo de pago invalido'
  }),
  monto: z.number().positive('El monto debe ser positivo'),
  comprobante_path: z.string().nullable(),
})
.refine(
  data => data.metodo === 'efectivo' || (data.comprobante_path !== null && data.comprobante_path !== ''),
  { message: 'Los pagos electronicos requieren foto del comprobante', path: ['comprobante_path'] }
)
```

3. **paymentSchema (main):**
```typescript
export const paymentSchema = z.object({
  patient_id: z.string().uuid('ID de paciente invalido'),

  items: z
    .array(paymentItemSchema)
    .min(1, 'Debe incluir al menos un servicio'),

  methods: z
    .array(paymentMethodSchema)
    .min(1, 'Debe incluir al menos un metodo de pago'),

  descuento: z
    .number()
    .min(0, 'El descuento no puede ser negativo')
    .default(0),

  descuento_justificacion: z
    .string()
    .max(500, 'La justificacion es muy larga')
    .nullable()
    .optional(),
})
.refine(
  data => data.descuento === 0 || (data.descuento_justificacion && data.descuento_justificacion.length >= 5),
  { message: 'Los descuentos requieren justificacion (minimo 5 caracteres)', path: ['descuento_justificacion'] }
)
```

4. **anulacionSchema:**
```typescript
export const anulacionSchema = z.object({
  payment_id: z.string().uuid('ID de pago invalido'),
  justificacion: z
    .string()
    .min(10, 'La justificacion debe tener al menos 10 caracteres')
    .max(500, 'La justificacion es muy larga'),
})
```

5. **Type exports:**
```typescript
export type PaymentFormData = z.infer<typeof paymentSchema>
export type PaymentItemFormData = z.infer<typeof paymentItemSchema>
export type PaymentMethodFormData = z.infer<typeof paymentMethodSchema>
export type AnulacionFormData = z.infer<typeof anulacionSchema>
```
  </action>
  <verify>
```bash
npx tsc --noEmit src/lib/validations/payment.ts 2>&1 | head -20
```
  </verify>
  <done>src/lib/validations/payment.ts exists with paymentItemSchema, paymentMethodSchema (refine for comprobante), paymentSchema (refine for descuento justificacion), anulacionSchema (10+ chars), and type exports</done>
</task>

</tasks>

<verification>
1. Both files compile without errors
2. serviceSchema validates precio_variable constraints correctly
3. paymentMethodSchema.refine enforces comprobante for non-cash
4. paymentSchema.refine enforces descuento_justificacion
5. anulacionSchema enforces 10+ char justificacion
6. All error messages in Spanish
</verification>

<success_criteria>
- src/lib/validations/service.ts: Service schemas with variable price validation
- src/lib/validations/payment.ts: Payment schemas with comprobante requirement and descuento justification
- All files compile, Spanish error messages
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments-core/04-04-SUMMARY.md`
</output>
