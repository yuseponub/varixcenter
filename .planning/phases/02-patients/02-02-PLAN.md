---
phase: 02-patients
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/006_patients_table.sql
autonomous: true

must_haves:
  truths:
    - "patients table exists with RLS enabled"
    - "cedula column is UNIQUE and cannot be updated (trigger prevents)"
    - "All authenticated staff can create and view patients"
    - "Audit trail captures all patient record changes"
  artifacts:
    - path: "supabase/migrations/006_patients_table.sql"
      provides: "Patients table with RLS, triggers, and audit"
      contains: "CREATE TABLE public.patients"
  key_links:
    - from: "tr_patients_immutable_cedula"
      to: "prevent_cedula_update()"
      via: "BEFORE UPDATE trigger"
      pattern: "RAISE EXCEPTION"
    - from: "patients"
      to: "audit_log"
      via: "enable_audit_for_table()"
      pattern: "tr_audit_patients"
---

<objective>
Create patients database table with RLS policies, immutable cedula trigger, and audit integration

Purpose: Establishes the data layer for patient management with proper security (RLS), anti-fraud protection (immutable cedula), and compliance (audit logging). This follows Phase 1 patterns.
Output: SQL migration file ready to apply to Supabase
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-patients/02-RESEARCH.md

# Phase 1 audit infrastructure (use enable_audit_for_table)
@supabase/migrations/002_audit_infrastructure.sql

# Phase 1 user roles (use get_user_role() in RLS)
@supabase/migrations/001_user_roles.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patients table migration</name>
  <files>supabase/migrations/006_patients_table.sql</files>
  <action>
Create migration file `supabase/migrations/006_patients_table.sql` with the following content:

```sql
-- Migration: 006_patients_table.sql
-- Purpose: Patient registry with immutable cedula and audit trail
-- Phase: 02-patients, Plan: 02
-- Created: 2026-01-23

-- ============================================
-- 1. PATIENTS TABLE
-- ============================================

CREATE TABLE public.patients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Identification (cedula is IMMUTABLE after creation)
  cedula VARCHAR(10) NOT NULL UNIQUE,

  -- Basic info
  nombre VARCHAR(100) NOT NULL,
  apellido VARCHAR(100) NOT NULL,
  celular VARCHAR(10) NOT NULL,
  email VARCHAR(255),
  fecha_nacimiento DATE,
  direccion VARCHAR(200),

  -- Emergency contact (REQUIRED)
  contacto_emergencia_nombre VARCHAR(100) NOT NULL,
  contacto_emergencia_telefono VARCHAR(10) NOT NULL,
  contacto_emergencia_parentesco VARCHAR(50) NOT NULL,

  -- Metadata
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Add table comment
COMMENT ON TABLE public.patients IS 'Registro de pacientes con cedula inmutable como identificador unico';
COMMENT ON COLUMN public.patients.cedula IS 'Cedula colombiana (6-10 digitos). INMUTABLE despues de creacion.';

-- ============================================
-- 2. INDEXES FOR SEARCH
-- ============================================

-- Primary search fields
CREATE INDEX idx_patients_cedula ON public.patients(cedula);
CREATE INDEX idx_patients_nombre ON public.patients(nombre);
CREATE INDEX idx_patients_apellido ON public.patients(apellido);
CREATE INDEX idx_patients_celular ON public.patients(celular);

-- Composite index for full name search
CREATE INDEX idx_patients_nombre_apellido ON public.patients(nombre, apellido);

-- ============================================
-- 3. ROW LEVEL SECURITY
-- ============================================

ALTER TABLE public.patients ENABLE ROW LEVEL SECURITY;

-- All authenticated users can view patients
CREATE POLICY "Authenticated users can view patients" ON public.patients
  FOR SELECT
  TO authenticated
  USING (true);

-- Staff can create patients (all roles)
CREATE POLICY "Staff can create patients" ON public.patients
  FOR INSERT
  TO authenticated
  WITH CHECK (
    public.get_user_role() IN ('admin', 'medico', 'enfermera', 'secretaria')
  );

-- Staff can update patients (but cedula trigger prevents cedula changes)
CREATE POLICY "Staff can update patients" ON public.patients
  FOR UPDATE
  TO authenticated
  USING (public.get_user_role() IN ('admin', 'medico', 'enfermera', 'secretaria'))
  WITH CHECK (public.get_user_role() IN ('admin', 'medico', 'enfermera', 'secretaria'));

-- Only admin can delete patients
CREATE POLICY "Only admin can delete patients" ON public.patients
  FOR DELETE
  TO authenticated
  USING (public.get_user_role() = 'admin');

-- ============================================
-- 4. IMMUTABLE CEDULA TRIGGER
-- ============================================

-- Function to prevent cedula updates (anti-fraud)
CREATE OR REPLACE FUNCTION public.prevent_cedula_update()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
  IF OLD.cedula IS DISTINCT FROM NEW.cedula THEN
    RAISE EXCEPTION 'La cedula no puede ser modificada';
  END IF;
  RETURN NEW;
END;
$$;

-- Attach trigger to patients table
CREATE TRIGGER tr_patients_immutable_cedula
  BEFORE UPDATE ON public.patients
  FOR EACH ROW
  EXECUTE FUNCTION public.prevent_cedula_update();

-- ============================================
-- 5. UPDATED_AT TRIGGER
-- ============================================

-- Reuse update_updated_at function from Phase 1 if exists, or create it
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'update_updated_at') THEN
    CREATE OR REPLACE FUNCTION public.update_updated_at()
    RETURNS TRIGGER
    LANGUAGE plpgsql
    AS $func$
    BEGIN
      NEW.updated_at = now();
      RETURN NEW;
    END;
    $func$;
  END IF;
END;
$$;

CREATE TRIGGER tr_patients_updated_at
  BEFORE UPDATE ON public.patients
  FOR EACH ROW
  EXECUTE FUNCTION public.update_updated_at();

-- ============================================
-- 6. AUDIT LOGGING
-- ============================================

-- Enable audit for patients table (uses function from 002_audit_infrastructure.sql)
SELECT enable_audit_for_table('public.patients');

-- ============================================
-- 7. VERIFICATION
-- ============================================

-- Verify RLS is enabled
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_tables
    WHERE schemaname = 'public'
    AND tablename = 'patients'
    AND rowsecurity = true
  ) THEN
    RAISE EXCEPTION 'RLS not enabled on patients table';
  END IF;
END;
$$;
```

Key points:
1. cedula: VARCHAR(10) NOT NULL UNIQUE - matches Colombian cedula format (6-10 digits stored without dashes)
2. Emergency contact fields are NOT NULL (required per PAT-04)
3. Immutable cedula enforced at DATABASE level via trigger (not just UI)
4. Uses get_user_role() from Phase 1 for RLS policies
5. Uses enable_audit_for_table() from Phase 1 for audit logging
6. Includes verification check that RLS is actually enabled
  </action>
  <verify>
Run `cat supabase/migrations/006_patients_table.sql | grep -E "(CREATE TABLE|ENABLE ROW LEVEL SECURITY|prevent_cedula_update|enable_audit_for_table)"` - should show all 4 patterns.
  </verify>
  <done>
Migration file exists with patients table, RLS policies, immutable cedula trigger, and audit integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>src/types/supabase.ts</files>
  <action>
Update the `src/types/supabase.ts` file to add the patients table types.

Add the following to the `public.Tables` section in the Database interface:

```typescript
patients: {
  Row: {
    id: string
    cedula: string
    nombre: string
    apellido: string
    celular: string
    email: string | null
    fecha_nacimiento: string | null
    direccion: string | null
    contacto_emergencia_nombre: string
    contacto_emergencia_telefono: string
    contacto_emergencia_parentesco: string
    created_by: string | null
    created_at: string
    updated_at: string
  }
  Insert: {
    id?: string
    cedula: string
    nombre: string
    apellido: string
    celular: string
    email?: string | null
    fecha_nacimiento?: string | null
    direccion?: string | null
    contacto_emergencia_nombre: string
    contacto_emergencia_telefono: string
    contacto_emergencia_parentesco: string
    created_by?: string | null
    created_at?: string
    updated_at?: string
  }
  Update: {
    id?: string
    // cedula intentionally omitted - immutable
    nombre?: string
    apellido?: string
    celular?: string
    email?: string | null
    fecha_nacimiento?: string | null
    direccion?: string | null
    contacto_emergencia_nombre?: string
    contacto_emergencia_telefono?: string
    contacto_emergencia_parentesco?: string
    created_by?: string | null
    created_at?: string
    updated_at?: string
  }
  Relationships: [
    {
      foreignKeyName: "patients_created_by_fkey"
      columns: ["created_by"]
      isOneToOne: false
      referencedRelation: "users"
      referencedColumns: ["id"]
    }
  ]
}
```

IMPORTANT: In the Update type, cedula is intentionally OMITTED to enforce immutability at the TypeScript level as well. This provides compile-time prevention in addition to the database trigger.

If the file uses a different structure (like Supabase-generated types), adapt the types to match that structure while keeping the same field definitions.
  </action>
  <verify>
Run `grep -A 30 "patients:" src/types/supabase.ts` - should show the patients type definition with Row, Insert, Update sections.
  </verify>
  <done>
TypeScript types for patients table added with cedula omitted from Update type
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Migration file exists at `supabase/migrations/006_patients_table.sql`
2. TypeScript types include patients table
3. `npm run build` should pass (TypeScript compiles)
</verification>

<success_criteria>
- Migration file creates patients table with all required columns
- RLS is enabled with 4 policies (SELECT, INSERT, UPDATE, DELETE)
- Immutable cedula trigger `tr_patients_immutable_cedula` is created
- Audit trigger is attached via `enable_audit_for_table('public.patients')`
- TypeScript types reflect the table structure
</success_criteria>

<output>
After completion, create `.planning/phases/02-patients/02-02-SUMMARY.md`
</output>
