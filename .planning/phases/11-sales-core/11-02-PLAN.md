---
phase: 11-sales-core
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - supabase/migrations/022_medias_sales_immutability.sql
autonomous: true

must_haves:
  truths:
    - "Sales cannot be UPDATEd (trigger blocks all updates)"
    - "Sales cannot be DELETEd directly (only via eliminar_medias_sale RPC)"
    - "Admin delete reverses stock and requires justification"
  artifacts:
    - path: "supabase/migrations/022_medias_sales_immutability.sql"
      provides: "Immutability trigger and delete RPC"
      contains: "enforce_medias_sale_immutability"
  key_links:
    - from: "eliminar_medias_sale"
      to: "medias_products"
      via: "stock restoration"
      pattern: "stock_normal \\+ .*.quantity"
---

<objective>
Create immutability trigger and admin delete RPC with stock reversal

Purpose: Enforce VTA-09 (immutability) and VTA-13 (delete reverses stock) at database level
Output: Migration 022_medias_sales_immutability.sql with trigger and RPC function
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-sales-core/11-RESEARCH.md
@supabase/migrations/010_payments_immutability.sql
@supabase/migrations/020_medias_foundation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create immutability enforcement migration</name>
  <files>supabase/migrations/022_medias_sales_immutability.sql</files>
  <action>
Create migration following 010_payments_immutability.sql pattern:

1. **enforce_medias_sale_immutability() function**:
   - BEFORE UPDATE OR DELETE trigger function
   - DELETE: RAISE EXCEPTION 'Las ventas no pueden ser eliminadas directamente. Use eliminar_medias_sale.'
   - UPDATE: Block ALL updates (simpler than payments - no anulacion transition needed)
     - RAISE EXCEPTION 'Las ventas son inmutables'
   - SECURITY DEFINER, SET search_path = public

2. **tr_medias_sale_immutability trigger**:
   - BEFORE UPDATE OR DELETE ON medias_sales
   - FOR EACH ROW EXECUTE FUNCTION enforce_medias_sale_immutability()

3. **Item immutability triggers** (same pattern):
   - enforce_medias_sale_items_immutability() - blocks UPDATE/DELETE
   - tr_medias_sale_items_immutability trigger

4. **Method immutability triggers** (same pattern):
   - enforce_medias_sale_methods_immutability() - blocks UPDATE/DELETE
   - tr_medias_sale_methods_immutability trigger

5. **eliminar_medias_sale(p_sale_id UUID, p_justificacion TEXT) RPC**:
   - SECURITY DEFINER function
   - Verify caller is admin (query user_roles)
   - Validate justificacion >= 10 chars
   - FOR each item in medias_sale_items WHERE sale_id = p_sale_id:
     - Lock product row with FOR UPDATE
     - UPDATE medias_products SET stock_normal = stock_normal + item.quantity
     - INSERT medias_stock_movements with tipo='ajuste_entrada', referencia_tipo='eliminacion_venta'
   - DISABLE trigger tr_medias_sale_immutability temporarily
   - UPDATE medias_sales SET estado='anulado', eliminado_por, eliminado_at, eliminacion_justificacion
   - ENABLE trigger
   - Return jsonb_build_object('success', true, 'sale_id', p_sale_id)
   - Use ALTER TABLE ... DISABLE/ENABLE TRIGGER for the update

6. **Audit trigger**:
   - tr_audit_medias_sales AFTER INSERT OR UPDATE on medias_sales
   - Execute audit_trigger_func() (existing from 002)

7. **GRANT EXECUTE** on eliminar_medias_sale to authenticated

8. **Verification DO block**:
   - Check all triggers exist
   - Check RPC function exists
  </action>
  <verify>
Run: `grep -c "CREATE TRIGGER" supabase/migrations/022_medias_sales_immutability.sql` shows 4+ triggers
Run: `grep "eliminar_medias_sale" supabase/migrations/022_medias_sales_immutability.sql` shows RPC
  </verify>
  <done>
Migration creates immutability enforcement and admin delete RPC that reverses stock
  </done>
</task>

</tasks>

<verification>
- [ ] UPDATE on medias_sales raises exception "Las ventas son inmutables"
- [ ] DELETE on medias_sales raises exception directing to RPC
- [ ] eliminar_medias_sale validates admin role
- [ ] eliminar_medias_sale validates justificacion >= 10 chars
- [ ] Stock is restored via medias_products UPDATE
- [ ] Stock movement logged with tipo='ajuste_entrada'
</verification>

<success_criteria>
Migration 022 makes sales immutable at database level; only admin can delete via RPC with stock reversal
</success_criteria>

<output>
After completion, create `.planning/phases/11-sales-core/11-02-SUMMARY.md`
</output>
